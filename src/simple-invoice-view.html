<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, minimum-scale=0.5, user-scalable=yes, viewport-fit=cover">
    <title>Invoice View</title>
    <style>
        /* Clean Professional CSS Variables */
        :root {
            --text: #2D3748;
            --text-light: #718096;
            --border: #E2E8F0;
            --bg: #FFFFFF;
            --bg-light: #F7FAFC;
            --success: #48BB78;
            --error: #F56565;
            --info: #4299E1;
            --warning: #ED8936;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text);
            background: white;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .paper-wrapper {
            width: fit-content;
            margin: 0 auto;
            transform-origin: top center;
            transform: scale(var(--mobile-scale-factor, 1));
            transition: transform 0.3s ease;
        }
        
        .paper {
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            max-width: none;
            margin: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 0;
            position: relative;
            margin-bottom: 20px;
        }
        
        .inv-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            padding: 24px 32px 16px 32px;
            background: var(--bg);
            border-bottom: 2px solid var(--border);
            align-items: start;
            border-radius: 8px 8px 0 0;
        }
        
        .logo-section {
            text-align: left;
        }
        
        .logo-section img {
            max-height: 120px;
            max-width: 300px;
            object-fit: contain;
            display: block;
            margin-bottom: 6px;
        }
        
        .logo-section strong {
            display: block;
            font-size: 28px;
            font-weight: 800;
            color: var(--text);
            margin-top: 4px;
            line-height: 1.1;
        }
        
        .invoice-meta {
            text-align: right;
        }
        
        .invoice-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text);
            margin: 0 0 20px 0;
            letter-spacing: 0.5px;
        }
        
        .invoice-details {
            font-size: 15px;
            color: var(--text-light);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .invoice-details strong {
            color: var(--text);
            font-weight: 600;
            min-width: 100px;
            display: inline-block;
        }
        
        .parties {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 80px;
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            border-radius: 8px;
            margin: 0 12px;
        }
        
        .party-section h3 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 16px 0;
        }
        
        .party-section address {
            font-style: normal;
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-light);
        }
        
        .party-section strong {
            color: var(--text);
            font-weight: 600;
            font-size: 16px;
            display: block;
            margin-bottom: 3px;
        }
        
        .items-section {
            padding: 20px 32px;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .items-table thead th {
            background: var(--bg-light);
            border-bottom: 2px solid var(--border);
            padding: 18px 20px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text);
            text-align: left;
        }
        
        .items-table th:last-child,
        .items-table th.text-right { text-align: right; }
        .items-table th.text-center { text-align: center; }
        
        .items-table tbody td {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            font-size: 15px;
            color: var(--text);
        }
        
        .items-table tbody tr:nth-child(even) {
            background: rgba(247, 250, 252, 0.5);
        }
        
        .items-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .items-table .text-right { text-align: right; font-weight: 600; }
        .items-table .text-center { text-align: center; }
        
        .product-name {
            font-weight: 500;
            color: var(--text);
            margin: 0;
        }
        
        .product-description {
            color: var(--text-light);
            font-size: 13px;
            margin: 2px 0 0 0;
        }
        
        .summary {
            padding: 20px 32px;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px 40px;
            max-width: 320px;
            margin-left: auto;
        }
        
        .summary-label {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .summary-value {
            color: var(--text);
            font-size: 15px;
            font-weight: 600;
            text-align: right;
        }
        
        .total-label {
            color: var(--text) !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-top: 12px;
            border-top: 2px solid var(--text);
            margin-top: 8px;
        }
        
        .total-value {
            color: var(--text) !important;
            font-weight: 800 !important;
            font-size: 20px !important;
            padding-top: 12px;
            border-top: 2px solid var(--text);
            margin-top: 8px;
        }
        
        .payment-stage-note {
            font-size: 12px;
            color: var(--warning);
            font-weight: 600;
            margin-top: 4px;
            margin-top: 8px;
            text-align: right;
        }

        /* Payment section styling (separate from invoice) */
        .payment-section {
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
        }

        .payment-section h3 {
            color: var(--text);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .payment-method {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .payment-method:hover {
            border-color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .payment-method.active {
            border-color: var(--text);
            background: var(--bg-light);
            color: var(--text);
            font-weight: 600;
        }

        .payment-method span {
            font-size: 1.8rem;
        }

        .pay-btn {
            background: var(--text);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 200px;
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .pay-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        .paid-notice {
            background: rgba(72, 187, 120, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            margin-top: 20px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            font-size: 1.2rem;
            color: var(--text-light);
        }

        .error {
            background: rgba(245, 101, 101, 0.1);
            border: 2px solid var(--error);
            color: var(--error);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            margin: 20px 0;
        }

        .payment-status {
            margin: 15px 0;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }

        .payment-status.success {
            background: rgba(72, 187, 120, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
        }

        .payment-status.error {
            background: rgba(245, 101, 101, 0.1);
            border: 2px solid var(--error);
            color: var(--error);
        }

        .payment-status.processing {
            background: rgba(66, 153, 225, 0.1);
            border: 2px solid var(--info);
            color: var(--info);
        }

        /* Print styles - maintain exact screen appearance */
        @media print {
            @page {
                margin: 10mm;
                size: A4 portrait;
            }
            
            /* Remove grid lines and ensure clean print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                box-shadow: none !important;
            }
            
            /* Clean white backgrounds for most elements */
            body, .container, .paper, .parties, .summary {
                background: white !important;
                border: none !important;
            }
            
            /* Preserve footer band styling */
            .footer-band {
                background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .footer-band h4, .footer-band p, .footer-band ul, .footer-band li {
                color: white !important;
            }
            
            /* Preserve essential borders for table structure */
            .items-table, .items-table th, .items-table td {
                border: 1px solid #e2e8f0 !important;
            }
            
            /* Ensure single page layout */
            .paper {
                page-break-inside: avoid !important;
                height: auto !important;
                min-height: auto !important;
                max-height: none !important;
            }
            
            /* Prevent unnecessary page breaks */
            .parties, .items-section, .summary, .footer-band {
                page-break-inside: avoid !important;
            }
            
            /* Compact print layout */
            .container {
                max-width: none !important;
                padding: 0 !important;
            }
            
            .paper-wrapper {
                transform: none !important;
            }
            
            /* Keep all original styling intact */
            body {
                background: white !important;
                padding: 20px !important;
                font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif !important;
                font-size: 16px !important;
                line-height: 1.5 !important;
                color: var(--text) !important;
            }
            
            /* Keep original paper styling */
            .paper {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                border-radius: 12px !important;
                background: white !important;
                margin: 0 auto !important;
                max-width: 800px !important;
                page-break-inside: avoid !important;
                overflow: visible !important;
            }
            
            /* Hide only management actions, keep everything else */
            .payment-section {
                display: block !important;
            }
            
            .paid-notice {
                display: block !important;
            }
            
            /* Keep all gradients and colors */
            .footer-band {
                background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Ensure all colors print exactly */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Hide all price/money related elements */
            .summary-section,
            .summary-label,
            .summary-value,
            .total-label,
            .total-value,
            .payment-section {
                display: none !important;
            }
            
            /* Hide price columns in invoice table */
            th:contains("Harga Satuan"),
            th:contains("Total"),
            th:nth-child(4), /* Harga Satuan column */
            th:nth-child(5), /* Total column */
            td:nth-child(4), /* Harga Satuan data */
            td:nth-child(5)  /* Total data */ {
                display: none !important;
            }
            
            /* Hide specific price table headers and cells */
            .invoice-table th:nth-child(4),
            .invoice-table th:nth-child(5),
            .invoice-table td:nth-child(4),
            .invoice-table td:nth-child(5) {
                display: none !important;
            }

            .footer-section img {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                display: block !important;
            }

            /* Header band print styles */
            .paper > div:first-child {
                background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Ensure all purple elements print with colors */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Force single page printing */
            html, body {
                height: auto !important;
                overflow: visible !important;
            }
            
            /* Reduce font sizes slightly for print to fit more content */
            .paper {
                font-size: 13px !important;
            }
            
            /* Compact payment schedule section */
            .payment-schedule-section {
                margin: 10px 0 !important;
                padding: 15px !important;
            }
            
            /* Ensure footer doesn't create page break */
            .footer-band {
                page-break-inside: avoid !important;
                margin-top: 10px !important;
            }
        }

        /* Mobile responsive - Smart A4 Scaling */
        @media (max-width: 768px) {
            body {
                padding: 8px;
                font-size: 14px;
                line-height: 1.4;
            }
            
            .container {
                padding: 8px;
                overflow-x: auto;
                overflow-y: visible;
                position: relative;
                width: 100%;
                min-height: 100vh;
            }
            
            .paper-wrapper {
                /* Smart scaling - maintains A4 aspect ratio with better readability */
                transform: scale(var(--mobile-scale-factor, 0.6));
                transform-origin: top center;
            }
            
            .paper {
                /* Keep A4 dimensions - no cramping */
                width: 210mm;
                min-height: 297mm;
                border: 1px solid var(--border);
                border-radius: 0;
            }
            
            /* Mobile zoom controls */
            .mobile-zoom-controls {
                position: fixed;
                top: 50%;
                right: 8px;
                transform: translateY(-50%);
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 8px;
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
                padding: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(8px);
            }

            .zoom-btn {
                width: 40px;
                height: 40px;
                border: none;
                background: #4299E1;
                color: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 2px 6px rgba(66, 153, 225, 0.3);
                touch-action: manipulation;
            }

            .zoom-btn:hover, .zoom-btn:active {
                background: #3182CE;
                transform: scale(1.05);
            }

            .zoom-indicator {
                position: fixed;
                top: 20px;
                right: 8px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 6px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 500;
                z-index: 1001;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .zoom-indicator.show {
                opacity: 1;
            }

            .pan-indicator {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 16px;
                border-radius: 16px;
                font-size: 12px;
                z-index: 1001;
                display: none;
            }

            .pan-indicator.show {
                display: block;
            }
            
            .party-section address {
                font-size: 14px;
            }
            
            .party-section strong {
                font-size: 15px;
            }
            
            .items-section {
                padding: 16px;
                margin: 0;
            }
            
            .items-table {
                font-size: 12px;
            }
            
            .items-table th,
            .items-table td {
                padding: 10px 6px;
            }
            
            /* Hide less important columns on very small screens */
            .items-table th:nth-child(3),
            .items-table td:nth-child(3) {
                display: none;
            }
            
            .summary {
                padding: 16px;
                margin: 0;
            }
            
            .summary-grid {
                gap: 6px 15px;
                font-size: 14px;
            }
            
            .summary-total {
                font-size: 18px;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
                gap: 12px;
                margin: 16px 0;
            }
            
            .payment-method {
                padding: 14px 16px;
                font-size: 14px;
            }
            
            .payment-method span {
                font-size: 1.5rem;
            }
            
            .payment-details {
                margin-top: 12px !important;
                padding: 16px !important;
            }
            
            .payment-details h4 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .pay-btn {
                padding: 12px 25px;
                font-size: 1rem;
                width: 100%;
                margin-top: 15px;
            }
            
            /* Mobile footer adjustments */
            .footer-band {
                padding: 16px !important;
                margin: 0 !important;
            }
            
            .footer-band > div:first-child {
                grid-template-columns: 1fr 1fr 120px !important; /* Three columns: terms, contact, logo */
                gap: 16px !important;
                align-items: flex-start !important;
                margin-bottom: 0 !important;
            }
            
            /* Logo positioned at same level as headers */
            .footer-band .footer-section:last-child {
                display: flex;
                justify-content: flex-end !important;
                align-items: flex-start !important;
                margin: 0 !important;
                padding-top: 0 !important;
            }
            
            .footer-band h4 {
                font-size: 16px;
            }
            
            .footer-band p, 
            .footer-band li {
                font-size: 13px;
            }
            
            /* Action buttons mobile optimization */
            .management-actions {
                padding: 15px 10px;
                gap: 10px;
            }
            
            .action-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: auto;
            }
            
            /* Payment upload section mobile */
            #payment-upload-section {
                margin-top: 15px;
            }
            
            #payment-upload-section h4 {
                font-size: 16px;
            }
            
            .file-upload-area {
                padding: 20px !important;
            }
            
            .file-upload-area p {
                font-size: 13px;
            }
            
            /* Mobile Payment Section Gap Fix - Reduce gap between invoice and payment */
            .paper-wrapper + .paper-wrapper {
                margin-top: 5px !important;
            }
            
            /* Payment section specific mobile adjustments */
            .payment-section {
                margin-top: 0px !important;
            }
            
            /* Reduce paper wrapper gap for payment section on mobile */
            .paper-wrapper + .paper-wrapper {
                margin-top: 1px !important;
            }
        }
        
        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            body {
                padding: 4px;
                font-size: 13px;
                line-height: 1.3;
            }
            
            .container {
                padding: 4px;
                overflow-x: auto;
                overflow-y: visible;
                width: 100%;
                min-height: 100vh;
            }
            
            .paper-wrapper {
                /* Smaller scale for very small screens with better readability */
                transform: scale(var(--mobile-scale-factor, 0.5));
            }
            
            .paper {
                /* Maintain A4 dimensions */
                width: 210mm;
                min-height: 297mm;
                border: 1px solid var(--border);
            }
            
            .parties {
                padding: 16px;
                gap: 20px;
                background: var(--bg-light) !important;
                margin: 0 8px;
                border-radius: 8px;
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
            
            .items-section {
                padding: 16px 8px;
                background: white !important;
                margin: 8px;
                border-radius: 8px;
            }
            
            /* Keep table structure but optimize for mobile */
            .items-section {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .items-table {
                min-width: 650px; /* Ensure all columns fit properly */
                font-size: 13px;
                width: 100%;
            }
            
            .items-table th {
                font-size: 12px;
                padding: 12px 8px;
                white-space: nowrap;
            }
            
            .items-table td {
                padding: 12px 8px;
                font-size: 13px;
                border-bottom: 1px solid var(--border);
            }
            
            .items-table td:first-child {
                min-width: 180px; /* Product name column */
            }
            
            .items-table th:nth-child(2),
            .items-table td:nth-child(2) {
                min-width: 60px; /* QTY column */
                text-align: center;
            }
            
            .items-table th:nth-child(3),
            .items-table td:nth-child(3) {
                min-width: 120px; /* Harga Satuan column */
                text-align: right;
            }
            
            .items-table th:nth-child(4),
            .items-table td:nth-child(4) {
                min-width: 120px; /* Total column */
                text-align: right;
            }
            
            .summary {
                padding: 12px;
                background: white !important;
                margin: 0 8px;
                border-radius: 8px;
            }
            
            .summary-grid {
                font-size: 13px;
                gap: 8px 16px !important;
                max-width: 280px !important;
                margin-left: auto !important;
            }
            
            .summary-total {
                font-size: 16px;
                font-weight: 700;
                border-top: 2px solid var(--text) !important;
                padding-top: 8px !important;
            }
            
            .summary-grid {
                gap: 4px 12px;
                font-size: 13px;
            }
            
            .summary-total {
                font-size: 16px;
            }
            
            .payment-method {
                padding: 12px;
                font-size: 13px;
                background: white !important;
                margin: 4px 8px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            /* Mobile scaling adjustments */
            .paper {
                padding: 16px !important;
            }
            
            .payment-method span {
                font-size: 1.3rem;
            }
            
            /* Extra small mobile - Even tighter gap for very small screens */
            .paper-wrapper + .paper-wrapper {
                margin-top: 2px !important;
            }
            
            .payment-section {
                margin-top: 0px !important;
            }
            
            /* Even tighter spacing for very small screens */
            .paper-wrapper + .paper-wrapper {
                margin-top: 0px !important;
            }
        }

        /* Loading animation */
        .loading::after {
            content: '';
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--text);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* Management Actions Styles */
        .management-actions {
            max-width: 800px;
            margin: 20px auto;
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .action-btn.primary {
            background: #2563EB;
            color: white;
        }
        
        .action-btn.primary:hover {
            background: #1D4ED8;
            transform: translateY(-1px);
        }
        
        .action-btn.success {
            background: #48BB78;
            color: white;
        }
        
        .action-btn.success:hover {
            background: #38A169;
            transform: translateY(-1px);
        }
        
        .action-btn.secondary {
            background: #718096;
            color: white;
        }
        
        .action-btn.secondary:hover {
            background: #4A5568;
            transform: translateY(-1px);
        }
        
        @media print {
            .management-actions {
                display: none !important;
            }
            .payment-confirmation-status {
                display: none !important;
            }
            .zoom-indicator, .pan-indicator {
                display: none !important;
            }
            .zoom-controls {
                display: none !important;
            }
            
            /* Keep original layout - no optimization changes */
            .container {
                max-width: 800px !important;
                margin: 0 auto !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            
            .paper {
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                page-break-inside: avoid;
            }
            
            /* Ensure good contrast for printing */
            h1, h2, h3, h4, h5, h6 {
                color: #000 !important;
            }
            
            /* Hide interactive elements */
            .loading, .error {
                display: none !important;
            }
            
            /* Optimize table printing */
            table {
                border-collapse: collapse !important;
                page-break-inside: avoid;
            }
            
            th, td {
                border: 1px solid #000 !important;
                padding: 8px !important;
            }
            
            /* Force page breaks appropriately */
            .page-break {
                page-break-after: always;
            }
            
            /* Preserve white text in footer band */
            .footer-band,
            .footer-band h4,
            .footer-band p,
            .footer-band ul,
            .footer-band li {
                color: white !important;
            }
            
            /* Ensure footer background is preserved for contrast */
            .footer-band {
                background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="main-container">
        <div id="loading" class="loading">Loading invoice...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="invoice-container" style="display: none;">
            <!-- Invoice will be loaded here -->
        </div>
        
        <!-- Mobile Zoom Controls (only visible on mobile) -->
        <div class="mobile-zoom-controls" id="mobile-zoom-controls" style="display: none;">
            <button class="zoom-btn" id="zoom-in-btn" onclick="adjustZoom(0.1)" title="Zoom In">+</button>
            <button class="zoom-btn" id="fit-screen-btn" onclick="fitToScreen()" title="Fit to Screen">⌂</button>
            <button class="zoom-btn" id="zoom-out-btn" onclick="adjustZoom(-0.1)" title="Zoom Out">−</button>
        </div>
        
        <!-- Zoom Indicator -->
        <div class="zoom-indicator" id="zoom-indicator">100%</div>
        
        <!-- Pan Indicator -->
        <div class="pan-indicator" id="pan-indicator">
            📱 Drag to pan around the invoice
        </div>
        
        <!-- Action buttons for management context -->
        <div id="management-actions" class="management-actions" style="display: none;">
            <button id="print-btn" class="action-btn primary" onclick="window.print()">
                🖨️ Print
            </button>
            <button id="whatsapp-btn" class="action-btn secondary" onclick="shareInvoiceWhatsApp()">
                📲 Share via WhatsApp
            </button>
            <button id="close-btn" class="action-btn secondary" onclick="window.close()">
                ❌ Close
            </button>
        </div>
    </div>

    <script>
        let currentInvoice = null;
        let selectedPaymentMethod = 'credit_card';

        // Use the same clean invoice generation as the preview
        function generateUnifiedInvoiceTemplate(invoice, context = 'view') {
            let businessCategory = 'general';
            let businessLogo = '';
            let businessTerms = 'Pembayaran dalam 30 hari';
            let businessProfile = null;
            
            console.log('🔧 generateUnifiedInvoiceTemplate called with context:', context);
            console.log('🔧 Raw invoice data:', invoice);
            
            try {
                // First try to get business profile from enhanced invoice data (provided by API)
                if (invoice.businessProfile) {
                    businessProfile = invoice.businessProfile;
                    businessLogo = businessProfile.logo || invoice.merchant_logo || '';
                    businessCategory = businessProfile.category || 'general';
                    businessTerms = businessProfile.termsAndConditions || businessTerms;
                    console.log('✅ Found business profile in enhanced invoice data:', businessProfile);
                    console.log('✅ Business logo from enhanced data:', businessLogo);
                } else {
                    // Fallback: try to get business profile from invoice metadata (saved invoices)
                    console.log('🔧 Trying to parse metadata_json:', invoice.metadata_json);
                    let metadata;
                    if (typeof invoice.metadata_json === 'string') {
                        metadata = JSON.parse(invoice.metadata_json || '{}');
                    } else if (invoice.metadata_json && typeof invoice.metadata_json === 'object') {
                        metadata = invoice.metadata_json; // Already an object
                    } else {
                        metadata = {}; // Default empty object
                    }
                    console.log('🔧 Parsed metadata:', metadata);
                    
                    businessCategory = metadata.businessCategory || metadata.category || 'general';
                    if (metadata.businessProfile) {
                        businessProfile = metadata.businessProfile;
                        businessLogo = businessProfile.logo || invoice.merchant_logo || '';
                        businessCategory = businessProfile.category || businessCategory;
                        businessTerms = businessProfile.termsAndConditions || businessTerms;
                        console.log('✅ Found business profile in metadata:', businessProfile);
                        console.log('✅ Business logo from metadata:', businessLogo);
                    } else {
                        // Try direct merchant_logo field from enhanced invoice
                        businessLogo = invoice.merchant_logo || '';
                        console.log('🔧 Using direct merchant_logo field:', businessLogo);
                    }
                }
                
                // If no business profile in metadata, try localStorage as fallback (for development/preview)
                if (!businessProfile) {
                    console.log('🔧 Trying localStorage fallback...');
                    try {
                        const savedProfile = localStorage.getItem('businessProfile');
                        if (savedProfile) {
                            businessProfile = JSON.parse(savedProfile);
                            businessLogo = businessProfile.logo || '';
                            businessCategory = businessProfile.category || 'general';
                            businessTerms = businessProfile.termsAndConditions || businessTerms;
                            console.log('✅ Found business profile in localStorage:', businessProfile);
                        } else {
                            console.log('❌ No localStorage business profile available');
                        }
                    } catch(localStorageError) {
                        console.log('❌ Error accessing localStorage:', localStorageError);
                    }
                }
                
                // Use business profile from invoice data as single source of truth
                console.log('🔧 Using business profile from invoice data as single source of truth');
                
                if (businessProfile) {
                    // Update contact information and terms in footer using invoice business profile
                    updateFooterFromBusinessSettings(businessProfile);
                    console.log('✅ Footer updated with business profile from invoice:', businessProfile);
                    
                    // Update logo if available in business profile
                    if (businessProfile.logoUrl || businessProfile.logo) {
                        businessLogo = businessProfile.logoUrl || businessProfile.logo;
                        console.log('✅ Using logo from business profile:', businessLogo);
                        updateLogoInTemplate(businessLogo);
                    }
                } else {
                    console.log('❌ No business profile found in invoice data, using default footer');
                }
            } catch(e) {
                // Fallback to general if no metadata
                console.error('❌ Error parsing invoice metadata:', e);
            }
            
            console.log('🔧 Final values:');
            console.log('  - businessLogo:', businessLogo);
            console.log('  - businessCategory:', businessCategory);
            console.log('  - businessTerms:', businessTerms);
            
            const getCategoryTitle = (category) => {
                const categoryTitles = {
                    'trade': 'FAKTUR PENJUALAN',
                    'services': 'FAKTUR JASA',
                    'manufacturing': 'FAKTUR PRODUKSI',
                    'logistics': 'FAKTUR PENGIRIMAN',
                    'digital_creative': 'FAKTUR LISENSI DIGITAL',
                    'agriculture': 'FAKTUR PERTANIAN',
                    'construction': 'FAKTUR KONSTRUKSI',
                    'tourism': 'FAKTUR PERHOTELAN',
                    'general': 'FAKTUR'
                };
                return categoryTitles[category] || 'FAKTUR';
            };
            
            const invoiceTitle = getCategoryTitle(businessCategory);
            
            const formatCurrency = (amount) => {
                try {
                    // Handle various input types and validate
                    let numAmount = 0;
                    if (amount !== null && amount !== undefined) {
                        if (typeof amount === 'string') {
                            // Remove any existing currency symbols and parse
                            numAmount = parseFloat(amount.replace(/[^\d.-]/g, ''));
                        } else if (typeof amount === 'number') {
                            numAmount = amount;
                        }
                    }
                    
                    // Ensure we have a valid number
                    if (isNaN(numAmount) || !isFinite(numAmount)) {
                        console.log('⚠️ Invalid amount for currency formatting:', amount, 'defaulting to 0');
                        numAmount = 0;
                    }
                    
                    // Format currency
                    const formatted = new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(numAmount).replace('IDR', 'Rp');
                    
                    console.log(`💰 Formatted currency: ${amount} → ${formatted}`);
                    return formatted;
                } catch (error) {
                    console.error('❌ Error formatting currency:', error, 'for amount:', amount);
                    return 'Rp0';
                }
            };

            // Safe HTML escaping function to prevent template string issues
            const escapeHtml = (text) => {
                if (!text || typeof text !== 'string') return text || '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;',
                    '/': '&#x2F;',
                    '`': '&#x60;',
                    '=': '&#x3D;'
                };
                return text.replace(/[&<>"'\/`=]/g, function (s) {
                    return map[s];
                });
            };

            // Premium branding helper function to adjust color brightness
            const adjustBrightness = (hex, percent) => {
                // Remove # if present
                const cleanHex = hex.replace('#', '');
                const num = parseInt(cleanHex, 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            };

            const formatDate = (dateString) => {
                try {
                    // Check if dateString is valid
                    if (!dateString || dateString === '' || dateString === 'null' || dateString === 'undefined') {
                        console.log('🔧 Date string is empty/null, skipping formatting');
                        return '-';
                    }
                    
                    const date = new Date(dateString);
                    
                    // Check if the date is valid
                    if (isNaN(date.getTime())) {
                        console.log('🔧 Invalid date detected:', dateString);
                        return '-';
                    }
                    
                    return date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    console.error('Error formatting date:', e, 'for dateString:', dateString);
                    return '-';
                }
            };

            let items = [];
            console.log('🔧 Processing invoice items...');
            console.log('🔧 Full invoice object:', invoice);
            console.log('🔧 Raw items_json:', invoice.items_json);
            console.log('🔧 Type:', typeof invoice.items_json);
            console.log('🔧 Is Array:', Array.isArray(invoice.items_json));
            
            try {
                // Strategy 1: Direct array items_json
                if (Array.isArray(invoice.items_json)) {
                    items = invoice.items_json;
                    console.log('✅ Items parsed as direct array:', items);
                } 
                // Strategy 2: String JSON items_json
                else if (typeof invoice.items_json === 'string' && invoice.items_json.trim() !== '') {
                    try {
                        items = JSON.parse(invoice.items_json);
                        if (!Array.isArray(items)) {
                            items = [items]; // Convert single object to array
                        }
                        console.log('✅ Items parsed from JSON string:', items);
                    } catch (parseError) {
                        console.log('❌ Failed to parse items_json as JSON:', parseError);
                        items = [];
                    }
                } 
                // Strategy 3: Object items_json (convert to array)
                else if (invoice.items_json && typeof invoice.items_json === 'object') {
                    items = [invoice.items_json];
                    console.log('✅ Items converted from single object:', items);
                } 
                // Strategy 4: Try invoice.items field
                else if (invoice.items && Array.isArray(invoice.items)) {
                    items = invoice.items;
                    console.log('✅ Found items in invoice.items field:', items);
                } 
                // Strategy 5: Try calculations_json
                else if (invoice.calculations_json) {
                    console.log('🔧 Trying calculations_json fallback...');
                    try {
                        let calc = typeof invoice.calculations_json === 'string' 
                            ? JSON.parse(invoice.calculations_json) 
                            : invoice.calculations_json;
                        if (calc && calc.items && Array.isArray(calc.items)) {
                            items = calc.items;
                            console.log('✅ Found items in calculations_json:', items);
                        } else if (calc && calc.invoice && calc.invoice.items) {
                            items = calc.invoice.items;
                            console.log('✅ Found items in calculations_json.invoice.items:', items);
                        }
                    } catch (calcError) {
                        console.log('❌ Error parsing calculations_json:', calcError);
                    }
                } 
                // Strategy 6: Try metadata_json
                else if (invoice.metadata_json) {
                    console.log('🔧 Trying metadata_json fallback...');
                    try {
                        let metadata = typeof invoice.metadata_json === 'string' 
                            ? JSON.parse(invoice.metadata_json) 
                            : invoice.metadata_json;
                        if (metadata && metadata.items && Array.isArray(metadata.items)) {
                            items = metadata.items;
                            console.log('✅ Found items in metadata_json:', items);
                        } else if (metadata && metadata.invoice && metadata.invoice.items) {
                            items = metadata.invoice.items;
                            console.log('✅ Found items in metadata_json.invoice.items:', items);
                        }
                    } catch (metaError) {
                        console.log('❌ Error parsing metadata_json:', metaError);
                    }
                }
                
                // Strategy 7: Create fallback from basic invoice data if still no items
                if (!items || items.length === 0) {
                    console.log('🔧 Creating fallback item from basic invoice data...');
                    const fallbackItem = {
                        productName: 'Invoice Item',
                        quantity: 1,
                        unitPrice: invoice.grand_total || invoice.total || 0,
                        lineTotal: invoice.grand_total || invoice.total || 0,
                        description: 'Generated from invoice total'
                    };
                    items = [fallbackItem];
                    console.log('✅ Created fallback item:', items);
                }
                
                // Validate and fix items structure
                if (Array.isArray(items)) {
                    items = items.map((item, index) => {
                        console.log(`🔧 Processing item ${index}:`, item);
                        
                        // Enhanced field mapping with more fallback names and validation
                        let productName = item.productName || item.product_name || item.name || item.productname || 
                                         item.itemName || item.item_name || item.title || `Item ${index + 1}`;
                        
                        let quantity = parseInt(item.quantity || item.qty || item.amount || item.count || 1);
                        if (isNaN(quantity) || quantity <= 0) {
                            quantity = 1;
                            console.log(`⚠️ Invalid quantity for item ${index}, defaulting to 1`);
                        }
                        
                        let unitPrice = parseFloat(item.unitPrice || item.unit_price || item.price || item.unitprice || 
                                                  item.pricePerUnit || item.rate || item.cost || 0);
                        if (isNaN(unitPrice) || unitPrice < 0) {
                            unitPrice = 0;
                            console.log(`⚠️ Invalid unit price for item ${index}, defaulting to 0`);
                        }
                        
                        let lineTotal = parseFloat(item.lineTotal || item.line_total || item.total || item.linetotal || 
                                                  item.itemTotal || item.subTotal || 0);
                        if (isNaN(lineTotal) || lineTotal < 0) {
                            lineTotal = 0;
                            console.log(`⚠️ Invalid line total for item ${index}, will calculate`);
                        }
                        
                        // Calculate line total if missing or invalid
                        if (!lineTotal || lineTotal === 0) {
                            lineTotal = quantity * unitPrice;
                            console.log(`📊 Calculated line total for item ${index}: ${quantity} × ${unitPrice} = ${lineTotal}`);
                        }
                        
                        const processedItem = {
                            productName: String(productName).trim(),
                            quantity: quantity,
                            unitPrice: unitPrice,
                            lineTotal: lineTotal,
                            description: String(item.description || item.desc || item.note || '').trim()
                        };
                        
                        // Validation check
                        if (!processedItem.productName || processedItem.productName === '') {
                            processedItem.productName = `Item ${index + 1}`;
                            console.log(`⚠️ Empty product name for item ${index}, using fallback`);
                        }
                        
                        console.log(`✅ Processed item ${index}:`, processedItem);
                        return processedItem;
                    });
                    
                    console.log('✅ Final processed items:', items);
                }
                
            } catch (e) {
                console.error('❌ Error parsing items:', e);
                console.log('🔧 Creating fallback items...');
                
                // Create a fallback item to help with debugging
                items = [{
                    productName: 'Debug: Items parsing failed',
                    quantity: 1,
                    unitPrice: 0,
                    lineTotal: 0,
                    description: 'Error: ' + (e.message || 'Unknown parsing error')
                }];
            }
            
            console.log('🎯 Final items count:', items.length);
            items.forEach((item, i) => console.log(`🎯 Item ${i}:`, item.productName, 'x', item.quantity, '@', item.unitPrice));
            
            const cleanHTML = `
                <div class="paper-wrapper">
                    <div class="paper">
                    <!-- Header band -->
                    ${businessProfile && businessProfile.premiumActive && businessProfile.hideAspreeBranding ? '' : `
                    <div style="background: ${businessProfile?.premiumActive && businessProfile.customHeaderBgColor ? 
                        `linear-gradient(135deg, ${businessProfile.customHeaderBgColor}, ${adjustBrightness(businessProfile.customHeaderBgColor, 20)})` : 
                        'linear-gradient(135deg, #311d6b, #4a2b7a)'}; color: white; padding: 12px 0; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            ${businessProfile?.premiumActive && businessProfile.customHeaderLogoUrl ? 
                                `<img src="${businessProfile.customHeaderLogoUrl}" alt="Header Logo" style="height: 32px; width: auto;">` :
                                `<img src="/assets/aspree-header-logo.png" alt="Aspree Logo" style="height: 32px; width: auto;">`
                            }
                            <p style="font-size: 14px; font-weight: 600; margin: 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${businessProfile?.premiumActive && businessProfile.customHeaderText ? 
                                    businessProfile.customHeaderText : 
                                    'Powered by Aspree Invoice Generator'
                                }
                            </p>
                        </div>
                    </div>
                    `}
                    
                    <div class="inv-header">
                        <div class="logo-section">
                            ${businessLogo ? 
                                `<img src="${businessLogo}" alt="Logo">` : 
                                `<div style="background: #f0f0f0; padding: 15px; border-radius: 4px; margin-bottom: 12px; font-size: 18px; color: #666; text-align: center; border: 1px solid #e0e0e0;">LOGO</div>`
                            }
                            ${businessProfile && businessProfile.hideBusinessName ? '' : `<strong>${invoice.merchant_name || '-'}</strong>`}
                        </div>
                        <div class="invoice-meta">
                            <h1 class="invoice-title">${invoiceTitle}</h1>
                            <div class="invoice-details">
                                <strong>No:</strong> ${invoice.invoice_number || 'INV-UNKNOWN'}
                            </div>
                            <div class="invoice-details">
                                <strong>Tanggal:</strong> ${formatDate(invoice.invoice_date || invoice.created_at || new Date().toISOString())}
                            </div>
                            <div class="invoice-details">
                                <strong>Jatuh Tempo:</strong> ${formatDate(invoice.due_date || invoice.invoice_date || new Date().toISOString())}
                            </div>
                        </div>
                    </div>
                    
                    <div class="parties">
                        <div class="party-section">
                            <h3>DARI</h3>
                            <address>
                                <strong>${invoice.merchant_name || 'Business Name'}</strong><br>
                                ${invoice.merchant_address ? invoice.merchant_address + '<br>' : ''}
                                ${invoice.merchant_phone ? invoice.merchant_phone + '<br>' : ''}
                                ${invoice.merchant_email || ''}
                            </address>
                        </div>
                        <div class="party-section">
                            <h3>KEPADA</h3>
                            <address>
                                <strong>${invoice.customer_name || 'Customer Name'}</strong><br>
                                ${invoice.customer_address ? invoice.customer_address + '<br>' : ''}
                                ${invoice.customer_phone ? invoice.customer_phone + '<br>' : ''}
                                ${invoice.customer_email || ''}
                            </address>
                        </div>
                    </div>
                    
                    <div class="items-section">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Produk/Layanan</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-right">Harga Satuan</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.length === 0 ? 
                                    '<tr><td colspan="4" style="text-align: center; color: #666;">No items found</td></tr>' :
                                    items.map(item => `
                                        <tr>
                                            <td data-label="Produk/Layanan">
                                                <div class="product-name">${item.productName || 'Product'}</div>
                                                ${item.description && item.description.trim() ? `<div class="product-description">${item.description}</div>` : ''}
                                            </td>
                                            <td class="text-center" data-label="QTY">${item.quantity || 1}</td>
                                            <td class="text-right" data-label="Harga Satuan">${formatCurrency(item.unitPrice || 0)}</td>
                                            <td class="text-right" data-label="Total">${formatCurrency(item.lineTotal || 0)}</td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Compact Notes Section -->
                    ${(() => {
                        try {
                            console.log('🔧 Processing notes - raw notes_json:', invoice.notes_json);
                            let notes = null;
                            if (invoice.notes_json) {
                                if (typeof invoice.notes_json === 'string') {
                                    try {
                                        notes = JSON.parse(invoice.notes_json);
                                    } catch (e) {
                                        console.log('❌ Failed to parse notes_json as string:', e);
                                        notes = null;
                                    }
                                } else if (typeof invoice.notes_json === 'object') {
                                    notes = invoice.notes_json; // Already an object
                                }
                            }
                            console.log('🔧 Parsed notes:', notes);
                            
                            // Collect all notes into an array
                            const allNotes = [];
                            
                            // List of placeholder/demo texts to filter out
                            const placeholderTexts = [
                                'Pembayaran dapat dilakukan melalui transfer bank atau tunai',
                                'tambahkan catatan tambahan disini, jika tidak ada catatan maka kolom catatan akan dihilangkan',
                                'Klik untuk menambahkan catatan...',
                                'Extract special requests from message',
                                'Extract delivery schedule if mentioned',
                                'Extract appointment info if service booking',
                                'Extract payment deadline if mentioned'
                            ];
                            
                            const isPlaceholderText = (text) => {
                                if (!text || !text.trim()) return true;
                                const trimmedText = text.trim();
                                return placeholderTexts.some(placeholder => trimmedText.includes(placeholder));
                            };
                            
                            // Only process main user-editable notes (removed AI extraction fields)
                            if (notes) {
                                if (notes.publicNotes && notes.publicNotes.trim() && !isPlaceholderText(notes.publicNotes)) {
                                    allNotes.push(notes.publicNotes.trim());
                                    console.log('✅ Added publicNotes:', notes.publicNotes.trim());
                                }
                                if (notes.customNotes && notes.customNotes.trim() && !isPlaceholderText(notes.customNotes)) {
                                    allNotes.push(notes.customNotes.trim());
                                    console.log('✅ Added customNotes:', notes.customNotes.trim());
                                }
                            }
                            
                            console.log('🔧 All notes collected:', allNotes);
                            
                            // Only show notes if they exist
                            if (allNotes.length === 0) {
                                console.log('❌ No notes found, hiding section');
                                return '';
                            }
                            
                            // Combine notes intelligently, max 2 rows
                            const combinedNotes = allNotes.length <= 2 ? 
                                allNotes : 
                                [allNotes.slice(0, 2).join(' | ')];
                            
                            console.log('✅ Final combined notes:', combinedNotes);
                            
                            return `
                                <div style="padding: 12px 32px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); background: rgba(247, 250, 252, 0.3);">
                                    ${combinedNotes.map(note => 
                                        `<p style="margin: 0; font-size: 14px; color: var(--text-light); line-height: 1.4;"><strong style="color: var(--text);">Catatan:</strong> ${note}</p>`
                                    ).join('')}
                                </div>
                            `;
                        } catch (e) {
                            console.error('❌ Error parsing compact notes:', e);
                            return '';
                        }
                    })()}
                    
                    ${(() => {
                        // Calculate totals with proper fallbacks and validation
                        console.log('💰 Calculating invoice totals...');
                        console.log('💰 Raw invoice totals:', {
                            subtotal: invoice.subtotal,
                            discount: invoice.discount,
                            tax_amount: invoice.tax_amount,
                            shipping_cost: invoice.shipping_cost,
                            grand_total: invoice.grand_total
                        });
                        
                        // Calculate subtotal from items if not provided
                        let calculatedSubtotal = parseFloat(invoice.subtotal || 0);
                        if (!calculatedSubtotal || calculatedSubtotal === 0) {
                            calculatedSubtotal = items.reduce((sum, item) => sum + (parseFloat(item.lineTotal) || 0), 0);
                            console.log('📊 Calculated subtotal from items:', calculatedSubtotal);
                        }
                        
                        const discount = parseFloat(invoice.discount || 0);
                        const taxAmount = parseFloat(invoice.tax_amount || 0);
                        const shippingCost = parseFloat(invoice.shipping_cost || 0);
                        
                        // Calculate grand total if not provided
                        let grandTotal = parseFloat(invoice.grand_total || 0);
                        if (!grandTotal || grandTotal === 0) {
                            grandTotal = calculatedSubtotal - discount + taxAmount + shippingCost;
                            console.log('📊 Calculated grand total:', grandTotal);
                        }
                        
                        const totals = {
                            subtotal: calculatedSubtotal,
                            discount: discount,
                            taxAmount: taxAmount,
                            shippingCost: shippingCost,
                            grandTotal: grandTotal
                        };
                        
                        console.log('✅ Final calculated totals:', totals);
                        
                        return `
                    <div class="summary">
                        <div class="summary-grid">
                            <div class="summary-label">Subtotal</div>
                            <div class="summary-value">${formatCurrency(totals.subtotal)}</div>
                            
                            ${totals.discount > 0 ? `
                            <div class="summary-label">${(() => {
                                const discountType = invoice.calculations?.discountType;
                                const discountValue = invoice.calculations?.discountValue;
                                if (discountType === 'percentage') {
                                    return `Diskon (${discountValue}%)`;
                                } else {
                                    return 'Diskon (Jumlah Tetap)';
                                }
                            })()}</div>
                            <div class="summary-value">-${formatCurrency(totals.discount)}</div>
                            ` : ''}
                            
                            ${totals.taxAmount > 0 ? `
                            <div class="summary-label">Pajak</div>
                            <div class="summary-value">${formatCurrency(totals.taxAmount)}</div>
                            ` : ''}
                            
                            ${totals.shippingCost > 0 ? `
                            <div class="summary-label">Biaya Kirim</div>
                            <div class="summary-value">${formatCurrency(totals.shippingCost)}</div>
                            ` : ''}
                            
                            <div class="summary-label total-label">TOTAL</div>
                            <div class="summary-value total-value">${formatCurrency(totals.grandTotal)}</div>
                        </div>
                    </div>`;
                    })()}

                    <!-- Payment Schedule section -->
                    ${(() => {
                        console.log('🔧🔧🔧 ============PAYMENT SCHEDULE PROCESSING============ 🔧🔧🔧');
                        console.log('🔧 Universal payment schedule processing started');
                        console.log('🔧 Raw payment_schedule_json:', invoice.payment_schedule_json);
                        console.log('🔧 Type of payment_schedule_json:', typeof invoice.payment_schedule_json);
                        console.log('🔧 Discount amount:', invoice.discount_amount);
                        console.log('🔧 Discount amount type:', typeof invoice.discount_amount);
                        console.log('🔧 Discount amount parsed:', parseFloat(invoice.discount_amount));
                        console.log('🔧 Discount amount > 0?', parseFloat(invoice.discount_amount) > 0);
                        console.log('🔧 Boolean discount_amount:', !!invoice.discount_amount);
                        
                        // STEP 1: Try to parse payment_schedule_json first (preferred method)
                        if (invoice.payment_schedule_json) {
                            try {
                                let paymentSchedule = null;
                                if (typeof invoice.payment_schedule_json === 'string') {
                                    console.log('🔧 Attempting to parse string payment schedule...');
                                    try {
                                        paymentSchedule = JSON.parse(invoice.payment_schedule_json);
                                        console.log('✅ Successfully parsed payment schedule from string:', paymentSchedule);
                                    } catch (e) {
                                        console.log('❌ Failed to parse payment_schedule_json as string:', e);
                                        console.log('❌ Raw string was:', invoice.payment_schedule_json);
                                        // Continue to fallback logic below
                                    }
                                } else if (typeof invoice.payment_schedule_json === 'object') {
                                    paymentSchedule = invoice.payment_schedule_json; // Already an object
                                    console.log('✅ Using object payment schedule:', paymentSchedule);
                                }
                                
                                if (paymentSchedule && paymentSchedule.scheduleType === 'down_payment') {
                                    console.log('✅ Payment schedule section will be rendered from payment_schedule_json!');
                                    return `
                                    <div class="payment-schedule-section" style="padding: 20px 32px; border-top: 1px solid var(--border); background: var(--bg);">
                                        <h3 style="color: var(--text); font-size: 16px; font-weight: 600; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Jadwal Pembayaran
                                        </h3>
                                        <div class="payment-schedule-table" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                                            <div style="background: var(--bg-light); padding: 18px 20px; border-bottom: 2px solid var(--border); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; font-weight: 700; font-size: 13px; color: var(--text); text-transform: uppercase; letter-spacing: 0.8px;">
                                                <div>Jenis Pembayaran</div>
                                                <div style="text-align: center;">Jatuh Tempo</div>
                                                <div style="text-align: right;">Jumlah</div>
                                            </div>
                                            ${(() => {
                                                // Show complete payment schedule with both phases
                                                const finalAmount = invoice.final_payment_amount || paymentSchedule.remainingBalance.amount;
                                                const currentStage = invoice.payment_stage || 'down_payment';
                                                
                                                // Determine status indicators
                                                const getStatusIndicator = (phase) => {
                                                    if (currentStage === 'completed' || (currentStage === 'final_payment' && phase === 'down_payment')) {
                                                        return '✅'; // Completed
                                                    } else if (currentStage === phase) {
                                                        return '⏳'; // Current/Pending
                                                    } else {
                                                        return '🔒'; // Future/Locked
                                                    }
                                                };
                                                
                                                const getPhaseStyle = (phase) => {
                                                    const baseStyle = "padding: 20px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; align-items: center;";
                                                    
                                                    if (currentStage === phase) {
                                                        return baseStyle + " background: rgba(139, 95, 255, 0.05); border-left: 4px solid #8B5FFF;";
                                                    } else if (currentStage === 'completed' || (currentStage === 'final_payment' && phase === 'down_payment')) {
                                                        return baseStyle + " opacity: 0.7; background: rgba(72, 187, 120, 0.05);";
                                                    } else {
                                                        return baseStyle + " opacity: 0.6;";
                                                    }
                                                };
                                                
                                                return `
                                                    <!-- Down Payment Row -->
                                                    <div style="${getPhaseStyle('down_payment')}">
                                                        <div style="font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                                            <span style="font-size: 16px;">${getStatusIndicator('down_payment')}</span>
                                                            ${(() => {
                                                                const dp = paymentSchedule.downPayment;
                                                                if (dp.type === 'fixed') {
                                                                    return 'Uang Muka (Jumlah Tetap)';
                                                                } else {
                                                                    return `Uang Muka (${dp.percentage}%)`;
                                                                }
                                                            })()}
                                                        </div>
                                                        <div style="text-align: center; color: var(--text-light); font-size: 15px;">${formatDate(paymentSchedule.downPayment.dueDate)}</div>
                                                        <div style="text-align: right; font-weight: 600; font-size: 16px; color: var(--text);">${formatCurrency(paymentSchedule.downPayment.amount)}</div>
                                                    </div>
                                                    <!-- Remaining Payment Row -->
                                                    <div style="${getPhaseStyle('final_payment')}">
                                                        <div style="font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                                            <span style="font-size: 16px;">${getStatusIndicator('final_payment')}</span>
                                                            Sisa Pembayaran
                                                        </div>
                                                        <div style="text-align: center; color: var(--text-light); font-size: 15px;">${formatDate(paymentSchedule.remainingBalance.dueDate)}</div>
                                                        <div style="text-align: right; font-weight: 600; font-size: 16px; color: var(--text);">${formatCurrency(finalAmount)}</div>
                                                    </div>
                                                `;
                                            })()}
                                        </div>
                                    </div>
                                    `;
                                }
                            } catch (e) {
                                console.error('❌ Error parsing payment schedule:', e);
                            }
                        }
                        
                        // STEP 2: Only show payment schedule for ACTUAL payment schedules
                        // DO NOT show payment schedule for regular discounts
                        // Only show if there's explicit payment schedule data (not discount_amount)
                        console.log('✅ No payment schedule detected - discount_amount should not trigger payment schedule');
                        console.log('   Discount should only appear in invoice summary, not as payment schedule');
                        
                        // No payment schedule found
                        console.log('✅ No payment schedule detected - showing standard invoice');
                        return '';
                    })()}

                    <!-- Footer band with terms and contact -->
                    <div class="footer-band" style="background: ${businessProfile?.premiumActive && businessProfile.customFooterBgColor ? 
                        `linear-gradient(135deg, ${businessProfile.customFooterBgColor}, ${adjustBrightness(businessProfile.customFooterBgColor, 20)})` : 
                        'linear-gradient(135deg, #311d6b, #4a2b7a)'}; color: white; padding: 20px; margin-bottom: 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 32px; align-items: start; margin-bottom: 24px;">
                            <div class="footer-section">
                                <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Syarat & Ketentuan</h4>
                                <p style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.8;">${businessTerms}</p>
                            </div>
                            <div class="footer-section">
                                <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Kontak</h4>
                                <ul style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.8; list-style: none; padding: 0;">
                                    <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                        <span style="opacity: 0.7;">📞</span>
                                        ${businessProfile ? (businessProfile.phone || invoice.merchant_phone) : invoice.merchant_phone || '-'}
                                    </li>
                                    <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                        <span style="opacity: 0.7;">📧</span>
                                        ${businessProfile ? (businessProfile.email || invoice.merchant_email) : invoice.merchant_email || '-'}
                                    </li>
                                    ${businessProfile && businessProfile.website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;">🌐</span>${escapeHtml(businessProfile.website)}</li>` : invoice.merchant_website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;">🌐</span>${escapeHtml(invoice.merchant_website)}</li>` : ''}
                                </ul>
                            </div>
                            ${businessProfile && businessProfile.premiumActive && businessProfile.hideAspreeBranding ? '' : `
                            <div class="footer-section" style="display: flex; align-items: flex-end; justify-content: flex-end; padding: 20px 0 0 0; margin: 0;">
                                ${businessProfile?.premiumActive && businessProfile.customFooterLogoUrl ? 
                                    `<img src="${businessProfile.customFooterLogoUrl}" alt="Footer Logo" style="height: 120px; width: auto; opacity: 0.9;">` :
                                    `<img src="/assets/aspri-logo.png" alt="aspree.id" style="height: 120px; width: auto; opacity: 0.9;">`
                                }
                            </div>
                            `}
                        </div>
                    </div>
                    </div>
                </div>
            `;
            
            return cleanHTML;
        }

        // Update logo in the template after async loading
        function updateLogoInTemplate(logoUrl) {
            try {
                // Find the logo img element and update it
                const logoElements = document.querySelectorAll('.logo-section img');
                logoElements.forEach(logoElement => {
                    logoElement.src = logoUrl;
                    logoElement.style.display = 'block';
                });

                // Also update any LOGO placeholder divs
                const placeholders = document.querySelectorAll('.logo-section div');
                placeholders.forEach(placeholder => {
                    if (placeholder.textContent === 'LOGO') {
                        placeholder.innerHTML = `<img src="${logoUrl}" alt="Logo" style="max-height: 120px; max-width: 300px; object-fit: contain; border-radius: 4px; margin-bottom: 6px;">`;
                    }
                });

                console.log('✅ Logo updated in template:', logoUrl);
            } catch (error) {
                console.error('❌ Error updating logo in template:', error);
            }
        }

        function updateFooterFromBusinessSettings(businessSettings) {
            try {
                console.log('🔄 Updating footer with business settings:', businessSettings);
                
                // Update terms and conditions
                const termsSection = document.querySelector('.footer-section p');
                if (termsSection && businessSettings.termsAndConditions) {
                    termsSection.textContent = businessSettings.termsAndConditions;
                    console.log('✅ Terms updated:', businessSettings.termsAndConditions);
                }
                
                // Update contact information
                const contactList = document.querySelector('.footer-section ul');
                if (contactList && businessSettings) {
                    const phone = businessSettings.phone || '-';
                    const email = businessSettings.email || '-';
                    const website = businessSettings.website || '';
                    
                    contactList.innerHTML = `
                        <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                            <span style="opacity: 0.7;">📞</span>
                            ${phone}
                        </li>
                        <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                            <span style="opacity: 0.7;">📧</span>
                            ${email}
                        </li>
                        ${website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;">🌐</span>${website}</li>` : ''}
                    `;
                    console.log('✅ Contact information updated:', { phone, email, website });
                }
                
                console.log('✅ Footer successfully updated with business settings');
            } catch (error) {
                console.error('❌ Error updating footer from business settings:', error);
            }
        }

        // Generate payment schedule breakdown for online payment section
        function generatePaymentScheduleBreakdown(invoice, paymentInfo, formatCurrency) {
            try {
                let paymentSchedule = null;
                
                // Parse payment schedule data
                if (invoice.payment_schedule_json) {
                    if (typeof invoice.payment_schedule_json === 'string') {
                        paymentSchedule = JSON.parse(invoice.payment_schedule_json);
                    } else if (typeof invoice.payment_schedule_json === 'object') {
                        paymentSchedule = invoice.payment_schedule_json;
                    }
                }
                
                // If we have payment schedule data, show detailed breakdown
                if (paymentSchedule && paymentSchedule.scheduleType === 'down_payment') {
                    console.log('💰 Showing payment schedule breakdown in online payment section');
                    return `
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; overflow: hidden;">
                            <div style="background: #f8fafc; padding: 16px; border-bottom: 1px solid #e2e8f0;">
                                <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #2d3748;">💳 Jadwal Pembayaran</h4>
                            </div>
                            <div style="padding: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div style="padding: 16px; background: ${paymentInfo.stage === 'down_payment' ? 'rgba(49, 29, 107, 0.1)' : '#f8fafc'}; border-radius: 8px; ${paymentInfo.stage === 'down_payment' ? 'border: 2px solid #311d6b;' : 'border: 1px solid #e2e8f0;'}">
                                        <div style="font-size: 12px; color: #718096; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">${(() => {
                                            const dp = paymentSchedule.downPayment;
                                            if (dp.type === 'fixed') {
                                                return 'Uang Muka (Jumlah Tetap)';
                                            } else {
                                                return `Uang Muka (${dp.percentage}%)`;
                                            }
                                        })()}</div>
                                        <div style="font-size: 18px; font-weight: 700; color: ${paymentInfo.stage === 'down_payment' ? '#311d6b' : '#2d3748'};">${formatCurrency(paymentSchedule.downPayment.amount)}</div>
                                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">${paymentInfo.stage === 'down_payment' ? '← Sedang dibayar' : 'Selesai'}</div>
                                    </div>
                                    <div style="padding: 16px; background: ${paymentInfo.stage === 'final_payment' ? 'rgba(49, 29, 107, 0.1)' : '#f8fafc'}; border-radius: 8px; ${paymentInfo.stage === 'final_payment' ? 'border: 2px solid #311d6b;' : 'border: 1px solid #e2e8f0;'}">
                                        <div style="font-size: 12px; color: #718096; font-weight: 600; text-transform: uppercase; margin-bottom: 8px;">Sisa Pembayaran</div>
                                        <div style="font-size: 18px; font-weight: 700; color: ${paymentInfo.stage === 'final_payment' ? '#311d6b' : '#2d3748'};">${formatCurrency(invoice.final_payment_amount || paymentSchedule.remainingBalance.amount)}</div>
                                        <div style="font-size: 12px; color: #718096; margin-top: 4px;">${paymentInfo.stage === 'final_payment' ? '← Sedang dibayar' : (paymentInfo.stage === 'down_payment' ? 'Menunggu' : 'Selesai')}</div>
                                    </div>
                                </div>
                                <div style="padding: 12px; background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 6px;">
                                    <div style="font-size: 13px; color: #2f855a; font-weight: 500;">
                                        ${paymentInfo.stage === 'down_payment' 
                                            ? `✨ Anda sedang membayar uang muka sebesar ${formatCurrency(paymentSchedule.downPayment.amount)}` 
                                            : `✨ Sisa pembayaran sebesar ${formatCurrency(invoice.final_payment_amount || paymentSchedule.remainingBalance.amount)}`
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // No fallback for discount_amount - only show payment schedule for actual schedules
                console.log('✅ No payment schedule breakdown needed for regular discount invoices');
                
                return '';
            } catch (e) {
                console.error('Error generating payment schedule breakdown:', e);
                return '';
            }
        }

        // Load payment methods configuration
        let paymentMethods = null;
        
        async function loadPaymentMethods() {
            try {
                // Try to load from localStorage first (business profile settings)
                const businessProfile = localStorage.getItem('businessProfile');
                if (businessProfile) {
                    const profile = JSON.parse(businessProfile);
                    if (profile.paymentMethods) {
                        paymentMethods = profile.paymentMethods;
                        console.log('💳 Payment methods loaded from business profile:', paymentMethods);
                        return;
                    }
                }
                
                // Fallback to API call
                const response = await fetch('/api/payment-methods');
                const apiResponse = await response.json();
                
                // Handle the API response structure properly
                if (apiResponse.success && apiResponse.paymentMethods) {
                    paymentMethods = apiResponse.paymentMethods;
                } else {
                    paymentMethods = apiResponse;
                }
                console.log('💳 Payment methods loaded from API:', paymentMethods);
            } catch (error) {
                console.error('Error loading payment methods:', error);
                paymentMethods = { bankTransfer: { enabled: false } }; // Fallback
            }
        }
        
        // Generate payment methods based on configuration
        function generatePaymentMethodsHTML() {
            if (!paymentMethods) {
                return `
                    <div class="payment-method active" data-method="credit_card">
                        <span>💳</span> Credit Card
                    </div>
                    <div class="payment-method" data-method="bank_transfer">
                        <span>🏦</span> Bank Transfer
                    </div>
                    <div class="payment-method" data-method="e_wallet">
                        <span>📱</span> E-Wallet
                    </div>
                    <div class="payment-method" data-method="convenience_store">
                        <span>🏪</span> Convenience Store
                    </div>
                `;
            }

            let methodsHTML = '';
            let firstMethod = '';
            
            // Check for Xendit payment gateway (prioritize as it's online payment)
            const xenditEnabled = paymentMethods.xendit?.enabled;
            if (xenditEnabled) {
                const xenditMethods = paymentMethods.xendit?.paymentMethods || {};
                let xenditMethodsText = [];
                
                if (xenditMethods.bankTransfer) xenditMethodsText.push('Bank Transfer');
                if (xenditMethods.ewallet) xenditMethodsText.push('E-Wallet');
                if (xenditMethods.creditCard) xenditMethodsText.push('Kartu Kredit');
                if (xenditMethods.retailOutlet) xenditMethodsText.push('Retail');
                
                const methodText = xenditMethodsText.length > 0 ? xenditMethodsText.join(', ') : 'Pembayaran Online';
                
                methodsHTML += `
                    <div class="payment-method ${firstMethod === '' ? 'active' : ''}" data-method="xendit">
                        <span>💳</span> ${methodText} (Xendit)
                    </div>
                `;
                if (firstMethod === '') {
                    firstMethod = 'xendit';
                    selectedPaymentMethod = 'xendit'; // Set default
                }
            }
            
            // Check for bank transfer (supports both localStorage and API structure)
            const bankTransferEnabled = paymentMethods.bankTransfer?.enabled || paymentMethods.bank_transfer?.enabled;
            if (bankTransferEnabled) {
                const bankName = paymentMethods.bankTransfer?.bankName || paymentMethods.bank_transfer?.bank_name || 'Bank Transfer';
                methodsHTML += `
                    <div class="payment-method ${firstMethod === '' ? 'active' : ''}" data-method="bank_transfer">
                        <span>🏦</span> ${bankName}
                    </div>
                `;
                if (firstMethod === '') {
                    firstMethod = 'bank_transfer';
                    selectedPaymentMethod = 'bank_transfer'; // Set default
                }
            }
            
            // Check for QRIS
            if (paymentMethods.qris?.enabled) {
                methodsHTML += `
                    <div class="payment-method ${firstMethod === '' ? 'active' : ''}" data-method="qris">
                        <span>📱</span> QRIS
                    </div>
                `;
                if (firstMethod === '') {
                    firstMethod = 'qris';
                    selectedPaymentMethod = 'qris';
                }
            }
            
            // Check for E-Wallet
            if (paymentMethods.ewallet?.enabled) {
                const ewalletTypes = paymentMethods.ewallet?.types || 'E-Wallet';
                methodsHTML += `
                    <div class="payment-method ${firstMethod === '' ? 'active' : ''}" data-method="ewallet">
                        <span>📱</span> ${ewalletTypes}
                    </div>
                `;
                if (firstMethod === '') {
                    firstMethod = 'ewallet';
                    selectedPaymentMethod = 'ewallet';
                }
            }
            
            // Check for Cash
            if (paymentMethods.cash?.enabled) {
                methodsHTML += `
                    <div class="payment-method ${firstMethod === '' ? 'active' : ''}" data-method="cash">
                        <span>💵</span> Cash
                    </div>
                `;
                if (firstMethod === '') {
                    firstMethod = 'cash';
                    selectedPaymentMethod = 'cash';
                }
            }
            
            // If no methods are configured, show a message
            if (methodsHTML === '') {
                methodsHTML = `
                    <div style="text-align: center; padding: 20px; color: #666; border: 2px dashed #ddd; border-radius: 8px;">
                        <p><strong>No payment methods configured</strong></p>
                        <p>Please configure payment methods in business settings</p>
                    </div>
                `;
            }
            
            return methodsHTML;
        }

        // Generate bank transfer details
        function generateBankTransferDetails() {
            if (!paymentMethods?.bankTransfer?.enabled && !paymentMethods?.bank_transfer?.enabled) return '';
            
            const bankInfo = paymentMethods.bankTransfer || paymentMethods.bank_transfer;
            // Show by default if it's the only payment method enabled
            const displayStyle = selectedPaymentMethod === 'bank_transfer' ? 'block' : 'none';
            return `
                <div id="bank-transfer-details" class="payment-details" style="display: ${displayStyle}; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-top: 15px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>🏦</span> Bank Transfer Details
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; color: #4a5568; font-size: 13px; margin-bottom: 4px;">BANK NAME</label>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-weight: 600;">${bankInfo.bankName || bankInfo.bank_name || '-'}</div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: #4a5568; font-size: 13px; margin-bottom: 4px;">ACCOUNT NUMBER</label>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-family: monospace; font-weight: 600; font-size: 16px;">${bankInfo.accountNumber || bankInfo.account_number || '-'}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr ${bankInfo.bankBranch ? '1fr' : ''}; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; font-weight: 600; color: #4a5568; font-size: 13px; margin-bottom: 4px;">ACCOUNT HOLDER</label>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0; font-weight: 600;">${bankInfo.accountHolderName || bankInfo.account_holder_name || bankInfo.accountName || '-'}</div>
                        </div>
                        ${(bankInfo.bankBranch || bankInfo.bank_branch) ? `
                        <div>
                            <label style="display: block; font-weight: 600; color: #4a5568; font-size: 13px; margin-bottom: 4px;">BRANCH</label>
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e2e8f0;">${bankInfo.bankBranch || bankInfo.bank_branch}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${bankInfo.instructions ? `
                    <div style="background: rgba(66, 153, 225, 0.1); border: 1px solid rgba(66, 153, 225, 0.2); border-radius: 6px; padding: 15px;">
                        <h5 style="margin: 0 0 8px 0; color: #2b6cb0; font-size: 14px;">📋 Transfer Instructions</h5>
                        <p style="margin: 0; color: #2d3748; font-size: 14px; line-height: 1.4;">${bankInfo.instructions}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Generate Xendit payment details
        function generateXenditDetails() {
            if (!paymentMethods?.xendit?.enabled) return '';
            
            const displayStyle = selectedPaymentMethod === 'xendit' ? 'block' : 'none';
            const xenditMethods = paymentMethods.xendit?.paymentMethods || {};
            
            return `
                <div id="xendit-details" class="payment-details" style="display: ${displayStyle}; background: #f8f9fa; border: 1px solid #4299E1; border-radius: 8px; padding: 20px; margin-top: 15px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>💳</span> Pembayaran Online (Xendit)
                    </h4>
                    
                    <div style="background: #e6f3ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <p style="color: #1a365d; font-size: 14px; margin: 0; line-height: 1.5;">
                            <strong>🚀 Bayar secara langsung dengan metode berikut:</strong>
                        </p>
                        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                            ${xenditMethods.bankTransfer ? '<span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">🏦 Bank Transfer</span>' : ''}
                            ${xenditMethods.ewallet ? '<span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">📱 E-Wallet</span>' : ''}
                            ${xenditMethods.creditCard ? '<span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">💳 Kartu Kredit</span>' : ''}
                            ${xenditMethods.retailOutlet ? '<span style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">🏪 Retail</span>' : ''}
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button id="xendit-pay-btn" onclick="processXenditPayment()" style="
                            background: linear-gradient(135deg, #4299E1 0%, #3182CE 100%);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 8px;
                            font-weight: 600;
                            font-size: 16px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
                        ">
                            💳 Bayar Sekarang dengan Xendit
                        </button>
                        
                        <div style="text-align: center; color: #666; font-size: 12px;">
                            Anda akan diarahkan ke halaman pembayaran Xendit yang aman
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate separate payment section
        function generatePaymentSection(invoice) {
            if (invoice.status === 'paid') {
                return `
                    <div class="paper-wrapper" style="margin-top: 20px;">
                        <div class="paper">
                            <div class="paid-notice">
                                ✅ Invoice ini telah dibayar lunas. Terima kasih!
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Check if payment confirmation is pending approval
            if (invoice.payment_status === 'confirmation_pending') {
                return `
                    <div class="paper-wrapper" style="margin-top: 20px;">
                        <div class="paper payment-confirmation-status">
                        <div style="background: rgba(66, 153, 225, 0.1); border: 2px solid #4299e1; border-radius: 8px; padding: 20px; text-align: center;">
                            <h3 style="color: #2b6cb0; margin-bottom: 15px;">⏳ Menunggu Konfirmasi Pembayaran</h3>
                            <p style="color: #4a5568; margin-bottom: 15px;">
                                Bukti pembayaran Anda telah diterima dan sedang dalam proses review oleh merchant.
                                Anda akan mendapat notifikasi setelah pembayaran dikonfirmasi.
                            </p>
                            ${invoice.payment_confirmation_date ? `
                                <div style="background: white; border-radius: 6px; padding: 12px; margin-top: 15px;">
                                    <small style="color: #666;">
                                        Upload pada: ${new Date(invoice.payment_confirmation_date).toLocaleDateString('id-ID', {
                                            day: 'numeric', month: 'long', year: 'numeric',
                                            hour: '2-digit', minute: '2-digit'
                                        })}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                        </div>
                    </div>
                `;
            }
            
            if (invoice.status === 'sent' || invoice.status === 'draft' || invoice.status === 'dp_paid') {
                const formatCurrency = (amount) => {
                    return new Intl.NumberFormat('id-ID', {
                        style: 'currency',
                        currency: 'IDR',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(amount || 0).replace('IDR', 'Rp');
                };
                
                // Smart payment amount logic based on payment stage
                const getPaymentInfo = () => {
                    try {
                        console.log('🔧 Current invoice payment stage:', invoice.payment_stage);
                        console.log('🔧 Current invoice payment status:', invoice.payment_status);
                        
                        // Check if there's a payment schedule
                        if (invoice.payment_schedule_json) {
                            let paymentSchedule = null;
                            if (typeof invoice.payment_schedule_json === 'string') {
                                try {
                                    paymentSchedule = JSON.parse(invoice.payment_schedule_json);
                                } catch (e) {
                                    console.log('❌ Failed to parse payment_schedule_json in payment section:', e);
                                    paymentSchedule = null;
                                }
                            } else if (typeof invoice.payment_schedule_json === 'object') {
                                paymentSchedule = invoice.payment_schedule_json; // Already an object
                            }
                            
                            if (paymentSchedule && paymentSchedule.scheduleType === 'down_payment') {
                                console.log('🔧 Down payment schedule detected for payment section:', paymentSchedule);
                                console.log('🔧 Down payment amount:', paymentSchedule.downPayment?.amount);
                                console.log('🔧 Down payment percentage:', paymentSchedule.downPayment?.percentage);
                                
                                // Use actual payment stage from invoice data
                                const currentStage = invoice.payment_stage || 'down_payment';
                                
                                if (currentStage === 'down_payment') {
                                    return {
                                        amount: paymentSchedule.downPayment.amount,
                                        label: (() => {
                                            const dp = paymentSchedule.downPayment;
                                            if (dp.type === 'fixed') {
                                                return 'Bayar Uang Muka (Jumlah Tetap)';
                                            } else {
                                                return `Bayar Uang Muka (${dp.percentage}%)`;
                                            }
                                        })(),
                                        description: `Uang muka untuk invoice ini. Sisa pembayaran: ${formatCurrency(paymentSchedule.remainingBalance.amount)}`,
                                        stage: 'down_payment'
                                    };
                                } else if (currentStage === 'final_payment') {
                                    // Use final_payment_amount if available, otherwise use remainingBalance.amount
                                    const finalAmount = invoice.final_payment_amount || paymentSchedule.remainingBalance.amount;
                                    return {
                                        amount: finalAmount,
                                        label: 'Bayar Sisa Pembayaran',
                                        description: 'Pembayaran terakhir untuk menyelesaikan invoice ini',
                                        stage: 'final_payment'
                                    };
                                } else if (currentStage === 'completed') {
                                    return {
                                        amount: 0,
                                        label: 'Invoice Lunas',
                                        description: 'Invoice ini telah dibayar lunas',
                                        stage: 'completed'
                                    };
                                }
                            }
                        }
                        
                        // NO FALLBACK for discount_amount - discount should not be treated as down payment
                        console.log('✅ discount_amount detected but NOT treating as down payment');
                        console.log('   Regular discount invoices should show "Bayar Invoice" with full amount');
                        
                        // Default: full payment
                        return {
                            amount: invoice.grand_total,
                            label: 'Bayar Invoice',
                            description: 'Pembayaran penuh untuk invoice ini',
                            stage: 'full_payment'
                        };
                    } catch (e) {
                        console.error('Error determining payment info:', e);
                        return {
                            amount: invoice.grand_total,
                            label: 'Bayar Invoice',
                            description: 'Pembayaran penuh untuk invoice ini',
                            stage: 'full_payment'
                        };
                    }
                };
                
                const paymentInfo = getPaymentInfo();
                console.log('💳 Payment info determined:', paymentInfo);
                
                return `
                    <div class="paper-wrapper" style="margin-top: 1px;">
                        <div class="paper" style="padding: 20px;">
                        <div class="payment-section">
                            <h3>Pembayaran Online</h3>
                            
                            <!-- Payment Stage Indicator -->
                            <div style="background: rgba(49, 29, 107, 0.1); border: 1px solid rgba(49, 29, 107, 0.2); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 600; color: #311d6b; margin-bottom: 8px;">${paymentInfo.label}</div>
                                <div style="font-size: 13px; color: #666; line-height: 1.4;">${paymentInfo.description}</div>
                                <div style="font-size: 20px; font-weight: 700; color: #311d6b; margin-top: 12px;">${formatCurrency(paymentInfo.amount)}</div>
                            </div>
                            
                            ${paymentInfo.stage === 'down_payment' || paymentInfo.stage === 'final_payment' ? generatePaymentScheduleBreakdown(invoice, paymentInfo, formatCurrency) : ''}
                            
                            <p>Pilih metode pembayaran:</p>
                            
                            <div class="payment-methods">
                                ${generatePaymentMethodsHTML()}
                            </div>
                            
                            ${generateBankTransferDetails()}
                            ${generateXenditDetails()}

                            <div id="payment-status" class="payment-status" style="display: none;"></div>

                            <!-- Payment Confirmation Upload Form -->
                            <div id="payment-upload-section" style="margin-top: 20px;">
                                <button id="confirm-payment-btn" class="pay-btn" onclick="showUploadForm()">
                                    🔄 Konfirmasi Pembayaran - ${formatCurrency(paymentInfo.amount)}
                                </button>
                                
                                <div id="upload-form" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                                    <h4 style="color: #2d3748; margin-bottom: 15px;">📎 Upload Bukti Pembayaran</h4>
                                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                                        Upload foto atau file PDF bukti transfer Anda. File maksimal 10MB.
                                    </p>
                                    
                                    <form id="payment-confirmation-form" enctype="multipart/form-data">
                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; font-weight: 600; color: #4a5568; font-size: 14px; margin-bottom: 5px;">
                                                Pilih File Bukti Transfer
                                            </label>
                                            <input type="file" id="payment-file" name="paymentProof" accept="image/*,.pdf" required
                                                   style="width: 100%; padding: 10px; border: 2px dashed #cbd5e0; border-radius: 6px; background: white;">
                                            <small style="color: #666; display: block; margin-top: 5px;">
                                                Format yang didukung: JPG, PNG, GIF, PDF (maksimal 10MB)
                                            </small>
                                        </div>
                                        
                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; font-weight: 600; color: #4a5568; font-size: 14px; margin-bottom: 5px;">
                                                Catatan Tambahan (Opsional)
                                            </label>
                                            <textarea id="payment-notes" name="notes" rows="3" 
                                                      placeholder="Contoh: Transfer dari rekening BCA a.n. John Doe pada tanggal 20 Jan 2024"
                                                      style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; resize: vertical;"></textarea>
                                        </div>
                                        
                                        <div id="file-preview" style="display: none; margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 4px; display: none;">
                                                <div>
                                                    <div id="file-name" style="font-weight: 600; color: #2d3748;"></div>
                                                    <div id="file-size" style="color: #666; font-size: 12px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                            <button type="button" onclick="hideUploadForm()" 
                                                    style="padding: 10px 20px; background: #f7fafc; color: #4a5568; border: 1px solid #cbd5e0; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                                Batal
                                            </button>
                                            <button type="submit" id="upload-btn"
                                                    style="padding: 10px 20px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                                📤 Upload Bukti Pembayaran
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }

        function displayInvoice(invoice) {
            document.getElementById('loading').style.display = 'none';
            currentInvoice = invoice;
            
            // Load invoice data
            console.log('📄 Loading invoice:', invoice.invoice_number);
            
            try {
                if (invoice.metadata_json) {
                    let metadata;
                    if (typeof invoice.metadata_json === 'string') {
                        metadata = JSON.parse(invoice.metadata_json);
                    } else {
                        metadata = invoice.metadata_json; // Already an object
                    }
                    console.log('🔍 Parsed metadata:', metadata);
                    console.log('🔍 Business profile in metadata:', metadata.businessProfile);
                }
            } catch (e) {
                console.error('❌ Error parsing metadata:', e);
            }
            
            try {
                const invoiceHTML = generateUnifiedInvoiceTemplate(invoice, 'view');
                const paymentHTML = generatePaymentSection(invoice);
                
                const combinedHTML = `${invoiceHTML}${paymentHTML}`;
                document.getElementById('invoice-container').innerHTML = combinedHTML;
                document.getElementById('invoice-container').style.display = 'block';
            } catch (templateError) {
                console.error('❌ Error generating invoice template:', templateError);
                document.getElementById('invoice-container').innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #d32f2f;">
                        <h3>⚠️ Error Loading Invoice</h3>
                        <p>There was an error displaying this invoice. Please try refreshing the page.</p>
                        <p><small>Error: ${escapeHtml(templateError.message || 'Unknown template error')}</small></p>
                        <button onclick="location.reload()" style="background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                            🔄 Reload Page
                        </button>
                    </div>
                `;
                document.getElementById('invoice-container').style.display = 'block';
                return;
            }
        }

        // Show upload form
        function showUploadForm() {
            document.getElementById('upload-form').style.display = 'block';
            document.getElementById('confirm-payment-btn').style.display = 'none';
        }
        
        // Hide upload form
        function hideUploadForm() {
            document.getElementById('upload-form').style.display = 'none';
            document.getElementById('confirm-payment-btn').style.display = 'block';
            
            // Reset form
            document.getElementById('payment-confirmation-form').reset();
            document.getElementById('file-preview').style.display = 'none';
        }
        
        // File preview functionality
        function previewFile(file) {
            const preview = document.getElementById('file-preview');
            const previewImage = document.getElementById('preview-image');
            const fileName = document.getElementById('file-name');
            const fileSize = document.getElementById('file-size');
            
            fileName.textContent = file.name;
            fileSize.textContent = `${(file.size / (1024 * 1024)).toFixed(2)} MB`;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewImage.style.display = 'none';
            }
            
            preview.style.display = 'block';
        }
        
        // Upload payment confirmation
        async function uploadPaymentConfirmation(formData) {
            // Use the currentInvoice ID instead of trying to extract from URL params
            const invoiceId = currentInvoice ? currentInvoice.id : null;
            
            if (!invoiceId) {
                throw new Error('Invoice not loaded. Please refresh the page and try again.');
            }
            
            const statusDiv = document.getElementById('payment-status');
            statusDiv.className = 'payment-status processing';
            statusDiv.textContent = '⏳ Mengupload bukti pembayaran...';
            statusDiv.style.display = 'block';
            
            try {
                const response = await fetch(`/api/invoices/${invoiceId}/payment-confirmation`, {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is ok and content type is JSON
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server returned non-JSON response');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'payment-status success';
                    statusDiv.textContent = '✅ Bukti pembayaran berhasil diupload! Menunggu konfirmasi dari merchant.';
                    
                    // Hide upload form and show success
                    hideUploadForm();
                    
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Error uploading payment confirmation:', error);
                statusDiv.className = 'payment-status error';
                
                // Provide user-friendly error messages
                let errorMessage = 'Gagal mengupload bukti pembayaran';
                
                if (error.message.includes('500')) {
                    errorMessage = 'Server mengalami masalah. Silakan coba lagi dalam beberapa saat atau hubungi customer service.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Invoice tidak ditemukan. Silakan periksa kembali link invoice Anda.';
                } else if (error.message.includes('400')) {
                    errorMessage = 'File yang diupload tidak valid. Pastikan file berformat gambar (JPG, PNG) atau PDF.';
                } else if (error.message.includes('Database schema issue')) {
                    errorMessage = 'Sistem sedang dalam maintenance. Silakan coba lagi nanti atau hubungi customer service.';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'Koneksi timeout. Silakan periksa koneksi internet dan coba lagi.';
                } else if (error.message.includes('Network')) {
                    errorMessage = 'Tidak dapat terhubung ke server. Periksa koneksi internet Anda.';
                } else if (error.message) {
                    // Use the server's error message if it's user-friendly
                    errorMessage = error.message;
                }
                
                statusDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">❌ ${errorMessage}</div>
                    <button onclick="location.reload()" style="
                        background: var(--primary-purple); 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 4px; 
                        cursor: pointer;
                        margin-right: 10px;
                    ">🔄 Coba Lagi</button>
                    <button onclick="window.location.href='/customer-support'" style="
                        background: #28a745; 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 4px; 
                        cursor: pointer;
                    ">💬 Customer Service</button>
                `;
            }
        }

        // Load invoice from URL parameter
        async function loadInvoice() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            const token = urlParams.get('token');
            const fromContext = urlParams.get('from');
            
            // Check for management context and show appropriate buttons
            if (fromContext === 'dashboard') {
                document.getElementById('management-actions').style.display = 'flex';
            }
            
            if (!id && !token) {
                showError('No invoice ID or token provided');
                return;
            }
            
            try {
                // Load payment methods first
                await loadPaymentMethods();
                
                // Prioritize ID over token for consistent behavior
                let response;
                if (id) {
                    console.log('🔍 Loading invoice by ID (numeric or invoice number):', id);
                    response = await fetch(`/api/invoices/${id}`);
                } else if (token) {
                    console.log('🔍 Loading invoice by token:', token);
                    response = await fetch(`/api/customer/invoice/${token}`);
                }
                if (!response.ok) throw new Error('Invoice not found');
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load invoice');
                }
                displayInvoice(result.invoice);
            } catch (error) {
                console.error('Error loading invoice:', error);
                let errorMessage = 'Failed to load invoice. Please check the URL and try again.';
                
                if (error.message === 'Invoice not found') {
                    errorMessage = 'Invoice tidak ditemukan. Silakan periksa nomor faktur dan coba lagi.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Koneksi ke server gagal. Silakan periksa koneksi internet Anda.';
                } else if (error.message.includes('network')) {
                    errorMessage = 'Masalah jaringan. Silakan coba lagi dalam beberapa saat.';
                } else if (error.message.includes('validation') || error.message.includes('500')) {
                    errorMessage = 'Server sedang memproses data. Invoice mungkin sedang dibuat atau diperbarui. Silakan coba lagi dalam beberapa detik.';
                }
                
                showError(errorMessage);
            }
        }

        function showError(message, showRetry = true) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('invoice-container').style.display = 'none';
            
            const errorDiv = document.getElementById('error');
            const retryButton = showRetry ? `
                <button onclick="window.location.reload()" style="background: #3182ce; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    🔄 Coba Lagi
                </button>
            ` : '';
            
            errorDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2 style="color: #e53e3e; margin-bottom: 20px;">⚠️ Terjadi Kesalahan</h2>
                    <p style="margin-bottom: 20px;">${message}</p>
                    ${retryButton}
                    <div style="margin-top: 20px;">
                        <a href="/merchant" style="color: #3182ce; text-decoration: none; font-size: 14px;">← Kembali ke Dashboard</a>
                    </div>
                </div>
            `;
            errorDiv.style.display = 'block';
        }

        // Payment method selection with payment details
        document.addEventListener('click', function(e) {
            if (e.target.closest('.payment-method')) {
                const method = e.target.closest('.payment-method');
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                method.classList.add('active');
                selectedPaymentMethod = method.dataset.method;
                
                // Show/hide payment details based on selection
                const bankTransferDetails = document.getElementById('bank-transfer-details');
                const xenditDetails = document.getElementById('xendit-details');
                const qrisDetails = document.getElementById('qris-details');
                const ewalletDetails = document.getElementById('ewallet-details');
                const cashDetails = document.getElementById('cash-details');
                
                // Hide all details first
                if (bankTransferDetails) bankTransferDetails.style.display = 'none';
                if (xenditDetails) xenditDetails.style.display = 'none';
                if (qrisDetails) qrisDetails.style.display = 'none';
                if (ewalletDetails) ewalletDetails.style.display = 'none';
                if (cashDetails) cashDetails.style.display = 'none';
                
                // Show relevant details
                if (selectedPaymentMethod === 'bank_transfer' && bankTransferDetails) {
                    bankTransferDetails.style.display = 'block';
                } else if (selectedPaymentMethod === 'xendit' && xenditDetails) {
                    xenditDetails.style.display = 'block';
                } else if (selectedPaymentMethod === 'qris' && qrisDetails) {
                    qrisDetails.style.display = 'block';
                } else if (selectedPaymentMethod === 'ewallet' && ewalletDetails) {
                    ewalletDetails.style.display = 'block';
                } else if (selectedPaymentMethod === 'cash' && cashDetails) {
                    cashDetails.style.display = 'block';
                }
            }
        });

        // Add event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // File input change event for preview
            document.addEventListener('change', function(e) {
                if (e.target.id === 'payment-file') {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file type
                        const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
                        if (!allowedTypes.includes(file.type)) {
                            alert('File harus berformat gambar (JPG, PNG) atau PDF!');
                            e.target.value = '';
                            return;
                        }
                        
                        // Validate file size (10MB limit)
                        if (file.size > 10 * 1024 * 1024) {
                            alert('File terlalu besar! Maksimal 10MB.');
                            e.target.value = '';
                            return;
                        }
                        
                        // Additional validation for very small files (likely corrupted)
                        if (file.size < 1024) { // Less than 1KB
                            alert('File terlalu kecil atau rusak. Silakan pilih file yang valid.');
                            e.target.value = '';
                            return;
                        }
                        
                        previewFile(file);
                    }
                }
            });
            
            // Form submit event
            document.addEventListener('submit', function(e) {
                if (e.target.id === 'payment-confirmation-form') {
                    e.preventDefault();
                    
                    const fileInput = document.getElementById('payment-file');
                    const notesInput = document.getElementById('payment-notes');
                    
                    if (!fileInput.files[0]) {
                        alert('Silakan pilih file bukti pembayaran terlebih dahulu.');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('paymentProof', fileInput.files[0]);
                    formData.append('notes', notesInput.value);
                    
                    uploadPaymentConfirmation(formData);
                }
            });
        });


        // Xendit payment processing
        async function processXenditPayment() {
            if (!currentInvoice) {
                alert('Invoice tidak ditemukan. Silakan refresh halaman.');
                return;
            }

            const payBtn = document.getElementById('xendit-pay-btn');
            const statusDiv = document.getElementById('payment-status');
            
            // Show loading state
            payBtn.disabled = true;
            payBtn.innerHTML = '⏳ Memproses pembayaran...';
            statusDiv.className = 'payment-status processing';
            statusDiv.textContent = '🔄 Membuat link pembayaran Xendit...';
            statusDiv.style.display = 'block';
            
            try {
                const response = await fetch('/api/xendit/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        invoiceId: currentInvoice.id,
                        paymentData: {
                            // Additional payment data if needed
                        }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'payment-status success';
                    statusDiv.innerHTML = '✅ Link pembayaran berhasil dibuat! Anda akan dialihkan ke Xendit...';
                    
                    // Redirect to Xendit payment page
                    setTimeout(() => {
                        window.open(result.paymentUrl, '_blank');
                    }, 1000);
                    
                    // Reset button after delay
                    setTimeout(() => {
                        payBtn.disabled = false;
                        payBtn.innerHTML = '💳 Bayar Sekarang dengan Xendit';
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Gagal membuat pembayaran Xendit');
                }
            } catch (error) {
                console.error('Xendit payment error:', error);
                statusDiv.className = 'payment-status error';
                statusDiv.textContent = '❌ Error: ' + (error.message || 'Unknown error');
                
                // Reset button
                payBtn.disabled = false;
                payBtn.innerHTML = '💳 Bayar Sekarang dengan Xendit';
            }
        }

        // WhatsApp sharing function
        async function shareInvoiceWhatsApp() {
            if (!currentInvoice) {
                alert('Tidak ada data faktur yang tersedia. Silakan refresh halaman.');
                return;
            }
            
            const invoice = currentInvoice;
            const invoiceNumber = invoice.invoice_number;
            const customerName = invoice.customer_name || '';
            const customerPhone = invoice.customer_phone || '';
            const customerAddress = invoice.customer_address || '';
            const dueDate = invoice.due_date;
            const businessName = invoice.business_name || 'Business';
            const total = invoice.total_amount || 0;
            const subtotal = invoice.subtotal || total;
            const discount = invoice.discount || 0;
            const discountType = invoice.discount_type;
            const discountValue = invoice.discount_value;
            const shippingCost = invoice.shipping_cost || 0;
            
            // Parse items from JSON with proper error handling
            let items = [];
            try {
                if (invoice.items_json) {
                    if (typeof invoice.items_json === 'string') {
                        items = JSON.parse(invoice.items_json);
                    } else if (Array.isArray(invoice.items_json)) {
                        items = invoice.items_json;
                    }
                }
            } catch (e) {
                console.error('Could not parse items for WhatsApp:', e);
                items = [];
            }
            
            // Get business settings for payment information
            const generatePaymentInfo = async () => {
                let bankInfo = '';
                let paymentMethods = '';
                console.log('🔧 Fetching payment methods for WhatsApp message...');
                
                try {
                    const response = await fetch('/api/settings/payment-methods');
                    console.log('📡 API Response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('📊 Payment methods data received:', data);
                        
                        if (data.success && data.paymentMethods) {
                            // Handle both camelCase and snake_case formats
                            const bank = data.paymentMethods.bankTransfer || data.paymentMethods.bank_transfer;
                            console.log('🏦 Bank transfer data:', bank);
                            
                            if (bank && bank.enabled) {
                                const bankName = bank.bankName || bank.bank_name || '';
                                const accountNumber = bank.accountNumber || bank.account_number || '';
                                const accountHolder = bank.accountHolderName || bank.account_holder_name || '';
                                const instructions = bank.instructions || '';
                                
                                bankInfo = `\n💳 *PEMBAYARAN BANK TRANSFER*\nBank: ${bankName}\nNo. Rekening: ${accountNumber}\nAtas Nama: ${accountHolder}\n${instructions ? `Catatan: ${instructions}` : ''}`;
                                console.log('✅ Bank info generated:', bankInfo);
                            } else {
                                console.log('❌ Bank transfer not enabled or missing');
                            }
                            
                            const methods = [];
                            if (bank && bank.enabled) methods.push('Transfer Bank');
                            if (data.paymentMethods.xendit && data.paymentMethods.xendit.enabled) {
                                methods.push('E-Wallet', 'Kartu Kredit');
                            }
                            if (methods.length > 0) {
                                paymentMethods = `\n📱 *METODE PEMBAYARAN:* ${methods.join(', ')}`;
                            }
                        }
                    }
                    
                    return paymentMethods + bankInfo;
                } catch (error) {
                    console.error('❌ Error fetching payment methods:', error);
                    return '';
                }
            };

            // Complete WhatsApp message generation
            const paymentInfo = await generatePaymentInfo();
            
            const whatsappMessage = `📋 *INVOICE ${invoiceNumber}*

🏢 *${businessName}*
📅 Tanggal: ${invoiceDate}
${dueDate ? `⏰ Jatuh Tempo: ${formatDate(dueDate)}` : ''}

👤 *Pelanggan:*
${customerName}
${customerPhone ? `📱 ${customerPhone}` : ''}
${customerAddress ? `📍 ${customerAddress}` : ''}

📦 *Detail Pesanan:*
${items.map(item => `• ${item.description || item.name || 'Item'} - ${formatCurrency(item.lineTotal || item.total || 0)}`).join('\n')}

💰 *Ringkasan:*
Subtotal: ${formatCurrency(subtotal)}
${discount > 0 ? `${(() => {
                if (discountType === 'percentage') {
                    return `Diskon (${discountValue}%)`;
                } else {
                    return 'Diskon (Jumlah Tetap)';
                }
            })()}: -${formatCurrency(discount)}` : ''}
${shippingCost > 0 ? `Biaya Kirim: ${formatCurrency(shippingCost)}` : ''}
*TOTAL: ${formatCurrency(total)}*

${paymentInfo}

Terima kasih atas kepercayaan Anda! 🙏`;

                return whatsappMessage;
            }

            // Initialize the page
            async function initializePage() {
                try {
                    console.log('🚀 Initializing invoice view page...');
                    
                    // Get invoice ID from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const invoiceId = urlParams.get('id');
                    
                    if (!invoiceId) {
                        throw new Error('Invoice ID not provided');
                    }
                    
                    console.log('📋 Loading invoice:', invoiceId);
                    await loadInvoice(invoiceId);
                    
                    // Check for print parameter and trigger print if requested
                    const printParam = urlParams.get('print');
                    if (printParam === 'true') {
                        console.log('🖨️ Print parameter detected, triggering print dialog...');
                        // Give the page time to fully render before printing
                        setTimeout(() => {
                            window.print();
                        }, 1500);
                    }
                    
                } catch (error) {
                    console.error('❌ Error initializing page:', error);
                    document.body.innerHTML = `
                        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                            <h2 style="color: #e53e3e;">Error Loading Invoice</h2>
                            <p style="color: #666;">${error.message}</p>
                            <button onclick="window.location.reload()" style="padding: 10px 20px; background: #3182ce; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }

            // Start the application
            document.addEventListener('DOMContentLoaded', initializePage);

        // Initialize when DOM is loaded
        // document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
