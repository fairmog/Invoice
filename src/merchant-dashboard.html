<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, minimum-scale=0.5, user-scalable=yes, viewport-fit=cover">
    <title>Merchant Dashboard - Aspree Invoice Gen</title>
    <style>
        /* Professional Business Design System */
        :root {
            /* Primary Blue-Grey Palette */
            --primary-purple: #2563EB;
            --primary-dark: #1D4ED8;
            --primary-light: #3B82F6;
            
            /* Secondary/Accent Colors */
            --accent-purple: #1E40AF;
            --light-accent: #60A5FA;
            --deep-purple: #1E3A8A;
            
            /* Neutral Colors */
            --background: #FAFAFA;
            --card-background: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --border-color: #E2E8F0;
            
            /* Status Colors */
            --success: #48BB78;
            --warning: #ED8936;
            --error: #F56565;
            --info: #4299E1;
            --whatsapp: #25D366;
            
            /* Component Specific */
            --shadow-soft: 0 4px 6px rgba(37, 99, 235, 0.05);
            --shadow-medium: 0 10px 25px rgba(37, 99, 235, 0.1);
            --shadow-strong: 0 20px 40px rgba(37, 99, 235, 0.15);
            --gradient-primary: linear-gradient(135deg, var(--primary-purple) 0%, var(--accent-purple) 100%);
            --gradient-card: linear-gradient(145deg, #FFFFFF 0%, #F7F9FF 100%);
            --border-radius: 12px;
            --border-radius-large: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', system-ui, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-purple));
            border-bottom: none;
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .logo-icon img {
            max-height: 36px;
            max-width: 200px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .settings-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
            backdrop-filter: blur(4px);
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .settings-btn span:first-child {
            font-size: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(139, 95, 255, 0.05);
            border-radius: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 12px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-logout-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 11px;
            background: var(--error);
            color: white;
            border: 1px solid var(--error);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            width: fit-content;
            margin-top: 2px;
        }

        .header-logout-btn:hover {
            background: #E53E3E;
            border-color: #E53E3E;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
        }

        .header-logout-btn:active {
            transform: translateY(0);
        }

        .header-logout-btn span {
            font-size: 10px;
        }

        /* Plan Status and Upgrade Button */
        .plan-status-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 16px;
        }

        .plan-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .plan-badge.free {
            background: linear-gradient(135deg, #E2E8F0, #CBD5E0);
            color: #2D3748;
            border: 1px solid #A0AEC0;
        }

        .plan-badge.premium {
            background: linear-gradient(135deg, #9F7AEA, #805AD5);
            color: white;
            border: 1px solid #6B46C1;
            box-shadow: 0 2px 4px rgba(159, 122, 234, 0.2);
        }

        .upgrade-btn {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            background: linear-gradient(135deg, #48BB78, #38A169);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .upgrade-btn:hover {
            background: linear-gradient(135deg, #38A169, #2F855A);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(72, 187, 120, 0.3);
        }

        .manage-btn {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            background: linear-gradient(135deg, #4A5568, #2D3748);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
        }

        .manage-btn:hover {
            background: linear-gradient(135deg, #2D3748, #1A202C);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 85, 104, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Dashboard Navigation */
        .dashboard-nav {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            color: var(--text-primary);
            background: var(--background);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
        }

        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary-purple);
            box-shadow: var(--shadow-soft);
        }


        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .section {
            background: var(--gradient-card);
            border-radius: var(--border-radius-large);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
        }

        .section h2 {
            color: var(--text-primary);
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }



        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-align: center;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-soft);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--card-background);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(72, 187, 120, 0.3);
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(245, 101, 101, 0.3);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(237, 137, 54, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Legacy product grid styles - no longer used for products/customers */

        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .product-card .selection-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .product-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .product-sku {
            color: #666;
            font-size: 0.9rem;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }

        .product-price {
            font-size: 1.4rem;
            font-weight: 700;
            color: #27ae60;
            margin: 0.5rem 0;
        }

        .product-stock {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
        }

        .stock-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .stock-high {
            background: #d4edda;
            color: #155724;
        }

        .stock-low {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-out {
            background: #f8d7da;
            color: #721c24;
        }

        .stock-medium {
            background: #fff3cd;
            color: #856404;
        }

        .product-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Share Dropdown Styles */
        .share-dropdown {
            position: relative;
            display: inline-block;
        }

        .share-menu {
            display: none;
            position: absolute;
            background: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 6px;
            z-index: 1000;
            top: 100%;
            left: 0;
            border: 1px solid #ddd;
        }

        .share-menu.show {
            display: block;
        }

        .share-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .share-option:hover {
            background-color: #f1f1f1;
        }

        .share-option:first-child {
            border-radius: 6px 6px 0 0;
        }

        .share-option:last-child {
            border-radius: 0 0 6px 6px;
        }

        /* Invoice, Order, Product & Customer Containers */
        .invoices-container,
        .orders-container,
        .products-container,
        .customers-container {
            width: 100%;
        }

        /* Invoice List View Styles */
        .invoice-date-group {
            margin-bottom: 30px;
        }

        .date-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 0;
        }

        .date-group-header h3 {
            margin: 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .invoice-count {
            color: #6c757d;
            font-size: 0.9rem;
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
        }

        .invoices-list {
            background: white;
            border-radius: 0 0 12px 12px;
            border: 1px solid #dee2e6;
            border-top: none;
            overflow: hidden;
        }

        .invoice-list-item {
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }

        .invoice-list-item:last-child {
            border-bottom: none;
        }

        .invoice-list-item:hover {
            background-color: #f8f9fa;
        }

        .invoice-list-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .selection-checkbox {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            margin-right: 15px;
        }

        .selection-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #007bff;
        }

        .invoice-selection-buttons {
            display: none;
        }

        .invoice-main-info {
            flex: 1;
            min-width: 0;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .invoice-number {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invoice-number strong {
            font-size: 1.1rem;
            color: #2d3748;
        }

        .payment-stage-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .payment-stage-badge.payment-stage-dp {
            background: #fff3e0;
            color: #f57c00;
            border-color: #ffcc02;
        }

        .payment-stage-badge.payment-stage-final {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #4caf50;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .invoice-customer {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .customer-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .customer-email {
            color: #718096;
            font-size: 0.85rem;
        }

        .invoice-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: right;
        }

        .invoice-meta span {
            font-size: 0.85rem;
            color: #718096;
        }

        .invoice-amount {
            font-weight: 700 !important;
            color: #2d3748 !important;
            font-size: 1rem !important;
        }

        .invoice-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: stretch;
            flex-shrink: 0;
        }

        .invoice-actions .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: auto;
            width: 100%;
            justify-content: center;
        }

        /* Mobile responsive for list view */
        @media (max-width: 768px) {
            .invoice-list-content {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }

            .invoice-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .invoice-meta {
                text-align: left;
            }

            .invoice-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 6px;
            }

            .invoice-actions .btn-sm {
                flex: 1;
                min-width: 100px;
                text-align: center;
            }

            .date-group-header {
                padding: 12px 15px;
            }

            .date-group-header h3 {
                font-size: 1rem;
            }

            .share-dropdown {
                width: 100%;
            }
        }

        /* Order List View Styles */
        .order-date-group {
            margin-bottom: 30px;
        }

        .order-count {
            color: #6c757d;
            font-size: 0.9rem;
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
        }

        .orders-list {
            background: white;
            border-radius: 0 0 12px 12px;
            border: 1px solid #dee2e6;
            border-top: none;
            overflow: hidden;
        }

        .order-list-item {
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }

        .order-list-item:last-child {
            border-bottom: none;
        }

        .order-list-item:hover {
            background-color: #f8f9fa;
        }

        .order-list-content {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .order-selection {
            flex-shrink: 0;
        }

        .order-main-info {
            flex: 1;
            min-width: 0;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-number {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-number strong {
            font-size: 1.1rem;
            color: #2d3748;
        }

        .tracking-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .order-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .order-customer {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .order-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: right;
        }

        .order-meta span {
            font-size: 0.85rem;
            color: #718096;
        }

        .order-amount {
            font-weight: 700 !important;
            color: #2d3748 !important;
            font-size: 1rem !important;
        }

        .order-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: stretch;
            flex-shrink: 0;
        }

        .order-actions .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: auto;
            width: 100%;
            justify-content: center;
        }

        /* Mobile responsive for order list view */
        @media (max-width: 768px) {
            .order-list-content {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }

            .order-selection {
                order: 3;
                text-align: center;
            }

            .order-main-info {
                order: 1;
            }

            .order-actions {
                order: 2;
                justify-content: center;
                flex-wrap: wrap;
                gap: 6px;
            }

            .order-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .order-meta {
                text-align: left;
            }

            .order-actions .btn-sm {
                flex: 1;
                min-width: 100px;
                text-align: center;
            }
        }

        /* Product List View Styles */
        .product-category-group {
            margin-bottom: 30px;
        }

        .category-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #b3d9ff;
            margin-bottom: 0;
        }

        .category-group-header h3 {
            margin: 0;
            color: #1e40af;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .product-count {
            color: #6c757d;
            font-size: 0.9rem;
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #b3d9ff;
        }

        .products-list {
            background: white;
            border-radius: 0 0 12px 12px;
            border: 1px solid #b3d9ff;
            border-top: none;
            overflow: hidden;
        }

        .product-list-item {
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }

        .product-list-item:last-child {
            border-bottom: none;
        }

        .product-list-item:hover {
            background-color: #f8f9fa;
        }

        .product-list-content {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .product-image-container {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
        }

        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .product-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-size: 2rem;
            color: #6c757d;
        }

        .product-main-info {
            flex: 1;
            min-width: 0;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .product-name {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .product-name strong {
            font-size: 1.1rem;
            color: #2d3748;
        }

        .product-sku {
            font-size: 0.75rem;
            color: #718096;
            background: #f7fafc;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .product-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .product-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #16a34a;
        }

        .product-description {
            font-size: 0.85rem;
            color: #718096;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .product-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: right;
        }

        .product-meta span {
            font-size: 0.85rem;
            color: #718096;
        }

        .product-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .product-actions .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: auto;
        }

        /* Customer List View Styles */
        .customer-activity-group {
            margin-bottom: 30px;
        }

        .activity-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #fef3e2 0%, #fde68a 100%);
            border-radius: 12px 12px 0 0;
            border-bottom: 2px solid #f59e0b;
            margin-bottom: 0;
        }

        .activity-group-header h3 {
            margin: 0;
            color: #92400e;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .customer-count {
            color: #6c757d;
            font-size: 0.9rem;
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #f59e0b;
        }

        .customers-list {
            background: white;
            border-radius: 0 0 12px 12px;
            border: 1px solid #f59e0b;
            border-top: none;
            overflow: hidden;
        }

        .customer-list-item {
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s ease;
        }

        .customer-list-item:last-child {
            border-bottom: none;
        }

        .customer-list-item:hover {
            background-color: #f8f9fa;
        }

        .customer-list-content {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .customer-avatar {
            flex-shrink: 0;
            width: 60px;
            height: 60px;
        }

        .customer-avatar-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .customer-main-info {
            flex: 1;
            min-width: 0;
        }

        .customer-header {
            margin-bottom: 12px;
        }

        .customer-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .customer-name strong {
            font-size: 1.1rem;
            color: #2d3748;
        }


        .customer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: start;
        }

        .customer-contact {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .customer-contact span {
            font-size: 0.85rem;
            color: #718096;
        }

        .customer-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: right;
        }

        .customer-stats span {
            font-size: 0.85rem;
            color: #718096;
        }

        .customer-stats .total-spent {
            font-weight: 700;
            color: #16a34a;
            font-size: 0.9rem;
        }

        .customer-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .customer-actions .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: auto;
        }

        /* Mobile responsive for product and customer list views */
        @media (max-width: 768px) {
            .product-list-content,
            .customer-list-content {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }

            .product-image-container {
                align-self: center;
                width: 60px;
                height: 60px;
            }

            .customer-avatar {
                align-self: center;
                width: 50px;
                height: 50px;
            }

            .product-details,
            .customer-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .product-meta,
            .customer-stats {
                text-align: left;
            }

            .product-actions,
            .customer-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 6px;
            }

            .product-actions .btn-sm,
            .customer-actions .btn-sm {
                flex: 1;
                min-width: 100px;
                text-align: center;
            }

            .category-group-header,
            .activity-group-header {
                padding: 12px 15px;
            }

            .category-group-header h3,
            .activity-group-header h3 {
                font-size: 1rem;
            }
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .close,
        .modal-close {
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            padding: 0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .link-box {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            align-items: center;
        }

        .link-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: monospace;
            background: var(--background);
        }

        .share-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
        }

        .status-sent {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        /* Payment Stage Badges */
        .payment-stage-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.3rem;
            display: inline-block;
        }

        .stage-down-payment {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .stage-remaining {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc02;
        }

        .stage-completed {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #81c784;
        }

        .stage-full {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }

        .invoice-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .invoice-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .header {
                padding: 1.5rem 1rem;
                text-align: center;
            }

            .header-content {
                padding: 0 16px;
            }

            /* Mobile logo sizing */
            .logo-icon img {
                max-height: 28px;
                max-width: 150px;
            }

            .user-info {
                padding: 6px 12px;
                gap: 8px;
            }

            .header-logout-btn {
                font-size: 10px;
                padding: 3px 6px;
                margin-top: 1px;
            }

            .header-logout-btn span {
                font-size: 9px;
            }

            /* Mobile plan status */
            .plan-status-container {
                gap: 6px;
                margin-right: 8px;
            }

            .plan-badge {
                padding: 3px 6px;
                font-size: 10px;
            }

            .upgrade-btn, .manage-btn {
                padding: 3px 8px;
                font-size: 10px;
                border-radius: 12px;
            }

            .settings-btn span:last-child {
                display: none;
            }

            .settings-btn {
                padding: 8px;
                min-width: 40px;
                justify-content: center;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 0.5rem;
            }

            .header p {
                font-size: 1rem;
            }

            .container {
                padding: 1rem;
            }

            .dashboard-nav {
                flex-wrap: wrap;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
            }

            .nav-btn {
                flex: 1;
                min-width: calc(50% - 0.25rem);
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
                text-align: center;
            }

            .section {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .section h2 {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .stat-card {
                padding: 1rem;
                text-align: center;
            }

            .stat-number {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .filter-select {
                padding: 0.75rem;
                font-size: 16px; /* Prevents zoom on iOS */
                width: 100%;
            }

            .btn {
                padding: 0.75rem 1rem;
                font-size: 1rem;
                width: 100%;
                margin-bottom: 0.5rem;
                min-height: 44px;
                touch-action: manipulation;
            }

            /* Legacy mobile product grid - no longer used */

            .product-card {
                padding: 1rem;
            }

            .product-name {
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
            }

            .product-sku {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }

            .product-price {
                font-size: 1.2rem;
                margin: 0.5rem 0;
            }

            .product-actions {
                flex-direction: column;
                gap: 0.5rem;
                margin-top: 1rem;
            }

            .btn-sm {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                width: 100%;
            }

            .form-row {
                flex-direction: column;
            }

            .form-control {
                padding: 0.75rem;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
                padding: 1.5rem;
                max-height: 90vh;
            }

            .invoice-modal-content {
                width: 98%;
                margin: 1% auto;
                padding: 1rem;
                max-height: 95vh;
            }
            
            /* Mobile Invoice Modal Zoom Controls */
            .mobile-invoice-zoom-controls {
                position: fixed !important;
                top: 50% !important;
                right: 8px !important;
                transform: translateY(-50%) !important;
                z-index: 1002 !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                padding: 12px 8px !important;
                border-radius: 12px !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
                border: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
            
            .invoice-zoom-btn {
                width: 36px !important;
                height: 36px !important;
                border: none !important;
                border-radius: 8px !important;
                background: var(--primary-purple) !important;
                color: white !important;
                font-size: 16px !important;
                font-weight: bold !important;
                cursor: pointer !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                transition: all 0.2s ease !important;
                user-select: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            .invoice-zoom-btn:hover, .invoice-zoom-btn:active {
                background: var(--primary-dark) !important;
                transform: scale(0.95) !important;
            }
            
            /* Invoice Modal Content Scaling */
            .invoice-modal-content-wrapper {
                transform: scale(var(--invoice-mobile-scale-factor, 0.8)) !important;
                transform-origin: top center !important;
                transition: transform 0.3s ease !important;
                width: 100% !important;
                overflow: visible !important;
            }
            
            /* Zoom Indicator */
            .invoice-zoom-indicator {
                position: fixed !important;
                top: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 1003 !important;
                background: rgba(0, 0, 0, 0.8) !important;
                color: white !important;
                padding: 4px 12px !important;
                border-radius: 16px !important;
                font-size: 12px !important;
                font-weight: 500 !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.3s ease !important;
            }
            
            .invoice-zoom-indicator.show {
                opacity: 1 !important;
            }

            .modal-header {
                margin-bottom: 1rem;
            }

            .modal-title {
                font-size: 1.2rem;
            }

            .close {
                font-size: 1.5rem;
            }

            /* Improve table display on mobile */
            table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            table th,
            table td {
                padding: 8px 4px;
                min-width: 80px;
            }

            .status-badge {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }

            .stock-badge {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }

            /* Customer grids - legacy grid layout */
            .customers-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .container {
                padding: 0.75rem;
            }

            /* Extra small mobile logo sizing */
            .logo-icon img {
                max-height: 24px;
                max-width: 120px;
            }

            .nav-btn {
                min-width: 100%;
                margin-bottom: 0.5rem;
                font-size: 0.8rem;
            }

            .section {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.75rem;
            }

            .stat-number {
                font-size: 1.3rem;
            }

            .product-card {
                padding: 0.75rem;
            }

            .product-name {
                font-size: 1rem;
            }

            .product-price {
                font-size: 1.1rem;
            }

            .modal-content,
            .invoice-modal-content {
                padding: 1rem;
            }

            .btn-sm {
                font-size: 0.8rem;
                padding: 0.5rem;
            }
        }

        /* Order Selection Mode Styles */
        .order-selection {
            display: none;
        }
        
        .selection-mode .order-selection {
            display: block;
        }
        
        .selection-mode .order-list-item {
            background-color: var(--background);
            border-left: 3px solid var(--primary-purple);
        }

        .selection-mode .order-list-item:hover {
            background-color: rgba(139, 69, 255, 0.1);
        }

        /* Service Ticket Modal Styles */
        #serviceTicketModal .modal-content {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .service-ticket-modal {
            padding: 20px;
            font-family: 'Arial', 'Helvetica', sans-serif;
        }

        .service-ticket {
            background: white;
            border: 1px solid #ddd;
            padding: 0;
            margin-bottom: 20px;
            max-width: 600px;
            margin: 0 auto 20px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid #ddd;
            padding: 24px 24px 16px 24px;
            flex-wrap: wrap;
        }

        .ticket-title {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .ticket-subtitle {
            font-size: 16px;
            margin-top: 5px;
            color: #666;
        }

        .ticket-body {
            font-size: 14px;
        }

        .info-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 15px;
        }

        .info-section:last-child {
            border-bottom: none;
        }

        .info-section h3 {
            margin-bottom: 10px;
            text-decoration: underline;
            font-size: 16px;
        }

        .info-item {
            display: flex;
            margin-bottom: 5px;
        }

        .info-label {
            font-weight: bold;
            width: 120px;
            flex-shrink: 0;
        }

        .info-value {
            flex: 1;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .items-table th, 
        .items-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }

        .items-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .notes {
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 3px solid #ccc;
            font-style: italic;
        }

        .print-button {
            background-color: var(--primary-purple);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .print-button:hover {
            background-color: var(--primary-purple-dark, #7c3aed);
        }

        /* New Service Ticket Styles - Clean Design */
        .service-ticket .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            text-align: left;
            flex-wrap: wrap;
            padding: 24px 24px 16px 24px;
            border-bottom: 1px solid #ddd;
        }

        .service-ticket .company-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .service-ticket .order-info {
            text-align: right;
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .service-ticket .order-number {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .ship-to-section {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .address-info {
            font-size: 12px;
            line-height: 1.6;
            color: #555;
        }

        .customer-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .items-section {
            padding: 20px 24px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .items-header .section-title {
            margin-bottom: 0;
        }

        .quantity-header {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .items-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .item-name {
            font-size: 14px;
            color: #333;
            flex-grow: 1;
            padding-right: 20px;
        }

        .item-quantity {
            font-size: 14px;
            color: #000;
            font-weight: 500;
            white-space: nowrap;
        }

        .ticket-footer {
            padding: 20px 24px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .thank-you {
            font-size: 13px;
            color: #666;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .company-info {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .company-info strong {
            color: #000;
            display: block;
            margin-bottom: 5px;
        }

        @media print {
            .modal, .modal-content, .modal-header {
                display: none !important;
            }
            
            body {
                font-family: Arial, sans-serif !important;
                font-size: 10px !important;
            }
            
            .service-ticket-modal {
                padding: 0;
                margin: 0;
                font-size: 10px;
            }
            
            .service-ticket {
                border: 1px solid #333;
                max-width: none;
                width: 100%;
                margin: 0;
                box-shadow: none;
                background: white;
            }
            
            .ticket-header {
                padding: 12px 16px 8px 16px;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
            }
            
            .ship-to-section {
                padding: 12px 16px;
                border-bottom: 1px solid #333;
            }
            
            .items-section {
                padding: 12px 16px;
            }
            
            .items-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                padding-bottom: 4px;
                border-bottom: 1px solid #333;
            }
            
            .ticket-footer {
                padding: 16px;
                background: #f8f8f8;
                border-top: none;
                text-align: center;
                margin-top: 20px;
            }
            
            .company-name {
                font-size: 16px;
                font-weight: bold;
                margin: 0;
            }
            
            .order-info {
                font-size: 10px;
                text-align: right;
                line-height: 1.3;
            }
            
            .order-number {
                font-weight: normal;
                font-size: 10px;
                margin-bottom: 2px;
            }
            
            .order-date {
                font-size: 10px;
                color: #666;
            }
            
            .section-title {
                font-size: 11px;
                font-weight: bold;
                margin-bottom: 8px;
                text-transform: uppercase;
            }
            
            .quantity-header {
                font-size: 11px;
                font-weight: bold;
                text-transform: uppercase;
            }
            
            .address-info {
                font-size: 10px;
                line-height: 1.3;
            }
            
            .customer-name {
                font-weight: bold;
                font-size: 10px;
                margin-bottom: 2px;
            }
            
            .item-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 3px 0;
                line-height: 1.3;
            }
            
            .item-name {
                font-size: 10px;
                color: #000;
                flex-grow: 1;
                padding-right: 20px;
            }
            
            .item-quantity {
                font-size: 10px;
                color: #000;
                text-align: right;
                min-width: 30px;
            }
            
            .thank-you {
                font-size: 12px;
                margin-bottom: 12px;
            }
            
            .company-info {
                font-size: 10px;
                line-height: 1.3;
            }
            
            .company-info strong {
                font-weight: bold;
                font-size: 11px;
                margin-bottom: 4px;
            }
            
            .print-button {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/generator" class="logo">
                <div class="logo-icon">
                    <img src="/assets/aspree-header-logo.png" alt="AI Invoice" onerror="this.style.display='none'; this.parentNode.innerHTML='';">
                </div>
            </a>
            <div class="header-actions">
                <!-- Plan Status -->
                <div class="plan-status-container" id="planStatusContainer">
                    <div class="plan-badge free" id="planBadge">
                        <span></span>
                        <span id="planText">FREE</span>
                    </div>
                    <button class="upgrade-btn" id="upgradeBtn" onclick="showUpgradeModal()" style="display: none;">
                        <span></span>
                        <span>Upgrade</span>
                    </button>
                    <button class="manage-btn" id="manageBtn" onclick="showManageSubscription()" style="display: none;">
                        <span></span>
                        <span>Manage</span>
                    </button>
                </div>
                <a href="/business-settings" class="settings-btn" title="Business Settings">
                    <span></span>
                    <span>Settings</span>
                </a>
                <div class="user-info">
                    <div class="user-avatar">AG</div>
                    <div class="user-details">
                        <div style="font-weight: 600; font-size: 14px;">Agus Merchant</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">Business Owner</div>
                        <button class="header-logout-btn" onclick="handleLogout()">
                            <span></span> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">Aspree Invoice Gen - Merchant Dashboard</h1>
                <p class="page-subtitle">Manage your business operations and insights</p>
            </div>
        </div>

        <!-- Dashboard Navigation -->
        <div class="dashboard-nav">
            <button class="nav-btn active" onclick="showSection('products')">
                <span></span> Products
            </button>
            <button class="nav-btn" onclick="showSection('orders')">
                <span></span> Orders
            </button>
            <button class="nav-btn" onclick="showSection('invoices')">
                <span></span> Invoices
            </button>
            <button class="nav-btn" onclick="showSection('customers')">
                <span></span> Customers
            </button>
        </div>

        <div id="products-section" class="section">
            <h2>
                <div class="section-icon"></div>
                Product Catalog
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-products">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-products">0</div>
                    <div class="stat-label">Active Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="low-stock-products">0</div>
                    <div class="stat-label">Low Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-categories">0</div>
                    <div class="stat-label">Categories</div>
                </div>
            </div>

            <div class="controls">
                <div class="filters">
                    <select class="filter-select" id="category-filter">
                        <option value="">All Categories</option>
                    </select>
                    <select class="filter-select" id="status-filter">
                        <option value="true">Active Only</option>
                        <option value="false">All Products</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-warning" onclick="seedProducts()">Seed Sample Products</button>
                    <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
                </div>
            </div>

            <div id="products-loading" class="loading">Loading products...</div>
            <div id="products-error" class="error" style="display: none;"></div>
            <div id="products-grid" class="products-container"></div>
        </div>

        <div id="orders-section" class="section" style="display: none;">
            <h2>
                <div class="section-icon"></div>
                Order Management
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-orders">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="delivered-orders">0</div>
                    <div class="stat-label">Delivered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="shipped-orders">0</div>
                    <div class="stat-label">Shipped</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-order-value">Rp 0</div>
                    <div class="stat-label">Total Value</div>
                </div>
            </div>

            <div class="controls">
                <div class="filters">
                    <select class="filter-select" id="order-status-filter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                    </select>
                    <input type="date" class="filter-select" id="order-date-from" placeholder="From Date">
                    <input type="date" class="filter-select" id="order-date-to" placeholder="To Date">
                    <button class="btn btn-primary" onclick="applyDateFilters()" id="apply-date-filters-btn" style="margin-left: 0.5rem; padding: 0.75rem 1rem;"> Apply</button>
                    <button class="btn btn-secondary" onclick="clearDateFilters()" id="clear-date-filters-btn" style="margin-left: 0.25rem; padding: 0.75rem 1rem;"> Clear</button>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="toggleOrderSelectionMode()" id="select-orders-btn"> Select Orders</button>
                    <button class="btn btn-info" onclick="printSelectedOrders()" id="print-orders-btn" style="display: none;"> Print Selected</button>
                    <button class="btn btn-warning" onclick="changeSelectedOrdersStatus()" id="change-status-btn" style="display: none;"> Change Status</button>
                    <button class="btn btn-success" onclick="openAddOrderModal()">+ Add Order</button>
                </div>
            </div>

            <div id="orders-loading" class="loading">Loading orders...</div>
            <div id="orders-error" class="error" style="display: none;"></div>
            <div id="orders-grid" class="orders-container"></div>
        </div>

        <div id="customers-section" class="section" style="display: none;">
            <h2>
                <div class="section-icon"></div>
                Customer Management
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-customers">0</div>
                    <div class="stat-label">Total Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-customers">0</div>
                    <div class="stat-label">Active Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="repeat-customers">0</div>
                    <div class="stat-label">Repeat Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="new-customers">0</div>
                    <div class="stat-label">New This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="average-clv">Rp 0</div>
                    <div class="stat-label">Avg CLV</div>
                </div>
            </div>

            <div class="controls">
                <div class="filters">
                    <input type="text" class="filter-select" id="customer-search" placeholder="Search customers..." style="min-width: 300px;">
                    <select class="filter-select" id="customer-sort" onchange="filterCustomers()">
                        <option value="name">Sort by Name</option>
                        <option value="orders">Sort by Total Orders</option>
                        <option value="spent">Sort by Total Spent</option>
                        <option value="recent">Sort by Last Activity</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-success" onclick="exportCustomers()"> Export CSV</button>
                    <button class="btn btn-primary" onclick="refreshCustomers()"> Refresh</button>
                </div>
            </div>

            <div id="customers-loading" class="loading">Loading customers...</div>
            <div id="customers-error" class="error" style="display: none;"></div>
            <div id="customers-grid" class="customers-container"></div>
        </div>

        <div id="inventory-section" class="section" style="display: none;">
            <h2>Inventory Management</h2>
            <div id="low-stock-alerts"></div>
        </div>

        <div id="categories-section" class="section" style="display: none;">
            <h2>
                <div class="section-icon"></div>
                Product Categories
            </h2>
            <div id="categories-list"></div>
        </div>

        <div id="invoices-section" class="section" style="display: none;">
            <h2>
                <div class="section-icon"></div>
                Invoice Management
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-invoices">0</div>
                    <div class="stat-label">Total Invoices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="draft-invoices">0</div>
                    <div class="stat-label">Draft</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sent-invoices">0</div>
                    <div class="stat-label">Sent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="paid-invoices">0</div>
                    <div class="stat-label">Paid</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-revenue">Rp 0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>

            <div class="controls">
                <div class="filters">
                    <input type="text" class="filter-select" id="invoice-search" placeholder="Search invoices..." style="min-width: 300px;">
                    <select class="filter-select" id="invoice-status-filter">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="paid">Paid</option>
                    </select>
                    <input type="date" class="filter-select" id="invoice-date-from" placeholder="From Date">
                    <input type="date" class="filter-select" id="invoice-date-to" placeholder="To Date">
                    <button class="btn btn-primary" onclick="applyInvoiceDateFilters()" id="apply-invoice-date-filters-btn" style="margin-left: 0.5rem; padding: 0.75rem 1rem;"> Apply</button>
                    <button class="btn btn-secondary" onclick="clearInvoiceDateFilters()" id="clear-invoice-date-filters-btn" style="margin-left: 0.25rem; padding: 0.75rem 1rem;"> Clear</button>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="toggleInvoiceSelectionMode()" id="select-invoices-btn"> Select Invoices</button>
                    <button class="btn btn-danger invoice-selection-buttons" onclick="deleteSelectedInvoices()" id="delete-invoices-btn" style="display: none;"> Delete Selected</button>
                </div>
            </div>

            <div id="invoices-loading" class="loading">Loading invoices...</div>
            <div id="invoices-error" class="error" style="display: none;"></div>
            <div id="invoices-grid" class="invoices-container"></div>
        </div>



    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add New Product</h3>
                <span class="close" onclick="closeProductModal()">&times;</span>
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">Product Name *</label>
                    <input type="text" class="form-control" id="product-name" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">SKU *</label>
                        <input type="text" class="form-control" id="product-sku" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" id="product-category">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="product-description" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Unit Price (IDR) *</label>
                        <input type="number" class="form-control" id="product-price" required min="0" step="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost Price (IDR)</label>
                        <input type="number" class="form-control" id="product-cost" min="0" step="100">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" class="form-control" id="product-stock" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min Stock Level</label>
                        <input type="number" class="form-control" id="product-min-stock" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tax Rate (%)</label>
                        <input type="number" class="form-control" id="product-tax" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" class="form-control" id="product-weight" min="0" step="0.1">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Dimensions (L x W x H cm)</label>
                    <input type="text" class="form-control" id="product-dimensions" placeholder="e.g., 10 x 5 x 3">
                </div>

                <div class="form-group">
                    <label class="form-label">Image URL</label>
                    <input type="url" class="form-control" id="product-image">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="product-active" checked> Active
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">Save Product</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Status Update Modal -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Update Order Status</h3>
                <span class="close" onclick="closeStatusModal()">&times;</span>
            </div>
            <form id="statusForm">
                <div class="form-group">
                    <label class="form-label">Current Order</label>
                    <div id="current-order-info" style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 15px;">
                        <strong id="current-order-number">Loading...</strong><br>
                        <span id="current-customer-name">Loading customer...</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">New Status</label>
                    <select class="form-control" id="new-status" required>
                        <option value="">Select status...</option>
                        <option value="pending"> Pending</option>
                        <option value="shipped"> Shipped</option>
                        <option value="delivered"> Delivered</option>
                    </select>
                </div>
                
                <div class="form-group" id="tracking-group" style="display: none;">
                    <label class="form-label">Tracking Number (Optional)</label>
                    <input type="text" class="form-control" id="tracking-number" placeholder="Enter tracking number">
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">Update Status</button>
                    <button type="button" class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Status Change Modal -->
    <div id="bulkStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Update Multiple Orders Status</h3>
                <span class="close" onclick="closeBulkStatusModal()">&times;</span>
            </div>
            <form id="bulkStatusForm">
                <div class="form-group">
                    <label class="form-label">Selected Orders</label>
                    <div id="selected-orders-info" style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 15px; max-height: 100px; overflow-y: auto;">
                        <span id="selected-orders-count">0 orders selected</span>
                        <div id="selected-orders-list" style="margin-top: 5px; font-size: 0.9rem;"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">New Status</label>
                    <select class="form-control" id="bulk-new-status" required>
                        <option value="">Select status...</option>
                        <option value="pending"> Pending</option>
                        <option value="processing"> Processing</option>
                        <option value="shipped"> Shipped</option>
                        <option value="delivered"> Delivered</option>
                        <option value="cancelled"> Cancelled</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulk-tracking-group" style="display: none;">
                    <label class="form-label">Tracking Number (Optional)</label>
                    <input type="text" class="form-control" id="bulk-tracking-number" placeholder="Enter tracking number for all orders">
                    <small style="color: #666; font-size: 0.8rem;">This tracking number will be applied to all selected orders</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" id="bulk-status-notes" rows="2" placeholder="Add notes for this status change"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">
                        <span id="bulk-update-btn-text">Update All Orders</span>
                        <span id="bulk-update-loading" style="display: none;"> Updating...</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeBulkStatusModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div id="invoiceModal" class="invoice-modal">
        <div class="invoice-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Invoice Details</h3>
                <span class="close" onclick="closeInvoiceModal()">&times;</span>
            </div>
            <div class="invoice-modal-content-wrapper" id="invoiceModalContentWrapper">
                <div id="invoiceModalContent"></div>
            </div>
        </div>
        
        <!-- Mobile Zoom Controls (only visible on mobile) -->
        <div class="mobile-invoice-zoom-controls" id="mobile-invoice-zoom-controls" style="display: none;">
            <button class="invoice-zoom-btn" id="invoice-zoom-in-btn" onclick="adjustInvoiceZoom(0.1)" title="Zoom In">+</button>
            <button class="invoice-zoom-btn" id="invoice-fit-screen-btn" onclick="fitInvoiceToScreen()" title="Fit to Screen"></button>
            <button class="invoice-zoom-btn" id="invoice-zoom-out-btn" onclick="adjustInvoiceZoom(-0.1)" title="Zoom Out"></button>
        </div>
        
        <!-- Zoom Indicator -->
        <div class="invoice-zoom-indicator" id="invoice-zoom-indicator">100%</div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="invoice-modal">
        <div class="invoice-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Customer Details</h3>
                <span class="close" onclick="closeCustomerModal()">&times;</span>
            </div>
            <div id="customerModalContent"></div>
        </div>
    </div>

    <!-- Service Ticket Modal -->
    <div id="serviceTicketModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Order Details</h3>
                <span class="close" onclick="closeServiceTicketModal()">&times;</span>
            </div>
            <div id="serviceTicketModalContent"></div>
        </div>
    </div>

    <!-- Premium Upgrade Modal -->
    <div id="premiumModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span style="background: linear-gradient(135deg, #9F7AEA, #805AD5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-flex; align-items: center; gap: 8px;">
                        <span></span> Upgrade to Premium
                    </span>
                </h3>
                <button class="modal-close" onclick="closePremiumModal()" style="font-size: 20px;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Before/After Preview -->
                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="text-align: center; margin: 0 0 16px; color: #2D3748;"> White-Label Your Invoices</h4>
                    
                    <!-- Before Preview -->
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #E53E3E; margin: 0 0 8px;"> Current (Free Plan):</h5>
                        <div style="border: 2px solid #E2E8F0; border-radius: 8px; overflow: hidden; background: white;">
                            <!-- Mock header -->
                            <div style="background: linear-gradient(135deg, #311d6b, #4a2b7a); color: white; padding: 8px 12px; text-align: center; font-size: 12px;">
                                <img src="/assets/aspree-header-logo.png" alt="Aspree Logo" style="height: 16px; width: auto; margin-right: 8px; vertical-align: middle;">
                                <span style="opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Powered by Aspree Invoice Generator</span>
                            </div>
                            <div style="padding: 12px; font-size: 12px; text-align: center; color: #666;">
                                Your invoice content here...
                            </div>
                            <!-- Mock footer -->
                            <div style="background: linear-gradient(135deg, #311d6b, #4a2b7a); color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 10px;">
                                <div>Terms & Contact Info</div>
                                <img src="/assets/aspri-logo.png" alt="Aspree" style="height: 24px; width: auto; opacity: 0.9;">
                            </div>
                        </div>
                    </div>

                    <!-- After Preview -->
                    <div>
                        <h5 style="color: #38A169; margin: 0 0 8px;"> Premium Plan:</h5>
                        <div style="border: 2px solid #9F7AEA; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 4px 8px rgba(159, 122, 234, 0.1);">
                            <!-- Mock custom header -->
                            <div style="background: linear-gradient(135deg, #1A365D, #2C5282); color: white; padding: 8px 12px; text-align: center; font-size: 12px;">
                                <span style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Your Custom Business Text</span>
                            </div>
                            <div style="padding: 12px; font-size: 12px; text-align: center; color: #666;">
                                Your invoice content here...
                            </div>
                            <!-- Mock custom footer -->
                            <div style="background: linear-gradient(135deg, #1A365D, #2C5282); color: white; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; font-size: 10px;">
                                <div>Terms & Contact Info</div>
                                <div style="background: white; color: #1A365D; padding: 2px 8px; border-radius: 4px; font-weight: 600;">YOUR LOGO</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feature List -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div style="background: white; border: 1px solid #E2E8F0; border-radius: 8px; padding: 16px;">
                        <h4 style="color: #9F7AEA; margin: 0 0 8px; display: flex; align-items: center; gap: 8px;">
                            <span></span> Custom Branding
                        </h4>
                        <ul style="margin: 0; padding-left: 16px; color: #4A5568; font-size: 14px;">
                            <li>Remove "Powered by Aspree" branding</li>
                            <li>Add your own header text</li>
                            <li>Upload your own logos</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; border: 1px solid #E2E8F0; border-radius: 8px; padding: 16px;">
                        <h4 style="color: #9F7AEA; margin: 0 0 8px; display: flex; align-items: center; gap: 8px;">
                            <span></span> Custom Colors
                        </h4>
                        <ul style="margin: 0; padding-left: 16px; color: #4A5568; font-size: 14px;">
                            <li>Customize header background</li>
                            <li>Customize footer background</li>
                            <li>Match your brand colors</li>
                        </ul>
                    </div>
                </div>

                <!-- Pricing -->
                <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #EDF2F7, #E2E8F0); border-radius: 12px;">
                    <h3 style="margin: 0 0 8px; color: #2D3748;"> Premium Plan</h3>
                    <div style="font-size: 32px; font-weight: 700; color: #9F7AEA; margin: 0 0 8px;">$9.99<span style="font-size: 16px; font-weight: normal; color: #666;">/month</span></div>
                    <p style="margin: 0; color: #4A5568;">Professional invoices that represent your brand</p>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                    <button onclick="closePremiumModal()" style="padding: 12px 24px; border: 2px solid #E2E8F0; background: white; border-radius: 8px; cursor: pointer; color: #4A5568; font-weight: 600;">
                        Maybe Later
                    </button>
                    <button onclick="upgradeToPremium()" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #9F7AEA, #805AD5); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span></span> Upgrade Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = [];
        let categories = [];
        let orders = [];
        let invoices = [];
        let customers = [];
        let currentProduct = null;

        // Navigation Functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Add active class to clicked nav button
            const targetButton = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Load data for the selected section
            switch(sectionName) {
                case 'products':
                    loadProducts();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'invoices':
                    loadInvoices();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
            }
        }

        // Authentication Helper Functions
        function getMerchantToken() {
            return localStorage.getItem('merchantToken') || sessionStorage.getItem('merchantToken');
        }

        function getAuthHeaders() {
            const token = getMerchantToken();
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        function getAuthHeadersForFormData() {
            const token = getMerchantToken();
            return {
                'Authorization': `Bearer ${token}`
                // Don't include Content-Type for FormData - browser sets it automatically
            };
        }

        function handleAuthError(response) {
            if (response.status === 401) {
                console.log('Authentication failed, redirecting to login');
                localStorage.removeItem('merchantToken');
                sessionStorage.removeItem('merchantToken');
                window.location.href = '/auth/login?redirect=' + encodeURIComponent(window.location.pathname);
                return true;
            }
            return false;
        }

        // generateUnifiedInvoiceTemplate function - copied from web-interface-indonesian.html
        function generateUnifiedInvoiceTemplate(invoiceData, context = 'preview') {
            const invoice = invoiceData.invoice;
            
            // Get business profile for logo and category
            const savedProfile = localStorage.getItem('businessProfile');
            let businessLogo = '';
            let businessCategory = 'general';
            let businessTerms = 'Pembayaran dalam 30 hari';
            let businessProfile = null;
            if (savedProfile) {
                businessProfile = JSON.parse(savedProfile);
                businessLogo = businessProfile.logo || '';
                businessCategory = businessProfile.category || 'general';
                businessTerms = businessProfile.termsAndConditions || 'Pembayaran dalam 30 hari';
            }
            
            // Logo is now managed by loadBusinessDataFromAPI which syncs database with localStorage
            
            // Premium branding settings from localStorage business profile
            const hideAspreeBranding = businessProfile?.hideAspreeBranding || businessProfile?.hide_aspree_branding || false;
            const customHeaderLogo = businessProfile?.customHeaderLogoUrl || businessProfile?.custom_header_logo_url || null;
            const customFooterLogo = businessProfile?.customFooterLogoUrl || businessProfile?.custom_footer_logo_url || null;
            const customHeaderText = businessProfile?.customHeaderText || businessProfile?.custom_header_text || 'Powered by Aspree Invoice Generator';
            const customHeaderBgColor = businessProfile?.customHeaderBgColor || businessProfile?.custom_header_bg_color || '#311d6b';
            const customFooterBgColor = businessProfile?.customFooterBgColor || businessProfile?.custom_footer_bg_color || '#311d6b';
            const customHeaderTextColor = businessProfile?.customHeaderTextColor || businessProfile?.custom_header_text_color || '#ffffff';
            const customFooterTextColor = businessProfile?.customFooterTextColor || businessProfile?.custom_footer_text_color || '#ffffff';
            
            console.log(' Premium branding settings (merchant dashboard):', {
                hideAspreeBranding,
                customHeaderLogo,
                customFooterLogo,
                customHeaderText,
                customHeaderBgColor,
                customFooterBgColor
            });
            
            // Category-based titles (consistent across all contexts)
            const getCategoryTitle = (category) => {
                const categoryTitles = {
                    'trade': 'FAKTUR PENJUALAN',
                    'services': 'FAKTUR JASA',
                    'manufacturing': 'FAKTUR PRODUKSI',
                    'logistics': 'FAKTUR PENGIRIMAN',
                    'digital_creative': 'FAKTUR LISENSI DIGITAL',
                    'agriculture': 'FAKTUR PERTANIAN',
                    'construction': 'FAKTUR KONSTRUKSI',
                    'tourism': 'FAKTUR PERHOTELAN',
                    'general': 'FAKTUR'
                };
                return categoryTitles[category] || 'FAKTUR';
            };
            
            const invoiceTitle = getCategoryTitle(businessCategory);
            
            // Currency formatting function
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount || 0).replace('IDR', 'Rp');
            };
            
            // Date formatting function
            const formatDate = (dateString) => {
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // Clean Professional CSS styling (no emojis, no purple gradient)
            const getContextStyles = (context) => {
                const cleanStyles = `
                    :root {
                        --text: #2D3748;
                        --text-light: #718096;
                        --border: #E2E8F0;
                        --bg: #FFFFFF;
                        --bg-light: #F7FAFC;
                    }
                    
                    body {
                        font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
                        font-size: 16px;
                        line-height: 1.5;
                        color: var(--text);
                        background: white;
                        margin: 0;
                        padding: 0;
                    }
                    
                    .paper {
                        width: 100%;
                        max-width: 794px;
                        min-height: 1123px;
                        margin: 0 auto;
                        background: var(--bg);
                        border: 1px solid var(--border);
                        border-radius: 0;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                        overflow: hidden;
                        padding: 0;
                        position: relative;
                    }
                    
                    .inv-header {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 60px;
                        padding: 24px 32px 16px 32px;
                        background: var(--bg);
                        border-bottom: 2px solid var(--border);
                        align-items: start;
                    }
                    
                    .logo-section {
                        text-align: left;
                    }
                    
                    .logo-section img {
                        max-height: 120px;
                        max-width: 300px;
                        object-fit: contain;
                        display: block;
                        margin-bottom: 6px;
                    }
                    
                    .logo-section strong {
                        display: block;
                        font-size: 28px;
                        font-weight: 800;
                        color: var(--text);
                        margin-top: 4px;
                        line-height: 1.1;
                    }
                    
                    .invoice-meta {
                        text-align: right;
                    }
                    
                    .invoice-title {
                        font-size: 28px;
                        font-weight: 800;
                        color: var(--text);
                        margin: 0 0 20px 0;
                        letter-spacing: 0.5px;
                    }
                    
                    .invoice-details {
                        font-size: 15px;
                        color: var(--text-light);
                        margin-bottom: 10px;
                        line-height: 1.4;
                    }
                    
                    .invoice-details strong {
                        color: var(--text);
                        font-weight: 600;
                        min-width: 100px;
                        display: inline-block;
                    }
                    
                    .parties {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 80px;
                        padding: 20px 32px;
                        border-bottom: 1px solid var(--border);
                    }
                    
                    .party-section h3 {
                        font-size: 14px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 600;
                        color: var(--text);
                        margin: 0 0 16px 0;
                    }
                    
                    .party-section address {
                        font-style: normal;
                        font-size: 15px;
                        line-height: 1.5;
                        color: var(--text-light);
                    }
                    
                    .party-section strong {
                        color: var(--text);
                        font-weight: 600;
                        font-size: 16px;
                        display: block;
                        margin-bottom: 3px;
                    }
                    
                    .items-section {
                        padding: 20px 32px;
                    }
                    
                    .items-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 0;
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        overflow: hidden;
                    }
                    
                    .items-table thead th {
                        background: var(--bg-light);
                        border-bottom: 2px solid var(--border);
                        padding: 18px 20px;
                        font-size: 13px;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.8px;
                        color: var(--text);
                        text-align: left;
                    }
                    
                    .items-table th:last-child,
                    .items-table th.text-right { text-align: right; }
                    .items-table th.text-center { text-align: center; }
                    
                    .items-table tbody td {
                        padding: 20px;
                        border-bottom: 1px solid var(--border);
                        font-size: 15px;
                        color: var(--text);
                    }
                    
                    .items-table tbody tr:nth-child(even) {
                        background: rgba(247, 250, 252, 0.5);
                    }
                    
                    .items-table tbody tr:last-child td {
                        border-bottom: none;
                    }
                    
                    .items-table .text-right { text-align: right; font-weight: 600; }
                    .items-table .text-center { text-align: center; }
                    
                    .product-name {
                        font-weight: 500;
                        color: var(--text);
                        margin: 0;
                    }
                    
                    .product-description {
                        color: var(--text-light);
                        font-size: 13px;
                        margin: 2px 0 0 0;
                    }
                    
                    .summary {
                        padding: 20px 32px;
                        border-top: 1px solid var(--border);
                        background: var(--bg);
                    }
                    
                    .summary-grid {
                        display: grid;
                        grid-template-columns: 1fr auto;
                        gap: 12px 40px;
                        max-width: 320px;
                        margin-left: auto;
                    }
                    
                    .summary-label {
                        color: var(--text-light);
                        font-size: 14px;
                    }
                    
                    .summary-value {
                        color: var(--text);
                        font-size: 15px;
                        font-weight: 600;
                        text-align: right;
                    }
                    
                    .total-label {
                        color: var(--text) !important;
                        font-weight: 700 !important;
                        font-size: 16px !important;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        padding-top: 12px;
                        border-top: 2px solid var(--text);
                        margin-top: 8px;
                    }
                    
                    .total-value {
                        color: var(--text) !important;
                        font-weight: 800 !important;
                        font-size: 20px !important;
                        padding-top: 12px;
                        border-top: 2px solid var(--text);
                        margin-top: 8px;
                        text-align: right;
                    }
                    
                    
                    /* Compact Notes Styles */
                    .editable[data-field="notes.publicNotes"] {
                        min-width: 200px;
                        display: inline-block;
                        padding: 2px 4px;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                    }
                    
                    .editable[data-field="notes.publicNotes"]:hover {
                        background: rgba(49, 29, 107, 0.05);
                        cursor: text;
                    }
                    
                    /* Print styles */
                    @media print {
                        @page {
                            margin: 10mm;
                            size: A4 portrait;
                        }
                        
                        body {
                            background: white !important;
                            padding: 0 !important;
                        }
                        
                        .paper {
                            box-shadow: none !important;
                            border: none !important;
                            margin: 0 !important;
                            max-width: none !important;
                            page-break-inside: avoid !important;
                        }
                        
                        /* Prevent page breaks within important sections */
                        .inv-header,
                        .invoice-table,
                        .summary-section,
                        .footer-band {
                            page-break-inside: avoid !important;
                        }
                        
                        /* Reduce spacing to fit on one page */
                        .inv-header {
                            margin-bottom: 10px !important;
                        }
                        
                        .invoice-table {
                            margin-bottom: 10px !important;
                        }
                        
                        .summary-section {
                            margin-bottom: 10px !important;
                        }
                        
                        .edit-indicator {
                            display: none !important;
                        }

                        .footer-band {
                            background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                            margin-bottom: 0 !important;
                            padding-bottom: 0 !important;
                        }

                        .footer-section img {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            display: block !important;
                        }

                        /* Header band print styles */
                        .paper > div:first-child {
                            background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }

                        /* Ensure all purple elements print with colors */
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* Force single page printing */
                        html, body {
                            height: auto !important;
                            overflow: visible !important;
                        }
                        
                        /* Reduce font sizes slightly for print to fit more content */
                        .paper {
                            font-size: 13px !important;
                        }
                        
                        /* Compact payment schedule section */
                        .payment-schedule-section {
                            margin: 10px 0 !important;
                            padding: 15px !important;
                        }
                        
                        /* Ensure footer doesn't create page break */
                        .footer-band {
                            page-break-inside: avoid !important;
                            margin-top: 10px !important;
                        }
                    }
                    
                    /* Context-specific styles */
                    ${context === 'preview' ? `
                        .paper {
                            margin: 20px auto;
                        }
                    ` : ''}
                    
                    ${context === 'print' ? `
                        body {
                            background: white !important;
                            padding: 0;
                        }
                        .paper {
                            box-shadow: none !important;
                            border: none !important;
                            margin: 0;
                        }
                    ` : ''}
                `;
                
                return cleanStyles;
            };
            
            // Generate clean professional HTML structure (no emojis)
            const cleanHTML = `
                <div class="paper">
                    <!-- Dynamic Premium/Aspree branding header -->
                    ${!hideAspreeBranding ? `
                        <div style="background: linear-gradient(135deg, ${customHeaderBgColor}, ${customHeaderBgColor}aa); color: ${customHeaderTextColor}; padding: 12px 0; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                ${customHeaderLogo ? 
                                    `<img src="${customHeaderLogo}" alt="Header Logo" style="height: 32px; width: auto; object-fit: contain;">` :
                                    `<img src="/assets/aspree-header-logo.png" alt="Aspree Logo" style="height: 32px; width: auto;">`
                                }
                                <p style="font-size: 14px; font-weight: 600; margin: 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">${customHeaderText}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Header with logo and invoice metadata -->
                    <div class="inv-header">
                        <div class="logo-section">
                            ${businessLogo ? 
                                `<img src="${businessLogo}" alt="Logo">` : 
                                `<div style="background: #f0f0f0; padding: 15px; border-radius: 4px; margin-bottom: 12px; font-size: 18px; color: #666; text-align: center; border: 1px solid #e0e0e0;">LOGO</div>`
                            }
                            ${businessProfile && businessProfile.hideBusinessName ? '' : 
                                `<strong>${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.businessName" data-type="text">${invoice.merchant.businessName}<span class="edit-indicator"></span></span>` : 
                                    invoice.merchant.businessName
                                }</strong>`
                            }
                        </div>
                        <div class="invoice-meta">
                            <h1 class="invoice-title">${invoiceTitle}</h1>
                            <div class="invoice-details">
                                <strong>No:</strong> ${invoice.header.invoiceNumber}
                            </div>
                            <div class="invoice-details">
                                <strong>Tanggal:</strong> ${context === 'preview' ? 
                                    `<span class="editable" data-field="header.invoiceDate" data-type="date">${formatDate(invoice.header.invoiceDate)}<span class="edit-indicator"></span></span>` : 
                                    formatDate(invoice.header.invoiceDate)
                                }
                            </div>
                            <div class="invoice-details">
                                <strong>Jatuh Tempo:</strong> ${context === 'preview' ? 
                                    `<span class="editable" data-field="header.dueDate" data-type="date">${formatDate(invoice.header.dueDate || invoice.header.invoiceDate)}<span class="edit-indicator"></span></span>` : 
                                    formatDate(invoice.header.dueDate || invoice.header.invoiceDate)
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parties section -->
                    <div class="parties">
                        <div class="party-section">
                            <h3>DARI</h3>
                            <address>
                                <strong>${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.businessName" data-type="text">${invoice.merchant.businessName}<span class="edit-indicator"></span></span>` : 
                                    invoice.merchant.businessName
                                }</strong><br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.address" data-type="textarea">${invoice.merchant.address}<span class="edit-indicator"></span></span>` : 
                                    invoice.merchant.address
                                }<br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.phone" data-type="tel">${invoice.merchant.phone}<span class="edit-indicator"></span></span>` : 
                                    invoice.merchant.phone
                                }<br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.email" data-type="email">${invoice.merchant.email}<span class="edit-indicator"></span></span>` : 
                                    invoice.merchant.email
                                }
                            </address>
                        </div>
                        <div class="party-section">
                            <h3>KEPADA</h3>
                            <address>
                                <strong>${context === 'preview' ? 
                                    `<span class="editable" data-field="customer.name" data-type="text">${invoice.customer.name}<span class="edit-indicator"></span></span>` : 
                                    invoice.customer.name
                                }</strong><br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="customer.address" data-type="textarea">${invoice.customer.address}<span class="edit-indicator"></span></span>` : 
                                    invoice.customer.address
                                }<br>
                                ${invoice.customer.phone ? (context === 'preview' ? 
                                    `<span class="editable" data-field="customer.phone" data-type="tel">${invoice.customer.phone}<span class="edit-indicator"></span></span><br>` : 
                                    `${invoice.customer.phone}<br>`
                                ) : ''}
                                ${invoice.customer.email ? (context === 'preview' ? 
                                    `<span class="editable" data-field="customer.email" data-type="email">${invoice.customer.email}<span class="edit-indicator"></span></span>` : 
                                    invoice.customer.email
                                ) : ''}
                            </address>
                        </div>
                    </div>
                    
                    <!-- Items section -->
                    <div class="items-section">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Produk/Layanan</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-right">Harga Satuan</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map((item, index) => `
                                    <tr>
                                        <td>
                                            <div class="product-name">${context === 'preview' ? 
                                                `<span class="editable" data-field="items.${index}.productName" data-type="text">${item.productName}<span class="edit-indicator"></span></span>` : 
                                                item.productName
                                            }</div>
                                            ${item.description ? `<div class="product-description">${item.description}</div>` : ''}
                                        </td>
                                        <td class="text-center">${context === 'preview' ? 
                                            `<span class="editable editable-quantity" data-field="items.${index}.quantity" data-type="number">${item.quantity}<span class="edit-indicator"></span></span>` : 
                                            item.quantity
                                        }</td>
                                        <td class="text-right">${context === 'preview' ? 
                                            `<span class="editable editable-price" data-field="items.${index}.unitPrice" data-type="currency">${formatCurrency(item.unitPrice)}<span class="edit-indicator"></span></span>` : 
                                            formatCurrency(item.unitPrice)
                                        }</td>
                                        <td class="text-right">${formatCurrency(item.lineTotal)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Compact Notes Section -->
                    ${(() => {
                        try {
                            const notes = invoice.notes;
                            
                            // Collect all notes into an array
                            const allNotes = [];
                            
                            // List of placeholder/demo texts to filter out
                            const placeholderTexts = [
                                'Pembayaran dapat dilakukan melalui transfer bank atau tunai',
                                'tambahkan catatan tambahan disini, jika tidak ada catatan maka kolom catatan akan dihilangkan',
                                'Klik untuk menambahkan catatan...',
                                'Extract special requests from message',
                                'Extract delivery schedule if mentioned',
                                'Extract appointment info if service booking',
                                'Extract payment deadline if mentioned'
                            ];
                            
                            const isPlaceholderText = (text) => {
                                if (!text || !text.trim()) return true;
                                const trimmedText = text.trim();
                                return placeholderTexts.some(placeholder => trimmedText.includes(placeholder));
                            };
                            
                            // Only process main user-editable notes (removed AI extraction fields)
                            if (notes?.publicNotes && notes.publicNotes.trim() && !isPlaceholderText(notes.publicNotes)) allNotes.push(notes.publicNotes.trim());
                            if (notes?.customNotes && notes.customNotes.trim() && !isPlaceholderText(notes.customNotes)) allNotes.push(notes.customNotes.trim());
                            
                            console.log(' All notes after filtering:', allNotes);
                            
                            // Show section always in preview mode for editing, or only when notes exist in other modes
                            const hasNotes = allNotes.length > 0;
                            const showSection = context === 'preview' || hasNotes;
                            
                            if (!showSection) return '';
                            
                            if (context === 'preview') {
                                // In preview mode, make it editable
                                const noteContent = hasNotes ? allNotes.join(' | ') : '';
                                const isEmpty = !noteContent.trim();
                                
                                return `
                                    <div style="padding: 12px 32px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); background: rgba(247, 250, 252, 0.3);">
                                        <p style="margin: 0; font-size: 14px; color: var(--text-light); line-height: 1.4;">
                                            <strong style="color: var(--text);">Catatan:</strong> 
                                            <span class="editable" data-field="notes.publicNotes" data-type="text" style="color: ${isEmpty ? 'var(--text-light)' : 'var(--text)'}; ${isEmpty ? 'font-style: italic;' : ''}">${isEmpty ? 'tambahkan catatan tambahan disini, jika tidak ada catatan maka kolom catatan akan dihilangkan' : noteContent}<span class="edit-indicator"></span></span>
                                        </p>
                                    </div>
                                `;
                            } else {
                                // In other modes, show static content
                                const combinedNotes = allNotes.length <= 2 ? 
                                    allNotes : 
                                    [allNotes.slice(0, 2).join(' | ')];
                                
                                return `
                                    <div style="padding: 12px 32px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); background: rgba(247, 250, 252, 0.3);">
                                        ${combinedNotes.map(note => 
                                            `<p style="margin: 0; font-size: 14px; color: var(--text-light); line-height: 1.4;"><strong style="color: var(--text);">Catatan:</strong> ${note}</p>`
                                        ).join('')}
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.error('Error parsing compact notes:', e);
                            return '';
                        }
                    })()}
                    
                    <!-- Summary section -->
                    <div class="summary">
                        <div class="summary-grid">
                            <div class="summary-label">Subtotal</div>
                            <div class="summary-value">${formatCurrency(invoice.calculations.subtotal)}</div>
                            
                            <div class="summary-label">${(() => {
                                const discountType = invoice.calculations.discountType;
                                const discountValue = invoice.calculations.discountValue;
                                if (discountType === 'percentage') {
                                    return `Diskon (${discountValue}%)`;
                                } else {
                                    return 'Diskon (Jumlah Tetap)';
                                }
                            })()}</div>
                            <div class="summary-value">${context === 'preview' ? 
                                `<span class="editable" data-field="calculations.discount" data-type="currency">-${formatCurrency(invoice.calculations.discount || 0)}<span class="edit-indicator"></span></span>` : 
                                `-${formatCurrency(invoice.calculations.discount || 0)}`
                            }</div>
                            
                            <div class="summary-label">Pajak</div>
                            <div class="summary-value">${context === 'preview' ? 
                                `<span class="editable" data-field="calculations.totalTax" data-type="currency">${formatCurrency(invoice.calculations.totalTax)}<span class="edit-indicator"></span></span>` : 
                                formatCurrency(invoice.calculations.totalTax)
                            }</div>
                            
                            <div class="summary-label">Biaya Kirim</div>
                            <div class="summary-value">${context === 'preview' ? 
                                `<span class="editable" data-field="calculations.shippingCost" data-type="currency">${formatCurrency(invoice.calculations.shippingCost)}<span class="edit-indicator"></span></span>` : 
                                formatCurrency(invoice.calculations.shippingCost)
                            }</div>
                            
                            <div class="summary-label total-label">TOTAL</div>
                            <div class="summary-value total-value">${formatCurrency(invoice.calculations.grandTotal)}</div>
                        </div>
                    </div>

                    <!-- Payment Schedule section -->
                    ${(() => {
                        try {
                            console.log(' Processing payment schedule - Context:', context);
                            console.log(' invoice.paymentSchedule:', invoice.paymentSchedule);
                            console.log(' invoice.payment_schedule_json:', invoice.payment_schedule_json);
                            
                            // Handle both direct object (preview) and JSON string (database) formats
                            let paymentSchedule = null;
                            if (invoice.paymentSchedule) {
                                // Direct object format (preview mode)
                                paymentSchedule = invoice.paymentSchedule;
                                console.log(' Using direct paymentSchedule object:', paymentSchedule);
                            } else if (invoice.payment_schedule_json) {
                                // JSON string format (database/view mode)
                                paymentSchedule = typeof invoice.payment_schedule_json === 'string' 
                                    ? JSON.parse(invoice.payment_schedule_json) 
                                    : invoice.payment_schedule_json;
                                console.log(' Parsed payment_schedule_json:', paymentSchedule);
                            } else {
                                console.log(' No payment schedule data found');
                            }
                            
                            if (paymentSchedule && paymentSchedule.scheduleType === 'down_payment') {
                                return `
                    <div class="payment-schedule-section" style="padding: 40px 32px; border-top: 1px solid var(--border); background: var(--bg);">
                        <h3 style="color: var(--text); font-size: 16px; font-weight: 600; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Jadwal Pembayaran
                        </h3>
                        <div class="payment-schedule-table" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                            <div style="background: var(--bg-light); padding: 18px 20px; border-bottom: 2px solid var(--border); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; font-weight: 700; font-size: 13px; color: var(--text); text-transform: uppercase; letter-spacing: 0.8px;">
                                <div>Jenis Pembayaran</div>
                                <div style="text-align: center;">Jatuh Tempo</div>
                                <div style="text-align: right;">Jumlah</div>
                            </div>
                            ${(() => {
                                // Show complete payment schedule with both phases
                                const finalAmount = invoice.final_payment_amount || paymentSchedule.remainingBalance.amount;
                                const currentStage = invoice.payment_stage || 'down_payment';
                                
                                // Determine status indicators
                                const getStatusIndicator = (phase) => {
                                    if (currentStage === 'completed' || (currentStage === 'final_payment' && phase === 'down_payment')) {
                                        return ''; // Completed
                                    } else if (currentStage === phase) {
                                        return ''; // Current/Pending
                                    } else {
                                        return ''; // Future/Locked
                                    }
                                };
                                
                                const getPhaseStyle = (phase) => {
                                    const baseStyle = "padding: 20px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; align-items: center;";
                                    
                                    if (currentStage === phase) {
                                        return baseStyle + " background: rgba(139, 95, 255, 0.05); border-left: 4px solid #8B5FFF;";
                                    } else if (currentStage === 'completed' || (currentStage === 'final_payment' && phase === 'down_payment')) {
                                        return baseStyle + " opacity: 0.7; background: rgba(72, 187, 120, 0.05);";
                                    } else {
                                        return baseStyle + " opacity: 0.6;";
                                    }
                                };
                                
                                return `
                                    <!-- Down Payment Row -->
                                    <div style="${getPhaseStyle('down_payment')}">
                                        <div style="font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 16px;">${getStatusIndicator('down_payment')}</span>
                                            ${(() => {
                                                const dp = paymentSchedule.downPayment;
                                                if (dp.type === 'fixed') {
                                                    return 'Uang Muka (Jumlah Tetap)';
                                                } else {
                                                    return `Uang Muka (${dp.percentage}%)`;
                                                }
                                            })()}
                                        </div>
                                        <div style="text-align: center; color: var(--text-light); font-size: 15px;">${context === 'preview' ? 
                                            `<span class="editable" data-field="paymentSchedule.downPayment.dueDate" data-type="date">${formatDate(paymentSchedule.downPayment.dueDate)}<span class="edit-indicator"></span></span>` : 
                                            formatDate(paymentSchedule.downPayment.dueDate)
                                        }</div>
                                        <div style="text-align: right; font-weight: 600; font-size: 16px; color: var(--text);">${context === 'preview' ? 
                                            `<span class="editable" data-field="paymentSchedule.downPayment.amount" data-type="currency">${formatCurrency(paymentSchedule.downPayment.amount)}<span class="edit-indicator"></span></span>` : 
                                            formatCurrency(paymentSchedule.downPayment.amount)
                                        }</div>
                                    </div>
                                    <!-- Remaining Payment Row -->
                                    <div style="${getPhaseStyle('final_payment')}">
                                        <div style="font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 16px;">${getStatusIndicator('final_payment')}</span>
                                            Sisa Pembayaran
                                        </div>
                                        <div style="text-align: center; color: var(--text-light); font-size: 15px;">${context === 'preview' ? 
                                            `<span class="editable" data-field="paymentSchedule.remainingBalance.dueDate" data-type="date">${formatDate(paymentSchedule.remainingBalance.dueDate)}<span class="edit-indicator"></span></span>` : 
                                            formatDate(paymentSchedule.remainingBalance.dueDate)
                                        }</div>
                                        <div style="text-align: right; font-weight: 600; font-size: 16px; color: var(--text);">${context === 'preview' ? 
                                            `<span class="editable" data-field="final_payment_amount" data-type="currency">${formatCurrency(finalAmount)}<span class="edit-indicator"></span></span>` : 
                                            formatCurrency(finalAmount)
                                        }</div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    `;
                            }
                            return '';
                        } catch (e) {
                            console.error('Error parsing payment schedule:', e);
                            return '';
                        }
                    })()}


                    <!-- Dynamic Premium/Aspree Footer -->
                    ${!hideAspreeBranding ? `
                        <div class="footer-band" style="background: linear-gradient(135deg, ${customFooterBgColor}, ${customFooterBgColor}aa); color: ${customFooterTextColor}; padding: 20px; margin-bottom: 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 32px; align-items: start; margin-bottom: 24px;">
                                <div class="footer-section">
                                    <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Syarat & Ketentuan</h4>
                                    <p style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.8;">${businessTerms}</p>
                                </div>
                                <div class="footer-section">
                                    <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Kontak</h4>
                                    <ul style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.8; list-style: none; padding: 0;">
                                        <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                            <span style="opacity: 0.7;"></span>
                                            ${businessProfile ? (businessProfile.phone || invoice.merchant_phone) : invoice.merchant_phone || '-'}
                                        </li>
                                        <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                            <span style="opacity: 0.7;"></span>
                                            ${businessProfile ? (businessProfile.email || invoice.merchant_email) : invoice.merchant_email || '-'}
                                        </li>
                                        ${businessProfile && businessProfile.website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;"></span>${businessProfile.website}</li>` : invoice.merchant_website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;"></span>${invoice.merchant_website}</li>` : ''}
                                    </ul>
                                </div>
                                <div class="footer-section" style="display: flex; align-items: flex-end; justify-content: flex-end; padding: 0; margin-bottom: -30px;">
                                    ${customFooterLogo ? 
                                        `<img src="${customFooterLogo}" alt="Footer Logo" style="height: 120px; width: auto; opacity: 0.9; object-fit: contain;">` :
                                        `<img src="/assets/aspri-logo.png" alt="aspree.id" style="height: 120px; width: auto; opacity: 0.9;">`
                                    }
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Return appropriate format based on context
            if (context === 'print') {
                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Faktur - ${invoice.header.invoiceNumber}</title>
                        <style>${getContextStyles(context)}</style>
                    </head>
                    <body>
                        ${cleanHTML}
                    </body>
                    </html>
                `;
            } else {
                return {
                    html: cleanHTML,
                    css: getContextStyles(context)
                };
            }
        }

        // DATA TRANSFORMATION FUNCTIONS
        // Transform flat database invoice to nested structure for template
        function transformInvoiceForTemplate(flatInvoice) {
            console.log(' Transforming flat invoice data to nested structure:', flatInvoice);
            
            // Parse items_json if it's a string
            let items = [];
            try {
                if (Array.isArray(flatInvoice.items_json)) {
                    items = flatInvoice.items_json;
                } else if (typeof flatInvoice.items_json === 'string') {
                    items = JSON.parse(flatInvoice.items_json);
                } else {
                    console.warn(' No valid items data found');
                    items = [];
                }
            } catch (error) {
                console.error(' Error parsing items_json:', error);
                items = [];
            }
            
            // Get business profile for merchant data
            let businessProfile = null;
            try {
                const savedProfile = localStorage.getItem('businessProfile');
                if (savedProfile) {
                    businessProfile = JSON.parse(savedProfile);
                }
            } catch (error) {
                console.warn(' Error parsing business profile:', error);
            }
            
            // Transform to nested structure expected by template
            const transformed = {
                invoice: {
                    header: {
                        invoiceNumber: flatInvoice.invoice_number,
                        invoiceDate: flatInvoice.invoice_date,
                        dueDate: flatInvoice.due_date
                    },
                    customer: {
                        name: flatInvoice.customer_name,
                        address: flatInvoice.customer_address,
                        phone: flatInvoice.customer_phone,
                        email: flatInvoice.customer_email
                    },
                    merchant: {
                        businessName: businessProfile?.name || businessProfile?.businessName || 'Your Business Name',
                        address: businessProfile?.address || 'Your Business Address',
                        phone: businessProfile?.phone || '',
                        email: businessProfile?.email || ''
                    },
                    items: items,
                    totals: {
                        subtotal: flatInvoice.subtotal,
                        tax: flatInvoice.tax_amount,
                        total: flatInvoice.total_amount,
                        discount: flatInvoice.discount || 0
                    },
                    // Additional fields that might be used
                    notes: flatInvoice.notes,
                    status: flatInvoice.status,
                    payment_stage: flatInvoice.payment_stage
                }
            };
            
            console.log(' Transformed invoice structure:', transformed);
            return transformed;
        }

        // Load business data from API and sync with localStorage for invoice generation
        async function loadBusinessDataFromAPI() {
            try {
                console.log(' Loading business data from API...');
                const response = await fetch('/api/business/settings', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                const settings = result.settings || result;
                
                if (settings) {
                    // Create business profile object for localStorage (used by invoice generation)
                    const businessProfile = {
                        name: settings.name || settings.businessName || 'Your Business Name',
                        email: settings.email || 'business@example.com',
                        phone: settings.phone || '+62 21 1234 5678',
                        address: settings.address || 'Your Business Address',
                        website: settings.website || '',
                        taxId: settings.taxId || '',
                        taxRate: settings.taxRate || 0,
                        taxEnabled: settings.taxEnabled || false,
                        taxName: settings.taxName || 'PPN',
                        taxDescription: settings.taxDescription || '',
                        logo: settings.logoUrl || '',  // Add logo field that template looks for
                        logoUrl: settings.logoUrl || null,
                        category: settings.category || 'general',
                        termsAndConditions: settings.termsAndConditions || 'Pembayaran dalam 30 hari',
                        hideBusinessName: settings.hideBusinessName || false  // Add hide business name setting
                    };
                    
                    // Update localStorage for invoice generation
                    localStorage.setItem('businessProfile', JSON.stringify(businessProfile));
                    
                    console.log(' Business data loaded and synced:', businessProfile);
                } else {
                    console.log(' No business settings found, using defaults');
                }
            } catch (error) {
                console.error(' Error loading business data:', error);
                // Keep existing hardcoded values as fallback
            }
        }

        // Plan Status Management
        async function loadPlanStatus() {
            try {
                const response = await fetch('/api/business/settings', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.settings) {
                    updatePlanStatusUI(data.settings.premiumActive === true);
                } else {
                    // Default to free plan
                    updatePlanStatusUI(false);
                }
            } catch (error) {
                console.error('Error loading plan status:', error);
                updatePlanStatusUI(false);
            }
        }

        function updatePlanStatusUI(isPremium) {
            const planBadge = document.getElementById('planBadge');
            const planText = document.getElementById('planText');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const manageBtn = document.getElementById('manageBtn');

            if (isPremium) {
                planBadge.className = 'plan-badge premium';
                planBadge.querySelector('span:first-child').textContent = '';
                planText.textContent = 'PREMIUM';
                upgradeBtn.style.display = 'none';
                manageBtn.style.display = 'flex';
            } else {
                planBadge.className = 'plan-badge free';
                planBadge.querySelector('span:first-child').textContent = '';
                planText.textContent = 'FREE';
                upgradeBtn.style.display = 'flex';
                manageBtn.style.display = 'none';
            }
        }

        function showUpgradeModal() {
            document.getElementById('premiumModal').style.display = 'block';
        }

        function closePremiumModal() {
            document.getElementById('premiumModal').style.display = 'none';
        }

        function upgradeToPremium() {
            // For now, redirect to business settings where we'll add premium controls
            // In the future, this could integrate with a payment processor
            window.location.href = '/business-settings#premium';
        }

        function showManageSubscription() {
            // For now, redirect to business settings
            window.location.href = '/business-settings#premium';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const premiumModal = document.getElementById('premiumModal');
            if (event.target === premiumModal) {
                closePremiumModal();
            }
        }

        // Load user info from account settings
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/account-settings');
                const settings = await response.json();
                
                if (settings && (settings.businessOwnerName || settings.fullName || settings.name)) {
                    const userName = settings.businessOwnerName || settings.fullName || settings.name;
                    const userInfoDiv = document.querySelector('.user-info div div');
                    if (userInfoDiv) {
                        userInfoDiv.textContent = userName;
                    }
                    
                    // Update user avatar with initials
                    const avatar = document.querySelector('.user-avatar');
                    if (avatar && userName) {
                        const initials = userName.split(' ')
                            .filter(word => word.length > 0)
                            .map(word => word.charAt(0).toUpperCase())
                            .slice(0, 2)
                            .join('');
                        avatar.textContent = initials;
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadCategories();
            setupEventListeners();
            refreshInvoiceNumber();
            loadUserInfo();
            loadPlanStatus();
            
            // Handle URL hash navigation
            const hash = window.location.hash.substring(1);
            if (hash && ['products', 'orders', 'invoices', 'customers', 'inventory', 'categories'].includes(hash)) {
                showSection(hash);
            } else {
                showSection('products'); // Default to products section
            }
        });

        function setupEventListeners() {
            // Navigation buttons - replace onclick handlers
            const navButtons = document.querySelectorAll('.nav-btn[onclick]');
            navButtons.forEach(button => {
                const onclickAttr = button.getAttribute('onclick');
                if (onclickAttr) {
                    // Extract function call from onclick attribute
                    const match = onclickAttr.match(/showSection\('([^']+)'\)/);
                    if (match) {
                        const section = match[1];
                        button.addEventListener('click', () => showSection(section));
                        button.removeAttribute('onclick');
                    }
                }
            });
            
            // Other buttons with onclick handlers
            const otherButtons = document.querySelectorAll('button[onclick]');
            otherButtons.forEach(button => {
                const onclickAttr = button.getAttribute('onclick');
                if (onclickAttr) {
                    button.addEventListener('click', function() {
                        // Use eval for complex onclick handlers (temporary solution)
                        try {
                            eval(onclickAttr);
                        } catch (error) {
                            console.error('Error executing onclick handler:', error);
                        }
                    });
                    button.removeAttribute('onclick');
                }
            });
            
            document.getElementById('category-filter').addEventListener('change', filterProducts);
            document.getElementById('status-filter').addEventListener('change', filterProducts);
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            
            // Order event listeners
            document.getElementById('order-status-filter').addEventListener('change', filterOrders);
            // Note: Date inputs no longer have automatic change listeners - use Apply button instead
            
            // Invoice event listeners
            document.getElementById('invoice-search').addEventListener('input', filterInvoices);
            document.getElementById('invoice-status-filter').addEventListener('change', filterInvoices);
            
            // Customer event listeners
            document.getElementById('customer-search').addEventListener('input', filterCustomers);
            
            // Status modal event listeners
            document.getElementById('statusForm').addEventListener('submit', handleStatusUpdate);
            document.getElementById('new-status').addEventListener('change', function() {
                toggleTrackingField(this.value);
            });
        }
        
        async function handleStatusUpdate(e) {
            e.preventDefault();
            
            if (!currentOrderId) {
                alert('No order selected');
                return;
            }
            
            const newStatus = document.getElementById('new-status').value;
            const trackingNumber = document.getElementById('tracking-number').value;
            
            if (!newStatus) {
                alert('Please select a status');
                return;
            }
            
            await updateOrderStatus(currentOrderId, newStatus, trackingNumber);
            closeStatusModal();
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                if (data.success) {
                    products = data.products;
                    displayProducts(products);
                    updateStats();
                } else {
                    showError('Failed to load products: ' + data.error);
                }
            } catch (error) {
                showError('Error loading products: ' + error.message);
            } finally {
                document.getElementById('products-loading').style.display = 'none';
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch('/api/products/categories');
                const data = await response.json();
                
                if (data.success) {
                    categories = data.categories;
                    updateCategoryFilter();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function updateCategoryFilter() {
            const select = document.getElementById('category-filter');
            select.innerHTML = '<option value="">All Categories</option>';
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.category;
                option.textContent = `${cat.category} (${cat.count})`;
                select.appendChild(option);
            });
        }

        function displayProducts(productsToShow) {
            const container = document.getElementById('products-grid');
            container.innerHTML = '';

            if (productsToShow.length === 0) {
                container.innerHTML = '<div class="loading">No products found</div>';
                return;
            }

            // Group products by category
            const groupedProducts = groupProductsByCategory(productsToShow);
            
            // Display each category group
            Object.keys(groupedProducts).forEach(categoryKey => {
                const categoryGroup = createProductCategoryGroup(categoryKey, groupedProducts[categoryKey]);
                container.appendChild(categoryGroup);
            });
        }

        function groupProductsByCategory(products) {
            const groups = {};
            
            products.forEach(product => {
                const category = product.category || 'Uncategorized';
                
                if (!groups[category]) {
                    groups[category] = {
                        displayName: category,
                        products: []
                    };
                }
                groups[category].products.push(product);
            });
            
            // Sort each group's products by name
            Object.keys(groups).forEach(key => {
                groups[key].products.sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));
            });
            
            return groups;
        }

        function createProductCategoryGroup(categoryKey, group) {
            const categoryGroup = document.createElement('div');
            categoryGroup.className = 'product-category-group';
            
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-group-header';
            categoryHeader.innerHTML = `
                <h3>${group.displayName}</h3>
                <span class="product-count">${group.products.length} product${group.products.length !== 1 ? 's' : ''}</span>
            `;
            
            const productsList = document.createElement('div');
            productsList.className = 'products-list';
            
            group.products.forEach(product => {
                const listItem = createProductListItem(product);
                productsList.appendChild(listItem);
            });
            
            categoryGroup.appendChild(categoryHeader);
            categoryGroup.appendChild(productsList);
            
            return categoryGroup;
        }

        function createProductListItem(product) {
            const listItem = document.createElement('div');
            listItem.className = 'product-list-item';
            
            const stockStatus = getStockStatus(product.stock_quantity, product.min_stock_level);
            const priceFormatted = formatCurrency(product.unit_price);
            
            // Product image or placeholder
            const productImage = product.image_url 
                ? `<img src="${product.image_url}" alt="${product.product_name}" class="product-image">` 
                : '<div class="product-image-placeholder"></div>';
            
            listItem.innerHTML = `
                <div class="product-list-content">
                    <div class="product-image-container">
                        ${productImage}
                    </div>
                    
                    <div class="product-main-info">
                        <div class="product-header">
                            <div class="product-name">
                                <strong>${product.product_name || 'Unnamed Product'}</strong>
                                ${product.sku ? `<span class="product-sku">SKU: ${product.sku}</span>` : ''}
                            </div>
                            <div class="product-status">
                                <span class="stock-badge ${stockStatus.class}">${stockStatus.text}</span>
                            </div>
                        </div>
                        
                        <div class="product-details">
                            <div class="product-info">
                                <span class="product-price">${priceFormatted}</span>
                                <span class="product-description">${product.description || 'No description'}</span>
                            </div>
                            
                            <div class="product-meta">
                                <span class="stock-info"> Stock: ${product.stock_quantity || 0}</span>
                                ${product.min_stock_level > 0 ? `<span class="min-stock"> Min: ${product.min_stock_level}</span>` : ''}
                                <span class="product-active">${product.active ? ' Active' : ' Inactive'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="product-actions">
                        ${getProductActionButtons(product)}
                    </div>
                </div>
            `;
            
            return listItem;
        }

        function getProductActionButtons(product) {
            let actions = [];

            // Edit button - always available
            actions.push(`<button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})" title="Edit product details"> Edit</button>`);

            // Stock button - always available
            actions.push(`<button class="btn btn-sm btn-warning" onclick="updateStock(${product.id})" title="Update stock quantity"> Stock</button>`);

            // Delete button - always available
            actions.push(`<button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Delete this product"> Delete</button>`);

            return actions.join('');
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const stockStatus = getStockStatus(product.stock_quantity, product.min_stock_level);
            const priceFormatted = formatCurrency(product.unit_price);
            
            card.innerHTML = `
                <div class="product-header">
                    <div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-sku">SKU: ${product.sku}</div>
                    </div>
                    <div class="stock-badge ${stockStatus.class}">${stockStatus.text}</div>
                </div>
                <div class="product-price">${priceFormatted}</div>
                <div class="product-stock">
                    <span>Stock: ${product.stock_quantity}</span>
                    ${product.min_stock_level > 0 ? `<span>(Min: ${product.min_stock_level})</span>` : ''}
                </div>
                <div>Category: ${product.category || 'Uncategorized'}</div>
                <div class="product-actions">
                    <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">Edit</button>
                    <button class="btn btn-sm btn-warning" onclick="updateStock(${product.id})">Stock</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                </div>
            `;
            
            return card;
        }

        function getStockStatus(stock, minStock) {
            if (stock <= 0) {
                return { class: 'stock-out', text: 'Out of Stock' };
            } else if (stock <= minStock) {
                return { class: 'stock-low', text: 'Low Stock' };
            } else {
                return { class: 'stock-high', text: 'In Stock' };
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function updateStats() {
            const totalProducts = products.length;
            const activeProducts = products.filter(p => p.is_active).length;
            const lowStockProducts = products.filter(p => p.stock_quantity <= p.min_stock_level).length;
            const totalCategories = [...new Set(products.map(p => p.category).filter(c => c))].length;

            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('active-products').textContent = activeProducts;
            document.getElementById('low-stock-products').textContent = lowStockProducts;
            document.getElementById('total-categories').textContent = totalCategories;
        }

        function filterProducts() {
            const categoryFilter = document.getElementById('category-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            let filtered = products;
            
            if (categoryFilter) {
                filtered = filtered.filter(p => p.category === categoryFilter);
            }
            
            if (statusFilter === 'true') {
                filtered = filtered.filter(p => p.is_active);
            }
            
            displayProducts(filtered);
        }

        // Duplicate showSection function removed - kept the original at line 3091

        // Order Management Functions
        async function loadOrders() {
            try {
                const statusFilter = document.getElementById('order-status-filter').value;
                const dateFrom = document.getElementById('order-date-from').value;
                const dateTo = document.getElementById('order-date-to').value;
                
                let url = '/api/orders?limit=100';
                if (statusFilter) url += `&status=${statusFilter}`;
                if (dateFrom) url += `&dateFrom=${dateFrom}`;
                if (dateTo) url += `&dateTo=${dateTo}`;
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    orders = data.orders;
                    displayOrders(orders);
                    // Also try to load stats (with fallback to manual calculation)
                    loadOrderStats();
                } else {
                    showOrderError('Failed to load orders: ' + data.error);
                }
            } catch (error) {
                showOrderError('Error loading orders: ' + error.message);
            } finally {
                document.getElementById('orders-loading').style.display = 'none';
            }
        }

        async function loadOrderStats() {
            try {
                // Get current date filter values
                const dateFrom = document.getElementById('order-date-from').value;
                const dateTo = document.getElementById('order-date-to').value;
                
                // Build URL with date filters
                let url = '/api/orders/stats';
                const params = new URLSearchParams();
                if (dateFrom) params.append('dateFrom', dateFrom);
                if (dateTo) params.append('dateTo', dateTo);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    console.warn('Orders stats endpoint not available:', response.status);
                    // Calculate stats from orders data as fallback
                    calculateOrderStatsFromData();
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // Update elements if they exist
                    const updateElement = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                        }
                    };
                    
                    updateElement('total-orders', stats.total_orders || 0);
                    updateElement('pending-orders', stats.pending_orders || 0);
                    updateElement('shipped-orders', stats.shipped_orders || 0);
                    updateElement('delivered-orders', stats.delivered_orders || 0);
                    updateElement('total-order-value', formatCurrency(stats.total_order_value || 0));
                } else {
                    // Fallback to manual calculation
                    calculateOrderStatsFromData();
                }
            } catch (error) {
                console.error('Error loading order stats:', error);
                // Fallback to manual calculation
                calculateOrderStatsFromData();
            }
        }

        function calculateOrderStatsFromData() {
            if (!orders || orders.length === 0) {
                console.log(' No orders data available for stats calculation');
                return;
            }

            console.log(' Calculating order stats from', orders.length, 'orders');

            // Improved total value calculation with multiple field fallbacks and validation
            let totalValue = 0;
            let processedOrders = 0;
            let skippedOrders = 0;
            
            const totalOrderValue = orders.reduce((sum, order, index) => {
                // Try multiple field names and parsing approaches
                let orderAmount = 0;
                
                // Primary field attempts with validation
                if (order.total_amount !== undefined && order.total_amount !== null) {
                    orderAmount = parseFloat(order.total_amount) || 0;
                } else if (order.grand_total !== undefined && order.grand_total !== null) {
                    orderAmount = parseFloat(order.grand_total) || 0;
                } else if (order.subtotal !== undefined && order.subtotal !== null) {
                    orderAmount = parseFloat(order.subtotal) || 0;
                } else if (order.amount !== undefined && order.amount !== null) {
                    orderAmount = parseFloat(order.amount) || 0;
                }
                
                // Validate the amount is reasonable
                if (orderAmount > 0 && orderAmount < 1000000000) { // Less than 1B IDR seems reasonable
                    processedOrders++;
                    return sum + orderAmount;
                } else {
                    skippedOrders++;
                    console.warn(` Order ${index + 1} (ID: ${order.id}) has invalid amount:`, {
                        total_amount: order.total_amount,
                        grand_total: order.grand_total,
                        subtotal: order.subtotal,
                        amount: order.amount,
                        calculated: orderAmount
                    });
                    return sum;
                }
            }, 0);

            console.log(` Order value calculation complete:`, {
                totalOrders: orders.length,
                processedOrders,
                skippedOrders,
                totalValue: totalOrderValue,
                formatted: formatCurrency(totalOrderValue)
            });

            const stats = {
                total_orders: orders.length,
                pending_orders: orders.filter(o => o.status === 'pending').length,
                shipped_orders: orders.filter(o => o.status === 'shipped').length,
                delivered_orders: orders.filter(o => o.status === 'delivered').length,
                total_order_value: totalOrderValue
            };

            // Update elements if they exist
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(` Updated ${id} with value:`, value);
                } else {
                    console.warn(` Element ${id} not found`);
                }
            };

            updateElement('total-orders', stats.total_orders);
            updateElement('pending-orders', stats.pending_orders);
            updateElement('shipped-orders', stats.shipped_orders);
            updateElement('delivered-orders', stats.delivered_orders);
            updateElement('total-order-value', formatCurrency(stats.total_order_value));
        }

        function displayOrders(ordersToShow) {
            const container = document.getElementById('orders-grid');
            container.innerHTML = '';

            if (ordersToShow.length === 0) {
                container.innerHTML = '<div class="loading">No orders found</div>';
                return;
            }

            // Group orders by date
            const groupedOrders = groupOrdersByDate(ordersToShow);
            
            // Display each date group
            Object.keys(groupedOrders).forEach(dateKey => {
                const dateGroup = createOrderDateGroup(dateKey, groupedOrders[dateKey]);
                container.appendChild(dateGroup);
            });
        }

        function groupOrdersByDate(orders) {
            const groups = {};
            
            orders.forEach(order => {
                const orderDate = new Date(order.order_date);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateKey;
                let sortKey;
                
                // Determine the date group key
                if (isSameDay(orderDate, today)) {
                    dateKey = 'Today';
                    sortKey = '1-today';
                } else if (isSameDay(orderDate, yesterday)) {
                    dateKey = 'Yesterday';
                    sortKey = '2-yesterday';
                } else if (isThisWeek(orderDate)) {
                    dateKey = formatDateGroup(orderDate, 'this-week');
                    sortKey = '3-' + formatDate(order.order_date);
                } else if (isThisMonth(orderDate)) {
                    dateKey = formatDateGroup(orderDate, 'this-month');
                    sortKey = '4-' + formatDate(order.order_date);
                } else {
                    dateKey = formatDateGroup(orderDate, 'older');
                    sortKey = '5-' + formatDate(order.order_date);
                }
                
                if (!groups[sortKey]) {
                    groups[sortKey] = {
                        displayName: dateKey,
                        orders: []
                    };
                }
                groups[sortKey].orders.push(order);
            });
            
            // Sort each group's orders by date (newest first)
            Object.keys(groups).forEach(key => {
                groups[key].orders.sort((a, b) => new Date(b.order_date) - new Date(a.order_date));
            });
            
            return groups;
        }

        function createOrderDateGroup(sortKey, group) {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'order-date-group';
            
            const dateHeader = document.createElement('div');
            dateHeader.className = 'date-group-header';
            dateHeader.innerHTML = `
                <h3>${group.displayName}</h3>
                <span class="order-count">${group.orders.length} order${group.orders.length !== 1 ? 's' : ''}</span>
            `;
            
            const ordersList = document.createElement('div');
            ordersList.className = 'orders-list';
            
            group.orders.forEach(order => {
                const listItem = createOrderListItem(order);
                ordersList.appendChild(listItem);
            });
            
            dateGroup.appendChild(dateHeader);
            dateGroup.appendChild(ordersList);
            
            return dateGroup;
        }

        function createOrderListItem(order) {
            const listItem = document.createElement('div');
            listItem.className = 'order-list-item';
            
            const statusClass = getOrderStatusClass(order.status);
            const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
            const totalFormatted = formatCurrency(order.total_amount);
            
            // Get status icon
            const statusIcon = getOrderStatusIcon(order.status);
            
            listItem.innerHTML = `
                <div class="order-list-content">
                    <div class="order-selection" style="display: none;">
                        <input type="checkbox" onchange="toggleOrderSelection(${order.id}, this.checked)" style="margin-right: 15px;">
                    </div>
                    
                    <div class="order-main-info">
                        <div class="order-header">
                            <div class="order-number">
                                <strong>#${order.order_number}</strong>
                                ${order.tracking_number ? `<span class="tracking-badge"> ${order.tracking_number}</span>` : ''}
                            </div>
                            <div class="order-status">
                                <span class="status-badge ${statusClass}">${statusIcon} ${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="order-details">
                            <div class="order-customer">
                                <span class="customer-name"> ${order.customer_name}</span>
                                <span class="customer-email">${order.customer_email}</span>
                            </div>
                            
                            <div class="order-meta">
                                <span class="order-date"> ${formatDate(order.order_date)}</span>
                                <span class="order-items"> ${order.total_items || 'N/A'} items</span>
                                <span class="order-amount">${totalFormatted}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-actions">
                        ${getOrderActionButtons(order)}
                    </div>
                </div>
            `;
            
            return listItem;
        }

        function getOrderStatusIcon(status) {
            const icons = {
                'pending': '',
                'shipped': '',
                'delivered': ''
            };
            return icons[status] || '';
        }

        function getOrderActionButtons(order) {
            let actions = [];

            // View Ticket button - always available
            actions.push(`<button class="btn btn-sm btn-info" onclick="printServiceTicket(${order.id})" title="View service ticket"> View Ticket</button>`);

            // Status button - always available
            actions.push(`<button class="btn btn-sm btn-warning" onclick="updateOrderStatusModal(${order.id})" title="Update order status"> Status</button>`);

            // Convert to Invoice button - only for delivered orders
            if (order.status === 'delivered') {
                actions.push(`<button class="btn btn-sm btn-success" onclick="convertToInvoice(${order.id})" title="Convert to invoice">  Invoice</button>`);
            }

            // Delete button - always available
            actions.push(`<button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})" title="Delete this order"> Delete</button>`);

            return actions.join('');
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const statusClass = getOrderStatusClass(order.status);
            const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
            const totalFormatted = formatCurrency(order.total_amount);
            
            card.innerHTML = `
                <div class="product-header">
                    <div>
                        <div class="product-name">${order.order_number}</div>
                        <div class="product-sku">Customer: ${order.customer_name}</div>
                    </div>
                    <div class="stock-badge ${statusClass}">${statusText}</div>
                </div>
                <div class="product-price">${totalFormatted}</div>
                <div class="product-stock">
                    <span>Date: ${formatDate(order.order_date)}</span>
                </div>
                <div>Email: ${order.customer_email}</div>
                ${order.tracking_number ? `<div>Tracking: ${order.tracking_number}</div>` : ''}
                <div class="product-actions">
                    <input type="checkbox" onchange="toggleOrderSelection(${order.id}, this.checked)" style="margin-right: 0.5rem;">
                    <button class="btn btn-sm btn-info" onclick="printServiceTicket(${order.id})"> View Ticket</button>
                    <button class="btn btn-sm btn-warning" onclick="updateOrderStatusModal(${order.id})">Status</button>
                    ${order.status === 'delivered' ? `<button class="btn btn-sm btn-success" onclick="convertToInvoice(${order.id})"> Invoice</button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
                </div>
            `;
            
            return card;
        }

        function getOrderStatusClass(status) {
            const statusClasses = {
                'pending': 'stock-low',
                'shipped': 'stock-medium', 
                'delivered': 'stock-high'
            };
            return statusClasses[status] || 'stock-low';
        }

        function filterOrders() {
            loadOrders();
        }

        function applyDateFilters() {
            const dateFrom = document.getElementById('order-date-from').value;
            const dateTo = document.getElementById('order-date-to').value;
            
            // Validate date range
            if (dateFrom && dateTo) {
                const fromDate = new Date(dateFrom);
                const toDate = new Date(dateTo);
                
                if (fromDate > toDate) {
                    alert('Start date cannot be after end date. Please correct the date range.');
                    return;
                }
            }
            
            // Visual feedback - show loading state
            const applyBtn = document.getElementById('apply-date-filters-btn');
            const originalText = applyBtn.innerHTML;
            applyBtn.innerHTML = ' Applying...';
            applyBtn.disabled = true;
            
            // Apply the filters
            filterOrders();
            
            // Reset button after a delay
            setTimeout(() => {
                applyBtn.innerHTML = originalText;
                applyBtn.disabled = false;
            }, 1000);
            
            // Show applied filter info
            showDateFilterStatus();
        }

        function clearDateFilters() {
            document.getElementById('order-date-from').value = '';
            document.getElementById('order-date-to').value = '';
            
            // Automatically apply the cleared filters
            applyDateFilters();
        }

        function showDateFilterStatus() {
            const dateFrom = document.getElementById('order-date-from').value;
            const dateTo = document.getElementById('order-date-to').value;
            
            // Remove existing status if any
            const existingStatus = document.getElementById('date-filter-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (dateFrom || dateTo) {
                let statusText = ' Active filters: ';
                if (dateFrom && dateTo) {
                    statusText += `${dateFrom} to ${dateTo}`;
                } else if (dateFrom) {
                    statusText += `From ${dateFrom}`;
                } else {
                    statusText += `Until ${dateTo}`;
                }
                
                const statusDiv = document.createElement('div');
                statusDiv.id = 'date-filter-status';
                statusDiv.style.cssText = `
                    background: #e3f2fd; 
                    color: #1976d2; 
                    padding: 0.5rem 1rem; 
                    margin: 0.5rem 0; 
                    border-radius: 4px; 
                    font-size: 0.9rem;
                    border-left: 4px solid #1976d2;
                `;
                statusDiv.innerHTML = statusText;
                
                const filtersDiv = document.querySelector('#orders-section .filters');
                filtersDiv.parentNode.insertBefore(statusDiv, filtersDiv.nextSibling);
            }
        }


        async function viewOrder(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const data = await response.json();
                
                if (data.success) {
                    showOrderModal(data.order);
                } else {
                    alert('Failed to load order details: ' + data.error);
                }
            } catch (error) {
                alert('Error loading order details: ' + error.message);
            }
        }

        let currentOrderId = null;

        async function updateOrderStatusModal(orderId) {
            currentOrderId = orderId;
            
            // Load order details to display in modal
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const data = await response.json();
                
                if (data.success) {
                    const order = data.order;
                    document.getElementById('current-order-number').textContent = order.order_number || `#${order.id}`;
                    document.getElementById('current-customer-name').textContent = order.customer_name || 'Unknown Customer';
                    document.getElementById('new-status').value = order.status || 'pending';
                    document.getElementById('tracking-number').value = order.tracking_number || '';
                    
                    // Show/hide tracking number field based on current status
                    toggleTrackingField(order.status);
                } else {
                    throw new Error(data.error || 'Failed to load order');
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                document.getElementById('current-order-number').textContent = `Order #${orderId}`;
                document.getElementById('current-customer-name').textContent = 'Error loading customer';
            }
            
            document.getElementById('statusModal').style.display = 'block';
        }

        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
            currentOrderId = null;
        }

        function toggleTrackingField(status) {
            const trackingGroup = document.getElementById('tracking-group');
            trackingGroup.style.display = status === 'shipped' ? 'block' : 'none';
        }

        async function updateOrderStatus(orderId, status, trackingNumber = '') {
            try {
                const payload = { status };
                if (trackingNumber) payload.tracking_number = trackingNumber;
                
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Order status updated successfully!');
                    loadOrders();
                    loadOrderStats();
                } else {
                    showError('Failed to update order status: ' + data.error);
                }
            } catch (error) {
                showError('Error updating order status: ' + error.message);
            }
        }

        async function convertToInvoice(orderId) {
            if (!confirm('Convert this order to an invoice?')) return;
            
            try {
                const response = await fetch(`/api/orders/${orderId}/convert-to-invoice`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Order converted to invoice: ${data.invoice.invoiceNumber}`);
                    loadOrders();
                    loadOrderStats();
                } else {
                    showError('Failed to convert order: ' + data.error);
                }
            } catch (error) {
                showError('Error converting order: ' + error.message);
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            try {
                const response = await fetch(`/api/orders/${orderId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Order deleted successfully!');
                    loadOrders();
                    loadOrderStats();
                } else {
                    showError('Failed to delete order: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting order: ' + error.message);
            }
        }

        function openBulkUpdateModal() {
            if (selectedOrders.length === 0) {
                alert('Please select orders to update');
                return;
            }
            
            const newStatus = prompt(`Update ${selectedOrders.length} orders to status (pending, processing, shipped, delivered, cancelled):`);
            if (!newStatus) return;
            
            const validStatuses = ['pending', 'processing', 'shipped', 'delivered', 'cancelled'];
            if (!validStatuses.includes(newStatus)) {
                alert('Invalid status. Valid options: ' + validStatuses.join(', '));
                return;
            }
            
            bulkUpdateOrderStatus(newStatus);
        }

        async function bulkUpdateOrderStatus(status) {
            try {
                const response = await fetch('/api/orders/bulk/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderIds: selectedOrders, status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`${data.updatedCount} orders updated to ${status}`);
                    selectedOrders = [];
                    loadOrders();
                    loadOrderStats();
                } else {
                    showError('Failed to bulk update orders: ' + data.error);
                }
            } catch (error) {
                showError('Error bulk updating orders: ' + error.message);
            }
        }

        function showOrderError(message) {
            const errorDiv = document.getElementById('orders-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showOrderModal(order) {
            // Simple order view modal - you can enhance this
            const modalContent = `
                <h3>Order ${order.order_number}</h3>
                <p><strong>Customer:</strong> ${order.customer_name} (${order.customer_email})</p>
                <p><strong>Status:</strong> ${order.status}</p>
                <p><strong>Total:</strong> ${formatCurrency(order.total_amount)}</p>
                <p><strong>Date:</strong> ${formatDate(order.order_date)}</p>
                ${order.tracking_number ? `<p><strong>Tracking:</strong> ${order.tracking_number}</p>` : ''}
                <h4>Items:</h4>
                <ul>
                    ${order.items.map(item => `<li>${item.quantity}x ${item.product_name} - ${formatCurrency(item.line_total)}</li>`).join('')}
                </ul>
            `;
            
            alert(modalContent.replace(/<[^>]*>/g, '\n')); // Simple alert for now
        }

        function openAddOrderModal() {
            alert('Add Order functionality would open a form modal here. This feature can be implemented based on your specific needs.');
        }

        async function seedOrders() {
            if (!confirm('This will add sample orders to your system. Continue?')) return;

            try {
                console.log('Attempting to seed orders...');
                const response = await fetch('/api/orders/seed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showSuccess(data.message);
                    loadOrders();
                    loadOrderStats();
                } else {
                    showError('Failed to seed orders: ' + data.error);
                }
            } catch (error) {
                console.error('Error seeding orders:', error);
                showError('Error seeding orders: ' + error.message);
            }
        }

        function openAddProductModal() {
            currentProduct = null;
            document.getElementById('modal-title').textContent = 'Add New Product';
            document.getElementById('productForm').reset();
            document.getElementById('product-active').checked = true;
            document.getElementById('productModal').style.display = 'block';
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            // Validate required fields
            const nameField = document.getElementById('product-name');
            const skuField = document.getElementById('product-sku');
            const priceField = document.getElementById('product-price');
            
            if (!nameField.value.trim()) {
                showError('Product name is required');
                nameField.focus();
                return;
            }
            
            if (!skuField.value.trim()) {
                showError('SKU is required');
                skuField.focus();
                return;
            }
            
            if (!priceField.value || parseFloat(priceField.value) <= 0) {
                showError('Valid unit price is required');
                priceField.focus();
                return;
            }
            
            const formData = {
                name: nameField.value.trim(),
                sku: skuField.value.trim().toUpperCase(),
                category: document.getElementById('product-category').value.trim(),
                description: document.getElementById('product-description').value.trim(),
                unit_price: parseFloat(priceField.value),
                cost_price: parseFloat(document.getElementById('product-cost').value) || 0,
                stock_quantity: parseInt(document.getElementById('product-stock').value) || 0,
                min_stock_level: parseInt(document.getElementById('product-min-stock').value) || 0,
                tax_rate: parseFloat(document.getElementById('product-tax').value) || 0,
                weight: parseFloat(document.getElementById('product-weight').value) || null,
                dimensions: document.getElementById('product-dimensions').value.trim(),
                image_url: document.getElementById('product-image').value.trim(),
                is_active: document.getElementById('product-active').checked
            };

            console.log('Submitting product data:', formData);

            try {
                const url = currentProduct ? `/api/products/${currentProduct.id}` : '/api/products';
                const method = currentProduct ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showSuccess(currentProduct ? 'Product updated successfully!' : 'Product created successfully!');
                    closeProductModal();
                    loadProducts();
                    loadCategories();
                } else {
                    showError('Failed to save product: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showError('Error saving product: ' + error.message);
            }
        }

        async function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            currentProduct = product;
            document.getElementById('modal-title').textContent = 'Edit Product';
            
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-sku').value = product.sku;
            document.getElementById('product-category').value = product.category || '';
            document.getElementById('product-description').value = product.description || '';
            document.getElementById('product-price').value = product.unit_price;
            document.getElementById('product-cost').value = product.cost_price;
            document.getElementById('product-stock').value = product.stock_quantity;
            document.getElementById('product-min-stock').value = product.min_stock_level;
            document.getElementById('product-tax').value = product.tax_rate;
            document.getElementById('product-weight').value = product.weight || '';
            document.getElementById('product-dimensions').value = product.dimensions || '';
            document.getElementById('product-image').value = product.image_url || '';
            document.getElementById('product-active').checked = product.is_active;
            
            document.getElementById('productModal').style.display = 'block';
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                const response = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Product deleted successfully!');
                    loadProducts();
                    loadCategories();
                } else {
                    showError('Failed to delete product: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting product: ' + error.message);
            }
        }

        function updateStock(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const newStock = prompt(`Update stock for ${product.name}\nCurrent stock: ${product.stock_quantity}`, product.stock_quantity);
            if (newStock === null) return;

            const quantity = parseInt(newStock);
            if (isNaN(quantity) || quantity < 0) {
                alert('Please enter a valid stock quantity');
                return;
            }

            updateProductStock(productId, quantity);
        }

        async function updateProductStock(productId, quantity) {
            try {
                const response = await fetch(`/api/products/${productId}/stock`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ quantity })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Stock updated successfully!');
                    loadProducts();
                } else {
                    showError('Failed to update stock: ' + data.error);
                }
            } catch (error) {
                showError('Error updating stock: ' + error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('products-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.container').insertBefore(successDiv, document.querySelector('.section'));
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        async function seedProducts() {
            if (!confirm('This will add sample products to your catalog. Continue?')) return;

            try {
                const response = await fetch('/api/seed-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    loadProducts();
                    loadCategories();
                } else {
                    showError('Failed to seed products: ' + data.error);
                }
            } catch (error) {
                showError('Error seeding products: ' + error.message);
            }
        }

        async function refreshInvoiceNumber() {
            try {
                const nextInvoiceElement = document.getElementById('next-invoice-number');
                if (!nextInvoiceElement) {
                    // Element doesn't exist, skip this function
                    return;
                }
                
                const response = await fetch('/api/test-db');
                const data = await response.json();
                
                if (data.success) {
                    nextInvoiceElement.textContent = data.nextInvoiceNumber;
                } else {
                    nextInvoiceElement.textContent = 'Error loading';
                }
            } catch (error) {
                console.error('Error fetching next invoice number:', error);
                const nextInvoiceElement = document.getElementById('next-invoice-number');
                if (nextInvoiceElement) {
                    nextInvoiceElement.textContent = 'Error loading';
                }
            }
        }

        // Invoice Management Functions
        let selectedInvoices = [];
        let invoiceSelectionMode = false;

        async function loadInvoices(dateFrom = null, dateTo = null) {
            try {
                document.getElementById('invoices-loading').style.display = 'block';
                const searchTerm = document.getElementById('invoice-search').value;
                const statusFilter = document.getElementById('invoice-status-filter').value;
                
                let url = '/api/invoices?limit=100';
                if (statusFilter) url += `&status=${statusFilter}`;
                if (searchTerm) url += `&customerEmail=${searchTerm}`;
                if (dateFrom) url += `&dateFrom=${dateFrom}`;
                if (dateTo) url += `&dateTo=${dateTo}`;
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    invoices = data.invoices;
                    displayInvoices(invoices);
                } else {
                    showInvoiceError('Failed to load invoices: ' + data.error);
                }
            } catch (error) {
                showInvoiceError('Error loading invoices: ' + error.message);
            } finally {
                document.getElementById('invoices-loading').style.display = 'none';
            }
        }

        function applyInvoiceDateFilters() {
            const dateFrom = document.getElementById('invoice-date-from').value;
            const dateTo = document.getElementById('invoice-date-to').value;
            loadInvoices(dateFrom, dateTo);
            loadInvoiceStats(dateFrom, dateTo);
        }

        function clearInvoiceDateFilters() {
            document.getElementById('invoice-date-from').value = '';
            document.getElementById('invoice-date-to').value = '';
            loadInvoices();
            loadInvoiceStats();
        }

        function toggleInvoiceSelectionMode() {
            invoiceSelectionMode = !invoiceSelectionMode;
            selectedInvoices = [];
            
            const selectionButtons = document.querySelectorAll('.invoice-selection-buttons');
            const selectButton = document.getElementById('select-invoices-btn');
            
            if (invoiceSelectionMode) {
                selectButton.innerHTML = ' Cancel Selection';
                selectButton.classList.remove('btn-primary');
                selectButton.classList.add('btn-secondary');
                selectionButtons.forEach(btn => btn.style.display = 'inline-block');
                displayInvoices(invoices); // Refresh to show checkboxes
            } else {
                selectButton.innerHTML = ' Select Invoices';
                selectButton.classList.remove('btn-secondary');
                selectButton.classList.add('btn-primary');
                selectionButtons.forEach(btn => btn.style.display = 'none');
                displayInvoices(invoices); // Refresh to hide checkboxes
            }
        }

        function toggleInvoiceSelection(invoiceId) {
            const index = selectedInvoices.indexOf(invoiceId);
            if (index > -1) {
                selectedInvoices.splice(index, 1);
            } else {
                selectedInvoices.push(invoiceId);
            }
            updateInvoiceSelectionUI();
        }

        function updateInvoiceSelectionUI() {
            const deleteButton = document.getElementById('delete-invoices-btn');
            
            if (selectedInvoices.length > 0) {
                deleteButton.innerHTML = ` Delete Selected (${selectedInvoices.length})`;
                deleteButton.disabled = false;
            } else {
                deleteButton.innerHTML = ' Delete Selected';
                deleteButton.disabled = true;
            }
        }



        async function deleteSelectedInvoices() {
            if (selectedInvoices.length === 0) {
                alert('Please select invoices to delete');
                return;
            }

            const confirmMessage = `Are you sure you want to delete ${selectedInvoices.length} selected invoice(s)? This action cannot be undone.`;
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await fetch('/api/invoices/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        invoiceIds: selectedInvoices
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(`Successfully deleted ${selectedInvoices.length} invoice(s)`);
                    selectedInvoices = [];
                    toggleInvoiceSelectionMode(); // Exit selection mode
                    loadInvoices(); // Reload invoices
                    loadInvoiceStats(); // Update stats
                } else {
                    alert('Failed to delete invoices: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting invoices: ' + error.message);
            }
        }

        async function loadInvoiceStats(dateFrom = null, dateTo = null) {
            try {
                let url = '/api/stats';
                const params = new URLSearchParams();
                if (dateFrom) params.append('dateFrom', dateFrom);
                if (dateTo) params.append('dateTo', dateTo);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    if (handleAuthError(response)) return;
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('total-invoices').textContent = stats.total_invoices || 0;
                    document.getElementById('draft-invoices').textContent = stats.draft_invoices || 0;
                    document.getElementById('sent-invoices').textContent = stats.sent_invoices || 0;
                    document.getElementById('paid-invoices').textContent = stats.paid_invoices || 0;
                    document.getElementById('total-revenue').textContent = formatCurrency(stats.total_revenue || 0);
                }
            } catch (error) {
                console.error('Error loading invoice stats:', error);
            }
        }

        function displayInvoices(invoicesToShow) {
            const container = document.getElementById('invoices-grid');
            container.innerHTML = '';

            if (invoicesToShow.length === 0) {
                container.innerHTML = '<div class="loading">No invoices found</div>';
                return;
            }

            // Group invoices by date
            const groupedInvoices = groupInvoicesByDate(invoicesToShow);
            
            // Display each date group
            Object.keys(groupedInvoices).forEach(dateKey => {
                const dateGroup = createDateGroup(dateKey, groupedInvoices[dateKey]);
                container.appendChild(dateGroup);
            });
        }

        function groupInvoicesByDate(invoices) {
            const groups = {};
            
            invoices.forEach(invoice => {
                // Handle empty or invalid dates
                const invoiceDateStr = invoice.invoice_date || new Date().toISOString().split('T')[0];
                const invoiceDate = new Date(invoiceDateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let dateKey;
                let sortKey;
                
                // Determine the date group key
                if (isSameDay(invoiceDate, today)) {
                    dateKey = 'Today';
                    sortKey = '1-today';
                } else if (isSameDay(invoiceDate, yesterday)) {
                    dateKey = 'Yesterday';
                    sortKey = '2-yesterday';
                } else if (isThisWeek(invoiceDate)) {
                    dateKey = formatDateGroup(invoiceDate, 'this-week');
                    sortKey = '3-' + formatDate(invoice.invoice_date);
                } else if (isThisMonth(invoiceDate)) {
                    dateKey = formatDateGroup(invoiceDate, 'this-month');
                    sortKey = '4-' + formatDate(invoice.invoice_date);
                } else {
                    dateKey = formatDateGroup(invoiceDate, 'older');
                    sortKey = '5-' + formatDate(invoice.invoice_date);
                }
                
                if (!groups[sortKey]) {
                    groups[sortKey] = {
                        displayName: dateKey,
                        invoices: []
                    };
                }
                groups[sortKey].invoices.push(invoice);
            });
            
            // Sort each group's invoices by date (newest first)
            Object.keys(groups).forEach(key => {
                groups[key].invoices.sort((a, b) => new Date(b.invoice_date) - new Date(a.invoice_date));
            });
            
            return groups;
        }

        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }

        function isThisWeek(date) {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            return date >= weekStart && date <= weekEnd;
        }

        function isThisMonth(date) {
            const today = new Date();
            return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
        }

        function formatDateGroup(date, type) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            
            if (type === 'this-week') {
                return days[date.getDay()];
            } else if (type === 'this-month') {
                return `${months[date.getMonth()]} ${date.getDate()}`;
            } else {
                return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
            }
        }

        function createDateGroup(sortKey, group) {
            const dateGroup = document.createElement('div');
            dateGroup.className = 'invoice-date-group';
            
            const dateHeader = document.createElement('div');
            dateHeader.className = 'date-group-header';
            dateHeader.innerHTML = `
                <h3>${group.displayName}</h3>
                <span class="invoice-count">${group.invoices.length} invoice${group.invoices.length !== 1 ? 's' : ''}</span>
            `;
            
            const invoicesList = document.createElement('div');
            invoicesList.className = 'invoices-list';
            
            group.invoices.forEach(invoice => {
                const listItem = createInvoiceListItem(invoice);
                invoicesList.appendChild(listItem);
            });
            
            dateGroup.appendChild(dateHeader);
            dateGroup.appendChild(invoicesList);
            
            return dateGroup;
        }

        function createInvoiceListItem(invoice) {
            const listItem = document.createElement('div');
            listItem.className = 'invoice-list-item';
            
            const statusClass = `status-${invoice.status}`;
            const statusText = invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1);
            const totalFormatted = formatCurrency(invoice.grand_total);
            
            // Payment stage information
            const paymentStage = invoice.payment_stage || 'full_payment';
            let paymentStageDisplay = '';
            let paymentStageClass = '';
            
            if (paymentStage === 'down_payment') {
                paymentStageDisplay = ' Down Payment';
                paymentStageClass = 'payment-stage-dp';
            } else if (paymentStage === 'final_payment') {
                paymentStageDisplay = ' Final Payment';
                paymentStageClass = 'payment-stage-final';
            } else if (paymentStage === 'completed') {
                paymentStageDisplay = ' Completed';
                paymentStageClass = 'payment-stage-completed';
            }
            
            listItem.innerHTML = `
                <div class="invoice-list-content">
                    ${invoiceSelectionMode ? `
                    <div class="selection-checkbox">
                        <input type="checkbox" 
                               id="invoice-${invoice.id}" 
                               onchange="toggleInvoiceSelection('${invoice.id}')"
                               ${selectedInvoices.includes(invoice.id) ? 'checked' : ''}>
                        <label for="invoice-${invoice.id}"></label>
                    </div>
                    ` : ''}
                    <div class="invoice-main-info">
                        <div class="invoice-header">
                            <div class="invoice-number">
                                <strong>#${invoice.invoice_number}</strong>
                                ${paymentStageDisplay ? `<span class="payment-stage-badge ${paymentStageClass}">${paymentStageDisplay}</span>` : ''}
                            </div>
                            <div class="invoice-status">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="invoice-details">
                            <div class="invoice-customer">
                                <span class="customer-name"> ${invoice.customer_name}</span>
                                <span class="customer-email">${invoice.customer_email}</span>
                            </div>
                            
                            <div class="invoice-meta">
                                <span class="invoice-date"> ${formatDate(invoice.invoice_date)}</span>
                                <span class="due-date"> Due: ${formatDate(invoice.due_date)}</span>
                                <span class="invoice-amount">${totalFormatted}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="invoice-actions">
                        ${getSimplifiedInvoiceActions(invoice)}
                    </div>
                </div>
            `;
            
            return listItem;
        }

        function createInvoiceCard(invoice) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const statusClass = `status-${invoice.status}`;
            const statusText = invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1);
            const totalFormatted = formatCurrency(invoice.grand_total);
            
            // Payment stage information
            const paymentStage = invoice.payment_stage || 'full_payment';
            const paymentStatus = invoice.payment_status || 'pending';
            let paymentStageDisplay = '';
            let paymentStageClass = '';
            
            if (paymentStage === 'down_payment') {
                paymentStageDisplay = ' Uang Muka';
                paymentStageClass = 'stage-down-payment';
            } else if (paymentStage === 'final_payment') {
                paymentStageDisplay = ' Sisa Pembayaran';
                paymentStageClass = 'stage-remaining';
            } else if (paymentStage === 'completed') {
                paymentStageDisplay = ' Lunas';
                paymentStageClass = 'stage-completed';
            } else {
                paymentStageDisplay = ' Pembayaran Penuh';
                paymentStageClass = 'stage-full';
            }
            
            card.innerHTML = `
                ${invoiceSelectionMode ? `
                <div class="selection-checkbox">
                    <input type="checkbox" 
                           id="invoice-${invoice.id}" 
                           onchange="toggleInvoiceSelection('${invoice.id}')"
                           ${selectedInvoices.includes(invoice.id) ? 'checked' : ''}>
                    <label for="invoice-${invoice.id}"></label>
                </div>
                ` : ''}
                <div class="product-header">
                    <div>
                        <div class="product-name">${invoice.invoice_number}</div>
                        <div class="product-sku">Customer: ${invoice.customer_name}</div>
                        ${paymentStage !== 'full_payment' ? `<div class="payment-stage-badge ${paymentStageClass}">${paymentStageDisplay}</div>` : ''}
                    </div>
                    <div class="status-badge ${statusClass}">${statusText}</div>
                </div>
                <div class="product-price">${totalFormatted}</div>
                <div class="product-stock">
                    <span>Date: ${formatDate(invoice.invoice_date)}</span>
                </div>
                <div>Email: ${invoice.customer_email}</div>
                <div class="product-actions">
                    ${getSimplifiedInvoiceActions(invoice)}
                </div>
            `;
            
            return card;
        }
        
        function getPaymentActionButtons(invoice) {
            const paymentStage = invoice.payment_stage || 'full_payment';
            const status = invoice.status;
            
            if (status === 'draft') {
                return `<button class="btn btn-sm btn-warning" onclick="updateInvoiceStatus(${invoice.id}, 'sent')"> Send</button>`;
            } else if (status === 'sent') {
                if (paymentStage === 'down_payment') {
                    return `<button class="btn btn-sm btn-success" onclick="confirmDownPayment(${invoice.id})"> Confirm Down Payment</button>`;
                } else if (paymentStage === 'final_payment') {
                    return `<button class="btn btn-sm btn-success" onclick="confirmFinalPayment(${invoice.id})"> Confirm Final Payment</button>`;
                } else {
                    return `<button class="btn btn-sm btn-success" onclick="updateInvoiceStatus(${invoice.id}, 'paid')"> Paid</button>`;
                }
            } else if (status === 'dp_paid') {
                // After down payment is confirmed, show final payment button
                if (paymentStage === 'final_payment') {
                    return `<button class="btn btn-sm btn-success" onclick="confirmFinalPayment(${invoice.id})"> Confirm Final Payment</button>`;
                }
            }
            return '';
        }

        // Simplified Invoice Actions
        function getSimplifiedInvoiceActions(invoice) {
            const status = invoice.status;
            let actions = [];

            // View button - always available
            actions.push(`<button class="btn btn-sm btn-primary" onclick="viewInvoiceDetailed(${invoice.id})" title="View invoice details and payment confirmations"> View</button>`);

            // Share button - removed as requested

            // Print button - always available
            actions.push(`<button class="btn btn-sm btn-success" onclick="printInvoice('${invoice.invoice_number}')" title="Download/Print PDF"> Print</button>`);

            // Confirm Payment button - based on payment stage and status
            if (status === 'sent' || status === 'dp_paid') {
                const paymentStage = invoice.payment_stage || 'full_payment';
                
                // Debug logging for payment stage
                console.log(` Invoice ${invoice.invoice_number} - Status: ${status}, Payment Stage: ${paymentStage}, Final Payment Token: ${invoice.final_payment_token ? 'Yes' : 'No'}`);
                
                if (paymentStage === 'down_payment') {
                    actions.push(`<button class="btn btn-sm btn-warning" onclick="confirmDownPayment(${invoice.id})" title="Confirm down payment received"> Confirm DP</button>`);
                } else if (paymentStage === 'final_payment') {
                    // Show confirm button only - final payment link is now in View modal
                    actions.push(`<button class="btn btn-sm btn-warning" onclick="confirmFinalPayment(${invoice.id})" title="Confirm final payment received"> Confirm Final</button>`);
                    
                    // Add debug info for final payment stage
                    if (!invoice.final_payment_token) {
                        console.warn(` Invoice ${invoice.invoice_number} is in final_payment stage but missing final_payment_token`);
                    }
                } else if (paymentStage === 'full_payment') {
                    actions.push(`<button class="btn btn-sm btn-warning" onclick="confirmPaymentAndMoveToOrders(${invoice.id}, 'full')" title="Confirm payment received"> Confirm Payment</button>`);
                }
            }

            // Delete button - always available
            actions.push(`<button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})" title="Delete this invoice"> Delete</button>`);

            return actions.join('');
        }

        function filterInvoices() {
            const searchTerm = document.getElementById('invoice-search').value.toLowerCase();
            const statusFilter = document.getElementById('invoice-status-filter').value;
            
            let filtered = invoices.filter(invoice => {
                const matchesSearch = !searchTerm || 
                    invoice.customer_name.toLowerCase().includes(searchTerm) ||
                    invoice.customer_email.toLowerCase().includes(searchTerm) ||
                    invoice.invoice_number.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || invoice.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            displayInvoices(filtered);
        }

        async function viewInvoice(invoiceId) {
            try {
                const response = await fetch(`/api/invoices/${invoiceId}`);
                const data = await response.json();
                
                if (data.success && data.invoice) {
                    showInvoiceModal(data.invoice);
                } else {
                    alert('Failed to load invoice details: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error loading invoice details: ' + error.message);
            }
        }

        // Enhanced View with Payment Confirmations
        async function viewInvoiceDetailed(invoiceId) {
            try {
                const response = await fetch(`/api/invoices/${invoiceId}`);
                const data = await response.json();
                
                if (data.success && data.invoice) {
                    showEnhancedInvoiceModal(data.invoice);
                } else {
                    alert('Failed to load invoice details: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error loading invoice details: ' + error.message);
            }
        }

        async function editInvoice(invoiceId) {
            try {
                const response = await fetch(`/api/invoices/${invoiceId}`);
                const data = await response.json();
                
                if (data.success && data.invoice) {
                    const invoice = data.invoice;
                    
                    // Parse invoice items
                    let items = [];
                    try {
                        if (Array.isArray(invoice.items_json)) {
                            items = invoice.items_json;
                        } else if (typeof invoice.items_json === 'string') {
                            items = JSON.parse(invoice.items_json);
                        }
                    } catch (e) {
                        console.error('Error parsing items:', e);
                        items = [];
                    }
                    
                    // Create a simplified description from the invoice data
                    const description = `Invoice for: ${invoice.customer_name}
Email: ${invoice.customer_email}
Phone: ${invoice.customer_phone || 'N/A'}
Address: ${invoice.customer_address || 'N/A'}

Items:
${items.map(item => `${item.quantity || 1}x ${item.productName || item.product_name || 'Unknown'} - ${formatCurrency(item.unitPrice || item.unit_price || 0)}`).join('\n')}

Total: ${formatCurrency(invoice.grand_total)}`;
                    
                    // Open the invoice generator with pre-filled data
                    const url = `/web-interface-indonesian.html?edit=${invoiceId}&desc=${encodeURIComponent(description)}`;
                    window.open(url, '_blank');
                } else {
                    alert('Failed to load invoice for editing: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error loading invoice for editing: ' + error.message);
            }
        }

        function showInvoiceModal(invoice) {
            const modal = document.getElementById('invoiceModal');
            const content = document.getElementById('invoiceModalContent');
            
            let items = [];
            console.log(' [Merchant Dashboard] Processing invoice items...');
            console.log(' Raw items_json:', invoice.items_json);
            console.log(' Type:', typeof invoice.items_json);
            
            try {
                // Try multiple parsing strategies
                if (Array.isArray(invoice.items_json)) {
                    items = invoice.items_json;
                    console.log(' Items parsed as array:', items);
                } else if (typeof invoice.items_json === 'string') {
                    items = JSON.parse(invoice.items_json);
                    console.log(' Items parsed from string:', items);
                } else if (invoice.items_json && typeof invoice.items_json === 'object') {
                    items = [invoice.items_json];
                    console.log(' Items converted from object:', items);
                } else {
                    // Fallback: try to find items in other locations
                    console.log(' Trying fallback methods...');
                    if (invoice.items && Array.isArray(invoice.items)) {
                        items = invoice.items;
                        console.log(' Found items in invoice.items:', items);
                    }
                }
                
                // Validate and fix items structure
                if (Array.isArray(items)) {
                    items = items.map((item, index) => {
                        return {
                            productName: item.productName || item.product_name || item.name || `Product ${index + 1}`,
                            quantity: parseInt(item.quantity || item.qty || 1),
                            unitPrice: parseFloat(item.unitPrice || item.unit_price || item.price || 0),
                            lineTotal: parseFloat(item.lineTotal || item.line_total || item.total || (item.quantity || 1) * (item.unitPrice || item.unit_price || item.price || 0)),
                            description: item.description || item.desc || ''
                        };
                    });
                    console.log(' Processed items:', items);
                }
                
            } catch (e) {
                console.error(' Error parsing items:', e);
                items = [{
                    productName: 'Error: Items parsing failed',
                    quantity: 1,
                    unitPrice: 0,
                    lineTotal: 0,
                    description: e.message
                }];
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>Invoice #${invoice.invoice_number}</h3>
                    <p><strong>Status:</strong> <span class="status-badge status-${invoice.status}">${invoice.status}</span></p>
                    <p><strong>Date:</strong> ${formatDate(invoice.invoice_date)}</p>
                    <p><strong>Due Date:</strong> ${formatDate(invoice.due_date)}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> ${invoice.customer_name}</p>
                    <p><strong>Email:</strong> ${invoice.customer_email}</p>
                    <p><strong>Phone:</strong> ${invoice.customer_phone || 'N/A'}</p>
                    <p><strong>Address:</strong> ${invoice.customer_address || 'N/A'}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Financial Summary</h4>
                    <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
                    <p><strong>Tax:</strong> ${formatCurrency(invoice.tax_amount)}</p>
                    <p><strong>Shipping:</strong> ${formatCurrency(invoice.shipping_cost)}</p>
                    <p><strong>Discount:</strong> ${formatCurrency(invoice.discount)}</p>
                    <p><strong>Total:</strong> <strong>${formatCurrency(invoice.grand_total)}</strong></p>
                </div>
                
                ${generatePaymentSchedulePreview(invoice)}
                
                <div style="margin-bottom: 20px;">
                    <h4>Items</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 8px; text-align: left;">Product</th>
                                <th style="padding: 8px; text-align: right;">Qty</th>
                                <th style="padding: 8px; text-align: right;">Price</th>
                                <th style="padding: 8px; text-align: right;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td style="padding: 8px;">${item.productName || item.product_name || 'Unknown Product'}</td>
                                    <td style="padding: 8px; text-align: right;">${item.quantity || 0}</td>
                                    <td style="padding: 8px; text-align: right;">${formatCurrency(item.unitPrice || item.unit_price || 0)}</td>
                                    <td style="padding: 8px; text-align: right;">${formatCurrency(item.lineTotal || item.line_total || 0)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="downloadInvoicePDF('${invoice.invoice_number}')"> Download PDF</button>
                    ${invoice.customer_token ? `<button class="btn btn-info" onclick="copyInvoiceLink('${invoice.customer_token}')"> Copy Link</button>` : ''}
                    <button class="btn btn-secondary" onclick="closeInvoiceModal()">Close</button>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Initialize mobile controls if on mobile
            setTimeout(() => initializeInvoiceModalMobile(), 100);
        }

        // Enhanced Invoice Modal with Payment Confirmations
        function showEnhancedInvoiceModal(invoice) {
            const modal = document.getElementById('invoiceModal');
            const content = document.getElementById('invoiceModalContent');
            
            let items = [];
            try {
                if (Array.isArray(invoice.items_json)) {
                    items = invoice.items_json;
                } else if (typeof invoice.items_json === 'string') {
                    items = JSON.parse(invoice.items_json);
                } else {
                    items = [];
                }
            } catch (e) {
                console.error('Error parsing items:', e);
                items = [];
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3> Invoice #${invoice.invoice_number}</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin: 15px 0;">
                        <div><strong>Status:</strong> <span class="status-badge status-${invoice.status}">${invoice.status.toUpperCase()}</span></div>
                        <div><strong>Date:</strong> ${formatDate(invoice.invoice_date)}</div>
                        <div><strong>Due Date:</strong> ${formatDate(invoice.due_date)}</div>
                        <div><strong>Total:</strong> <span style="color: #28a745; font-size: 1.2em; font-weight: bold;">${formatCurrency(invoice.grand_total)}</span></div>
                    </div>
                </div>
                
                <!-- Payment Confirmations Section -->
                ${generatePaymentConfirmationsSection(invoice)}
                
                <!-- Customer Information -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4> Customer Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Name:</strong> ${invoice.customer_name}</p>
                            <p><strong>Email:</strong> ${invoice.customer_email}</p>
                        </div>
                        <div>
                            <p><strong>Phone:</strong> ${invoice.customer_phone || 'N/A'}</p>
                            <p><strong>Address:</strong> ${invoice.customer_address || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Summary -->
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4> Financial Summary</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Subtotal:</strong> ${formatCurrency(invoice.subtotal)}</p>
                            <p><strong>Tax:</strong> ${formatCurrency(invoice.tax_amount)}</p>
                        </div>
                        <div>
                            <p><strong>Shipping:</strong> ${formatCurrency(invoice.shipping_cost)}</p>
                            <p><strong>Discount:</strong> ${formatCurrency(invoice.discount)}</p>
                        </div>
                    </div>
                    <hr style="margin: 10px 0;">
                    <p style="font-size: 1.1em;"><strong>Grand Total:</strong> <span style="color: #28a745; font-weight: bold;">${formatCurrency(invoice.grand_total)}</span></p>
                </div>
                
                ${generatePaymentSchedulePreview(invoice)}
                
                <!-- Items Table -->
                <div style="margin-bottom: 20px;">
                    <h4> Items</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #dee2e6;">
                            <thead>
                                <tr style="background: #343a40; color: white;">
                                    <th style="padding: 12px; text-align: left;">Product</th>
                                    <th style="padding: 12px; text-align: center;">Qty</th>
                                    <th style="padding: 12px; text-align: right;">Price</th>
                                    <th style="padding: 12px; text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((item, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-bottom: 1px solid #dee2e6;">
                                        <td style="padding: 12px;">${item.productName || item.product_name || 'Unknown Product'}</td>
                                        <td style="padding: 12px; text-align: center;">${item.quantity || 0}</td>
                                        <td style="padding: 12px; text-align: right;">${formatCurrency(item.unitPrice || item.unit_price || 0)}</td>
                                        <td style="padding: 12px; text-align: right; font-weight: bold;">${formatCurrency(item.lineTotal || item.line_total || 0)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <!-- Final Payment Email Section for invoices in final_payment stage -->
                ${invoice.payment_stage === 'final_payment' && invoice.final_payment_token ? `
                <div style="margin-top: 30px; padding: 20px; border: 2px solid #fd7e14; border-radius: 8px; background-color: #fff8f0;">
                    <h5 style="margin-bottom: 15px; color: #fd7e14;"> Final Payment Required</h5>
                    <p style="margin-bottom: 15px; color: #6c757d;">This invoice requires final payment completion. Send the final payment email to the customer:</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <input type="email" id="finalPaymentEmailInput" placeholder="Customer email address" 
                               value="${invoice.customer_email || ''}" 
                               style="flex: 1; min-width: 250px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                        <button onclick="sendFinalPaymentEmail(${invoice.id}, document.getElementById('finalPaymentEmailInput').value)" 
                                class="btn btn-warning" style="min-width: 140px;"> Send Final Payment Email</button>
                    </div>
                    
                    <div style="font-size: 12px; color: #6c757d;">
                        <strong>Final Payment Amount:</strong> ${formatCurrency(invoice.final_payment_amount || 0)}<br>
                        <strong>Invoice Link:</strong> ${window.location.origin}/invoice?token=${invoice.customer_token}
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #dee2e6; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-success" onclick="printInvoice('${invoice.invoice_number}')" style="min-width: 120px;"> Print/PDF</button>
                    ${invoice.customer_token ? `<button class="btn btn-info" onclick="copyInvoiceLink('${invoice.customer_token}')" style="min-width: 120px;"> Copy Link</button>` : ''}
                    <button class="btn" style="background-color: var(--whatsapp); color: white; min-width: 120px;" onclick="shareViaWhatsApp('${invoice.id}')"> WhatsApp</button>
                    ${invoice.customer_email && invoice.payment_stage !== 'final_payment' ? `<button class="btn btn-primary" onclick="sendInvoiceEmail(${invoice.id}, '${invoice.customer_email}')" style="min-width: 120px;"> Send Email</button>` : ''}
                    <button class="btn btn-secondary" onclick="closeInvoiceModal()" style="min-width: 120px;"> Close</button>
                </div>
            `;
            
            modal.style.display = 'block';
            
            // Initialize mobile controls if on mobile
            setTimeout(() => initializeInvoiceModalMobile(), 100);
        }

        // Generate Payment Confirmations Section
        function generatePaymentConfirmationsSection(invoice) {
            if (invoice.status === 'draft') {
                return `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <h4> Payment Status</h4>
                        <p>This invoice is still in draft mode. Send it to the customer to enable payment confirmations.</p>
                    </div>
                `;
            } else if (invoice.status === 'sent' || invoice.status === 'dp_paid') {
                const paymentStage = invoice.payment_stage || 'full_payment';
                const paymentSchedule = invoice.payment_schedule_json ? 
                    (typeof invoice.payment_schedule_json === 'string' ? JSON.parse(invoice.payment_schedule_json) : invoice.payment_schedule_json) : null;
                
                let stageInfo = '';
                let headerIcon = '';
                let headerText = 'Payment Confirmations';
                
                if (paymentStage === 'down_payment') {
                    headerIcon = '';
                    headerText = 'Down Payment Confirmations';
                    stageInfo = `<div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #ffc107;">
                        <strong> Payment Stage:</strong> Down Payment (${paymentSchedule ? formatCurrency(paymentSchedule.downPayment.amount) : 'N/A'})
                        <br><small>After confirmation, final payment link will be generated for remaining amount.</small>
                    </div>`;
                } else if (paymentStage === 'final_payment') {
                    headerIcon = '';
                    headerText = 'Final Payment Confirmations';
                    stageInfo = `<div style="background: #e2e3ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #6f42c1;">
                        <strong> Payment Stage:</strong> Final Payment (${paymentSchedule ? formatCurrency(paymentSchedule.remainingBalance.amount) : 'N/A'})
                        <br><small>After confirmation, invoice will be completed and order will be created.</small>
                    </div>`;
                } else {
                    stageInfo = `<div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #28a745;">
                        <strong> Payment Stage:</strong> Full Payment (${formatCurrency(invoice.grand_total)})
                        <br><small>After confirmation, invoice will be marked as paid and order will be created.</small>
                    </div>`;
                }
                
                return `
                    <div style="background: #cce5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h4>${headerIcon} ${headerText}</h4>
                        ${stageInfo}
                        <p style="margin-bottom: 15px;">Waiting for customer payment. Payment confirmations will appear here when uploaded by the customer.</p>
                        <div id="payment-confirmations-${invoice.id}">
                            <!-- Payment confirmations will be loaded here -->
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; color: #6c757d;">
                                <em>No payment confirmations uploaded yet</em>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-warning" onclick="refreshPaymentConfirmations(${invoice.id})" style="margin-top: 10px;"> Refresh</button>
                    </div>
                `;
            } else if (invoice.status === 'paid') {
                return `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                        <h4> Payment Confirmed</h4>
                        <p>This invoice has been marked as paid and moved to orders.</p>
                        <div id="payment-confirmations-${invoice.id}">
                            <!-- Payment confirmations will be loaded here -->
                        </div>
                        <button class="btn btn-sm btn-info" onclick="refreshPaymentConfirmations(${invoice.id})" style="margin-top: 10px;"> View Payment History</button>
                    </div>
                `;
            }
            return '';
        }

        function generatePaymentSchedulePreview(invoice) {
            // Check if invoice has payment schedule data
            let paymentSchedule = null;
            try {
                if (invoice.paymentSchedule) {
                    paymentSchedule = invoice.paymentSchedule;
                } else if (invoice.metadata_json) {
                    const metadata = JSON.parse(invoice.metadata_json);
                    paymentSchedule = metadata.paymentSchedule;
                }
            } catch (e) {
                console.log('No payment schedule found in invoice');
            }

            if (!paymentSchedule) {
                return '';
            }

            const formatDate = (dateString) => {
                if (!dateString) return '-';
                try {
                    return new Date(dateString).toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            };

            const getStatusBadge = (status) => {
                const statusClasses = {
                    'pending': 'background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;',
                    'paid': 'background: #d1edff; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;',
                    'partial': 'background: #e2e3ff; color: #6D46D6; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;'
                };
                const statusText = status === 'pending' ? ' Pending' : status === 'paid' ? ' Paid' : ' Partial';
                return `<span style="${statusClasses[status] || statusClasses['pending']}">${statusText}</span>`;
            };

            const totalPaid = paymentSchedule.paymentStatus?.totalPaid || 0;
            const totalAmount = paymentSchedule.totalAmount;
            const progressPercentage = totalAmount > 0 ? (totalPaid / totalAmount) * 100 : 0;

            return `
                <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%); border-radius: 12px; border: 1px solid #e6ebff;">
                    <h4 style="color: #8B5FFF; margin-bottom: 15px;"> Payment Schedule</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e6ebff;">
                            <div>
                                <strong>Down Payment (${paymentSchedule.downPayment.percentage}%)</strong><br>
                                <span style="color: #8B5FFF; font-size: 1.2rem; font-weight: 600;">${formatCurrency(paymentSchedule.downPayment.amount)}</span><br>
                                <small style="color: #718096;">Due: ${formatDate(paymentSchedule.downPayment.dueDate)}</small>
                            </div>
                            <div>
                                ${getStatusBadge(paymentSchedule.downPayment.status)}
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e6ebff;">
                            <div>
                                <strong>Remaining Balance</strong><br>
                                <span style="color: #8B5FFF; font-size: 1.2rem; font-weight: 600;">${formatCurrency(paymentSchedule.remainingBalance.amount)}</span><br>
                                <small style="color: #718096;">Due: ${formatDate(paymentSchedule.remainingBalance.dueDate)}</small>
                            </div>
                            <div>
                                ${getStatusBadge(paymentSchedule.remainingBalance.status)}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: 600;">Payment Progress</span>
                            <span style="color: #718096;">${formatCurrency(totalPaid)} of ${formatCurrency(totalAmount)} paid</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(135deg, #8B5FFF 0%, #9966FF 100%); width: ${progressPercentage}%; border-radius: 4px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <div style="padding: 15px; background: linear-gradient(135deg, #8B5FFF 0%, #9966FF 100%); color: white; border-radius: 8px; text-align: center;">
                        <strong>Payment Status: ${paymentSchedule.paymentStatus?.status.toUpperCase() || 'PENDING'}</strong>
                    </div>
                </div>
            `;
        }

        async function copyInvoiceLink(customerToken) {
            console.log(' Copy link called with token:', customerToken);
            
            if (!customerToken) {
                alert('Error: No customer token available for this invoice');
                return;
            }
            
            const baseUrl = window.location.origin;
            
            // Find the invoice by customer token to check status
            const foundInvoice = invoices.find(inv => inv.customer_token === customerToken);
            
            const invoiceUrl = `${baseUrl}/simple-invoice-view.html?id=${foundInvoice.invoice_number}&from=dashboard`;
            console.log(' Generated URL:', invoiceUrl);
            console.log(' Found invoice:', foundInvoice);
            
            // Copy to clipboard
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(invoiceUrl).then(async () => {
                    showSuccess('Invoice link copied to clipboard!');
                    await updateStatusOnShare(foundInvoice);
                }).catch(() => {
                    fallbackCopyTextToClipboard(invoiceUrl);
                });
            } else {
                fallbackCopyTextToClipboard(invoiceUrl);
                await updateStatusOnShare(foundInvoice);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showSuccess('Invoice link copied to clipboard!');
                } else {
                    showError('Failed to copy link. Please try again.');
                }
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
                showError('Could not copy link. Please copy manually: ' + text);
            }

            document.body.removeChild(textArea);
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal').style.display = 'none';
            // Close any open share dropdowns
            document.querySelectorAll('.share-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            // Hide mobile zoom controls
            const mobileControls = document.getElementById('mobile-invoice-zoom-controls');
            if (mobileControls) {
                mobileControls.style.display = 'none';
            }
        }
        
        // Mobile Invoice Zoom Functionality
        let invoiceCurrentScale = 0.8;
        const invoiceMinScale = 0.3;
        const invoiceMaxScale = 3.0;
        
        function initializeInvoiceModalMobile() {
            const isMobile = window.innerWidth <= 767;
            if (!isMobile) return;
            
            const mobileControls = document.getElementById('mobile-invoice-zoom-controls');
            const wrapper = document.getElementById('invoiceModalContentWrapper');
            
            if (mobileControls && wrapper) {
                mobileControls.style.display = 'flex';
                
                // Set initial scale
                invoiceCurrentScale = 0.8;
                wrapper.style.setProperty('--invoice-mobile-scale-factor', invoiceCurrentScale);
                
                // Add touch gesture support
                addInvoiceModalTouchGestureSupport();
            }
        }
        
        function adjustInvoiceZoom(delta) {
            invoiceCurrentScale = Math.max(invoiceMinScale, Math.min(invoiceMaxScale, invoiceCurrentScale + delta));
            
            const wrapper = document.getElementById('invoiceModalContentWrapper');
            const indicator = document.getElementById('invoice-zoom-indicator');
            
            if (wrapper) {
                wrapper.style.setProperty('--invoice-mobile-scale-factor', invoiceCurrentScale);
            }
            
            // Show zoom indicator
            if (indicator) {
                indicator.textContent = Math.round(invoiceCurrentScale * 100) + '%';
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 1500);
            }
        }
        
        function fitInvoiceToScreen() {
            const modal = document.getElementById('invoiceModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.invoice-modal-content');
            if (!modalContent) return;
            
            const containerWidth = modalContent.clientWidth - 32; // Account for padding
            const estimatedContentWidth = 400; // Estimated invoice content width
            invoiceCurrentScale = Math.max(containerWidth / estimatedContentWidth, invoiceMinScale);
            invoiceCurrentScale = Math.min(invoiceCurrentScale, invoiceMaxScale);
            
            const wrapper = document.getElementById('invoiceModalContentWrapper');
            const indicator = document.getElementById('invoice-zoom-indicator');
            
            if (wrapper) {
                wrapper.style.setProperty('--invoice-mobile-scale-factor', invoiceCurrentScale);
            }
            
            if (indicator) {
                indicator.textContent = Math.round(invoiceCurrentScale * 100) + '%';
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 1500);
            }
        }
        
        function addInvoiceModalTouchGestureSupport() {
            const wrapper = document.getElementById('invoiceModalContentWrapper');
            if (!wrapper) return;
            
            let initialDistance = 0;
            let initialScale = invoiceCurrentScale;
            let lastTap = 0;
            
            wrapper.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    // Pinch-zoom start
                    e.preventDefault();
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    initialScale = invoiceCurrentScale;
                } else if (e.touches.length === 1) {
                    // Double-tap detection
                    const currentTime = new Date().getTime();
                    const tapGap = currentTime - lastTap;
                    
                    if (tapGap < 300 && tapGap > 0) {
                        // Double-tap detected
                        e.preventDefault();
                        const targetScale = invoiceCurrentScale < 1.5 ? 2.0 : 0.8;
                        invoiceCurrentScale = targetScale;
                        
                        wrapper.style.setProperty('--invoice-mobile-scale-factor', invoiceCurrentScale);
                        
                        const indicator = document.getElementById('invoice-zoom-indicator');
                        if (indicator) {
                            indicator.textContent = Math.round(invoiceCurrentScale * 100) + '%';
                            indicator.classList.add('show');
                            setTimeout(() => indicator.classList.remove('show'), 1500);
                        }
                    }
                    lastTap = currentTime;
                }
            });
            
            wrapper.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    const scale = (currentDistance / initialDistance) * initialScale;
                    invoiceCurrentScale = Math.max(invoiceMinScale, Math.min(invoiceMaxScale, scale));
                    
                    wrapper.style.setProperty('--invoice-mobile-scale-factor', invoiceCurrentScale);
                    
                    const indicator = document.getElementById('invoice-zoom-indicator');
                    if (indicator) {
                        indicator.textContent = Math.round(invoiceCurrentScale * 100) + '%';
                        indicator.classList.add('show');
                    }
                }
            });
            
            wrapper.addEventListener('touchend', function(e) {
                if (e.touches.length === 0) {
                    const indicator = document.getElementById('invoice-zoom-indicator');
                    if (indicator) {
                        setTimeout(() => indicator.classList.remove('show'), 1500);
                    }
                }
            });
        }

        // Share Dropdown Functions
        function toggleShareDropdown(invoiceId) {
            const menu = document.getElementById(`share-menu-${invoiceId}`);
            if (!menu) {
                console.error('Share menu not found for invoice:', invoiceId);
                return;
            }
            
            // Close all other dropdowns first
            document.querySelectorAll('.share-menu.show').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.remove('show');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('show');
            
            // Debug log
            console.log('Share dropdown toggled for invoice:', invoiceId, 'Visible:', menu.classList.contains('show'));
        }

        async function shareViaWhatsApp(invoiceId) {
            console.log(' WhatsApp share called with ID:', invoiceId);
            
            // Get invoice data to construct WhatsApp message
            const invoice = invoices.find(inv => inv.id == invoiceId || inv.id === parseInt(invoiceId));
            console.log(' Found invoice for WhatsApp:', invoice);
            
            if (!invoice) {
                console.warn('Invoice not found for ID:', invoiceId, 'Available invoices:', invoices.map(inv => ({id: inv.id, number: inv.invoice_number})));
                alert('Invoice not found for WhatsApp sharing');
                return;
            }

            const baseUrl = window.location.origin;
            const invoiceUrl = `${baseUrl}/simple-invoice-view.html?id=${invoice.invoice_number}`;
            
            // Parse invoice data with proper fallbacks
            const invoiceNumber = invoice.invoice_number || 'N/A';
            const customerName = invoice.customer_name || '';
            const customerPhone = invoice.customer_phone || '';
            const customerAddress = invoice.customer_address || '';
            const businessName = invoice.business_name || 'Business';
            const total = invoice.grand_total || 0;
            const subtotal = invoice.subtotal || total;
            const discount = invoice.discount_amount || 0;
            const shippingCost = invoice.shipping_cost || 0;
            
            // Parse items from JSON with error handling
            let items = [];
            try {
                if (invoice.items_json) {
                    if (typeof invoice.items_json === 'string') {
                        items = JSON.parse(invoice.items_json);
                    } else if (Array.isArray(invoice.items_json)) {
                        items = invoice.items_json;
                    }
                }
            } catch (e) {
                console.error('Error parsing items for WhatsApp:', e);
                items = [];
            }
            
            // Format items list
            let itemsList = '';
            if (items.length > 0) {
                itemsList = items.map((item, index) => {
                    const qty = item.quantity || 0;
                    const price = item.unit_price || item.unitPrice || 0;
                    const total = item.line_total || item.lineTotal || (qty * price);
                    const productName = item.product_name || item.productName || 'Produk';
                    return `${index + 1}. ${productName}\n   ${qty}x @ Rp ${price.toLocaleString('id-ID')} = Rp ${total.toLocaleString('id-ID')}`;
                }).join('\n\n');
            }
            
            // Check for payment schedule with proper date handling
            let paymentSchedule = '';
            try {
                if (invoice.payment_schedule_json) {
                    let schedule;
                    if (typeof invoice.payment_schedule_json === 'string') {
                        schedule = JSON.parse(invoice.payment_schedule_json);
                    } else {
                        schedule = invoice.payment_schedule_json;
                    }
                    
                    if (schedule && schedule.scheduleType === 'down_payment') {
                        const dp = schedule.downPayment;
                        const remaining = schedule.remainingBalance;
                        if (dp && remaining) {
                            const dpDate = dp.dueDate ? new Date(dp.dueDate).toLocaleDateString('id-ID') : 'Segera';
                            const finalDate = remaining.dueDate ? new Date(remaining.dueDate).toLocaleDateString('id-ID') : 'Sesuai kesepakatan';
                            paymentSchedule = `\n *JADWAL PEMBAYARAN*\n DP (${dp.percentage}%): Rp ${dp.amount.toLocaleString('id-ID')} - Jatuh Tempo: ${dpDate}\n Pelunasan: Rp ${remaining.amount.toLocaleString('id-ID')} - Jatuh Tempo: ${finalDate}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error parsing payment schedule:', error);
            }
            
            // Get notes
            let notes = '';
            try {
                if (invoice.notes_json) {
                    let notesData;
                    if (typeof invoice.notes_json === 'string') {
                        notesData = JSON.parse(invoice.notes_json);
                    } else {
                        notesData = invoice.notes_json;
                    }
                    if (notesData && notesData.publicNotes) {
                        notes = `\n *CATATAN*\n${notesData.publicNotes}`;
                    }
                }
            } catch (error) {
                console.error('Error parsing notes:', error);
            }
            
            // Get proper due date
            const dueDate = invoice.due_date ? new Date(invoice.due_date).toLocaleDateString('id-ID') : 'Sesuai kesepakatan';
            
            // Create comprehensive WhatsApp message
            const message = ` *FAKTUR #${invoiceNumber}*

*DARI:* ${businessName}
*KEPADA:* ${customerName}

 *MOHON KONFIRMASI DATA ANDA:*
 Telepon: ${customerPhone || 'Belum diisi'}
 Alamat: ${customerAddress || 'Belum diisi'}
${customerPhone || customerAddress ? '\n*Jika ada yang salah, silakan beritahu kami.*' : '\n*Silakan berikan no. telepon dan alamat lengkap Anda.*'}

 *DETAIL PEMBELIAN:*${itemsList ? `\n${itemsList}` : '\nTidak ada detail item'}

 *RINGKASAN BIAYA:*
 Subtotal: Rp ${subtotal.toLocaleString('id-ID')}${discount > 0 ? `\n Diskon: -Rp ${discount.toLocaleString('id-ID')}` : ''}${shippingCost > 0 ? `\n Ongkos Kirim: Rp ${shippingCost.toLocaleString('id-ID')}` : ''}
 *TOTAL: Rp ${total.toLocaleString('id-ID')}*${paymentSchedule}${notes}

 *LIHAT FAKTUR LENGKAP:*
${invoiceUrl}

Terima kasih! `;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Update status after sharing
            await updateStatusOnShare(invoice);
            
            // Close dropdown
            document.getElementById(`share-menu-${invoiceId}`).classList.remove('show');
        }

        // Direct Print Function - Simple approach that works with flat invoice data
        async function printInvoice(invoiceNumber) {
            console.log(' Print function called for invoice:', invoiceNumber);
            
            try {
                // Get the invoice by number to find the full invoice data
                const invoiceResponse = await fetch(`/api/invoices/number/${invoiceNumber}`, {
                    headers: getAuthHeaders()
                });
                
                if (!invoiceResponse.ok) {
                    if (handleAuthError(invoiceResponse)) return;
                    throw new Error(`HTTP ${invoiceResponse.status}: ${invoiceResponse.statusText}`);
                }
                
                const invoiceResult = await invoiceResponse.json();
                
                if (!invoiceResult.success) {
                    alert('Failed to load invoice for printing: ' + invoiceResult.error);
                    return;
                }

                const invoice = invoiceResult.invoice;
                console.log(' Found invoice for printing:', invoice);
                
                // Load business profile for logos and branding
                console.log(' Loading business data...');
                await loadBusinessDataFromAPI();
                console.log(' Business data loaded');
                
                // Generate simple printable HTML directly from flat data
                console.log(' Generating simple printable HTML...');
                const printableHTML = generateSimplePrintableInvoice(invoice);
                console.log(' Printable HTML generated');
                
                // Create new window and print immediately
                const printWindow = window.open('', '_blank', 'width=1000,height=800,scrollbars=yes');
                if (!printWindow) {
                    alert('Popup blocked. Please allow popups for this site and try again.');
                    return;
                }
                
                // Write the complete HTML to the print window
                printWindow.document.write(printableHTML);
                printWindow.document.close();
                
                // Wait for content to load then print
                printWindow.onload = function() {
                    console.log(' Print window loaded, initiating print...');
                    setTimeout(() => {
                        printWindow.print();
                    }, 500);
                };
                
            } catch (error) {
                console.error(' Error loading invoice for printing:', error);
                console.error(' Error stack:', error.stack);
                alert('Error loading invoice for printing: ' + error.message);
            }
        }

        // Generate simple printable invoice HTML directly from flat database data
        function generateSimplePrintableInvoice(invoice) {
            // Get business profile from localStorage
            let businessProfile = null;
            try {
                const savedProfile = localStorage.getItem('businessProfile');
                if (savedProfile) {
                    businessProfile = JSON.parse(savedProfile);
                }
            } catch (error) {
                console.warn(' Error parsing business profile:', error);
            }
            
            // Parse items similar to showInvoiceModal
            let items = [];
            try {
                if (Array.isArray(invoice.items_json)) {
                    items = invoice.items_json;
                } else if (typeof invoice.items_json === 'string') {
                    items = JSON.parse(invoice.items_json);
                } else if (invoice.items_json && typeof invoice.items_json === 'object') {
                    items = [invoice.items_json];
                } else if (invoice.items && Array.isArray(invoice.items)) {
                    items = invoice.items;
                }
                
                // Validate and fix items structure
                if (Array.isArray(items)) {
                    items = items.map((item, index) => {
                        return {
                            productName: item.productName || item.product_name || item.name || `Product ${index + 1}`,
                            quantity: parseInt(item.quantity || item.qty || 1),
                            unitPrice: parseFloat(item.unitPrice || item.unit_price || item.price || 0),
                            lineTotal: parseFloat(item.lineTotal || item.line_total || item.total || (item.quantity || 1) * (item.unitPrice || item.unit_price || item.price || 0)),
                            description: item.description || item.desc || ''
                        };
                    });
                }
            } catch (e) {
                console.error(' Error parsing items for print:', e);
                items = [{
                    productName: 'Error: Items parsing failed',
                    quantity: 1,
                    unitPrice: 0,
                    lineTotal: 0,
                    description: e.message
                }];
            }
            
            // Use modular template engine for better performance and maintainability
            const hideAspreeBranding = businessProfile?.hideAspreeBranding || false;
            const theme = hideAspreeBranding ? 'custom' : 'aspree';
            
            return generateModularTemplate(invoice, items, businessProfile, theme);
        }

        // Modular Template Engine - Reduces code duplication by 70%
        function generateModularTemplate(invoice, items, businessProfile, theme = 'aspree') {
            const templateData = prepareTemplateData(invoice, items, businessProfile);
            const themeConfig = getThemeConfiguration(theme, businessProfile);
            
            return buildInvoiceTemplate(templateData, themeConfig);
        }

        // Data Preparation Utility - Shared across all templates
        function prepareTemplateData(invoice, items, businessProfile) {
            const businessName = businessProfile?.name || businessProfile?.businessName || 'Your Business Name';
            const businessAddress = businessProfile?.address || 'Your Business Address';
            const businessPhone = businessProfile?.phone || '';
            const businessEmail = businessProfile?.email || '';
            const businessLogo = businessProfile?.logo || businessProfile?.logoUrl || '';

            return {
                invoice: {
                    number: invoice.invoice_number,
                    date: formatDate(invoice.invoice_date),
                    dueDate: formatDate(invoice.due_date),
                    customerName: invoice.customer_name,
                    customerAddress: invoice.customer_address || '',
                    customerPhone: invoice.customer_phone || '',
                    customerEmail: invoice.customer_email || '',
                    subtotal: invoice.subtotal || (invoice.total_amount - (invoice.tax || 0)),
                    tax: invoice.tax || 0,
                    shipping: invoice.shipping_cost || 0,
                    discount: invoice.discount || 0,
                    total: invoice.total_amount || invoice.grand_total || 0,
                    notes: invoice.notes || ''
                },
                business: {
                    name: businessName,
                    address: businessAddress,
                    phone: businessPhone,
                    email: businessEmail,
                    logo: businessLogo
                },
                items: items.map(item => ({
                    name: item.productName,
                    quantity: item.quantity,
                    unitPrice: item.unitPrice,
                    total: item.lineTotal,
                    description: item.description || ''
                }))
            };
        }

        // Theme Configuration - Centralized styling management
        function getThemeConfiguration(theme, businessProfile) {
            const themes = {
                aspree: {
                    name: 'Aspree Professional',
                    colors: {
                        primary: '#6366f1',
                        secondary: '#4f46e5',
                        light: '#e0e7ff',
                        text: '#1f2937',
                        background: '#f8fafc'
                    },
                    branding: {
                        showFooter: true,
                        footerText: 'Powered by <strong>Aspree.id</strong> - Professional Invoice Management',
                        headerStyle: 'gradient',
                        borderRadius: '16px'
                    },
                    typography: {
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif',
                        titleSize: '32px',
                        headerSize: '28px'
                    }
                },
                custom: {
                    name: 'Custom Business',
                    colors: {
                        primary: businessProfile?.customColors?.primary || '#374151',
                        secondary: businessProfile?.customColors?.secondary || '#4f46e5',
                        light: '#f9fafb',
                        text: '#111827',
                        background: '#ffffff'
                    },
                    branding: {
                        showFooter: false,
                        footerText: '',
                        headerStyle: 'flat',
                        borderRadius: '8px'
                    },
                    typography: {
                        fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif',
                        titleSize: '28px',
                        headerSize: '24px'
                    }
                }
            };

            return themes[theme] || themes.aspree;
        }

        // Template Builder - Generates HTML with theme configuration
        function buildInvoiceTemplate(data, theme) {
            const itemsHTML = generateItemsTable(data.items, theme);
            const totalsHTML = generateTotalsSection(data.invoice, theme);
            const headerHTML = generateHeaderSection(data, theme);
            const partiesHTML = generatePartiesSection(data, theme);
            const stylesCSS = generateThemeStyles(theme);

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice - ${data.invoice.number}</title>
                    <style>${stylesCSS}</style>
                </head>
                <body>
                    <div class="invoice-container">
                        ${headerHTML}
                        <div class="content-section">
                            ${partiesHTML}
                            ${itemsHTML}
                            ${totalsHTML}
                            ${data.invoice.notes ? generateNotesSection(data.invoice.notes, theme) : ''}
                        </div>
                        ${theme.branding.showFooter ? `<div class="footer">${theme.branding.footerText}</div>` : ''}
                    </div>
                </body>
                </html>
            `;
        }

        // Component Generators - Modular and reusable
        function generateItemsTable(items, theme) {
            const itemRows = items.map(item => `
                <tr>
                    <td class="item-cell">${item.name}</td>
                    <td class="item-cell center">${item.quantity}</td>
                    <td class="item-cell right">${formatCurrency(item.unitPrice)}</td>
                    <td class="item-cell right">${formatCurrency(item.total)}</td>
                </tr>
            `).join('');

            return `
                <table class="items-table">
                    <thead>
                        <tr>
                            <th class="header-cell">Item</th>
                            <th class="header-cell center">Qty</th>
                            <th class="header-cell right">Harga</th>
                            <th class="header-cell right">Total</th>
                        </tr>
                    </thead>
                    <tbody>${itemRows}</tbody>
                </table>
            `;
        }

        function generateTotalsSection(invoice, theme) {
            return `
                <div class="totals">
                    <table class="totals-table">
                        ${invoice.tax > 0 ? `
                        <tr>
                            <td>Subtotal:</td>
                            <td class="right">${formatCurrency(invoice.subtotal)}</td>
                        </tr>
                        <tr>
                            <td>Pajak:</td>
                            <td class="right">${formatCurrency(invoice.tax)}</td>
                        </tr>
                        ` : ''}
                        ${invoice.shipping > 0 ? `
                        <tr>
                            <td>Ongkir:</td>
                            <td class="right">${formatCurrency(invoice.shipping)}</td>
                        </tr>
                        ` : ''}
                        ${invoice.discount > 0 ? `
                        <tr>
                            <td>Diskon:</td>
                            <td class="right">-${formatCurrency(invoice.discount)}</td>
                        </tr>
                        ` : ''}
                        <tr class="total-row">
                            <td>TOTAL:</td>
                            <td class="right">${formatCurrency(invoice.total)}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generateHeaderSection(data, theme) {
            const isGradient = theme.branding.headerStyle === 'gradient';
            const headerClass = isGradient ? 'header-gradient' : 'header-flat';

            return `
                <div class="${headerClass}">
                    <div class="header-content">
                        <div class="business-info">
                            ${data.business.logo ? `<img src="${data.business.logo}" alt="Logo" class="business-logo">` : ''}
                            <div class="business-name">${data.business.name}</div>
                            <div class="business-details">
                                ${data.business.address}<br>
                                ${data.business.phone}<br>
                                ${data.business.email}
                            </div>
                        </div>
                        <div class="invoice-meta">
                            <div class="invoice-title">FAKTUR</div>
                            <div class="invoice-number">#${data.invoice.number}</div>
                            <div class="invoice-dates">
                                <div>Tanggal: ${data.invoice.date}</div>
                                <div>Jatuh Tempo: ${data.invoice.dueDate}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePartiesSection(data, theme) {
            return `
                <div class="parties">
                    <div class="party">
                        <h3>DARI</h3>
                        <div class="party-name">${data.business.name}</div>
                        <div>
                            ${data.business.address}<br>
                            ${data.business.phone}<br>
                            ${data.business.email}
                        </div>
                    </div>
                    <div class="party">
                        <h3>KEPADA</h3>
                        <div class="party-name">${data.invoice.customerName}</div>
                        <div>
                            ${data.invoice.customerAddress}<br>
                            ${data.invoice.customerPhone}<br>
                            ${data.invoice.customerEmail}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateNotesSection(notes, theme) {
            return `
                <div class="notes">
                    <h3>Catatan:</h3>
                    <p>${notes}</p>
                </div>
            `;
        }

        function generateThemeStyles(theme) {
            return `
                :root {
                    --primary: ${theme.colors.primary};
                    --secondary: ${theme.colors.secondary};
                    --light: ${theme.colors.light};
                    --text: ${theme.colors.text};
                    --background: ${theme.colors.background};
                }
                
                body {
                    font-family: ${theme.typography.fontFamily};
                    margin: 0;
                    padding: 20px;
                    color: var(--text);
                    line-height: 1.6;
                    background: var(--background);
                }
                
                .invoice-container {
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    border-radius: ${theme.branding.borderRadius};
                    overflow: hidden;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                }
                
                .header-gradient {
                    background: linear-gradient(135deg, var(--primary), var(--secondary));
                    color: white;
                    padding: 40px;
                    position: relative;
                }
                
                .header-flat {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    padding: 40px;
                    background: var(--light);
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .header-content {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                }
                
                .business-info { flex: 1; }
                
                .business-logo {
                    max-height: 60px;
                    max-width: 180px;
                    margin-bottom: 16px;
                    border-radius: 8px;
                }
                
                .business-name {
                    font-size: ${theme.typography.headerSize};
                    font-weight: 800;
                    margin-bottom: 8px;
                    color: ${theme.branding.headerStyle === 'gradient' ? 'white' : 'var(--primary)'};
                }
                
                .business-details {
                    opacity: 0.9;
                    font-size: 14px;
                    line-height: 1.5;
                }
                
                .invoice-meta {
                    text-align: right;
                    background: ${theme.branding.headerStyle === 'gradient' ? 'rgba(255, 255, 255, 0.1)' : 'white'};
                    padding: 20px;
                    border-radius: 6px;
                    ${theme.branding.headerStyle === 'gradient' ? 'backdrop-filter: blur(10px);' : 'border: 1px solid #e5e7eb;'}
                }
                
                .invoice-title {
                    font-size: ${theme.typography.titleSize};
                    font-weight: 900;
                    margin-bottom: 12px;
                    color: ${theme.branding.headerStyle === 'gradient' ? 'white' : 'var(--primary)'};
                }
                
                .content-section { padding: 40px; }
                
                .parties {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 40px;
                    margin-bottom: 40px;
                }
                
                .party {
                    background: var(--light);
                    padding: 20px;
                    border-radius: 6px;
                    border-left: 3px solid var(--primary);
                }
                
                .party h3 {
                    margin: 0 0 12px 0;
                    color: var(--primary);
                    font-size: 12px;
                    text-transform: uppercase;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                }
                
                .party-name {
                    font-size: 16px;
                    font-weight: 600;
                    margin-bottom: 8px;
                }
                
                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 32px;
                    border-radius: 6px;
                    overflow: hidden;
                    border: 1px solid #e5e7eb;
                }
                
                .items-table thead {
                    background: ${theme.branding.headerStyle === 'gradient' ? 'linear-gradient(135deg, var(--primary), var(--secondary))' : 'var(--primary)'};
                    color: white;
                }
                
                .header-cell {
                    padding: 14px 12px;
                    text-align: left;
                    font-weight: 600;
                    font-size: 13px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .item-cell {
                    padding: 12px 8px;
                    border-bottom: 1px solid #e5e7eb;
                }
                
                .items-table tbody tr:nth-child(even) {
                    background: var(--light);
                }
                
                .totals {
                    background: var(--light);
                    padding: 24px;
                    border-radius: 6px;
                    border: 1px solid #e5e7eb;
                }
                
                .totals-table {
                    width: 100%;
                    max-width: 350px;
                    margin-left: auto;
                }
                
                .totals-table td {
                    padding: 6px 0;
                    border: none;
                    font-size: 15px;
                }
                
                .total-row td {
                    font-weight: 700;
                    font-size: 18px;
                    padding-top: 12px;
                    border-top: 2px solid var(--primary);
                    color: var(--primary);
                }
                
                .notes {
                    background: #fef3cd;
                    border: 1px solid #f59e0b;
                    border-radius: 6px;
                    padding: 20px;
                    margin-top: 24px;
                }
                
                .notes h3 {
                    color: #92400e;
                    margin-bottom: 8px;
                    font-size: 16px;
                }
                
                .footer {
                    background: linear-gradient(135deg, #1f2937, #374151);
                    color: white;
                    padding: 24px 40px;
                    text-align: center;
                    font-size: 12px;
                    opacity: 0.8;
                }
                
                .center { text-align: center; }
                .right { text-align: right; }
                
                @media print {
                    body { margin: 0; padding: 0; background: white; }
                    .invoice-container { box-shadow: none; border-radius: 0; }
                }
            `;
        }

        // Generate items HTML for legacy compatibility
        function generateLegacyTemplate(invoice, items, businessProfile) {
            const itemsHTML = items.map(item => `
                <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${item.productName}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${formatCurrency(item.unitPrice)}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">${formatCurrency(item.lineTotal)}</td>
                </tr>
            `).join('');
            
            // Get business information
            const businessName = businessProfile?.name || businessProfile?.businessName || 'Your Business Name';
            const businessAddress = businessProfile?.address || 'Your Business Address';
            const businessPhone = businessProfile?.phone || '';
            const businessEmail = businessProfile?.email || '';
            const businessLogo = businessProfile?.logo || businessProfile?.logoUrl || '';
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice - ${invoice.invoice_number}</title>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #333;
                            line-height: 1.4;
                        }
                        .invoice-container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 30px;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        }
                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #eee;
                            padding-bottom: 20px;
                        }
                        .business-info {
                            flex: 1;
                        }
                        .business-logo {
                            max-height: 80px;
                            max-width: 200px;
                            margin-bottom: 10px;
                        }
                        .invoice-title {
                            font-size: 24px;
                            font-weight: bold;
                            color: #2c3e50;
                            margin: 0;
                        }
                        .invoice-meta {
                            text-align: right;
                        }
                        .parties {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 30px;
                        }
                        .party {
                            flex: 1;
                            margin-right: 20px;
                        }
                        .party:last-child {
                            margin-right: 0;
                        }
                        .party h3 {
                            margin: 0 0 10px 0;
                            color: #2c3e50;
                            font-size: 14px;
                            text-transform: uppercase;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        th {
                            background: #f8f9fa;
                            padding: 12px 8px;
                            text-align: left;
                            border-bottom: 2px solid #ddd;
                            font-weight: bold;
                        }
                        .totals {
                            text-align: right;
                            margin-top: 20px;
                        }
                        .totals table {
                            margin-left: auto;
                            width: 300px;
                        }
                        .totals td {
                            padding: 5px 10px;
                            border: none;
                        }
                        .total-row {
                            font-weight: bold;
                            font-size: 16px;
                            border-top: 2px solid #333 !important;
                        }
                        @media print {
                            body { margin: 0; padding: 0; }
                            .invoice-container { box-shadow: none; padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="header">
                            <div class="business-info">
                                ${businessLogo ? `<img src="${businessLogo}" alt="Logo" class="business-logo">` : ''}
                                <h2>${businessName}</h2>
                                <p>${businessAddress}<br>
                                ${businessPhone}<br>
                                ${businessEmail}</p>
                            </div>
                            <div class="invoice-meta">
                                <h1 class="invoice-title">FAKTUR</h1>
                                <p><strong>No:</strong> ${invoice.invoice_number}</p>
                                <p><strong>Tanggal:</strong> ${formatDate(invoice.invoice_date)}</p>
                                <p><strong>Jatuh Tempo:</strong> ${formatDate(invoice.due_date)}</p>
                            </div>
                        </div>
                        
                        <div class="parties">
                            <div class="party">
                                <h3>DARI</h3>
                                <strong>${businessName}</strong><br>
                                ${businessAddress}<br>
                                ${businessPhone}<br>
                                ${businessEmail}
                            </div>
                            <div class="party">
                                <h3>KEPADA</h3>
                                <strong>${invoice.customer_name}</strong><br>
                                ${invoice.customer_address || ''}<br>
                                ${invoice.customer_phone || ''}<br>
                                ${invoice.customer_email || ''}
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Produk/Layanan</th>
                                    <th style="text-align: center; width: 80px;">Qty</th>
                                    <th style="text-align: right; width: 120px;">Harga</th>
                                    <th style="text-align: right; width: 120px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                        
                        <div class="totals">
                            <table>
                                <tr>
                                    <td>Subtotal:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.subtotal || 0)}</td>
                                </tr>
                                ${invoice.tax_amount > 0 ? `
                                <tr>
                                    <td>Pajak:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.tax_amount)}</td>
                                </tr>
                                ` : ''}
                                ${invoice.shipping_cost > 0 ? `
                                <tr>
                                    <td>Ongkir:</td>
                                    <td style="text-align: right;">${formatCurrency(invoice.shipping_cost)}</td>
                                </tr>
                                ` : ''}
                                ${invoice.discount > 0 ? `
                                <tr>
                                    <td>Diskon:</td>
                                    <td style="text-align: right;">-${formatCurrency(invoice.discount)}</td>
                                </tr>
                                ` : ''}
                                <tr class="total-row">
                                    <td><strong>TOTAL:</strong></td>
                                    <td style="text-align: right;"><strong>${formatCurrency(invoice.total_amount || invoice.grand_total || 0)}</strong></td>
                                </tr>
                            </table>
                        </div>
                        
                        ${invoice.notes ? `
                        <div style="margin-top: 30px;">
                            <h3>Catatan:</h3>
                            <p>${invoice.notes}</p>
                        </div>
                        ` : ''}
                    </div>
                </body>
                </html>
            `;
        }

        // Legacy template functions removed - replaced by modular template engine above
        // This reduces code duplication by ~600 lines while maintaining functionality

        // DEPRECATED: Direct print function that generates unified invoice template
        // Orphaned code removed to fix syntax errors

        // Clean Custom Template without Aspree branding
        function generateCustomBrandingTemplate(invoice, items, businessProfile) {
            const itemsHTML = items.map(item => `
                <tr>
                    <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb;">${item.productName}</td>
                    <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: center;">${item.quantity}</td>
                    <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${formatCurrency(item.unitPrice)}</td>
                    <td style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; text-align: right;">${formatCurrency(item.lineTotal)}</td>
                </tr>
            `).join('');
            
            const businessName = businessProfile?.name || businessProfile?.businessName || 'Your Business Name';
            const businessAddress = businessProfile?.address || 'Your Business Address';
            const businessPhone = businessProfile?.phone || '';
            const businessEmail = businessProfile?.email || '';
            const businessLogo = businessProfile?.logo || businessProfile?.logoUrl || '';
            const primaryColor = businessProfile?.customColors?.primary || '#374151';
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice - ${invoice.invoice_number}</title>
                    <style>
                        body {
                            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #111827;
                            line-height: 1.6;
                            background: #ffffff;
                        }
                        .invoice-container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            border: 1px solid #e5e7eb;
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        .header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            padding: 40px;
                            background: #f9fafb;
                            border-bottom: 1px solid #e5e7eb;
                        }
                        .business-info {
                            flex: 1;
                        }
                        .business-logo {
                            max-height: 80px;
                            max-width: 200px;
                            margin-bottom: 16px;
                        }
                        .business-name {
                            font-size: 24px;
                            font-weight: 700;
                            color: ${primaryColor};
                            margin-bottom: 8px;
                        }
                        .business-details {
                            color: #6b7280;
                            font-size: 14px;
                            line-height: 1.5;
                        }
                        .invoice-meta {
                            text-align: right;
                            background: white;
                            padding: 20px;
                            border-radius: 6px;
                            border: 1px solid #e5e7eb;
                        }
                        .invoice-title {
                            font-size: 28px;
                            font-weight: 800;
                            color: ${primaryColor};
                            margin-bottom: 12px;
                        }
                        .invoice-details {
                            color: #6b7280;
                            font-size: 14px;
                        }
                        .content-section {
                            padding: 40px;
                        }
                        .parties {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 40px;
                            margin-bottom: 40px;
                        }
                        .party {
                            background: #f9fafb;
                            padding: 20px;
                            border-radius: 6px;
                            border-left: 3px solid ${primaryColor};
                        }
                        .party h3 {
                            margin: 0 0 12px 0;
                            color: ${primaryColor};
                            font-size: 12px;
                            text-transform: uppercase;
                            font-weight: 600;
                            letter-spacing: 0.5px;
                        }
                        .party-name {
                            font-size: 16px;
                            font-weight: 600;
                            color: #111827;
                            margin-bottom: 8px;
                        }
                        .items-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 32px;
                            border: 1px solid #e5e7eb;
                            border-radius: 6px;
                            overflow: hidden;
                        }
                        .items-table thead {
                            background: ${primaryColor};
                            color: white;
                        }
                        .items-table th {
                            padding: 14px 12px;
                            text-align: left;
                            font-weight: 600;
                            font-size: 13px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .items-table th:nth-child(2) { text-align: center; }
                        .items-table th:nth-child(3), .items-table th:nth-child(4) { text-align: right; }
                        .items-table tbody tr:nth-child(even) {
                            background: #f9fafb;
                        }
                        .totals {
                            background: #f9fafb;
                            padding: 24px;
                            border-radius: 6px;
                            border: 1px solid #e5e7eb;
                        }
                        .totals-table {
                            width: 100%;
                            max-width: 350px;
                            margin-left: auto;
                        }
                        .totals-table td {
                            padding: 6px 0;
                            border: none;
                            font-size: 15px;
                        }
                        .totals-table .total-row td {
                            font-weight: 700;
                            font-size: 18px;
                            padding-top: 12px;
                            border-top: 2px solid ${primaryColor};
                            color: ${primaryColor};
                        }
                        .notes {
                            background: #fef3cd;
                            border: 1px solid #f59e0b;
                            border-radius: 6px;
                            padding: 20px;
                            margin-top: 24px;
                        }
                        .notes h3 {
                            color: #92400e;
                            margin-bottom: 8px;
                            font-size: 16px;
                        }
                        @media print {
                            body { margin: 0; padding: 0; }
                            .invoice-container { border: none; border-radius: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="header">
                            <div class="business-info">
                                ${businessLogo ? `<img src="${businessLogo}" alt="Logo" class="business-logo">` : ''}
                                <div class="business-name">${businessName}</div>
                                <div class="business-details">
                                    ${businessAddress}<br>
                                    ${businessPhone}<br>
                                    ${businessEmail}
                                </div>
                            </div>
                            <div class="invoice-meta">
                                <div class="invoice-title">FAKTUR</div>
                                <div class="invoice-details">
                                    <div><strong>No:</strong> ${invoice.invoice_number}</div>
                                    <div><strong>Tanggal:</strong> ${formatDate(invoice.invoice_date)}</div>
                                    <div><strong>Jatuh Tempo:</strong> ${formatDate(invoice.due_date)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <div class="parties">
                                <div class="party">
                                    <h3>DARI</h3>
                                    <div class="party-name">${businessName}</div>
                                    <div>
                                        ${businessAddress}<br>
                                        ${businessPhone}<br>
                                        ${businessEmail}
                                    </div>
                                </div>
                                <div class="party">
                                    <h3>KEPADA</h3>
                                    <div class="party-name">${invoice.customer_name}</div>
                                    <div>
                                        ${invoice.customer_address || ''}<br>
                                        ${invoice.customer_phone || ''}<br>
                                        ${invoice.customer_email || ''}
                                    </div>
                                </div>
                            </div>
                            
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Harga</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHTML}
                                </tbody>
                            </table>
                            
                            <div class="totals">
                                <table class="totals-table">
                                    ${invoice.tax > 0 ? `
                                    <tr>
                                        <td>Subtotal:</td>
                                        <td style="text-align: right;">${formatCurrency(invoice.subtotal || (invoice.total_amount - invoice.tax))}</td>
                                    </tr>
                                    <tr>
                                        <td>Pajak:</td>
                                        <td style="text-align: right;">${formatCurrency(invoice.tax)}</td>
                                    </tr>
                                    ` : ''}
                                    ${invoice.shipping_cost > 0 ? `
                                    <tr>
                                        <td>Ongkir:</td>
                                        <td style="text-align: right;">${formatCurrency(invoice.shipping_cost)}</td>
                                    </tr>
                                    ` : ''}
                                    ${invoice.discount > 0 ? `
                                    <tr>
                                        <td>Diskon:</td>
                                        <td style="text-align: right;">-${formatCurrency(invoice.discount)}</td>
                                    </tr>
                                    ` : ''}
                                    <tr class="total-row">
                                        <td>TOTAL:</td>
                                        <td style="text-align: right;">${formatCurrency(invoice.total_amount || invoice.grand_total || 0)}</td>
                                    </tr>
                                </table>
                            </div>
                            
                            ${invoice.notes ? `
                            <div class="notes">
                                <h3>Catatan:</h3>
                                <p>${invoice.notes}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        // DEPRECATED: Direct print function that generates unified invoice template
        // Now using updated invoice view for consistent formatting
        /* function directPrintInvoice(invoiceData) {
            console.log(' Generating unified invoice template for direct printing');
            
            try {
                // Generate the printable HTML using unified template
                const printableHTML = generateUnifiedInvoiceForPrint(invoiceData);
                
                // Create new window and print immediately
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (!printWindow) {
                    alert('Popup blocked. Please allow popups for this site and try again.');
                    return;
                }
                
                printWindow.document.write(printableHTML);
                printWindow.document.close();
                
                // Wait for content to load then print immediately
                printWindow.onload = function() {
                    setTimeout(() => {
                        console.log(' Triggering print dialog');
                        printWindow.print();
                        // Close after printing (or user cancels)
                        setTimeout(() => {
                            printWindow.close();
                        }, 100);
                    }, 250); // Small delay to ensure styles are loaded
                };
                
            } catch (error) {
                console.error('Error generating invoice for direct printing:', error);
                alert('Error generating invoice for printing: ' + error.message);
            }
        } */


        // Payment Confirmation Functions
        async function refreshPaymentConfirmations(invoiceId) {
            try {
                // Placeholder for payment confirmations API
                // This would fetch payment confirmations uploaded by customers
                const response = await fetch(`/api/invoices/${invoiceId}/payment-confirmations`);
                const data = await response.json();
                
                const container = document.getElementById(`payment-confirmations-${invoiceId}`);
                if (data.success && data.confirmations && data.confirmations.length > 0) {
                    // Get current invoice to determine payment stage
                    const invoice = invoices.find(inv => inv.id == invoiceId || inv.id === parseInt(invoiceId));
                    const paymentStage = invoice ? invoice.payment_stage || 'full_payment' : 'full_payment';
                    
                    // Determine button text based on payment stage
                    let approveButtonText = ' Approve';
                    if (paymentStage === 'down_payment') {
                        approveButtonText = ' Approve DP';
                    } else if (paymentStage === 'final_payment') {
                        approveButtonText = ' Approve Final';
                    } else {
                        approveButtonText = ' Approve Payment';
                    }
                    container.innerHTML = data.confirmations.map(conf => `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <strong style="color: #2563eb;">Payment Confirmation</strong>
                                    <div style="font-size: 0.9em; color: #666; margin-top: 4px;">
                                        <div>Uploaded: ${conf.uploadDate ? formatDate(conf.uploadDate) : 'Unknown date'}</div>
                                        <div>Status: <span style="color: ${conf.status === 'pending' ? '#f59e0b' : (conf.status === 'approved' ? '#10b981' : '#ef4444')}; font-weight: bold;">${conf.status || 'pending'}</span></div>
                                        ${conf.notes ? `<div>Notes: ${conf.notes}</div>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-direction: column;">
                                    <button class="btn btn-sm btn-info" onclick="viewPaymentProof('${conf.filePath}')"> View Proof</button>
                                    ${conf.status === 'pending' ? `
                                        <div style="display: flex; gap: 5px;">
                                            <button class="btn btn-sm btn-success" onclick="approvePaymentConfirmation(${invoiceId}, '${conf.id}')" style="font-size: 0.8em;">${approveButtonText}</button>
                                            <button class="btn btn-sm btn-danger" onclick="rejectPaymentConfirmation(${invoiceId}, '${conf.id}')" style="font-size: 0.8em;"> Reject</button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            ${conf.status === 'approved' ? `
                                <div style="background: #d1fae5; border: 1px solid #10b981; padding: 8px; border-radius: 4px; font-size: 0.85em; color: #065f46;">
                                     Payment approved and converted to order
                                </div>
                            ` : ''}
                            ${conf.status === 'rejected' ? `
                                <div style="background: #fee2e2; border: 1px solid #ef4444; padding: 8px; border-radius: 4px; font-size: 0.85em; color: #991b1b;">
                                     Payment rejected
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; color: #6c757d;">
                            <em>No payment confirmations uploaded yet</em>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error refreshing payment confirmations:', error);
                alert('Failed to refresh payment confirmations');
            }
        }

        function viewPaymentProof(fileUrl) {
            // Open payment proof in new window
            window.open(fileUrl, '_blank');
        }

        // Approve payment confirmation
        async function approvePaymentConfirmation(invoiceId, confirmationId) {
            try {
                // Get current invoice to determine payment stage
                const invoice = invoices.find(inv => inv.id == invoiceId || inv.id === parseInt(invoiceId));
                if (!invoice) {
                    alert('Invoice not found');
                    return;
                }

                const paymentStage = invoice.payment_stage || 'full_payment';
                const merchantNotes = prompt('Add notes (optional):') || '';
                
                let endpoint, confirmMessage, successMessage;
                
                // Route to appropriate stage-specific endpoint
                if (paymentStage === 'down_payment') {
                    endpoint = `/api/invoices/${invoiceId}/confirm-down-payment`;
                    confirmMessage = 'Approve down payment confirmation? This will generate a final payment link.';
                    successMessage = ' Down payment confirmed! Final payment link generated for customer.';
                } else if (paymentStage === 'final_payment') {
                    endpoint = `/api/invoices/${invoiceId}/confirm-final-payment`;
                    confirmMessage = 'Approve final payment confirmation? This will complete the invoice and create an order.';
                    successMessage = ' Final payment confirmed! Invoice completed and order created.';
                } else {
                    endpoint = `/api/invoices/${invoiceId}/status`;
                    confirmMessage = 'Approve payment confirmation? This will mark invoice as paid and create an order.';
                    successMessage = ' Payment confirmed! Invoice marked as paid and order created.';
                }

                if (!confirm(confirmMessage)) {
                    return;
                }
                
                let requestBody;
                if (paymentStage === 'down_payment' || paymentStage === 'final_payment') {
                    requestBody = JSON.stringify({ merchantNotes });
                } else {
                    requestBody = JSON.stringify({ 
                        status: 'paid',
                        payment_confirmed_at: new Date().toISOString(),
                        merchantNotes 
                    });
                }

                const response = await fetch(endpoint, {
                    method: paymentStage === 'down_payment' || paymentStage === 'final_payment' ? 'POST' : 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: requestBody
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show appropriate success message
                    if (result.orderNumber) {
                        alert(`${successMessage}\n\nOrder created: ${result.orderNumber}`);
                    } else {
                        alert(successMessage);
                    }
                    
                    // Close modal if open
                    closeInvoiceModal();
                    
                    // Refresh data
                    await loadInvoices();
                    if (typeof loadOrders !== 'undefined') {
                        loadOrders();
                    }
                } else {
                    alert('Error approving payment: ' + result.error);
                }
            } catch (error) {
                console.error('Error approving payment confirmation:', error);
                alert('Error approving payment confirmation');
            }
        }

        // Reject payment confirmation
        async function rejectPaymentConfirmation(invoiceId, confirmationId) {
            try {
                const merchantNotes = prompt('Reason for rejection:') || '';
                
                if (!merchantNotes.trim()) {
                    alert('Please provide a reason for rejection');
                    return;
                }
                
                const response = await fetch(`/api/invoices/${invoiceId}/payment-confirmations/reject`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ merchantNotes })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(' Payment confirmation rejected.');
                    // Refresh payment confirmations to show updated status
                    await refreshPaymentConfirmations(invoiceId);
                    // Refresh the invoice list to update status
                    loadInvoices();
                } else {
                    alert('Error rejecting payment: ' + result.error);
                }
            } catch (error) {
                console.error('Error rejecting payment confirmation:', error);
                alert('Error rejecting payment confirmation');
            }
        }

        // Confirm Payment and Move to Orders
        async function confirmPaymentAndMoveToOrders(invoiceId, paymentType) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                alert('Invoice not found');
                return;
            }

            let confirmMessage = '';
            if (paymentType === 'down_payment') {
                confirmMessage = 'Are you sure you want to confirm the down payment for this invoice?';
            } else if (paymentType === 'final') {
                confirmMessage = 'Are you sure you want to confirm the final payment for this invoice?';
            } else {
                confirmMessage = 'Are you sure you want to confirm payment for this invoice? This will mark it as paid and move it to Orders.';
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Update invoice status to paid
                const response = await fetch(`/api/invoices/${invoiceId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: 'paid',
                        payment_confirmed_at: new Date().toISOString(),
                        payment_type: paymentType
                    })
                });

                const data = await response.json();
                console.log(' Payment confirmation response:', data);
                
                if (data.success) {
                    if (data.orderCreated || data.orderId) {
                        alert(` Payment confirmed! Invoice has been marked as paid and moved to Orders.\n\nOrder created: ${data.orderNumber || data.orderId}`);
                    } else {
                        alert(' Payment confirmed! Invoice has been marked as paid.');
                        console.warn(' Order was not created automatically. Check server logs.');
                    }
                    
                    // Close modal if open
                    closeInvoiceModal();
                    
                    // Refresh invoices list
                    await loadInvoices();
                    
                    // Refresh orders list if we're on that tab
                    if (document.querySelector('.nav-btn.active')?.textContent?.includes('Orders')) {
                        await loadOrders();
                    }
                    
                } else {
                    alert(' Failed to confirm payment: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error confirming payment:', error);
                alert(' Error confirming payment: ' + error.message);
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.share-dropdown')) {
                document.querySelectorAll('.share-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        async function updateInvoiceStatus(invoiceId, newStatus) {
            if (!confirm(`Are you sure you want to mark this invoice as ${newStatus}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/invoices/${invoiceId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`Invoice status updated to ${newStatus}`);
                    loadInvoices();
                    loadInvoiceStats();
                } else {
                    showError('Failed to update invoice status: ' + data.error);
                }
            } catch (error) {
                showError('Error updating invoice status: ' + error.message);
            }
        }

        // Automatically update invoice status when sharing actions occur
        async function updateStatusOnShare(invoice) {
            if (!invoice) return;
            
            // Only auto-update if status is 'draft' - change to 'sent' when shared
            if (invoice.status === 'draft') {
                try {
                    console.log(` Auto-updating invoice ${invoice.invoice_number} status from 'draft' to 'sent' after sharing`);
                    
                    const response = await fetch(`/api/invoices/${invoice.id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            status: 'sent',
                            sent_at: new Date().toISOString()
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        console.log(' Invoice status automatically updated to sent');
                        // Update the local invoice object
                        invoice.status = 'sent';
                        invoice.sent_at = new Date().toISOString();
                        // Refresh the invoices list to show updated status
                        loadInvoices();
                        loadInvoiceStats();
                    } else {
                        console.error(' Failed to auto-update invoice status:', data.error);
                    }
                } catch (error) {
                    console.error(' Error auto-updating invoice status:', error);
                }
            }
        }

        async function confirmDownPayment(invoiceId) {
            if (!confirm('Confirm that down payment has been received? This will generate a final payment link for the customer.')) {
                return;
            }
            
            console.log(' Confirming down payment for invoice ID:', invoiceId);
            
            try {
                const response = await fetch(`/api/invoices/${invoiceId}/confirm-down-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log(' DP confirmation response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(' DP confirmation response data:', data);
                
                if (data.success) {
                    showSuccess(' Down payment confirmed! Final payment link generated.');
                    
                    // Validate we have the required data
                    if (!data.finalPaymentToken) {
                        showError('Warning: Final payment token not received from server');
                        console.error(' Missing finalPaymentToken in response:', data);
                    }
                    
                    // Refresh invoices list first to get updated data
                    await loadInvoices();
                    await loadInvoiceStats();
                    
                    // Show final payment link modal with updated invoice data
                    if (data.finalPaymentToken) {
                        try {
                            const invoiceResponse = await fetch(`/api/invoices/${invoiceId}`);
                            console.log(' Invoice fetch response status:', invoiceResponse.status);
                            
                            if (!invoiceResponse.ok) {
                                throw new Error(`Failed to fetch updated invoice: HTTP ${invoiceResponse.status}`);
                            }
                            
                            const invoiceData = await invoiceResponse.json();
                            console.log(' Updated invoice data:', invoiceData);
                            
                            if (invoiceData.success && invoiceData.invoice) {
                                setTimeout(() => {
                                    showFinalPaymentLink(invoiceData.invoice.invoice_number);
                                }, 1000);
                            } else {
                                showError('Failed to fetch updated invoice data: ' + (invoiceData.error || 'Unknown error'));
                            }
                        } catch (invoiceError) {
                            console.error(' Error fetching updated invoice:', invoiceError);
                            showError('Warning: Could not show final payment link. Please refresh and try again.');
                        }
                    }
                } else {
                    showError('Failed to confirm down payment: ' + (data.error || 'Unknown error'));
                    console.error(' DP confirmation failed:', data);
                }
            } catch (error) {
                console.error(' Error confirming down payment:', error);
                showError('Error confirming down payment: ' + error.message);
            }
        }

        async function confirmFinalPayment(invoiceId) {
            if (!confirm('Confirm that final payment has been received? This will complete the invoice and move it to orders.')) {
                return;
            }
            
            console.log(' Confirming final payment for invoice ID:', invoiceId);
            
            try {
                const response = await fetch(`/api/invoices/${invoiceId}/confirm-final-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log(' Final payment confirmation response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(' Final payment confirmation response data:', data);
                
                if (data.success) {
                    const orderMessage = data.orderNumber ? ` Order created: ${data.orderNumber}` : '';
                    showSuccess(` Final payment confirmed! Invoice completed and moved to orders.${orderMessage}`);
                    
                    console.log(' Final payment confirmed successfully:', {
                        invoiceId: invoiceId,
                        orderNumber: data.orderNumber,
                        orderResult: data.orderResult
                    });
                    
                    // Refresh data
                    await loadInvoices();
                    await loadInvoiceStats();
                    
                    // If on orders tab, refresh orders too
                    if (document.querySelector('.nav-btn.active')?.textContent?.includes('Orders')) {
                        await loadOrders();
                    }
                    
                    // Optional: Navigate to orders section after a delay
                    if (data.orderNumber) {
                        setTimeout(() => {
                            if (confirm('Would you like to view the new order?')) {
                                document.querySelector('[data-section="orders"]')?.click();
                            }
                        }, 2000);
                    }
                } else {
                    showError('Failed to confirm final payment: ' + (data.error || 'Unknown error'));
                    console.error(' Final payment confirmation failed:', data);
                }
            } catch (error) {
                console.error(' Error confirming final payment:', error);
                showError('Error confirming final payment: ' + error.message);
            }
        }

        function showFinalPaymentLink(invoiceNumber) {
            const invoice = invoices.find(inv => inv.invoice_number === invoiceNumber);
            
            console.log(' Showing final payment link for invoice:', invoiceNumber);
            console.log(' Invoice data:', invoice);
            
            if (!invoice) {
                showError('Invoice not found for final payment link');
                return;
            }
            
            if (!invoice.final_payment_token) {
                showError('Final payment token not found. Please try confirming the down payment again.');
                return;
            }
            
            const finalPaymentUrl = `${window.location.origin}/final-payment?token=${invoice.final_payment_token}`;
            console.log(' Generated final payment URL:', finalPaymentUrl);
            
            // Show modal with final payment link
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Invoice Link for Final Payment</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Send this invoice link to the customer for final payment:</p>
                        <div class="link-box">
                            <input type="text" value="${finalPaymentUrl}" readonly onclick="this.select()" class="link-input">
                            <button onclick="copyToClipboard('${finalPaymentUrl}'); showSuccess('Link copied to clipboard!')" class="btn btn-sm btn-primary"> Copy</button>
                        </div>
                        
                        <!-- Email Section -->
                        <div class="email-section" style="margin-top: 20px; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background-color: #f8f9fa;">
                            <h5 style="margin-bottom: 10px;"> Send via Email</h5>
                            <div class="email-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="email" id="finalPaymentEmail" placeholder="Customer email address" 
                                       value="${invoice?.customer_email || ''}" 
                                       style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <button onclick="sendFinalPaymentEmail(${invoice?.id}, document.getElementById('finalPaymentEmail').value)" 
                                        class="btn btn-sm btn-success"> Send Email</button>
                            </div>
                            <small style="color: #6c757d;">This will send a professional email with the invoice link for final payment completion.</small>
                        </div>
                        
                        <div class="share-buttons" style="margin-top: 15px;">
                            <button onclick="shareViaWhatsAppLink('${invoiceUrl}')" class="btn btn-sm btn-success"> WhatsApp</button>
                            <button onclick="shareViaMailto('${invoiceUrl}')" class="btn btn-sm btn-secondary"> Mailto</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Link copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        function shareViaWhatsAppLink(url) {
            const whatsappUrl = `https://api.whatsapp.com/send?text=Silakan selesaikan pembayaran akhir invoice Anda: ${encodeURIComponent(url)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        function shareViaMailto(url) {
            const subject = 'Final Payment Required - Invoice';
            const body = `Please complete your final payment using this link: ${url}`;
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoUrl);
        }
        
        function getFinalPaymentToken(invoiceNumber) {
            const invoice = invoices.find(inv => inv.invoice_number === invoiceNumber);
            return invoice?.final_payment_token || '';
        }
        
        async function sendFinalPaymentEmail(invoiceId, customerEmail) {
            if (!customerEmail) {
                alert('Please enter a customer email address');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(customerEmail)) {
                alert('Please enter a valid email address');
                return;
            }
            
            const confirmSend = confirm(`Send final payment email to ${customerEmail}?`);
            if (!confirmSend) return;
            
            try {
                const response = await fetch('/api/final-payment/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        invoiceId: invoiceId,
                        customerEmail: customerEmail
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(' Final payment email sent successfully!');
                    
                    // Close the modal
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                    }
                } else {
                    showError('Failed to send final payment email: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending final payment email:', error);
                showError('Error sending final payment email: ' + error.message);
            }
        }

        async function sendInvoiceEmail(invoiceId, customerEmail) {
            if (!customerEmail) {
                alert('No customer email available for this invoice');
                return;
            }
            
            const confirmSend = confirm(`Send invoice email to ${customerEmail}?`);
            if (!confirmSend) return;
            
            try {
                const response = await fetch('/api/notifications/send-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        invoice_id: invoiceId,
                        customer_email: customerEmail,
                        include_pdf: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Invoice email sent successfully!');
                    
                    // Update status after successful email send
                    const invoice = invoices.find(inv => inv.id === invoiceId);
                    await updateStatusOnShare(invoice);
                } else {
                    alert('Failed to send invoice email: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending invoice email:', error);
                alert('Error sending invoice email: ' + error.message);
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/invoices/${invoiceId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Invoice deleted successfully');
                    loadInvoices();
                    loadInvoiceStats();
                } else {
                    showError('Failed to delete invoice: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting invoice: ' + error.message);
            }
        }

        async function downloadInvoicePDF(invoiceNumber) {
            try {
                // First get the invoice by number to get the ID
                const invoiceResponse = await fetch(`/api/invoices/number/${invoiceNumber}`);
                const invoiceResult = await invoiceResponse.json();
                
                if (!invoiceResult.success) {
                    alert('Failed to fetch invoice data: ' + invoiceResult.error);
                    return;
                }

                const invoice = invoiceResult.invoice;
                
                // Try the PDF endpoint that takes invoice ID
                const response = await fetch(`/api/invoices/pdf/${invoice.id}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Invoice-${invoiceNumber}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    console.log(' PDF downloaded successfully');
                } else {
                    console.warn('PDF endpoint not available, using fallback method');
                    // Fallback: Open invoice view in new window for printing
                    fallbackPrintInvoice(invoice);
                }
            } catch (error) {
                console.error('PDF Download Error:', error);
                console.log('Using fallback print method');
                // Try to get invoice data and use fallback
                try {
                    const invoiceResponse = await fetch(`/api/invoices/number/${invoiceNumber}`);
                    const invoiceResult = await invoiceResponse.json();
                    if (invoiceResult.success) {
                        fallbackPrintInvoice(invoiceResult.invoice);
                    } else {
                        alert('Could not load invoice for printing');
                    }
                } catch (fallbackError) {
                    alert('Error generating PDF: ' + error.message);
                }
            }
        }

        function fallbackPrintInvoice(invoice) {
            if (!invoice.customer_token) {
                alert('Cannot print: Invoice does not have a customer token. Please regenerate the invoice.');
                return;
            }

            // Open invoice view in new window
            const baseUrl = window.location.origin;
            const invoiceUrl = `${baseUrl}/simple-invoice-view.html?id=${invoice.invoice_number}&from=dashboard`;
            
            // Show user a helpful message
            const userConfirm = confirm(
                'PDF generation is not available. Would you like to open the invoice in a new window where you can print it manually?\n\n' +
                'Click OK to open invoice, or Cancel to copy the link instead.'
            );
            
            if (userConfirm) {
                const printWindow = window.open(invoiceUrl, '_blank');
                
                if (printWindow) {
                    // Additional instruction after window opens
                    setTimeout(() => {
                        alert('Invoice opened! Use Ctrl+P (or Cmd+P on Mac) to print.');
                    }, 1000);
                } else {
                    // Popup blocked
                    alert('Popup was blocked. Copying invoice link to clipboard instead...');
                    copyInvoiceLink(invoice.customer_token);
                }
            } else {
                // User chose to copy link
                copyInvoiceLink(invoice.customer_token);
            }
        }

        function refreshInvoices() {
            loadInvoices();
            loadInvoiceStats();
        }

        function showInvoiceError(message) {
            const errorDiv = document.getElementById('invoices-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Invalid date';
            return date.toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Order Print Functions
        function printShippingLabel(orderId) {
            const baseUrl = window.location.origin;
            const labelUrl = `${baseUrl}/shipping-label.html?id=${orderId}`;
            
            const userConfirm = confirm(
                'Open shipping label in a new window?\n\n' +
                'Click OK to open label for printing, or Cancel to copy the link.'
            );
            
            if (userConfirm) {
                const printWindow = window.open(labelUrl, '_blank');
                
                if (printWindow) {
                    setTimeout(() => {
                        alert(' Shipping label opened! Use Ctrl+P (or Cmd+P on Mac) to print.');
                    }, 1000);
                } else {
                    alert('Popup blocked. Copying link to clipboard...');
                    navigator.clipboard?.writeText(labelUrl).then(() => {
                        alert(' Shipping label link copied to clipboard!');
                    }).catch(() => {
                        alert('Link: ' + labelUrl);
                    });
                }
            } else {
                navigator.clipboard?.writeText(labelUrl).then(() => {
                    alert(' Shipping label link copied to clipboard!');
                }).catch(() => {
                    alert('Link: ' + labelUrl);
                });
            }
        }

        function printServiceTicket(orderId) {
            openServiceTicketModal(orderId);
        }

        async function openServiceTicketModal(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load order');
                }
                
                const businessResponse = await fetch('/api/business-settings');
                const businessData = await businessResponse.json();
                const businessSettings = businessData.success ? businessData.settings : businessData;
                
                const modalContent = document.getElementById('serviceTicketModalContent');
                modalContent.innerHTML = generateServiceTicketHTML(data.order, businessSettings);
                
                // Store data for printing
                const modal = document.getElementById('serviceTicketModal');
                modal._orderData = data.order;
                modal._businessSettings = businessSettings;
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading service ticket:', error);
                alert('Error loading service ticket: ' + error.message);
            }
        }

        function closeServiceTicketModal() {
            document.getElementById('serviceTicketModal').style.display = 'none';
            document.getElementById('serviceTicketModalContent').innerHTML = '';
        }

        function generateServiceTicketHTML(order, businessSettings) {
            // Add null checks for order properties
            
            // Comprehensive address fallback chain
            const customerAddress = order.customer_address || 
                                  order.home_address || 
                                  order.address || 
                                  order.shipping_address || 
                                  order.billing_address;
            
            // Group items by name and sum quantities for simplified display
            const itemGroups = {};
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const name = item.product_name || item.description || 'Unknown Item';
                    const quantity = item.quantity || 1;
                    
                    if (itemGroups[name]) {
                        itemGroups[name] += quantity;
                    } else {
                        itemGroups[name] = quantity;
                    }
                });
            }
            
            return `
                <div class="service-ticket-modal">
                    <div class="service-ticket">
                        <!-- Header Section -->
                        <div class="ticket-header">
                            <h1 class="company-name">${businessSettings.company_name || businessSettings.business_name || businessSettings.name || 'Business Name'}</h1>
                            <div class="order-info">
                                <div class="order-number">${order.order_number || `Order #${order.id}`}</div>
                                <div class="order-date">${order.created_at ? new Date(order.created_at).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                }) : 'N/A'}</div>
                            </div>
                        </div>
                        
                        <!-- Ship To Section -->
                        <div class="ship-to-section">
                            <h2 class="section-title">Ship To</h2>
                            <div class="address-info">
                                <div class="customer-name">${order.customer_name || 'Walk-in Customer'}</div>
                                <div>${customerAddress || 'Address not provided'}</div>
                                <div>${order.customer_phone || 'Phone not provided'}</div>
                                <div>${order.customer_email || 'Email not provided'}</div>
                            </div>
                        </div>
                        
                        <!-- Items Section -->
                        <div class="items-section">
                            <div class="items-header">
                                <h2 class="section-title">Items</h2>
                                <div class="quantity-header">Quantity</div>
                            </div>
                            <ul class="items-list">
                                ${Object.keys(itemGroups).length > 0 
                                    ? Object.entries(itemGroups).map(([name, totalQuantity]) => `
                                        <li class="item-row">
                                            <div class="item-name">${name}</div>
                                            <div class="item-quantity">${totalQuantity}</div>
                                        </li>
                                    `).join('')
                                    : `<li class="item-row">
                                        <div class="item-name">No items found</div>
                                        <div class="item-quantity">0</div>
                                    </li>`
                                }
                            </ul>
                        </div>
                        
                        <!-- Footer Section -->
                        <div class="ticket-footer">
                            <div class="thank-you">Thank you for shopping with us!</div>
                            <div class="company-info">
                                <strong>${businessSettings.company_name || businessSettings.business_name || businessSettings.name || 'Your Business'}</strong>
                                <div>${businessSettings.address || 'Business Address'}</div>
                                <div>${businessSettings.phone || 'Phone'} | ${businessSettings.email || 'business@email.com'}</div>
                                <div>${businessSettings.website || 'company.com'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="print-button" onclick="printServiceTicketModal()">
                         Print Ticket
                    </button>
                </div>
            `;
        }

        function printServiceTicketModal() {
            const modal = document.getElementById('serviceTicketModal');
            const order = modal._orderData;
            const businessSettings = modal._businessSettings;
            
            if (!order || !businessSettings) {
                alert('Unable to print - ticket data not available');
                return;
            }
            
            const thermalContent = generateThermalTicketHTML(order, businessSettings);
            
            const printWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Thermal Ticket</title>
                    <style>
                        @page {
                            size: 10cm 15cm;
                            margin: 0.2cm;
                        }
                        
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 10px;
                            line-height: 1.3;
                            margin: 0;
                            padding: 0.2cm;
                            width: 9.6cm;
                            box-sizing: border-box;
                        }
                        
                        .thermal-ticket {
                            width: 100%;
                            border: 1px solid #333;
                            padding: 12px 16px;
                            background: white;
                        }
                        
                        .thermal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 1px solid #333;
                            padding-bottom: 8px;
                            margin-bottom: 12px;
                        }
                        
                        .thermal-title {
                            font-size: 16px;
                            font-weight: bold;
                            margin: 0;
                        }
                        
                        .thermal-order-info {
                            text-align: right;
                            font-size: 10px;
                            line-height: 1.3;
                        }
                        
                        .thermal-order-number {
                            font-weight: normal;
                            margin-bottom: 2px;
                        }
                        
                        .thermal-order-date {
                            color: #666;
                        }
                        
                        .thermal-section {
                            margin-bottom: 6px;
                            font-size: 9px;
                        }
                        
                        .thermal-section h4 {
                            font-size: 10px;
                            margin: 0 0 3px 0;
                            font-weight: bold;
                            text-decoration: underline;
                        }
                        
                        .thermal-row {
                            margin-bottom: 1px;
                            word-wrap: break-word;
                            overflow-wrap: break-word;
                        }
                        
                        .thermal-label {
                            font-weight: bold;
                            display: inline-block;
                            width: 2.2cm;
                            vertical-align: top;
                        }
                        
                        .thermal-address {
                            font-size: 7px;
                            line-height: 1.0;
                        }
                        
                        .thermal-items-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 8px;
                            padding-bottom: 4px;
                            border-bottom: 1px solid #333;
                        }
                        
                        .thermal-items-header h4 {
                            margin: 0;
                            font-size: 11px;
                            font-weight: bold;
                        }
                        
                        .thermal-items-list {
                            margin-top: 6px;
                        }
                        
                        .thermal-item-row {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 3px 0;
                            line-height: 1.3;
                        }
                        
                        .thermal-item-name {
                            font-size: 10px;
                            color: #000;
                            flex-grow: 1;
                            padding-right: 20px;
                        }
                        
                        .thermal-item-quantity {
                            font-size: 10px;
                            color: #000;
                            text-align: right;
                            min-width: 30px;
                        }
                        
                        .thermal-notes {
                            font-size: 8px;
                            border-top: 1px dashed #000;
                            padding-top: 3px;
                            margin-top: 5px;
                        }
                        
                        .thermal-footer {
                            text-align: center;
                            margin-top: 20px;
                            padding-top: 16px;
                        }
                        
                        .thermal-thank-you {
                            font-size: 12px;
                            margin-bottom: 12px;
                            font-weight: normal;
                        }
                        
                        .thermal-business-info {
                            font-size: 10px;
                            line-height: 1.3;
                        }
                        
                        .thermal-business-info strong {
                            font-weight: bold;
                            font-size: 11px;
                            margin-bottom: 4px;
                            display: block;
                        }
                        
                        /* Mobile thermal ticket adjustments */
                        @media screen and (max-width: 768px) {
                            body {
                                width: 100%;
                                max-width: 100%;
                                padding: 0.1cm;
                                font-size: 9px;
                            }
                            
                            .thermal-ticket {
                                border-width: 1px;
                                padding: 8px;
                            }
                            
                            .thermal-title {
                                font-size: 12px;
                            }
                            
                            .thermal-section h4 {
                                font-size: 9px;
                            }
                            
                            .thermal-row {
                                flex-direction: column;
                                gap: 2px;
                            }
                            
                            .thermal-total {
                                font-size: 10px;
                            }
                        }

                        @media print {
                            body {
                                margin: 0 !important;
                                padding: 0 !important;
                                width: 9.6cm;
                            }
                            
                            .thermal-ticket {
                                page-break-inside: avoid;
                            }
                        }
                        
                        /* Mobile print-specific adjustments */
                        @media print and (max-width: 768px) {
                            body {
                                width: 100% !important;
                                max-width: 100% !important;
                                font-size: 8px;
                            }
                            
                            .thermal-ticket {
                                width: 100%;
                                max-width: 100%;
                                border-width: 1px;
                                padding: 6px;
                                margin: 0;
                            }
                            
                            .thermal-title {
                                font-size: 11px;
                            }
                            
                            .thermal-subtitle {
                                font-size: 8px;
                            }
                            
                            .thermal-section h4 {
                                font-size: 8px;
                            }
                            
                            .thermal-row {
                                font-size: 7px;
                            }
                            
                            .thermal-total {
                                font-size: 9px;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${thermalContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            // Delay print to ensure styles are loaded
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function generateThermalTicketHTML(order, businessSettings) {
            // Add null checks for order properties
            
            // Comprehensive address fallback chain
            const customerAddress = order.customer_address || 
                                  order.home_address || 
                                  order.address || 
                                  order.shipping_address || 
                                  order.billing_address;
            
            return `
                <div class="thermal-ticket">
                    <div class="thermal-header">
                        <div class="thermal-title">${businessSettings.company_name || businessSettings.business_name || businessSettings.name || 'Business Name'}</div>
                        <div class="thermal-order-info">
                            <div class="thermal-order-number">${order.order_number || 'ORD-' + new Date().getFullYear() + String(Math.random()).substring(2, 8)}</div>
                            <div class="thermal-order-date">${order.created_at ? new Date(order.created_at).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long', 
                                day: 'numeric'
                            }) : new Date().toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}</div>
                        </div>
                    </div>
                    
                    <div class="thermal-section ship-to-section">
                        <h4>SHIP TO</h4>
                        <div class="thermal-row">
                            <span class="thermal-label">Name:</span>
                            <span>${order.customer_name || 'Walk-in Customer'}</span>
                        </div>
                        ${order.customer_phone ? `
                        <div class="thermal-row">
                            <span class="thermal-label">Phone:</span>
                            <span>${order.customer_phone}</span>
                        </div>
                        ` : ''}
                        ${order.customer_email ? `
                        <div class="thermal-row">
                            <span class="thermal-label">Email:</span>
                            <span>${order.customer_email}</span>
                        </div>
                        ` : ''}
                        ${customerAddress ? `
                        <div class="thermal-row">
                            <span class="thermal-label">Address:</span>
                            <span class="thermal-address">${customerAddress}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${order.items && order.items.length > 0 ? `
                    <div class="thermal-section items-section">
                        <div class="thermal-items-header">
                            <h4>ITEMS</h4>
                            <h4>QUANTITY</h4>
                        </div>
                        <div class="thermal-items-list">
                            ${order.items.map(item => `
                                <div class="thermal-item-row">
                                    <div class="thermal-item-name">${item.product_name || item.description || 'Item'}</div>
                                    <div class="thermal-item-quantity">${item.quantity || 1}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="thermal-section items-section">
                        <div class="thermal-items-header">
                            <h4>ITEMS</h4>
                            <h4>QUANTITY</h4>
                        </div>
                        <div class="thermal-items-list">
                            <div class="thermal-item-row">
                                <div class="thermal-item-name">No items found</div>
                                <div class="thermal-item-quantity">0</div>
                            </div>
                        </div>
                    </div>
                    `}
                    
                    ${order.notes ? `
                    <div class="thermal-notes">
                        <strong>Notes:</strong><br>
                        ${order.notes}
                    </div>
                    ` : ''}
                    
                    <div class="thermal-footer">
                        <div class="thermal-thank-you">Thank you for shopping with us!</div>
                        <div class="thermal-business-info">
                            <strong>${businessSettings.company_name || businessSettings.business_name || businessSettings.name || 'Your Business'}</strong>
                            <div>${businessSettings.address || 'Business Address'}</div>
                            <div>${businessSettings.phone || 'Phone'} | ${businessSettings.email || 'business@email.com'}</div>
                            <div>${businessSettings.website || 'company.com'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Order Selection Mode Functions
        let selectedOrders = new Set();
        let isSelectionMode = false;

        function toggleOrderSelectionMode() {
            const btn = document.getElementById('select-orders-btn');
            const printBtn = document.getElementById('print-orders-btn');
            const statusBtn = document.getElementById('change-status-btn');
            const ordersContainer = document.getElementById('orders-grid');

            if (!isSelectionMode) {
                // Enter selection mode
                isSelectionMode = true;
                btn.textContent = ' Cancel Selection';
                btn.className = 'btn btn-secondary';
                
                // Show bulk action buttons
                printBtn.style.display = 'inline-block';
                statusBtn.style.display = 'inline-block';
                
                // Show all checkboxes
                ordersContainer.classList.add('selection-mode');
                const checkboxes = ordersContainer.querySelectorAll('.order-selection');
                checkboxes.forEach(checkbox => {
                    checkbox.style.display = 'block';
                });
            } else {
                // Exit selection mode
                isSelectionMode = false;
                selectedOrders.clear();
                btn.textContent = ' Select Orders';
                btn.className = 'btn btn-primary';
                
                // Hide bulk action buttons
                printBtn.style.display = 'none';
                statusBtn.style.display = 'none';
                
                // Hide all checkboxes and uncheck them
                ordersContainer.classList.remove('selection-mode');
                const checkboxes = ordersContainer.querySelectorAll('.order-selection');
                checkboxes.forEach(checkbox => {
                    checkbox.style.display = 'none';
                    const input = checkbox.querySelector('input[type="checkbox"]');
                    if (input) input.checked = false;
                });
            }
        }

        function toggleOrderSelection(orderId, isChecked) {
            if (isChecked) {
                selectedOrders.add(orderId);
            } else {
                selectedOrders.delete(orderId);
            }
        }

        async function printSelectedOrders() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to print.');
                return;
            }
            const selectedOrdersList = orders.filter(order => selectedOrders.has(order.id));
            
            // Get business settings for thermal tickets
            let businessSettings = null;
            try {
                const response = await fetch('/api/business-settings');
                if (response.ok) {
                    const data = await response.json();
                    businessSettings = data;
                }
            } catch (error) {
                console.warn('Could not load business settings for printing, trying business profile...');
                try {
                    const profileResponse = await fetch('/api/business-profile');
                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        businessSettings = profileData.profile;
                    }
                } catch (profileError) {
                    console.warn('Could not load business profile either');
                }
            }
            
            // Ensure consistent fallback structure
            if (!businessSettings) {
                businessSettings = {
                    name: 'Your Business',
                    address: 'Business address not provided',
                    phone: 'Phone not provided'
                };
            }
            
            // Use the same thermal ticket styling as individual prints
            let printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Service Tickets</title>
                    <style>
                        @page {
                            size: 10cm 15cm;
                            margin: 0.2cm;
                        }
                        
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 10px;
                            line-height: 1.1;
                            margin: 0;
                            padding: 0.2cm;
                            width: 9.6cm;
                            box-sizing: border-box;
                        }
                        
                        .thermal-ticket {
                            width: 100%;
                            border: 2px solid #000;
                            padding: 10px;
                            page-break-after: always;
                            box-sizing: border-box;
                        }
                        
                        .thermal-ticket:last-child {
                            page-break-after: auto;
                        }
                        
                        .thermal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            border-bottom: 1px solid #333;
                            padding-bottom: 8px;
                            margin-bottom: 12px;
                        }
                        
                        .thermal-title {
                            font-size: 16px;
                            font-weight: bold;
                            margin: 0;
                        }
                        
                        .thermal-order-info {
                            text-align: right;
                            font-size: 10px;
                            line-height: 1.3;
                        }
                        
                        .thermal-order-number {
                            font-weight: normal;
                            margin-bottom: 2px;
                        }
                        
                        .thermal-order-date {
                            color: #666;
                        }
                        
                        .thermal-section {
                            margin-bottom: 8px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid #ccc;
                        }
                        
                        .thermal-section:last-child {
                            border-bottom: none;
                        }
                        
                        .thermal-section h4 {
                            font-size: 10px;
                            margin: 0 0 3px 0;
                            font-weight: bold;
                            text-decoration: underline;
                        }
                        
                        .thermal-row {
                            display: flex;
                            margin-bottom: 2px;
                        }
                        
                        .thermal-label {
                            width: 60px;
                            font-weight: bold;
                            flex-shrink: 0;
                        }
                        
                        .thermal-address {
                            font-size: 9px;
                            line-height: 1.2;
                        }
                        
                        .thermal-items {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 8px;
                            margin-top: 3px;
                        }
                        
                        .thermal-items th,
                        .thermal-items td {
                            border: 1px solid #000;
                            padding: 2px;
                            text-align: left;
                        }
                        
                        .thermal-items th {
                            background: #f0f0f0;
                            font-weight: bold;
                        }
                        
                        .thermal-notes {
                            margin-top: 8px;
                            padding: 5px;
                            background: #f9f9f9;
                            border: 1px solid #ddd;
                            font-size: 9px;
                        }
                        
                        .thermal-business-contact {
                            margin: 6px 0;
                            font-size: 9px;
                            line-height: 1.2;
                        }
                        
                        .thermal-business-address {
                            margin-bottom: 2px;
                            font-weight: normal;
                        }
                        
                        .thermal-business-phone {
                            font-weight: normal;
                        }
                    </style>
                </head>
                <body>`;
            
            // Generate thermal ticket for each selected order
            for (const order of selectedOrdersList) {
                printContent += generateThermalTicketHTML(order, businessSettings);
            }
            
            printContent += `
                </body>
                </html>`;
            
            const printWindow = window.open('', '_blank', 'width=400,height=600,scrollbars=yes');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            // Delay print to ensure styles are loaded
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        async function changeSelectedOrdersStatus() {
            if (selectedOrders.size === 0) {
                alert('Please select at least one order to update.');
                return;
            }

            // Populate the modal with selected orders info
            updateBulkStatusModal();
            
            // Show the modal
            document.getElementById('bulkStatusModal').style.display = 'block';
        }

        function updateBulkStatusModal() {
            const selectedOrdersList = orders.filter(order => selectedOrders.has(order.id));
            const count = selectedOrdersList.length;
            
            // Update count
            document.getElementById('selected-orders-count').textContent = `${count} order${count !== 1 ? 's' : ''} selected`;
            
            // Update orders list
            const ordersList = document.getElementById('selected-orders-list');
            ordersList.innerHTML = selectedOrdersList.map(order => 
                `<div style="margin: 2px 0; padding: 2px 5px; background: white; border-radius: 2px; font-size: 0.8rem;">
                    ${order.order_number || `#${order.id}`} - ${order.customer_name || 'Walk-in Customer'}
                </div>`
            ).join('');
            
            // Reset form
            document.getElementById('bulk-new-status').value = '';
            document.getElementById('bulk-tracking-number').value = '';
            document.getElementById('bulk-status-notes').value = '';
            document.getElementById('bulk-tracking-group').style.display = 'none';
        }

        function closeBulkStatusModal() {
            document.getElementById('bulkStatusModal').style.display = 'none';
        }

        // Bulk Status Modal Event Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Handle bulk status form submission
            document.getElementById('bulkStatusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newStatus = document.getElementById('bulk-new-status').value;
                const trackingNumber = document.getElementById('bulk-tracking-number').value;
                const notes = document.getElementById('bulk-status-notes').value;
                
                if (!newStatus) {
                    alert('Please select a status');
                    return;
                }

                // Show loading state
                const btnText = document.getElementById('bulk-update-btn-text');
                const loading = document.getElementById('bulk-update-loading');
                btnText.style.display = 'none';
                loading.style.display = 'inline';
                
                try {
                    const updateData = { status: newStatus };
                    if (trackingNumber) updateData.tracking_number = trackingNumber;
                    if (notes) updateData.notes = notes;

                    const updatePromises = Array.from(selectedOrders).map(orderId => 
                        fetch(`/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updateData)
                        })
                    );

                    await Promise.all(updatePromises);
                    
                    alert(`Successfully updated ${selectedOrders.size} orders to "${newStatus}"`);
                    
                    // Close modal and refresh
                    closeBulkStatusModal();
                    loadOrders();
                    selectedOrders.clear();
                    toggleOrderSelectionMode();
                    
                } catch (error) {
                    alert('Error updating orders: ' + error.message);
                } finally {
                    // Reset loading state
                    btnText.style.display = 'inline';
                    loading.style.display = 'none';
                }
            });

            // Show/hide tracking number field based on status
            document.getElementById('bulk-new-status').addEventListener('change', function() {
                const trackingGroup = document.getElementById('bulk-tracking-group');
                if (this.value === 'shipped') {
                    trackingGroup.style.display = 'block';
                } else {
                    trackingGroup.style.display = 'none';
                }
            });
        });

        // Customer Management Functions
        async function loadCustomers() {
            try {
                document.getElementById('customers-loading').style.display = 'block';
                const searchTerm = document.getElementById('customer-search').value;
                
                let url = '/api/customers?limit=100';
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    customers = data.customers;
                    displayCustomers(customers);
                } else {
                    showCustomerError('Failed to load customers: ' + data.error);
                }
            } catch (error) {
                showCustomerError('Error loading customers: ' + error.message);
            } finally {
                document.getElementById('customers-loading').style.display = 'none';
            }
        }

        async function loadCustomerStats() {
            try {
                const response = await fetch('/api/customers/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('total-customers').textContent = stats.total_customers || 0;
                    document.getElementById('active-customers').textContent = stats.active_customers || 0;
                    document.getElementById('repeat-customers').textContent = stats.repeat_customers || 0;
                    document.getElementById('new-customers').textContent = stats.new_customers_this_month || 0;
                    document.getElementById('average-clv').textContent = formatCurrency(stats.average_clv || 0);
                }
            } catch (error) {
                console.error('Error loading customer stats:', error);
            }
        }

        function displayCustomers(customersToShow) {
            const container = document.getElementById('customers-grid');
            container.innerHTML = '';

            if (customersToShow.length === 0) {
                container.innerHTML = '<div class="loading">No customers found</div>';
                return;
            }

            // Group customers by activity level
            const groupedCustomers = groupCustomersByActivity(customersToShow);
            
            // Display each activity group
            Object.keys(groupedCustomers).forEach(activityKey => {
                const activityGroup = createCustomerActivityGroup(activityKey, groupedCustomers[activityKey]);
                container.appendChild(activityGroup);
            });
        }

        function groupCustomersByActivity(customers) {
            const groups = {};
            
            customers.forEach(customer => {
                const totalOrders = customer.total_orders || 0;
                const totalSpent = customer.total_spent || 0;
                
                let activityLevel;
                if (totalOrders === 0) {
                    activityLevel = 'New Customers';
                } else if (totalOrders >= 10 || totalSpent >= 10000000) { // 10M IDR
                    activityLevel = 'VIP Customers';
                } else if (totalOrders >= 3 || totalSpent >= 1000000) { // 1M IDR
                    activityLevel = 'Regular Customers';
                } else {
                    activityLevel = 'Occasional Customers';
                }
                
                if (!groups[activityLevel]) {
                    groups[activityLevel] = {
                        displayName: activityLevel,
                        customers: []
                    };
                }
                groups[activityLevel].customers.push(customer);
            });
            
            // Sort each group's customers by total spent (highest first)
            Object.keys(groups).forEach(key => {
                groups[key].customers.sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0));
            });
            
            // Define order of groups
            const orderedGroups = {};
            const groupOrder = ['VIP Customers', 'Regular Customers', 'Occasional Customers', 'New Customers'];
            groupOrder.forEach(groupName => {
                if (groups[groupName]) {
                    orderedGroups[groupName] = groups[groupName];
                }
            });
            
            return orderedGroups;
        }

        function createCustomerActivityGroup(activityKey, group) {
            const activityGroup = document.createElement('div');
            activityGroup.className = 'customer-activity-group';
            
            const activityHeader = document.createElement('div');
            activityHeader.className = 'activity-group-header';
            activityHeader.innerHTML = `
                <h3>${group.displayName}</h3>
                <span class="customer-count">${group.customers.length} customer${group.customers.length !== 1 ? 's' : ''}</span>
            `;
            
            const customersList = document.createElement('div');
            customersList.className = 'customers-list';
            
            group.customers.forEach(customer => {
                const listItem = createCustomerListItem(customer);
                customersList.appendChild(listItem);
            });
            
            activityGroup.appendChild(activityHeader);
            activityGroup.appendChild(customersList);
            
            return activityGroup;
        }

        function createCustomerListItem(customer) {
            const listItem = document.createElement('div');
            listItem.className = 'customer-list-item';
            
            const totalSpentFormatted = formatCurrency(customer.total_spent || 0);
            const totalOrders = customer.total_orders || 0;
            const totalInvoices = customer.total_invoices || 0;
            
            listItem.innerHTML = `
                <div class="customer-list-content">
                    <div class="customer-avatar">
                        <div class="customer-avatar-circle">
                            ${customer.name ? customer.name.charAt(0).toUpperCase() : ''}
                        </div>
                    </div>
                    
                    <div class="customer-main-info">
                        <div class="customer-header">
                            <div class="customer-name">
                                <strong>${customer.name || 'Unnamed Customer'}</strong>
                            </div>
                        </div>
                        
                        <div class="customer-details">
                            <div class="customer-contact">
                                <span class="customer-email"> ${customer.email || 'No email'}</span>
                                <span class="customer-phone"> ${customer.phone || 'No phone'}</span>
                                ${customer.address ? `<span class="customer-address"> ${customer.address}</span>` : ''}
                            </div>
                            
                            <div class="customer-stats">
                                <span class="orders-count"> ${totalOrders} orders</span>
                                <span class="invoices-count"> ${totalInvoices} invoices</span>
                                <span class="total-spent">${totalSpentFormatted}</span>
                                ${customer.last_order_date ? `<span class="last-order"> Last: ${formatDate(customer.last_order_date)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="customer-actions">
                        ${getCustomerActionButtons(customer)}
                    </div>
                </div>
            `;
            
            return listItem;
        }


        function getCustomerActionButtons(customer) {
            let actions = [];

            // View button - always available
            actions.push(`<button class="btn btn-sm btn-primary" onclick="viewCustomer(${customer.id})" title="View customer details"> View</button>`);

            // Edit button - always available
            actions.push(`<button class="btn btn-sm btn-warning" onclick="editCustomer(${customer.id})" title="Edit customer information"> Edit</button>`);

            // Delete button - always available
            actions.push(`<button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})" title="Delete this customer"> Delete</button>`);

            return actions.join('');
        }

        function createCustomerCard(customer) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const statusClass = customer.status === 'active' ? 'stock-high' : 'stock-low';
            const statusText = customer.status === 'active' ? 'Active' : 'Inactive';
            const totalSpentFormatted = formatCurrency(customer.total_spent || 0);
            
            card.innerHTML = `
                <div class="product-header">
                    <div>
                        <div class="product-name">${customer.name || 'Unknown'}</div>
                        <div class="product-sku">Email: ${customer.email}</div>
                    </div>
                    <div class="stock-badge ${statusClass}">${statusText}</div>
                </div>
                <div class="product-price">${totalSpentFormatted}</div>
                <div class="product-stock">
                    <span>Orders: ${customer.total_orders || 0}</span>
                    <span>Invoices: ${customer.total_invoices || 0}</span>
                </div>
                <div>Phone: ${customer.phone || 'N/A'}</div>
                ${customer.last_order_date ? `<div>Last Order: ${formatDate(customer.last_order_date)}</div>` : ''}
                <div class="product-actions">
                    <button class="btn btn-sm btn-primary" onclick="viewCustomer(${customer.id})"> View</button>
                    <button class="btn btn-sm btn-warning" onclick="editCustomer(${customer.id})"> Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id})"> Delete</button>
                </div>
            `;
            
            return card;
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const sortOption = document.getElementById('customer-sort').value;
            
            let filtered = customers.filter(customer => {
                return !searchTerm || 
                    (customer.name && customer.name.toLowerCase().includes(searchTerm)) ||
                    (customer.email && customer.email.toLowerCase().includes(searchTerm)) ||
                    (customer.phone && customer.phone.toLowerCase().includes(searchTerm)) ||
                    (customer.address && customer.address.toLowerCase().includes(searchTerm));
            });
            
            // Sort customers based on selected option
            filtered.sort((a, b) => {
                switch (sortOption) {
                    case 'name':
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    case 'orders':
                        return (b.total_orders || 0) - (a.total_orders || 0);
                    case 'spent':
                        return (b.total_spent || 0) - (a.total_spent || 0);
                    case 'recent':
                        const dateA = a.last_order_date ? new Date(a.last_order_date) : new Date(0);
                        const dateB = b.last_order_date ? new Date(b.last_order_date) : new Date(0);
                        return dateB - dateA;
                    default:
                        return 0;
                }
            });
            
            displayCustomers(filtered);
        }

        async function viewCustomer(customerId) {
            try {
                const response = await fetch(`/api/customers/${customerId}`);
                const data = await response.json();
                
                if (data.success && data.customer) {
                    showCustomerModal(data.customer);
                } else {
                    alert('Failed to load customer details: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error loading customer details: ' + error.message);
            }
        }

        function showCustomerModal(customer) {
            const modal = document.getElementById('customerModal');
            const content = document.getElementById('customerModalContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>${customer.name || 'Unknown Customer'}</h3>
                    <p><strong>Email:</strong> ${customer.email}</p>
                    <p><strong>Phone:</strong> ${customer.phone || 'N/A'}</p>
                    <p><strong>Address:</strong> ${customer.address || 'N/A'}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${customer.status === 'active' ? 'status-paid' : 'status-draft'}">${customer.status}</span></p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Customer Statistics</h4>
                    <p><strong>Total Spent:</strong> ${formatCurrency(customer.total_spent || 0)}</p>
                    <p><strong>Total Orders:</strong> ${customer.total_orders || 0}</p>
                    <p><strong>Total Invoices:</strong> ${customer.total_invoices || 0}</p>
                    <p><strong>Average Order Value:</strong> ${formatCurrency(customer.avg_order_value || 0)}</p>
                    <p><strong>Customer Since:</strong> ${formatDate(customer.created_at)}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>Recent Orders</h4>
                    ${customer.orders && customer.orders.length > 0 ? 
                        `<table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: left;">Order #</th>
                                    <th style="padding: 8px; text-align: left;">Date</th>
                                    <th style="padding: 8px; text-align: right;">Amount</th>
                                    <th style="padding: 8px; text-align: left;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customer.orders.slice(0, 5).map(order => `
                                    <tr>
                                        <td style="padding: 8px;">${order.order_number}</td>
                                        <td style="padding: 8px;">${formatDate(order.order_date)}</td>
                                        <td style="padding: 8px; text-align: right;">${formatCurrency(order.total_amount)}</td>
                                        <td style="padding: 8px;">${order.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>` 
                        : '<p>No orders found</p>'
                    }
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="editCustomer(${customer.id})"> Edit Customer</button>
                    <button class="btn btn-secondary" onclick="closeCustomerModal()">Close</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const name = prompt('Customer Name:', customer.name || '');
            if (name === null) return;

            const phone = prompt('Phone Number:', customer.phone || '');
            if (phone === null) return;

            const address = prompt('Address:', customer.address || '');
            if (address === null) return;

            updateCustomer(customerId, { name, phone, address });
        }

        async function updateCustomer(customerId, customerData) {
            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(customerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Customer updated successfully');
                    loadCustomers();
                    loadCustomerStats();
                } else {
                    showError('Failed to update customer: ' + data.error);
                }
            } catch (error) {
                showError('Error updating customer: ' + error.message);
            }
        }

        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Customer deleted successfully');
                    loadCustomers();
                    loadCustomerStats();
                } else {
                    showError('Failed to delete customer: ' + data.error);
                }
            } catch (error) {
                showError('Error deleting customer: ' + error.message);
            }
        }

        async function exportCustomers() {
            try {
                const response = await fetch('/api/customers/export/csv');
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `customers-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showSuccess('Customer data exported successfully');
                } else {
                    const errorText = await response.text();
                    showError('Failed to export customers: ' + errorText);
                }
            } catch (error) {
                console.error('Export Error:', error);
                showError('Error exporting customers: ' + error.message);
            }
        }

        function refreshCustomers() {
            loadCustomers();
            loadCustomerStats();
        }

        function showCustomerError(message) {
            const errorDiv = document.getElementById('customers-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const productModal = document.getElementById('productModal');
            const invoiceModal = document.getElementById('invoiceModal');
            const customerModal = document.getElementById('customerModal');
            const serviceTicketModal = document.getElementById('serviceTicketModal');
            
            if (event.target === productModal) {
                closeProductModal();
            } else if (event.target === invoiceModal) {
                closeInvoiceModal();
            } else if (event.target === customerModal) {
                closeCustomerModal();
            } else if (event.target === serviceTicketModal) {
                closeServiceTicketModal();
            }
        }






        // Logout function
        async function handleLogout() {
            const confirmed = confirm('Are you sure you want to logout?');
            if (!confirmed) return;

            try {
                // Show loading state
                const logoutBtn = document.querySelector('.header-logout-btn');
                const originalText = logoutBtn.innerHTML;
                logoutBtn.innerHTML = '<span></span> Logging out...';
                logoutBtn.disabled = true;

                // Call logout API
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // Clear any local storage data
                    localStorage.removeItem('merchantToken');
                    localStorage.removeItem('businessProfile');
                    
                    // Show success message briefly
                    logoutBtn.innerHTML = '<span></span> Logged out!';
                    
                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout. Please try again.');
                
                // Reset button state
                const logoutBtn = document.querySelector('.header-logout-btn');
                logoutBtn.innerHTML = '<span></span> Logout';
                logoutBtn.disabled = false;
            }
        }

    </script>
</body>
</html>
