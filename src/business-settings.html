<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Business Settings - AI Invoice Generator</title>
    <style>
        /* Modern Purple Design System */
        :root {
            /* Primary Purple Palette */
            --primary-purple: #8B5FFF;
            --primary-dark: #6D46D6;
            --primary-light: #A78BFF;
            
            /* Secondary/Accent Colors */
            --accent-purple: #9966FF;
            --light-accent: #B794F6;
            --deep-purple: #553C9A;
            
            /* Neutral Colors */
            --background: #FAFAFA;
            --card-background: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --border-color: #E2E8F0;
            
            /* Status Colors */
            --success: #48BB78;
            --warning: #ED8936;
            --error: #F56565;
            --info: #4299E1;
            
            /* Component Specific */
            --shadow-soft: 0 4px 6px rgba(139, 95, 255, 0.05);
            --shadow-medium: 0 10px 25px rgba(139, 95, 255, 0.1);
            --shadow-strong: 0 20px 40px rgba(139, 95, 255, 0.15);
            --gradient-primary: linear-gradient(135deg, var(--primary-purple) 0%, var(--accent-purple) 100%);
            --gradient-card: linear-gradient(145deg, #FFFFFF 0%, #F8F9FF 100%);
            --border-radius: 12px;
            --border-radius-large: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius-large);
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
        }

        .nav-btn:hover,
        .nav-btn.active {
            background: var(--primary-purple);
            color: white;
            border-color: var(--primary-purple);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .settings-section {
            background: var(--card-background);
            border-radius: var(--border-radius-large);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-icon {
            font-size: 2em;
            color: var(--primary-purple);
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(139, 95, 255, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-three {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--card-background);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #38A169;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #DD6B20;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .status-connected {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .status-disconnected {
            background: rgba(245, 101, 101, 0.1);
            color: var(--error);
        }

        .status-mock {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
        }

        .help-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Tax Configuration Styles */
        .tax-config-container {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            background: linear-gradient(145deg, #FFFFFF 0%, #FAFBFF 100%);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: var(--primary-purple);
        }

        .tax-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .email-test-section {
            background: rgba(139, 95, 255, 0.05);
            border: 1px solid rgba(139, 95, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: rgba(66, 153, 225, 0.1);
            color: var(--info);
            border: 1px solid rgba(66, 153, 225, 0.2);
        }

        .alert-success {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
            border: 1px solid rgba(72, 187, 120, 0.2);
        }

        .alert-warning {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning);
            border: 1px solid rgba(237, 137, 54, 0.2);
        }

        .alert-error {
            background: rgba(245, 101, 101, 0.1);
            color: var(--error);
            border: 1px solid rgba(245, 101, 101, 0.2);
        }

        /* Tab Navigation Styles */
        .tabs-container {
            background: var(--card-background);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .tabs-nav {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            padding: 0 10px;
        }

        .tab-button {
            padding: 20px 25px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: fit-content;
        }

        .tab-button:hover {
            color: var(--primary-purple);
            background: rgba(139, 95, 255, 0.05);
        }

        .tab-button.active {
            color: var(--primary-purple);
            border-bottom-color: var(--primary-purple);
            background: rgba(139, 95, 255, 0.08);
        }

        .tab-content {
            padding: 30px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .tab-panel h2 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .form-row,
            .form-row-three {
                grid-template-columns: 1fr;
            }

            .nav-bar {
                flex-direction: column;
            }

            .container {
                padding: 15px;
            }

            .tabs-nav {
                padding: 0;
            }

            .tab-button {
                padding: 15px 20px;
                font-size: 14px;
            }

            .tab-content {
                padding: 20px;
            }
            
            /* Logo Upload Styling */
            .logo-upload-container {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-top: 12px;
            }

            .logo-preview {
                width: 100px;
                height: 100px;
                border: 2px dashed var(--border-color);
                border-radius: var(--border-radius);
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--background);
                cursor: pointer;
                transition: var(--transition);
                position: relative;
                overflow: hidden;
            }

            .logo-preview:hover {
                border-color: var(--primary-purple);
                background: rgba(139, 95, 255, 0.05);
            }

            .logo-placeholder {
                text-align: center;
                color: var(--text-secondary);
                font-size: 12px;
                font-weight: 500;
                pointer-events: none;
            }

            .logo-controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
                flex: 1;
            }

            .logo-controls .btn {
                width: fit-content;
                min-width: 140px;
            }

            #current-business-logo {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: calc(var(--border-radius) - 2px);
            }

            @media (max-width: 768px) {
                .logo-upload-container {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .logo-preview {
                    width: 80px;
                    height: 80px;
                }
                
                .logo-controls {
                    width: 100%;
                }
                
                .logo-controls .btn {
                    width: 100%;
                    min-width: auto;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Business Settings</h1>
            <p>Configure your business information and email settings</p>
        </div>

        <div class="nav-bar">
            <a href="/generator" class="nav-btn">üè† Home</a>
            <a href="/merchant-dashboard.html" class="nav-btn">‚Üê Back to Dashboard</a>
            <a href="/business-settings" class="nav-btn active">‚öôÔ∏è Settings</a>
        </div>

        <!-- Tabbed Interface -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" data-tab="business-info">
                    üè¢ Business Info
                </button>
                <button class="tab-button" data-tab="payment-methods">
                    üí≥ Payment Methods
                </button>
                <button class="tab-button" data-tab="account-settings">
                    üë§ Account Settings
                </button>
                <button class="tab-button" data-tab="email-setup">
                    üìß Email & Setup
                </button>
            </div>

            <div class="tab-content">
                <!-- Business Information Tab -->
                <div class="tab-panel active" id="business-info">
                    <h2>üè¢ Business Information</h2>

            <form id="businessInfoForm">
                <!-- Business Logo Upload -->
                <div class="form-group">
                    <label class="form-label">Business Logo</label>
                    <div class="help-text">Upload your business logo to appear on invoices and documents</div>
                    <div class="logo-upload-container">
                        <div class="logo-preview" id="logo-preview" onclick="document.getElementById('business-logo-upload').click()">
                            <img id="current-business-logo" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                            <div class="logo-placeholder" id="logo-placeholder">
                                <div style="font-size: 32px; margin-bottom: 8px;">üè¢</div>
                                <div>Click to upload logo</div>
                            </div>
                        </div>
                        <div class="logo-controls">
                            <input type="file" id="business-logo-upload" accept="image/*" style="display: none;" onchange="previewBusinessLogo(event)">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('business-logo-upload').click()">
                                üìÅ Choose Logo
                            </button>
                            <button type="button" class="btn btn-warning" onclick="removeBusinessLogo()" id="remove-logo-btn" style="display: none;">
                                üóëÔ∏è Remove Logo
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Hide Business Name Toggle -->
                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="hideBusinessName">
                        Hide business name in invoices
                    </label>
                    <div class="help-text">Enable this if your logo already contains your business name to avoid redundancy</div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Business Name</label>
                        <input type="text" class="form-input" id="businessName" placeholder="Your Business Name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Business Email</label>
                        <input type="email" class="form-input" id="businessEmail" placeholder="billing@yourbusiness.com">
                        <div class="help-text">This will be used as the sender email for invoices</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Business Address</label>
                    <input type="text" class="form-input" id="businessAddress" placeholder="Full business address">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="businessPhone" placeholder="+62 21 1234 5678">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-input" id="businessWebsite" placeholder="https://yourbusiness.com">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tax ID / NPWP</label>
                    <input type="text" class="form-input" id="businessTaxId" placeholder="01.123.456.7-123.000">
                </div>

                <div class="form-group">
                    <label class="form-label">Tax Configuration</label>
                    <div class="tax-config-container">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="taxEnabled" onchange="toggleTaxSettings()">
                                    <span class="checkmark"></span>
                                    Enable tax on invoices
                                </label>
                            </div>
                        </div>
                        
                        <div id="taxSettings" class="tax-settings" style="display: none;">
                            <div class="form-row">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Tax Rate (%)</label>
                                    <input type="number" class="form-input" id="businessTaxRate" min="0" max="100" step="0.1" placeholder="e.g., 11 for 11% PPN">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Tax Name</label>
                                    <input type="text" class="form-input" id="businessTaxName" placeholder="e.g., PPN, VAT, Sales Tax">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tax Description</label>
                                <input type="text" class="form-input" id="businessTaxDescription" placeholder="e.g., Pajak Pertambahan Nilai 11%">
                                <div class="help-text">This will appear on invoices to explain the tax charge</div>
                            </div>
                        </div>
                        
                        <div class="help-text">
                            <strong>Tax Options:</strong><br>
                            ‚Ä¢ <strong>Disabled:</strong> No tax will be applied to any invoices<br>
                            ‚Ä¢ <strong>Enabled:</strong> Default tax rate will be applied to all invoices<br>
                            ‚Ä¢ You can override tax settings per invoice if needed
                        </div>
                    </div>
                </div>

                <!-- Terms & Conditions Section -->
                <div class="form-group">
                    <label class="form-label">üìã Terms & Conditions</label>
                    <textarea class="form-input" id="businessTerms" rows="4" placeholder="e.g., Pembayaran dalam 30 hari, barang yang sudah dibeli tidak dapat dikembalikan"></textarea>
                    <div class="help-text">
                        This text will appear in the "Syarat & Ketentuan" section of your invoices. Leave empty to use default: "Pembayaran dalam 30 hari"
                    </div>
                </div>

                    <button type="submit" class="btn btn-primary">üíæ Save Business Information</button>
                </form>
                </div>

                <!-- Payment Methods Tab -->
                <div class="tab-panel" id="payment-methods">
                    <h2>üí≥ Payment Methods</h2>

            <form id="paymentMethodsForm">
                <div class="alert alert-info">
                    <strong>üí° Payment Methods:</strong><br>
                    Configure which payment methods are available to your customers. Only enabled methods will be shown on invoices.
                </div>

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="enableBankTransfer" onchange="toggleBankTransferSettings()">
                        <span class="checkmark"></span>
                        Enable Bank Transfer
                    </label>
                    <div class="help-text">Allow customers to pay via bank transfer</div>
                </div>
                
                <div id="bankTransferSettings" class="tax-settings" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-input" id="bankName" placeholder="e.g., Bank BCA, Bank Mandiri">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-input" id="accountNumber" placeholder="1234567890">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Account Holder Name</label>
                            <input type="text" class="form-input" id="accountHolderName" placeholder="Business Name or Owner Name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bank Branch</label>
                            <input type="text" class="form-input" id="bankBranch" placeholder="e.g., Jakarta Pusat (Optional)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Transfer Instructions</label>
                        <textarea class="form-input" id="transferInstructions" rows="3" placeholder="Additional instructions for customers (e.g., Please include invoice number in transfer description)"></textarea>
                        <div class="help-text">These instructions will be shown to customers when they select bank transfer</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label class="checkbox-container">
                        <input type="checkbox" id="enableCreditCard" disabled>
                        <span class="checkmark"></span>
                        Enable Credit Card (Coming Soon)
                    </label>
                    <div class="help-text">Credit card integration will be available in future updates</div>
                </div>

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="enableXendit" onchange="toggleXenditSettings()">
                        <span class="checkmark"></span>
                        Enable Xendit Payment Gateway
                    </label>
                    <div class="help-text">Accept payments via Xendit (bank transfer, e-wallets, retail outlets)</div>
                </div>

                <div id="xenditSettings" class="tax-settings" style="display: none;">
                    <div class="alert alert-info">
                        <strong>üîê Xendit Configuration:</strong><br>
                        Use your own Xendit account credentials. Transactions will be processed directly through your Xendit account.
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Environment</label>
                            <select class="form-input" id="xenditEnvironment">
                                <option value="sandbox">Sandbox (Testing)</option>
                                <option value="production">Production (Live)</option>
                            </select>
                            <div class="help-text">Start with sandbox for testing, switch to production when ready</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Xendit Secret Key</label>
                            <input type="password" class="form-input" id="xenditSecretKey" placeholder="xnd_development_... or xnd_production_...">
                            <div class="help-text">Your Xendit secret API key (will be encrypted)</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Xendit Public Key</label>
                            <input type="text" class="form-input" id="xenditPublicKey" placeholder="xnd_public_...">
                            <div class="help-text">Your Xendit public key for frontend operations</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Webhook Verification Token</label>
                            <input type="password" class="form-input" id="xenditWebhookToken" placeholder="Your webhook verification token">
                            <div class="help-text">For securing webhook communications (optional but recommended)</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Supported Payment Methods</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                            <label class="checkbox-container">
                                <input type="checkbox" id="xenditBankTransfer" checked>
                                Bank Transfer
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="xenditEWallet" checked>
                                E-Wallets (OVO, DANA, LinkAja)
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="xenditRetailOutlet" checked>
                                Retail Outlets (Alfamart, Indomaret)
                            </label>
                            <label class="checkbox-container">
                                <input type="checkbox" id="xenditCreditCard" checked>
                                Credit/Debit Cards
                            </label>
                        </div>
                        <div class="help-text">Select which payment methods to offer your customers</div>
                    </div>

                    <div class="email-test-section">
                        <h4 style="margin-bottom: 15px;">üß™ Test Xendit Connection</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Test Amount (IDR)</label>
                                <input type="number" class="form-input" id="xenditTestAmount" value="10000" min="10000">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="button" class="btn btn-secondary" onclick="testXenditConnection()">
                                    üß™ Test Connection
                                </button>
                            </div>
                        </div>
                        <div id="xenditTestResult" style="margin-top: 10px;"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Webhook URL</label>
                        <input type="text" class="form-input" id="xenditWebhookUrl" readonly>
                        <div class="help-text">Add this URL to your Xendit dashboard webhook settings</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-container">
                        <input type="checkbox" id="enableEWallet" disabled>
                        <span class="checkmark"></span>
                        Enable E-Wallet (Coming Soon)
                    </label>
                    <div class="help-text">E-wallet integration (OVO, GoPay, DANA) will be available in future updates</div>
                </div>

                    <button type="submit" class="btn btn-primary">üíæ Save Payment Methods</button>
                </form>
                </div>

                <!-- Account Settings Tab -->
                <div class="tab-panel" id="account-settings">
                    <h2>üë§ Account Settings</h2>

                    <form id="accountInfoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-input" id="accountName" placeholder="Your Full Name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="accountEmail" placeholder="your.email@example.com">
                                <div class="help-text">This is your login email and where account notifications are sent</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-input" id="accountPhone" placeholder="+62 812 3456 7890">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time Zone</label>
                                <select class="form-input" id="accountTimezone">
                                    <option value="Asia/Jakarta">Jakarta (UTC+7)</option>
                                    <option value="Asia/Makassar">Makassar (UTC+8)</option>
                                    <option value="Asia/Jayapura">Jayapura (UTC+9)</option>
                                    <option value="UTC">UTC (GMT+0)</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">üíæ Save Account Information</button>
                    </form>

                    <!-- Current Plan Information -->
                    <h3 style="margin: 40px 0 20px; color: var(--text-primary);">üìä Current Plan & Usage</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Plan Card -->
                        <div style="border: 2px solid var(--success); border-radius: var(--border-radius-large); padding: 25px; background: rgba(72, 187, 120, 0.05);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 2em;">üÜì</span>
                                <div>
                                    <h4 style="margin: 0; color: var(--success); font-size: 1.3em;">Free Plan</h4>
                                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.9em;">Perfect for getting started</p>
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); line-height: 1.6;">
                                <div>‚úÖ Unlimited invoices</div>
                                <div>‚úÖ Up to 100 customers</div>
                                <div>‚úÖ Basic payment methods</div>
                                <div>‚úÖ Email support</div>
                                <div>‚úÖ Standard templates</div>
                            </div>
                        </div>

                        <!-- Usage Statistics -->
                        <div style="border: 2px solid var(--border-color); border-radius: var(--border-radius-large); padding: 25px;">
                            <h4 style="margin: 0 0 20px; color: var(--text-primary);">üìà Usage This Month</h4>
                            <div style="space-y: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span>üìÑ Invoices Created</span>
                                    <strong id="usageInvoices">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span>üë• Total Customers</span>
                                    <strong id="usageCustomers">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span>üí∞ Total Revenue</span>
                                    <strong id="usageRevenue">Rp 0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <span>üìß Emails Sent</span>
                                    <strong id="usageEmails">0</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Future Plans Preview -->
                    <div class="alert alert-info">
                        <strong>üöÄ Coming Soon - Premium Plans:</strong><br>
                        We're working on premium subscription tiers with advanced features like:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>üé® Custom invoice templates & branding</li>
                            <li>üìä Advanced analytics & reporting</li>
                            <li>ü§ñ AI-powered insights & recommendations</li>
                            <li>‚ö° Priority support & faster processing</li>
                            <li>üîÑ Automated recurring invoices</li>
                            <li>üíº Multi-business management</li>
                        </ul>
                    </div>

                    <!-- Account Actions -->
                    <h3 style="margin: 40px 0 20px; color: var(--text-primary);">üîß Account Actions</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="exportAccountData()">
                            üì• Export Data
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="downloadBackup()">
                            üíæ Download Backup
                        </button>
                        <button type="button" class="btn btn-warning" onclick="resetAccountData()">
                            üîÑ Reset Account
                        </button>
                    </div>
                    <div class="help-text" style="margin-top: 10px;">
                        Export your business data, create backups, or reset your account to start fresh.
                    </div>
                </div>

                <!-- Email & Setup Tab -->
                <div class="tab-panel" id="email-setup">
                    <h2>üìß Email & Setup</h2>
                    
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px;">
                        <h3 style="margin: 0; color: var(--text-primary);">Email Configuration</h3>
                        <span id="emailStatus" class="status-indicator status-mock">
                            üü° Mock Mode
                        </span>
                    </div>

                    <div class="alert alert-info">
                        <strong>üí° Email Service Options:</strong><br>
                        ‚Ä¢ <strong>SaaS Mode:</strong> Use our reliable email service (recommended for most users)<br>
                        ‚Ä¢ <strong>Custom SMTP:</strong> Use your own email server (Gmail, Outlook, custom server)<br>
                        ‚Ä¢ <strong>Smart Fallback:</strong> Try custom first, fallback to SaaS if it fails
                    </div>

                    <!-- Custom SMTP Configuration -->
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">üìÆ Custom SMTP Settings</h3>
                    
                    <form id="emailConfigForm">
                        <div class="form-row-three">
                            <div class="form-group">
                                <label class="form-label">SMTP Host</label>
                                <input type="text" class="form-input" id="smtpHost" placeholder="smtp.gmail.com">
                                <div class="help-text">Gmail: smtp.gmail.com, Outlook: smtp-mail.outlook.com</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">SMTP Port</label>
                                <input type="number" class="form-input" id="smtpPort" placeholder="587" value="587">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Security</label>
                                <select class="form-input" id="smtpSecure">
                                    <option value="false">STARTTLS (587)</option>
                                    <option value="true">SSL/TLS (465)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-input" id="smtpUser" placeholder="your-email@gmail.com">
                                <div class="help-text">Your email address for sending invoices</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">App Password</label>
                                <input type="password" class="form-input" id="smtpPass" placeholder="16-character app password">
                                <div class="help-text">For Gmail: Use App Password, not regular password</div>
                            </div>
                        </div>

                        <div class="email-test-section">
                            <h4 style="margin-bottom: 15px;">üß™ Test Email Configuration</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Test Email Address</label>
                                    <input type="email" class="form-input" id="testEmailAddress" placeholder="test@example.com">
                                </div>
                                <div class="form-group" style="display: flex; align-items: end;">
                                    <button type="button" class="btn btn-secondary" onclick="testEmailConfiguration()">
                                        üß™ Test Connection
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">üíæ Save Email Settings</button>
                            <button type="button" class="btn btn-warning" onclick="resetEmailSettings()">üîÑ Reset to Defaults</button>
                        </div>
                    </form>

                    <!-- Setup Guides -->
                    <h3 style="margin: 40px 0 20px; color: var(--text-primary);">üìö Setup Guides</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="border: 2px solid var(--border-color); border-radius: var(--border-radius); padding: 20px;">
                            <h4 style="color: var(--primary-purple); margin-bottom: 10px;">üì¨ Gmail Setup</h4>
                            <ol style="margin-left: 20px; color: var(--text-secondary);">
                                <li>Enable 2-Factor Authentication</li>
                                <li>Go to Security ‚Üí App passwords</li>
                                <li>Generate app password for "Mail"</li>
                                <li>Use app password (not regular password)</li>
                            </ol>
                            <button class="btn btn-secondary" style="margin-top: 15px;" onclick="window.open('https://support.google.com/accounts/answer/185833', '_blank')">
                                üìñ Detailed Guide
                            </button>
                        </div>

                        <div style="border: 2px solid var(--border-color); border-radius: var(--border-radius); padding: 20px;">
                            <h4 style="color: var(--primary-purple); margin-bottom: 10px;">üìß Outlook Setup</h4>
                            <ol style="margin-left: 20px; color: var(--text-secondary);">
                                <li>Host: smtp-mail.outlook.com</li>
                                <li>Port: 587</li>
                                <li>Security: STARTTLS</li>
                                <li>Use regular email password</li>
                            </ol>
                            <button class="btn btn-secondary" style="margin-top: 15px;" onclick="window.open('https://support.microsoft.com/en-us/office/pop-imap-and-smtp-settings-for-outlook-com-d088b986-291d-42b8-9564-9c414e2aa040', '_blank')">
                                üìñ Outlook Guide
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab Management
        function switchTab(tabId) {
            // Hide all tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab panel
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to selected tab button
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Save active tab to localStorage
            localStorage.setItem('activeSettingsTab', tabId);
        }
        
        // Add click listeners to tab buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Restore last active tab or default to business-info
            const activeTab = localStorage.getItem('activeSettingsTab') || 'business-info';
            switchTab(activeTab);
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Load settings for all tabs
            loadBusinessSettings();
            loadEmailSettings();
            loadPaymentMethods();
            checkEmailStatus();
            loadAccountSettings();
            loadUsageStatistics();
        });

        // Business Logo Upload Functions
        function previewBusinessLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showAlert('Please select a valid image file (JPEG, PNG, GIF, or WebP)', 'error');
                return;
            }

            // Validate file size (5MB max)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showAlert('Logo file size must be less than 5MB', 'error');
                return;
            }

            // Create preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoImg = document.getElementById('current-business-logo');
                const logoPlaceholder = document.getElementById('logo-placeholder');
                const removeBtn = document.getElementById('remove-logo-btn');
                
                logoImg.src = e.target.result;
                logoImg.style.display = 'block';
                logoPlaceholder.style.display = 'none';
                removeBtn.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);

            // Upload the file immediately
            uploadBusinessLogo(file);
        }

        async function uploadBusinessLogo(file) {
            const formData = new FormData();
            formData.append('logo', file);

            try {
                console.log('üì∏ Uploading business logo...');
                showAlert('Uploading logo...', 'info');

                const response = await fetch('/api/upload-business-logo', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Logo uploaded successfully!', 'success');
                    console.log('‚úÖ Logo uploaded:', result.logoUrl);
                    
                    // Update the logo display immediately after successful upload
                    displayCurrentLogo(result.logoUrl);
                    console.log('üñºÔ∏è Logo preview updated in UI');
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('‚ùå Logo upload failed:', error);
                showAlert('Failed to upload logo: ' + error.message, 'error');
                
                // Reset preview on error
                resetLogoPreview();
            }
        }

        async function removeBusinessLogo() {
            try {
                console.log('üóëÔ∏è Removing business logo...');
                showAlert('Removing logo...', 'info');

                const response = await fetch('/api/remove-business-logo', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Logo removed successfully!', 'success');
                    console.log('‚úÖ Logo removed');
                    resetLogoPreview();
                } else {
                    throw new Error(result.error || 'Remove failed');
                }
            } catch (error) {
                console.error('‚ùå Logo removal failed:', error);
                showAlert('Failed to remove logo: ' + error.message, 'error');
            }
        }

        function resetLogoPreview() {
            const logoImg = document.getElementById('current-business-logo');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            const removeBtn = document.getElementById('remove-logo-btn');
            const fileInput = document.getElementById('business-logo-upload');
            
            logoImg.style.display = 'none';
            logoImg.src = '';
            logoPlaceholder.style.display = 'block';
            removeBtn.style.display = 'none';
            fileInput.value = '';
        }

        function displayCurrentLogo(logoUrl) {
            if (logoUrl) {
                const logoImg = document.getElementById('current-business-logo');
                const logoPlaceholder = document.getElementById('logo-placeholder');
                const removeBtn = document.getElementById('remove-logo-btn');
                
                logoImg.src = logoUrl;
                logoImg.style.display = 'block';
                logoPlaceholder.style.display = 'none';
                removeBtn.style.display = 'inline-block';
            } else {
                resetLogoPreview();
            }
        }

        async function loadBusinessSettings() {
            try {
                const response = await fetch('/api/business-settings');
                const settings = await response.json();
                
                if (settings) {
                    document.getElementById('businessName').value = settings.name || '';
                    document.getElementById('businessEmail').value = settings.email || '';
                    document.getElementById('businessAddress').value = settings.address || '';
                    document.getElementById('businessPhone').value = settings.phone || '';
                    document.getElementById('businessWebsite').value = settings.website || '';
                    document.getElementById('businessTaxId').value = settings.taxId || settings.tax_id || '';
                    document.getElementById('businessTaxRate').value = settings.taxRate || settings.tax_rate || 0;
                    document.getElementById('businessTaxName').value = settings.taxName || settings.tax_name || 'PPN';
                    document.getElementById('businessTaxDescription').value = settings.taxDescription || settings.tax_description || '';
                    document.getElementById('hideBusinessName').checked = settings.hideBusinessName || settings.hide_business_name || false;
                    document.getElementById('businessTerms').value = settings.termsAndConditions || settings.terms_conditions || '';
                    
                    // Handle tax enabled state
                    const taxRate = settings.taxRate || settings.tax_rate || 0;
                    const taxEnabled = settings.taxEnabled || settings.tax_enabled || (taxRate > 0);
                    document.getElementById('taxEnabled').checked = taxEnabled;
                    toggleTaxSettings(); // Show/hide tax settings based on state
                    
                    // Display current logo if exists
                    const logoUrl = settings.logoUrl || settings.logo_url || '';
                    displayCurrentLogo(logoUrl);
                }
            } catch (error) {
                console.error('Error loading business settings:', error);
            }
        }

        async function loadEmailSettings() {
            try {
                const response = await fetch('/api/email-settings');
                const settings = await response.json();
                
                if (settings) {
                    document.getElementById('smtpHost').value = settings.host || 'smtp.gmail.com';
                    document.getElementById('smtpPort').value = settings.port || 587;
                    document.getElementById('smtpSecure').value = settings.secure || 'false';
                    document.getElementById('smtpUser').value = settings.user || '';
                    // Don't load password for security
                }
            } catch (error) {
                console.error('Error loading email settings:', error);
            }
        }

        async function checkEmailStatus() {
            try {
                const response = await fetch('/api/email-status');
                const status = await response.json();
                
                const statusElement = document.getElementById('emailStatus');
                
                if (status.saasConfigured && status.customConfigured) {
                    statusElement.className = 'status-indicator status-connected';
                    statusElement.innerHTML = 'üü¢ SaaS + Custom';
                } else if (status.saasConfigured) {
                    statusElement.className = 'status-indicator status-connected';
                    statusElement.innerHTML = 'üü¢ SaaS Only';
                } else if (status.customConfigured) {
                    statusElement.className = 'status-indicator status-connected';
                    statusElement.innerHTML = 'üü¢ Custom Only';
                } else {
                    statusElement.className = 'status-indicator status-mock';
                    statusElement.innerHTML = 'üü° Mock Mode';
                }
            } catch (error) {
                console.error('Error checking email status:', error);
            }
        }

        // Business Information Form
        document.getElementById('businessInfoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // First, get existing business settings to merge with new data (same logic as working modal)
            console.log('üì• Getting existing business settings to merge...');
            let existingSettings = {};
            try {
                const existingResponse = await fetch('/api/business-settings');
                if (existingResponse.ok) {
                    const existingData = await existingResponse.json();
                    existingSettings = existingData.settings || {};
                    console.log('‚úÖ Existing settings loaded for dashboard:', existingSettings);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è  Could not load existing settings, proceeding with new data only:', error);
            }

            // Merge with existing settings to avoid data loss (same logic as working modal)
            const settings = {
                // Preserve existing fields that might not be in the dashboard form
                ...existingSettings,
                
                // Update with form data
                name: document.getElementById('businessName').value,
                email: document.getElementById('businessEmail').value,
                address: document.getElementById('businessAddress').value,
                phone: document.getElementById('businessPhone').value,
                website: document.getElementById('businessWebsite').value,
                taxId: document.getElementById('businessTaxId').value,
                taxEnabled: document.getElementById('taxEnabled').checked,
                taxRate: parseFloat(document.getElementById('businessTaxRate').value) || 0,
                taxName: document.getElementById('businessTaxName').value || 'PPN',
                taxDescription: document.getElementById('businessTaxDescription').value || '',
                hideBusinessName: document.getElementById('hideBusinessName').checked,
                termsAndConditions: document.getElementById('businessTerms').value || '',
                
                // Preserve important fields from existing settings
                logoUrl: existingSettings.logoUrl || existingSettings.logo_url || '',
                logoPublicId: existingSettings.logoPublicId || existingSettings.logo_public_id || '',
                logoFilename: existingSettings.logoFilename || existingSettings.logo_filename || ''
            };
            
            console.log('üíæ Saving merged business settings from dashboard:', settings);

            try {
                const response = await fetch('/api/business-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAlert('Business information saved successfully!', 'success');
                    
                    // Notify main page to refresh business data if it's open
                    try {
                        // Try to access the main page if opened from there
                        if (window.opener && !window.opener.closed) {
                            // Check if the main page has our reload function
                            if (typeof window.opener.loadBusinessDataFromAPI === 'function') {
                                console.log('üîÑ Refreshing main page business data...');
                                window.opener.loadBusinessDataFromAPI();
                            }
                        }
                        
                        // Also broadcast to other windows/tabs using BroadcastChannel
                        const channel = new BroadcastChannel('business-settings-updates');
                        channel.postMessage({ type: 'business-data-updated', data: settings });
                        channel.close();
                    } catch (error) {
                        // Ignore errors if cross-page communication fails
                        console.log('Cross-page update attempted but not available');
                    }
                } else {
                    showAlert('Failed to save business information', 'error');
                }
            } catch (error) {
                console.error('Error saving business settings:', error);
                showAlert('Error saving business information', 'error');
            }
        });

        // Email Configuration Form
        document.getElementById('emailConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const settings = {
                host: document.getElementById('smtpHost').value,
                port: parseInt(document.getElementById('smtpPort').value),
                secure: document.getElementById('smtpSecure').value === 'true',
                user: document.getElementById('smtpUser').value,
                pass: document.getElementById('smtpPass').value
            };

            try {
                const response = await fetch('/api/email-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAlert('Email settings saved successfully! Restarting email service...', 'success');
                    setTimeout(() => {
                        checkEmailStatus();
                    }, 2000);
                } else {
                    showAlert('Failed to save email settings', 'error');
                }
            } catch (error) {
                console.error('Error saving email settings:', error);
                showAlert('Error saving email settings', 'error');
            }
        });

        async function testEmailConfiguration() {
            const testEmail = document.getElementById('testEmailAddress').value;
            
            if (!testEmail) {
                showAlert('Please enter a test email address', 'warning');
                return;
            }

            try {
                showAlert('Testing email configuration...', 'info');
                
                const response = await fetch('/api/test-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        testEmail: testEmail,
                        settings: {
                            host: document.getElementById('smtpHost').value,
                            port: parseInt(document.getElementById('smtpPort').value),
                            secure: document.getElementById('smtpSecure').value === 'true',
                            user: document.getElementById('smtpUser').value,
                            pass: document.getElementById('smtpPass').value
                        }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Test email sent successfully! Check ${testEmail} for the test message.`, 'success');
                } else {
                    showAlert(`Test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error testing email:', error);
                showAlert('Error testing email configuration', 'error');
            }
        }

        function resetEmailSettings() {
            if (confirm('Reset email settings to defaults?')) {
                document.getElementById('smtpHost').value = 'smtp.gmail.com';
                document.getElementById('smtpPort').value = '587';
                document.getElementById('smtpSecure').value = 'false';
                document.getElementById('smtpUser').value = '';
                document.getElementById('smtpPass').value = '';
                showAlert('Email settings reset to defaults', 'info');
            }
        }

        // Toggle tax settings visibility
        function toggleTaxSettings() {
            const taxEnabled = document.getElementById('taxEnabled').checked;
            const taxSettings = document.getElementById('taxSettings');
            
            if (taxEnabled) {
                taxSettings.style.display = 'block';
            } else {
                taxSettings.style.display = 'none';
                // Clear tax fields when disabled
                document.getElementById('businessTaxRate').value = '0';
            }
        }

        // Payment Methods Functions
        async function loadPaymentMethods() {
            try {
                const response = await fetch('/api/payment-methods');
                const methods = await response.json();
                
                if (methods) {
                    // Handle API response structure (methods.paymentMethods or methods)
                    const paymentData = methods.paymentMethods || methods;
                    
                    // Bank Transfer settings - handle both snake_case and camelCase
                    const bankTransfer = paymentData.bankTransfer || paymentData.bank_transfer || {};
                    document.getElementById('enableBankTransfer').checked = bankTransfer.enabled || false;
                    document.getElementById('bankName').value = bankTransfer.bankName || bankTransfer.bank_name || '';
                    document.getElementById('accountNumber').value = bankTransfer.accountNumber || bankTransfer.account_number || '';
                    document.getElementById('accountHolderName').value = bankTransfer.accountHolderName || bankTransfer.account_holder_name || '';
                    document.getElementById('bankBranch').value = bankTransfer.bankBranch || bankTransfer.bank_branch || '';
                    document.getElementById('transferInstructions').value = bankTransfer.instructions || '';
                    
                    // Xendit settings
                    const xendit = paymentData.xendit || {};
                    document.getElementById('enableXendit').checked = xendit.enabled || false;
                    document.getElementById('xenditEnvironment').value = xendit.environment || 'sandbox';
                    document.getElementById('xenditPublicKey').value = xendit.publicKey || xendit.public_key || '';
                    // Don't load secret keys for security
                    const xenditMethods = xendit.paymentMethods || xendit.payment_methods || {};
                    document.getElementById('xenditBankTransfer').checked = xenditMethods.bankTransfer !== false && xenditMethods.bank_transfer !== false;
                    document.getElementById('xenditEWallet').checked = xenditMethods.ewallet !== false;
                    document.getElementById('xenditRetailOutlet').checked = xenditMethods.retailOutlet !== false && xenditMethods.retail_outlet !== false;
                    document.getElementById('xenditCreditCard').checked = xenditMethods.creditCard !== false && xenditMethods.credit_card !== false;
                    
                    // Show/hide settings based on state
                    toggleBankTransferSettings();
                    toggleXenditSettings();
                }
            } catch (error) {
                console.error('Error loading payment methods:', error);
            }
        }

        // Payment Methods Form
        document.getElementById('paymentMethodsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const methods = {
                bankTransfer: {
                    enabled: document.getElementById('enableBankTransfer').checked,
                    bankName: document.getElementById('bankName').value,
                    accountNumber: document.getElementById('accountNumber').value,
                    accountHolderName: document.getElementById('accountHolderName').value,
                    bankBranch: document.getElementById('bankBranch').value,
                    instructions: document.getElementById('transferInstructions').value
                },
                xendit: {
                    enabled: document.getElementById('enableXendit').checked,
                    environment: document.getElementById('xenditEnvironment').value,
                    secretKey: document.getElementById('xenditSecretKey').value,
                    publicKey: document.getElementById('xenditPublicKey').value,
                    webhookToken: document.getElementById('xenditWebhookToken').value,
                    paymentMethods: {
                        bankTransfer: document.getElementById('xenditBankTransfer').checked,
                        ewallet: document.getElementById('xenditEWallet').checked,
                        retailOutlet: document.getElementById('xenditRetailOutlet').checked,
                        creditCard: document.getElementById('xenditCreditCard').checked
                    }
                }
            };

            try {
                const response = await fetch('/api/payment-methods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(methods)
                });

                if (response.ok) {
                    showAlert('Payment methods saved successfully!', 'success');
                } else {
                    showAlert('Failed to save payment methods', 'error');
                }
            } catch (error) {
                console.error('Error saving payment methods:', error);
                showAlert('Error saving payment methods', 'error');
            }
        });

        // Toggle bank transfer settings visibility
        function toggleBankTransferSettings() {
            const enabled = document.getElementById('enableBankTransfer').checked;
            const settings = document.getElementById('bankTransferSettings');
            
            if (enabled) {
                settings.style.display = 'block';
            } else {
                settings.style.display = 'none';
            }
        }

        // Toggle Xendit settings visibility
        function toggleXenditSettings() {
            const enabled = document.getElementById('enableXendit').checked;
            const settings = document.getElementById('xenditSettings');
            const webhookUrl = document.getElementById('xenditWebhookUrl');
            
            if (enabled) {
                settings.style.display = 'block';
                // Set webhook URL based on current domain
                webhookUrl.value = `${window.location.protocol}//${window.location.host}/api/xendit/webhook`;
            } else {
                settings.style.display = 'none';
            }
        }

        // Test Xendit connection
        async function testXenditConnection() {
            const secretKey = document.getElementById('xenditSecretKey').value;
            const environment = document.getElementById('xenditEnvironment').value;
            const amount = document.getElementById('xenditTestAmount').value;
            const resultDiv = document.getElementById('xenditTestResult');
            
            if (!secretKey) {
                showXenditTestResult('Please enter your Xendit Secret Key first', 'error');
                return;
            }

            try {
                showXenditTestResult('Testing Xendit connection...', 'info');
                
                const response = await fetch('/api/xendit/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        secretKey: secretKey,
                        environment: environment,
                        amount: parseInt(amount)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showXenditTestResult(`‚úÖ Connection successful! Test invoice created: ${result.invoiceId}`, 'success');
                } else {
                    showXenditTestResult(`‚ùå Test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error testing Xendit:', error);
                showXenditTestResult('‚ùå Error testing Xendit connection', 'error');
            }
        }

        function showXenditTestResult(message, type) {
            const resultDiv = document.getElementById('xenditTestResult');
            const alertClass = `alert-${type}`;
            resultDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            // Auto clear after 10 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 10000);
            }
        }

        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild.nextSibling);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Account Settings Functions
        async function loadAccountSettings() {
            try {
                const response = await fetch('/api/account-settings');
                const settings = await response.json();
                
                if (settings) {
                    document.getElementById('accountName').value = settings.name || '';
                    document.getElementById('accountEmail').value = settings.email || '';
                    document.getElementById('accountPhone').value = settings.phone || '';
                    document.getElementById('accountTimezone').value = settings.timezone || 'Asia/Jakarta';
                }
            } catch (error) {
                console.error('Error loading account settings:', error);
            }
        }

        async function loadUsageStatistics() {
            try {
                const response = await fetch('/api/usage-stats');
                const stats = await response.json();
                
                if (stats) {
                    document.getElementById('usageInvoices').textContent = stats.invoicesCount || '0';
                    document.getElementById('usageCustomers').textContent = stats.customersCount || '0';
                    document.getElementById('usageRevenue').textContent = formatCurrency(stats.totalRevenue || 0);
                    document.getElementById('usageEmails').textContent = stats.emailsSent || '0';
                }
            } catch (error) {
                console.error('Error loading usage statistics:', error);
            }
        }

        // Account Information Form
        document.getElementById('accountInfoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const settings = {
                name: document.getElementById('accountName').value,
                email: document.getElementById('accountEmail').value,
                phone: document.getElementById('accountPhone').value,
                timezone: document.getElementById('accountTimezone').value
            };

            try {
                const response = await fetch('/api/account-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAlert('Account information saved successfully!', 'success');
                } else {
                    showAlert('Failed to save account information', 'error');
                }
            } catch (error) {
                console.error('Error saving account settings:', error);
                showAlert('Error saving account information', 'error');
            }
        });

        // Account Actions
        async function exportAccountData() {
            try {
                showAlert('Preparing data export...', 'info');
                
                const response = await fetch('/api/export-data');
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `account-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('Account data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Error exporting account data', 'error');
            }
        }

        async function downloadBackup() {
            try {
                showAlert('Creating backup...', 'info');
                
                const response = await fetch('/api/backup-data');
                const blob = await response.blob();
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().split('T')[0]}.zip`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('Backup downloaded successfully!', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showAlert('Error creating backup', 'error');
            }
        }

        function resetAccountData() {
            if (confirm('‚ö†Ô∏è WARNING: This will permanently delete all your data including invoices, customers, and orders. This action cannot be undone.\n\nAre you absolutely sure you want to reset your account?')) {
                if (confirm('Last chance! This will delete EVERYTHING. Type "RESET" in the next dialog to confirm.')) {
                    const confirmation = prompt('Type "RESET" to confirm account reset:');
                    if (confirmation === 'RESET') {
                        performAccountReset();
                    } else {
                        showAlert('Account reset cancelled', 'info');
                    }
                }
            }
        }

        async function performAccountReset() {
            try {
                showAlert('Resetting account data...', 'info');
                
                const response = await fetch('/api/reset-account', {
                    method: 'POST'
                });

                if (response.ok) {
                    showAlert('Account reset successfully! Redirecting to dashboard...', 'success');
                    setTimeout(() => {
                        window.location.href = '/merchant-dashboard.html';
                    }, 2000);
                } else {
                    showAlert('Failed to reset account', 'error');
                }
            } catch (error) {
                console.error('Error resetting account:', error);
                showAlert('Error resetting account', 'error');
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }
    </script>
</body>
</html>
