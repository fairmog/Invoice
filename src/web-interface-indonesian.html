<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, minimum-scale=0.5, user-scalable=yes, viewport-fit=cover">
    <title>Aspree Invoice Generator - Modern Purple</title>
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="alternate icon" href="/assets/favicon.ico">
    <style>
        /* Modern Purple Design System */
        :root {
            /* Primary Purple Palette - Updated to match invoice */
            --primary-purple: #311d6b;
            --primary-dark: #2a1759;
            --primary-light: #4a2b7a;
            
            /* Secondary/Accent Colors */
            --accent-purple: #4a2b7a;
            --light-accent: #6d5498;
            --deep-purple: #241347;
            
            /* Neutral Colors */
            --background: #FAFAFA;
            --card-background: #FFFFFF;
            --text-primary: #2D3748;
            --text-secondary: #718096;
            --border-color: #E2E8F0;
            
            /* Status Colors */
            --success: #48BB78;
            --warning: #ED8936;
            --error: #F56565;
            --info: #4299E1;
            --whatsapp: #25D366;
            --disabled-grey: #9CA3AF;
            
            /* Component Specific */
            --shadow-soft: 0 4px 6px rgba(49, 29, 107, 0.05);
            --shadow-medium: 0 10px 25px rgba(49, 29, 107, 0.1);
            --shadow-strong: 0 20px 40px rgba(49, 29, 107, 0.15);
            --gradient-primary: linear-gradient(135deg, #311d6b, #4a2b7a);
            --gradient-card: linear-gradient(145deg, #FFFFFF 0%, #F8F9FF 100%);
            --border-radius: 12px;
            --border-radius-large: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', system-ui, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Mobile optimizations */
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            /* Safe area insets for modern phones */
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header */
        .header {
            background: var(--gradient-primary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
            text-decoration: none;
            margin-left: 8px;
            transition: var(--transition);
            border-radius: 8px;
            padding: 4px;
        }
        
        .logo:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .logo-icon img {
            max-height: 36px;
            max-width: 200px;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        /* Provider button styles */
        .provider-btn:hover {
            border-color: var(--primary-light) !important;
            background: var(--background) !important;
            transform: translateY(-1px);
            box-shadow: var(--shadow-soft);
        }

        .provider-btn:active {
            transform: translateY(0);
        }
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: var(--shadow-soft);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: var(--transition);
            text-decoration: none;
            backdrop-filter: blur(8px);
        }

        .profile-btn:hover {
            background: var(--primary-light);
            color: white;
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        /* Main Content */
        .main {
            padding: 40px 0;
            min-height: calc(100vh - 80px);
        }

        .page-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .page-title {
            font-size: 40px;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }

        .page-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Business Profile */
        .business-profile {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-color);
        }

        .profile-header {
            background: var(--gradient-primary);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-info h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .profile-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .edit-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .edit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .profile-content {
            padding: 32px;
        }

        .business-info {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 32px;
            align-items: start;
        }

        .business-logo {
            width: 100px;
            height: 100px;
            background: var(--background);
            border-radius: var(--border-radius);
            border: 2px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .business-logo:hover {
            border-color: var(--primary-purple);
            background: rgba(139, 95, 255, 0.05);
            transform: scale(1.02);
        }

        .business-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .logo-placeholder {
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
            font-weight: 500;
        }

        .business-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: rgba(139, 95, 255, 0.02);
            padding: 16px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(139, 95, 255, 0.1);
        }

        .detail-label {
            font-size: 12px;
            color: var(--primary-purple);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .detail-value.empty {
            color: var(--text-secondary);
            font-style: italic;
            font-weight: 400;
        }

        /* Invoice Generator */
        .invoice-generator {
            background: var(--card-background);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-strong);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .generator-header {
            background: var(--gradient-primary);
            color: white;
            padding: 32px;
            text-align: center;
            position: relative;
        }

        .generator-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            opacity: 0.3;
        }

        .generator-title {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .generator-subtitle {
            opacity: 0.95;
            font-size: 16px;
            position: relative;
            z-index: 1;
        }

        .generator-content {
            padding: 40px;
        }

        /* Chat Interface */
        .generator-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .generator-input-section,
        .generator-output-section {
            background: var(--gradient-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-large);
            padding: 32px;
            box-shadow: var(--shadow-soft);
        }

        .chat-header {
            padding: 20px 24px;
            background: rgba(139, 95, 255, 0.03);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .ai-avatar {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
            box-shadow: var(--shadow-soft);
        }

        .ai-info h4 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .ai-status {
            font-size: 13px;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            padding: 32px;
            min-height: 360px;
            max-height: 450px;
            overflow-y: auto;
            background: linear-gradient(180deg, rgba(139, 95, 255, 0.01) 0%, transparent 100%);
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-ai {
            text-align: left;
        }

        .message-user {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            padding: 16px 20px;
            border-radius: 20px;
            max-width: 85%;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }

        .message-ai .message-bubble {
            background: rgba(139, 95, 255, 0.08);
            color: var(--text-primary);
            border: 1px solid rgba(139, 95, 255, 0.15);
        }

        .message-user .message-bubble {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-soft);
        }

        .chat-input-container {
            padding: 24px;
            background: rgba(139, 95, 255, 0.01);
            border-top: 1px solid var(--border-color);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .chat-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 24px;
            font-size: 15px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
            transition: var(--transition);
            background: var(--card-background);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(139, 95, 255, 0.1);
        }

        .send-btn {
            padding: 16px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            font-size: 14px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* Generator Interface Styles */
        .input-header h3,
        .output-header h3 {
            color: var(--primary-purple);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-header p,
        .output-header p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 14px;
        }

        .input-area {
            margin-top: 24px;
        }

        .input-wrapper {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .generator-textarea {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 15px;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
            min-height: 120px;
            transition: var(--transition);
            background: var(--card-background);
        }

        .generator-textarea:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(139, 95, 255, 0.1);
        }


        .generator-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .generate-btn {
            flex: 1;
            padding: 16px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            max-width: 300px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .generate-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }
        .share-btn {
            flex: 1;
            padding: 16px 24px;
            background: var(--info);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
            max-width: 300px;
        }
        .share-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            background: #3182CE;
        }
        .share-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        /* Confirm button (Generate Final Invoice) styles */
        .confirm-btn {
            background: var(--success) !important;
            color: white !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
        }

        .confirm-btn:hover:not(:disabled) {
            background: #38A169 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3) !important;
        }

        .confirm-btn:disabled {
            background: var(--disabled-grey) !important;
            color: #6B7280 !important;
            cursor: not-allowed !important;
            transform: none !important;
            opacity: 0.7 !important;
        }

        .clear-btn {
            padding: 16px 20px;
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .clear-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .output-actions {
            display: flex;
            gap: 8px;
        }

        .edit-btn,
        .download-btn,
        .send-options-container {
            position: relative;
            display: inline-block;
        }
        
        .send-btn-new {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-background);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            justify-content: space-between;
            min-width: 140px;
        }
        
        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .send-options-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            margin-top: 4px;
        }
        
        .send-option {
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background-color 0.2s ease;
        }
        
        .send-option:hover {
            background-color: var(--hover-color);
        }
        
        .send-option:first-child {
            border-radius: 6px 6px 0 0;
        }
        
        .send-option:last-child {
            border-radius: 0 0 6px 6px;
        }

        .edit-btn:hover {
            border-color: var(--warning);
            color: var(--warning);
        }

        .download-btn:hover {
            border-color: var(--info);
            color: var(--info);
        }

        .send-btn-new:hover {
            border-color: var(--success);
            color: var(--success);
        }

        .pdf-preview-container {
            background: #f5f5f5;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            min-height: 600px;
            position: relative;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .pdf-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            display: block;
            overflow: hidden;
            position: relative;
            /* A4 aspect ratio */
            max-width: 794px; /* 210mm at 96 DPI */
            margin: 0 auto;
        }

        .preview-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            z-index: 10;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .edit-form-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .edit-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-background);
        }

        .edit-form-content {
            padding: 20px;
            background: var(--card-background);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: var(--border-radius);
        }

        .close-edit-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
        }

        .close-edit-btn:hover {
            color: var(--error);
        }

        /* Example Messages */
        .example-messages {
            margin-top: 32px;
        }

        .example-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .example-icon {
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }

        .example-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .example-message {
            padding: 16px 20px;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .example-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: var(--transition);
        }

        .example-message:hover {
            border-color: var(--primary-purple);
            background: rgba(139, 95, 255, 0.02);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .example-message:hover::before {
            transform: scaleY(1);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(139, 95, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-purple);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Response Actions */
        .response-actions {
            margin-top: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .action-btn:hover {
            background: var(--primary-purple);
            color: white;
            border-color: var(--primary-purple);
        }

        .action-btn.primary {
            background: var(--primary-purple);
            color: white;
            border-color: var(--primary-purple);
        }

        .action-btn.primary:hover {
            background: var(--primary-dark);
        }

        /* Smart Confirmation */
        .smart-confirm {
            background: rgba(237, 137, 54, 0.05);
            border: 1px solid rgba(237, 137, 54, 0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
        }

        .confirm-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .confirm-title {
            font-weight: 600;
            color: var(--warning);
        }

        .confirm-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 12px;
            }
            
            .main {
                padding: 20px 0;
            }

            /* Mobile logo sizing */
            .logo-icon img {
                max-height: 28px;
                max-width: 150px;
            }

            .page-title {
                font-size: 24px;
                margin-bottom: 12px;
            }
            
            /* Business Profile Mobile Improvements */
            .business-profile {
                margin: 0 -12px;
                border-radius: 0;
                padding: 16px;
            }
            
            .profile-header {
                padding: 16px;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .edit-btn {
                align-self: flex-end;
                padding: 8px 12px;
                font-size: 14px;
            }

            .business-info {
                flex-direction: column;
                gap: 16px;
                text-align: left;
            }
            
            .business-logo {
                align-self: center;
                width: 80px;
                height: 80px;
            }

            .business-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .detail-item {
                justify-content: space-between;
            }

            .generator-content {
                padding: 24px;
            }

            .generator-input-section,
            .generator-output-section {
                padding: 20px;
            }

            .generator-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .generate-btn {
                max-width: none;
                margin-bottom: 12px;
            }


            .output-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .output-actions {
                width: 100%;
                justify-content: center;
            }

            .edit-btn,
            .download-btn,
            .send-btn-new {
                flex: 1;
                justify-content: center;
            }

            .edit-form-content {
                width: 95%;
                margin: 2% auto;
                padding: 16px;
            }


            .profile-content {
                padding: 20px;
            }

            /* CRITICAL: Mobile Invoice Preview Fixes */
            .pdf-preview-container {
                padding: 8px !important;
                min-height: auto !important;
                overflow: auto !important;
                position: relative !important;
                -webkit-overflow-scrolling: touch !important;
            }

            .pdf-preview {
                /* Maintain A4 aspect ratio (210:297) */
                width: 210mm !important;
                min-height: 297mm !important;
                max-width: none !important;
                min-width: none !important;
                margin: 0 auto !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                transform-origin: top center !important;
                transform: scale(var(--mobile-scale-factor, 0.4)) !important;
                transition: transform 0.3s ease !important;
            }

            .pdf-preview-mobile-wrapper {
                width: calc(210mm * var(--mobile-scale-factor, 0.4)) !important;
                height: calc(297mm * var(--mobile-scale-factor, 0.4)) !important;
                margin: 0 auto !important;
                overflow: visible !important;
            }

            /* Mobile Invoice Content Scaling */
            .pdf-preview .inv-container {
                padding: 12px !important;
                font-size: 12px !important;
                line-height: 1.4 !important;
            }

            .pdf-preview .inv-header {
                margin-bottom: 16px !important;
            }

            .pdf-preview .inv-header h1 {
                font-size: 20px !important;
                margin-bottom: 8px !important;
            }

            .pdf-preview .inv-header-content {
                flex-direction: column !important;
                gap: 16px !important;
            }

            .pdf-preview .invoice-info {
                text-align: left !important;
            }

            .pdf-preview .logo-section {
                text-align: center !important;
                margin-bottom: 16px !important;
            }

            .pdf-preview .logo-section img {
                max-width: 120px !important;
                max-height: 80px !important;
            }

            /* Mobile Table Responsiveness */
            .pdf-preview .invoice-table {
                font-size: 11px !important;
                width: 100% !important;
                display: block !important;
                overflow-x: auto !important;
                white-space: nowrap !important;
            }

            .pdf-preview .invoice-table table {
                width: 100% !important;
                min-width: 320px !important;
            }

            .pdf-preview .invoice-table th,
            .pdf-preview .invoice-table td {
                padding: 6px 4px !important;
                font-size: 10px !important;
                line-height: 1.3 !important;
            }

            .pdf-preview .invoice-table th {
                font-size: 11px !important;
                font-weight: 600 !important;
            }

            /* Mobile Summary Section */
            .pdf-preview .summary-section {
                margin-top: 16px !important;
            }

            .pdf-preview .summary-table {
                font-size: 12px !important;
            }

            .pdf-preview .summary-table td {
                padding: 4px 8px !important;
            }

            .pdf-preview .total-row td {
                font-size: 14px !important;
                font-weight: bold !important;
            }

            /* Mobile Addresses */
            .pdf-preview .addresses {
                flex-direction: column !important;
                gap: 16px !important;
            }

            .pdf-preview .address-block {
                width: 100% !important;
                margin-bottom: 12px !important;
            }

            .pdf-preview .address-block h3 {
                font-size: 13px !important;
                margin-bottom: 6px !important;
            }

            .pdf-preview .address-block address {
                font-size: 11px !important;
                line-height: 1.4 !important;
            }

            /* Mobile Footer */
            .pdf-preview .footer-band {
                padding: 12px !important;
                font-size: 11px !important;
                text-align: center !important;
            }

            /* Mobile Form Inputs */
            .generator-input-section textarea {
                min-height: 120px !important;
                font-size: 16px !important; /* Prevents zoom on iOS */
            }

            .generator-input-section input,
            .generator-input-section select {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 12px !important;
            }

            /* Mobile Button Optimizations */
            .btn-primary,
            .btn-secondary {
                min-height: 48px !important;
                font-size: 16px !important;
                padding: 12px 24px !important;
                touch-action: manipulation !important;
            }

            .generate-btn {
                width: 100% !important;
                margin-bottom: 16px !important;
            }

            /* Mobile Output Actions */
            .output-actions {
                gap: 8px !important;
                flex-wrap: wrap !important;
            }

            .output-actions .btn {
                flex: 1 1 auto !important;
                min-width: 120px !important;
            }

            /* Mobile Invoice Preview Zoom Controls */
            .mobile-zoom-controls {
                position: fixed !important;
                top: 50% !important;
                right: 8px !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
                background: rgba(255, 255, 255, 0.95) !important;
                border-radius: 20px !important;
                padding: 8px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
                backdrop-filter: blur(8px) !important;
            }

            .zoom-btn {
                width: 40px !important;
                height: 40px !important;
                border: none !important;
                background: var(--primary-purple) !important;
                color: white !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 18px !important;
                font-weight: bold !important;
                cursor: pointer !important;
                transition: all 0.2s ease !important;
                box-shadow: 0 2px 6px rgba(49, 29, 107, 0.3) !important;
                touch-action: manipulation !important;
            }

            .zoom-btn:hover, .zoom-btn:active {
                background: var(--primary-light) !important;
                transform: scale(1.05) !important;
            }

            .zoom-indicator {
                position: fixed !important;
                top: 20px !important;
                right: 8px !important;
                background: rgba(0, 0, 0, 0.8) !important;
                color: white !important;
                padding: 6px 12px !important;
                border-radius: 12px !important;
                font-size: 12px !important;
                font-weight: 500 !important;
                z-index: 1001 !important;
                pointer-events: none !important;
                opacity: 0 !important;
                transition: opacity 0.3s ease !important;
            }

            .zoom-indicator.show {
                opacity: 1 !important;
            }

            /* Pan indicator for when zoomed in */
            .pan-indicator {
                position: fixed !important;
                bottom: 20px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                background: rgba(0, 0, 0, 0.8) !important;
                color: white !important;
                padding: 8px 16px !important;
                border-radius: 16px !important;
                font-size: 12px !important;
                z-index: 1001 !important;
                display: none !important;
            }

            .pan-indicator.show {
                display: block !important;
            }
        }

        /* Extra Small Mobile - Fine-tune logo for very small screens */
        @media (max-width: 480px) {
            .logo-icon img {
                max-height: 24px;
                max-width: 120px;
            }
            
            .header {
                padding: 12px 0;
            }
            
            .container {
                padding: 0 8px;
            }
        }

        /* Tablet Responsive Styles (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 740px;
                padding: 0 20px;
            }

            .pdf-preview-container {
                padding: 16px;
            }

            .pdf-preview {
                width: 100%;
                max-width: 700px;
                margin: 0 auto;
            }

            .pdf-preview .inv-container {
                padding: 20px;
                font-size: 13px;
            }

            .pdf-preview .invoice-table {
                font-size: 12px;
            }

            .generator-content {
                padding: 32px;
            }

            .generator-actions {
                flex-direction: row;
                justify-content: center;
                gap: 16px;
            }

            .generate-btn {
                max-width: 300px;
            }
        }

        /* Desktop Responsive Styles (1024px+) */
        @media (min-width: 1024px) {
            .container {
                max-width: 1200px;
                padding: 0 40px;
            }

            .pdf-preview-container {
                padding: 32px;
                min-height: 700px;
            }

            .pdf-preview {
                width: 210mm;
                max-width: 794px;
                min-height: 297mm;
            }

            .generator-content {
                padding: 40px;
            }

            .generator-sections {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 40px;
                align-items: start;
            }

            .generator-input-section {
                max-width: none;
            }

            .generator-output-section {
                position: sticky;
                top: 20px;
            }
        }

        /* Ultra-wide Desktop (1440px+) */
        @media (min-width: 1440px) {
            .container {
                max-width: 1400px;
                padding: 0 60px;
            }

            .generator-content {
                padding: 60px;
            }

            .generator-sections {
                gap: 60px;
            }
        }

        /* Inline Editing Styles for Preview */
        #pdf-preview .editable {
            position: relative !important;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer !important;
            min-height: 20px;
            display: inline-block !important;
            min-width: 80px;
            pointer-events: auto !important;
            z-index: 1 !important;
        }

        #pdf-preview .editable:hover {
            background-color: rgba(139, 95, 255, 0.05);
            box-shadow: 0 0 0 1px rgba(139, 95, 255, 0.2);
        }

        #pdf-preview .editable.editing {
            background-color: white;
            box-shadow: 0 0 0 2px var(--primary-purple);
            cursor: text;
            z-index: 10;
        }

        #pdf-preview .editable-input {
            border: none;
            background: transparent;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            width: 100%;
            min-width: 80px;
            padding: 2px 4px;
        }

        #pdf-preview .editable-textarea {
            border: none;
            background: transparent;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            width: 100%;
            resize: vertical;
            min-height: 40px;
            padding: 2px 4px;
        }

        #pdf-preview .edit-indicator {
            display: none;
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--primary-purple);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        #pdf-preview .editable:hover .edit-indicator {
            display: flex;
        }

        #pdf-preview .editable.editing .edit-indicator {
            display: none;
        }

        #pdf-preview .inline-edit-actions {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 10px 25px rgba(139, 95, 255, 0.1);
            padding: 8px;
            gap: 8px;
            z-index: 20;
            white-space: nowrap;
        }

        #pdf-preview .editable.editing .inline-edit-actions {
            display: flex;
        }

        #pdf-preview .inline-edit-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #pdf-preview .save-btn {
            background: var(--success);
            color: white;
        }

        #pdf-preview .save-btn:hover {
            background: #38a169;
        }

        #pdf-preview .cancel-btn {
            background: var(--border-color);
            color: var(--text-secondary);
        }

        #pdf-preview .cancel-btn:hover {
            background: #cbd5e0;
        }

        /* Specific field styles */
        #pdf-preview .editable-currency {
            text-align: right;
            font-weight: 600;
        }

        #pdf-preview .editable-quantity, #pdf-preview .editable-price {
            text-align: right;
            font-weight: 600;
            font-size: 16px;
        }

        /* Auto-calculation feedback styles */
        #pdf-preview .editable.calculation-field {
            position: relative;
        }

        #pdf-preview .editable.calculation-field::before {
            content: "🔢";
            position: absolute;
            top: -8px;
            right: -8px;
            background: rgba(139, 95, 255, 0.9);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }

        #pdf-preview .editable.calculation-field:hover::before {
            opacity: 1;
        }

        #pdf-preview .editable.calculation-updating {
            background: rgba(139, 95, 255, 0.15) !important;
            transform: scale(1.02);
            transition: all 0.3s ease;
        }

        /* Live preview styling for real-time calculations */
        #pdf-preview .live-preview {
            background: rgba(34, 197, 94, 0.08) !important;
            color: #16a34a !important;
            font-style: italic;
            position: relative;
            transition: all 0.2s ease;
            border-left: 3px solid #16a34a !important;
        }

        #pdf-preview .live-preview::after {
            content: "●";
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            color: #16a34a;
            font-size: 8px;
            animation: live-pulse 1s infinite;
        }

        @keyframes live-pulse {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        #pdf-preview .editable.calculation-highlight {
            background: linear-gradient(45deg, rgba(139, 95, 255, 0.1), rgba(139, 95, 255, 0.2));
            border-left: 3px solid rgba(139, 95, 255, 0.8);
            box-shadow: 0 2px 4px rgba(139, 95, 255, 0.1);
        }

        .editing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: 5;
            display: none;
        }

        .editing-overlay.active {
            display: block;
        }

        /* Save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(139, 95, 255, 0.1);
            display: none;
            z-index: 100;
            animation: slideInRight 0.3s ease-out;
        }

        .save-indicator.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/generator" class="logo" title="Aspree Invoice Generator - Home">
                    <div class="logo-icon">
                        <img src="/assets/aspree-header-logo.png" alt="Aspree Invoice Generator" onerror="this.style.display='none'; this.parentNode.innerHTML='🏠';">
                    </div>
                </a>
                <div class="header-actions">
                    <button class="profile-btn" onclick="openMerchantDashboard()">
                        <span>📊</span>
                        <span>Merchant Dashboard</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Aspree Invoice Generator</h1>
                <p class="page-subtitle">
                    Create professional invoices instantly with AI. Just describe your order in natural language, and let our intelligent system handle the rest.
                </p>
            </div>

            <!-- Business Profile Card -->
            <div class="business-profile">
                <div class="profile-header">
                    <div class="profile-info">
                        <h3>Business Information</h3>
                    </div>
                    <a href="/business-settings" class="edit-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                        <span>⚙️</span>
                        Settings
                    </a>
                </div>

                <div class="profile-content">
                    <div class="business-info">
                        <div class="business-logo" onclick="openBusinessProfile()">
                            <img id="business-logo-img" src="" alt="" style="display: none;">
                            <div class="logo-placeholder" id="logo-placeholder">
                                <div style="font-size: 24px; margin-bottom: 8px;">🏢</div>
                                <div>Upload Logo</div>
                            </div>
                        </div>

                        <div class="business-details">
                            <div class="detail-item">
                                <div class="detail-label">Business Name</div>
                                <div class="detail-value" id="business-name">Toko Gadget Teknologi</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Alamat Email</div>
                                <div class="detail-value" id="business-email">billing@tokogadget.co.id</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Nomor Telepon</div>
                                <div class="detail-value" id="business-phone">+62 21 1234 5678</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Alamat Bisnis</div>
                                <div class="detail-value" id="business-address">Jl. Teknologi No. 123, Jakarta Selatan</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Kategori Bisnis</div>
                                <div class="detail-value" id="business-category">Bisnis Umum</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Generator -->
            <div class="invoice-generator">
                <div class="generator-header">
                    <h2 class="generator-title">🚀 Aspree Invoice Generator</h2>
                    <p class="generator-subtitle">Buat faktur profesional dengan bantuan AI</p>
                </div>

                <div class="generator-content">
                    <!-- Generator Interface -->
                    <div class="generator-container">
                        <!-- Input Section -->
                        <div class="generator-input-section">
                            <div class="input-header">
                                <h3>✨ Copas Format Pesanan Anda</h3>
                                <p>kami akan membuatkan Faktur Proffesional segera untuk anda.</p>
                            </div>
                            
                            <div class="input-area">
                                <div class="input-wrapper">
                                    <label for="invoice-description" class="input-label">Deskripsi Pesanan</label>
                                    <textarea 
                                        id="invoice-description" 
                                        class="generator-textarea"
                                        placeholder="Contoh: 'Buat faktur untuk Ahmad Rahman (ahmad@email.com) untuk 2 iPhone 15 Pro masing-masing 16.5 juta dan 1 AirPods Pro 4.1 juta'"
                                        rows="4"
                                        oninput="toggleGenerateButton()"
                                    ></textarea>
                                </div>
                                
                                
                                <div class="generator-actions">
                                    <button class="generate-btn" onclick="generateInvoice()" id="generate-btn" disabled>
                                        <span class="btn-icon">🚀</span>
                                        <span class="btn-text">Buat Faktur</span>
                                        <span class="btn-spinner" style="display: none;">⏳</span>
                                    </button>
                                    <button class="clear-btn" onclick="clearInput()">
                                        <span>🗑️</span>
                                        <span>Clear</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Output Section -->
                        <div class="generator-output-section" id="output-section" style="display: none;">
                            <div class="output-header">
                                <h3 id="output-section-title">🔍 Preview Faktur</h3>
                                <div class="output-actions" id="preview-actions">
                                    <button class="confirm-btn" onclick="generateFinalInvoice()" style="background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                                        <span>✅</span>
                                        <span>Generate Final Invoice</span>
                                    </button>
                                    <button class="share-btn" onclick="openSharingPopup()" id="share-btn-preview" disabled style="display: none; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                                        <span>📤</span>
                                        <span>Bagikan Faktur</span>
                                    </button>
                                </div>
                                <div class="output-actions" id="final-actions" style="display: none;">
                                    <button class="edit-btn" onclick="editInvoice()">
                                        <span>✏️</span>
                                        <span>Edit</span>
                                    </button>
                                    <button class="print-btn" onclick="printInvoice()">
                                        <span>🖨️</span>
                                        <span>Print Invoice</span>
                                    </button>
                                    <button class="share-btn" onclick="openSharingPopup()" id="share-btn-final" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                                        <span>📤</span>
                                        <span>Bagikan Faktur</span>
                                    </button>
                                    <div class="send-options-container">
                                        <button class="send-btn-new" onclick="toggleSendOptions()">
                                            <span>📧</span>
                                            <span>Kirim</span>
                                            <span class="dropdown-arrow">▼</span>
                                        </button>
                                        <div class="send-options-dropdown" id="sendOptionsDropdown" style="display: none;">
                                            <button class="send-option" onclick="sendInvoiceEmail()">
                                                <span>📧</span>
                                                <span>Kirim Email</span>
                                            </button>
                                            <button class="send-option" onclick="shareWhatsApp()">
                                                <span>📱</span>
                                                <span>Bagikan WhatsApp</span>
                                            </button>
                                            <button class="send-option" onclick="copyLink()">
                                                <span>🔗</span>
                                                <span>Salin Link</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PDF Preview -->
                            <div class="pdf-preview-container" id="pdf-preview-container">
                                <div class="pdf-preview-mobile-wrapper" id="pdf-preview-wrapper">
                                    <div class="pdf-preview" id="pdf-preview">
                                        <div class="preview-loading">
                                            <div class="loading-spinner"></div>
                                            <div>Generating PDF preview...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Mobile Zoom Controls (only visible on mobile) -->
                                <div class="mobile-zoom-controls" id="mobile-zoom-controls" style="display: none;">
                                    <button class="zoom-btn" id="zoom-in-btn" onclick="adjustZoom(0.1)" title="Zoom In">+</button>
                                    <button class="zoom-btn" id="fit-screen-btn" onclick="fitToScreen()" title="Fit to Screen">⌂</button>
                                    <button class="zoom-btn" id="zoom-out-btn" onclick="adjustZoom(-0.1)" title="Zoom Out">−</button>
                                </div>
                                
                                <!-- Zoom Indicator -->
                                <div class="zoom-indicator" id="zoom-indicator">100%</div>
                                
                                <!-- Pan Indicator -->
                                <div class="pan-indicator" id="pan-indicator">
                                    📱 Drag to pan around the invoice
                                </div>
                            </div>
                            
                            <!-- Edit Form (Hidden by default) -->
                            <div class="edit-form-container" id="edit-form" style="display: none;">
                                <div class="edit-form-header">
                                    <h4>✏️ Edit Detail Faktur</h4>
                                    <button class="close-edit-btn" onclick="closeEditForm()">&times;</button>
                                </div>
                                <div class="edit-form-content" id="edit-form-content">
                                    <!-- Dynamic edit form will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Inline editing overlay and indicators -->
    <div class="editing-overlay" id="editing-overlay"></div>
    <div class="save-indicator" id="save-indicator">
        ✅ Changes saved
    </div>

    <script>
        // Dynamic URL Management
        function getBaseUrl() {
            return window.location.origin;
        }
        
        function openMerchantDashboard() {
            const dashboardUrl = getBaseUrl() + '/merchant';
            window.open(dashboardUrl, '_blank');
        }
        
        // Chat functionality
        function handleKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Generator Interface Functions
        let currentInvoiceData = null;
        let invoiceGenerated = false;
        let hasUnsavedEdits = false;
        let currentInvoiceDbId = null; // Track database ID to prevent duplicate creation
        let finalInvoiceGenerated = false; // Track if final invoice has been generated

        function toggleGenerateButton() {
            const textarea = document.getElementById('invoice-description');
            hasUnsavedEdits = true;
            updateButtonStates();
        }
        
        function updateButtonStates() {
            const textarea = document.getElementById('invoice-description');
            const generateBtn = document.getElementById('generate-btn');
            const shareBtnPreview = document.getElementById('share-btn-preview');
            const shareBtnFinal = document.getElementById('share-btn-final');
            const confirmBtn = document.querySelector('.confirm-btn'); // Generate Final Invoice button
            
            const hasInput = textarea.value.trim();
            
            // Debug logging
            console.log('updateButtonStates called:', {
                invoiceGenerated: invoiceGenerated,
                finalInvoiceGenerated: finalInvoiceGenerated,
                hasUnsavedEdits: hasUnsavedEdits,
                hasInput: !!hasInput,
                currentInvoiceDbId: currentInvoiceDbId,
                shareBtnPreview: shareBtnPreview ? 'found' : 'not found',
                shareBtnFinal: shareBtnFinal ? 'found' : 'not found',
                confirmBtn: confirmBtn ? 'found' : 'not found'
            });
            
            // Generate button: enabled when there's input AND (no invoice generated OR has unsaved edits)
            generateBtn.disabled = !hasInput || (!hasUnsavedEdits && invoiceGenerated);
            
            // Generate Final Invoice button logic
            if (confirmBtn) {
                // Disabled when: final invoice generated AND no unsaved edits
                const shouldDisableConfirm = finalInvoiceGenerated && !hasUnsavedEdits;
                confirmBtn.disabled = shouldDisableConfirm;
                
                // Update button text to show current action
                const buttonText = confirmBtn.querySelector('span:last-child');
                if (buttonText) {
                    if (currentInvoiceDbId && hasUnsavedEdits) {
                        buttonText.textContent = 'Update Final Invoice';
                    } else if (currentInvoiceDbId && !hasUnsavedEdits) {
                        buttonText.textContent = 'Generate Final Invoice';
                    } else {
                        buttonText.textContent = 'Generate Final Invoice';
                    }
                }
                
                console.log('Confirm button state:', {
                    disabled: confirmBtn.disabled,
                    text: buttonText ? buttonText.textContent : 'no text element'
                });
            }
            
            // Share button in preview section: enabled when invoice has been generated (preview mode)
            if (shareBtnPreview) {
                shareBtnPreview.disabled = !invoiceGenerated;
                shareBtnPreview.style.display = invoiceGenerated ? 'flex' : 'none';
            }
            
            // Share button in final section: always enabled (will be shown/hidden by section visibility)
            if (shareBtnFinal) {
                shareBtnFinal.disabled = false;
            }
            
            // Debug logging for all button states
            console.log('All buttons updated:', {
                generate: generateBtn ? generateBtn.disabled : 'not found',
                confirm: confirmBtn ? confirmBtn.disabled : 'not found',
                sharePreview: shareBtnPreview ? {
                    disabled: shareBtnPreview.disabled,
                    display: shareBtnPreview.style.display
                } : 'not found',
                shareFinal: shareBtnFinal ? {
                    disabled: shareBtnFinal.disabled
                } : 'not found'
            });
        }


        function clearInput() {
            document.getElementById('invoice-description').value = '';
            document.getElementById('output-section').style.display = 'none';
            
            // Reset all states
            currentInvoiceData = null;
            invoiceGenerated = false;
            hasUnsavedEdits = false;
            currentInvoiceDbId = null; // Reset DB ID so next generation creates new invoice
            finalInvoiceGenerated = false; // Reset button state
            
            updateButtonStates();
        }

        async function generateInvoice() {
            const textarea = document.getElementById('invoice-description');
            const message = textarea.value.trim();
            
            if (!message) return;

            // Show loading state
            const generateBtn = document.getElementById('generate-btn');
            const btnIcon = generateBtn.querySelector('.btn-icon');
            const btnText = generateBtn.querySelector('.btn-text');
            const btnSpinner = generateBtn.querySelector('.btn-spinner');
            
            btnIcon.style.display = 'none';
            btnText.textContent = 'Generating...';
            btnSpinner.style.display = 'inline';
            generateBtn.disabled = true;

            try {
                console.log('🚀 Starting invoice generation process...');
                
                // Process with AI
                const result = await processWithAI(message);
                console.log('📦 AI processing result:', result);
                
                if (result.success) {
                    console.log('✅ AI processing successful, setting up preview...');
                    currentInvoiceData = result;
                    
                    // Check for warnings (like missing prices) and show helpful feedback
                    if (result.warnings && result.warnings.length > 0) {
                        const missingPriceWarning = result.warnings.find(w => w.type === 'missing_prices');
                        if (missingPriceWarning) {
                            showAlert(missingPriceWarning.message + '\n\n' + missingPriceWarning.helpText, 'warning', 8000);
                        }
                    }
                    
                    try {
                        console.log('🔄 Generating invoice preview...');
                        showInvoicePreview(result);
                        console.log('✅ Invoice preview generated successfully');
                        // Note: Don't set invoiceGenerated = true here, this is just preview
                        // Only set it in generateFinalInvoice()
                    } catch (previewError) {
                        console.error('❌ Error generating invoice preview:', previewError);
                        console.error('Preview error stack:', previewError.stack);
                        alert('Berhasil membuat faktur, tetapi gagal menampilkan preview. Error: ' + previewError.message);
                    }
                } else {
                    console.error('❌ AI processing failed:', result.error);
                    alert('Error membuat faktur: ' + result.error);
                }
            } catch (error) {
                console.error('❌ Invoice generation error:', error);
                console.error('Error stack:', error.stack);
                alert('Gagal membuat faktur. Error: ' + error.message + '. Silakan coba lagi.');
            } finally {
                console.log('🔄 Clearing loading state...');
                // Reset button
                btnIcon.style.display = 'inline';
                btnText.textContent = 'Buat Faktur';
                btnSpinner.style.display = 'none';
                
                // Ensure all loading indicators are hidden
                const loadingIndicators = document.querySelectorAll('.loading-indicator, .spinner, .loading');
                loadingIndicators.forEach(indicator => {
                    indicator.style.display = 'none';
                });
                
                // Update button states based on current status
                updateButtonStates();
                console.log('✅ Loading state cleared successfully');
            }
        }

        function showInvoicePreview(invoiceData) {
            try {
                console.log('🔄 Starting invoice preview display...');
                console.log('Invoice data received:', invoiceData);
                
                // Validate input data
                if (!invoiceData) {
                    throw new Error('Invoice data is null or undefined');
                }
                
                if (!invoiceData.invoice) {
                    throw new Error('Invoice data missing invoice property');
                }
                
                // Store preview data globally
                currentInvoiceData = invoiceData;
                
                // Initialize notes structure if it doesn't exist
                if (!currentInvoiceData.invoice.notes) {
                    currentInvoiceData.invoice.notes = { publicNotes: '' };
                    console.log('Initialized empty notes structure for invoice');
                }
                
                // Validate required DOM elements exist
                const outputSection = document.getElementById('output-section');
                const outputSectionTitle = document.getElementById('output-section-title');
                const previewActions = document.getElementById('preview-actions');
                const finalActions = document.getElementById('final-actions');
                
                if (!outputSection) throw new Error('Output section element not found');
                if (!outputSectionTitle) throw new Error('Output section title element not found');
                if (!previewActions) throw new Error('Preview actions element not found');
                if (!finalActions) throw new Error('Final actions element not found');
                
                // Show output section
                outputSection.style.display = 'block';
                
                // Configure for preview mode
                if (invoiceData.isPreview || invoiceData.preview) {
                    outputSectionTitle.textContent = '🔍 Preview Faktur';
                    previewActions.style.display = 'flex';
                    finalActions.style.display = 'none';
                } else {
                    outputSectionTitle.textContent = '📄 Faktur Selesai';
                    previewActions.style.display = 'none';
                    finalActions.style.display = 'flex';
                }
                
                // Generate invoice preview with error handling
                console.log('🔄 Calling generateInvoicePreview...');
                generateInvoicePreview(invoiceData);
                
                // Attach event listeners to action buttons
                console.log('🔄 Attaching action button listeners...');
                attachActionButtonListeners();
                
                console.log('✅ Invoice preview displayed successfully');
                
            } catch (error) {
                console.error('❌ Error in showInvoicePreview:', error);
                console.error('Error stack:', error.stack);
                
                // Show user-friendly error message
                const outputSection = document.getElementById('output-section');
                if (outputSection) {
                    outputSection.style.display = 'block';
                    
                    // Create error message safely without template string interpolation
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.cssText = `
                        background: #fee; 
                        border: 1px solid #fcc; 
                        padding: 20px; 
                        border-radius: 8px;
                        color: #c00;
                        margin: 20px 0;
                    `;
                    
                    const heading = document.createElement('h3');
                    heading.textContent = '❌ Error Menampilkan Preview Faktur';
                    
                    const errorDetail = document.createElement('p');
                    errorDetail.innerHTML = '<strong>Detail Error:</strong> ';
                    errorDetail.appendChild(document.createTextNode(error.message || 'Unknown error'));
                    
                    const helpText = document.createElement('p');
                    helpText.textContent = 'Silakan coba generate ulang atau periksa data input Anda.';
                    
                    errorDiv.appendChild(heading);
                    errorDiv.appendChild(errorDetail);
                    errorDiv.appendChild(helpText);
                    outputSection.innerHTML = '';
                    outputSection.appendChild(errorDiv);
                }
                
                // Re-throw error so it can be caught by the calling function
                throw error;
            }
            
            // Scroll to output section
            document.getElementById('output-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        function preserveUserEditedNotes() {
            // Capture current notes from the DOM to preserve user edits
            const notesElement = document.querySelector('[data-field="notes.publicNotes"]');
            if (notesElement && currentInvoiceData && currentInvoiceData.invoice) {
                const currentNotesText = notesElement.textContent.replace('✏️', '').trim();
                
                // Only update if it's not the placeholder text
                const isPlaceholder = currentNotesText === 'tambahkan catatan tambahan disini, jika tidak ada catatan maka kolom catatan akan dihilangkan' ||
                                    currentNotesText === 'Tulis Catatan tambahan disini, jika tidak ada maka Catatan tidak akan ditampilkan' ||
                                    currentNotesText === 'Klik untuk menambahkan catatan...' ||
                                    currentNotesText === 'Extract special requests from message';
                
                if (!isPlaceholder && currentNotesText.length > 0) {
                    // Check if it contains AI extraction artifacts
                    const hasAIArtifacts = currentNotesText.includes('Extract delivery schedule') ||
                                         currentNotesText.includes('Extract appointment info') ||
                                         currentNotesText.includes('Extract payment deadline') ||
                                         currentNotesText.includes('Extract special requests');
                    
                    if (hasAIArtifacts) {
                        // Clean up AI-generated notes or reset to empty
                        if (currentInvoiceData.invoice.notes) {
                            currentInvoiceData.invoice.notes.publicNotes = '';
                        }
                        console.log('🧹 Cleaned up AI-generated notes artifacts');
                    } else {
                        // User has edited the notes, preserve them
                        if (!currentInvoiceData.invoice.notes) {
                            currentInvoiceData.invoice.notes = {};
                        }
                        currentInvoiceData.invoice.notes.publicNotes = currentNotesText;
                        console.log('🔒 Preserved user-edited notes:', currentNotesText);
                    }
                } else {
                    // Empty or placeholder notes, clear the field
                    if (currentInvoiceData.invoice.notes) {
                        currentInvoiceData.invoice.notes.publicNotes = '';
                    }
                    console.log('🗑️ Cleared placeholder notes');
                }
            }
        }
        
        // STAGE 2: Generate final invoice with database save
        async function generateFinalInvoice() {
            if (!currentInvoiceData) {
                showAlert('❌ No preview data available', 'error');
                return;
            }

            try {
                showAlert('⏳ Creating final invoice...', 'info');
                
                // Get current business profile
                let businessProfile = {};
                const savedProfile = localStorage.getItem('businessProfile');
                if (savedProfile) {
                    businessProfile = JSON.parse(savedProfile);
                }
                
                // Determine if this is an UPDATE or CREATE operation
                const isUpdate = currentInvoiceDbId !== null;
                const endpoint = '/api/confirm-invoice'; // Use same endpoint for both create and update
                const method = 'POST'; // Always use POST
                
                console.log(`Invoice operation: ${isUpdate ? 'UPDATE' : 'CREATE'}, DB ID: ${currentInvoiceDbId}`);
                
                // Log invoice data before processing
                console.log('📊 Invoice data before final processing:', {
                    items: currentInvoiceData.invoice.items?.map(item => ({
                        quantity: item.quantity,
                        unitPrice: item.unitPrice,
                        lineTotal: item.lineTotal
                    })),
                    calculations: currentInvoiceData.invoice.calculations
                });
                
                // Preserve user-edited notes before sending to backend
                preserveUserEditedNotes();
                
                // Ensure all calculations are properly applied to data structure
                ensureDataConsistency();
                
                // Log invoice data after processing
                console.log('📊 Invoice data after final processing:', {
                    items: currentInvoiceData.invoice.items?.map(item => ({
                        quantity: item.quantity,
                        unitPrice: item.unitPrice,
                        lineTotal: item.lineTotal
                    })),
                    calculations: currentInvoiceData.invoice.calculations
                });
                
                // Call appropriate API endpoint
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        invoiceId: currentInvoiceDbId, // Include DB ID for updates
                        invoiceData: currentInvoiceData,
                        businessProfile: businessProfile,
                        previewId: currentInvoiceData.previewId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const finalData = await response.json();

                if (finalData.success) {
                    // Show appropriate success message
                    const action = isUpdate ? 'updated' : 'created';
                    showAlert(`✅ Final invoice ${action} successfully!`, 'success');
                    
                    // Store database ID for future updates (only if this was a CREATE)
                    if (!isUpdate && finalData.databaseId) {
                        currentInvoiceDbId = finalData.databaseId;
                        console.log('Stored invoice DB ID for future updates:', currentInvoiceDbId);
                    }
                    
                    // Update invoice data
                    currentInvoiceData = finalData;
                    
                    // Show final invoice with sharing options
                    showInvoicePreview(finalData);
                    
                    // Update state - invoice has been generated successfully
                    console.log('Setting invoiceGenerated = true, finalInvoiceGenerated = true');
                    invoiceGenerated = true;
                    finalInvoiceGenerated = true;
                    hasUnsavedEdits = false;
                    
                    // Update button states immediately after setting the flag
                    console.log('Calling updateButtonStates immediately');
                    updateButtonStates();
                    
                    // Show sharing popup automatically for first time
                    console.log('Showing sharing popup');
                    showSharingPopup(finalData);
                    
                } else {
                    showAlert(`❌ Failed to create final invoice: ${finalData.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Final invoice generation error:', error);
                showAlert(`❌ Error creating final invoice: ${error.message}`, 'error');
            } finally {
                // Reset button state (safely handle missing elements)
                try {
                    const confirmBtn = document.querySelector('.confirm-btn');
                    if (confirmBtn) {
                        const btnIcon = confirmBtn.querySelector('span:first-child');
                        const btnText = confirmBtn.querySelector('span:last-child');
                        const btnSpinner = confirmBtn.querySelector('.spinner');
                        
                        if (btnIcon) btnIcon.style.display = 'inline';
                        if (btnText) btnText.textContent = 'Generate Final Invoice';
                        if (btnSpinner) btnSpinner.style.display = 'none';
                    }
                } catch (buttonError) {
                    console.log('Button state reset skipped:', buttonError.message);
                }
                
                // Update button states based on current status
                updateButtonStates();
            }
        }
        
        // Open sharing popup function (separate from generation)
        function openSharingPopup() {
            if (!currentInvoiceData) {
                showAlert('❌ No invoice data available', 'error');
                return;
            }
            showSharingPopup(currentInvoiceData);
        }
        
        // Show sharing options popup after final invoice creation
        function showSharingPopup(invoiceData) {
            const popup = document.createElement('div');
            popup.className = 'sharing-popup-overlay';
            popup.innerHTML = `
                <div class="sharing-popup">
                    <div class="sharing-header">
                        <h3>✅ Invoice Generated Successfully!</h3>
                        <button class="close-popup" onclick="closeSharingPopup()">×</button>
                    </div>
                    <div class="sharing-content">
                        <p><strong>📋 Invoice:</strong> ${invoiceData.invoice.header.invoiceNumber}</p>
                        <p><strong>💰 Total:</strong> ${formatCurrency(invoiceData.invoice.calculations.grandTotal)}</p>
                        <p><strong>👤 Customer:</strong> ${invoiceData.invoice.customer.name}</p>
                        
                        <h4>Share Options:</h4>
                        <div class="sharing-options">
                            <button class="sharing-option print" onclick="printInvoice(); closeSharingPopup();">
                                <span>🖨️</span>
                                <span>Print</span>
                            </button>
                            <button class="sharing-option email" onclick="sendInvoiceEmail(); closeSharingPopup();">
                                <span>📧</span>
                                <span>Email</span>
                            </button>
                            <button class="sharing-option link" onclick="copyInvoiceLink(); closeSharingPopup();">
                                <span>🔗</span>
                                <span>Copy Link</span>
                            </button>
                            <button class="sharing-option whatsapp" onclick="shareViaWhatsApp(); closeSharingPopup();">
                                <span>📱</span>
                                <span>WhatsApp</span>
                            </button>
                        </div>
                        
                        <div class="popup-actions">
                            <button class="action-btn primary" onclick="window.open('simple-invoice-view.html?id=${invoiceData.invoice.header.invoiceNumber}', '_blank')">
                                🔍 View Full Invoice
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Add CSS if not already added
            if (!document.querySelector('#sharing-popup-styles')) {
                const styles = document.createElement('style');
                styles.id = 'sharing-popup-styles';
                styles.textContent = `
                    .sharing-popup-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    }
                    .sharing-popup {
                        background: white;
                        border-radius: 16px;
                        padding: 32px;
                        max-width: 500px;
                        width: 90%;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
                        animation: popupSlideIn 0.3s ease-out;
                    }
                    @keyframes popupSlideIn {
                        from {
                            opacity: 0;
                            transform: scale(0.9) translateY(-20px);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1) translateY(0);
                        }
                    }
                    .sharing-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                        padding-bottom: 16px;
                        border-bottom: 1px solid #eee;
                    }
                    .sharing-header h3 {
                        margin: 0;
                        color: var(--success);
                    }
                    .close-popup {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #999;
                        padding: 4px;
                    }
                    .close-popup:hover {
                        color: #333;
                    }
                    .sharing-content p {
                        margin: 8px 0;
                        color: #666;
                    }
                    .sharing-content h4 {
                        margin: 24px 0 16px 0;
                        color: #333;
                    }
                    .sharing-options {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 12px;
                        margin-bottom: 24px;
                    }
                    .sharing-option {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 12px 16px;
                        border: 2px solid #eee;
                        border-radius: 8px;
                        background: white;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        font-weight: 500;
                    }
                    .sharing-option:hover {
                        border-color: var(--primary-purple);
                        background: var(--primary-light);
                        color: white;
                        transform: translateY(-1px);
                    }
                    .sharing-option.print:hover {
                        border-color: var(--info);
                        background: var(--info);
                    }
                    .sharing-option.email:hover {
                        border-color: var(--primary-purple);
                        background: var(--primary-purple);
                    }
                    .sharing-option.link:hover {
                        border-color: var(--success);
                        background: var(--success);
                    }
                    .sharing-option.whatsapp:hover {
                        border-color: #25D366;
                        background: #25D366;
                    }
                    .popup-actions {
                        display: flex;
                        justify-content: center;
                        gap: 12px;
                        margin-top: 16px;
                    }
                    .action-btn {
                        padding: 12px 20px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                    }
                    .action-btn.primary {
                        background: var(--gradient-primary);
                        color: white;
                    }
                    .action-btn:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    }
                `;
                document.head.appendChild(styles);
            }
        }
        
        function closeSharingPopup() {
            const popup = document.querySelector('.sharing-popup-overlay');
            if (popup) {
                popup.remove();
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0).replace('IDR', 'Rp');
        }
        
        // Show alert notification
        function showAlert(message, type = 'info') {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.alert-notification');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert-notification alert-${type}`;
            alert.innerHTML = `
                <div class="alert-content">
                    <span class="alert-message">${message}</span>
                    <button class="alert-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(alert);
            
            // Auto remove after delay
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, type === 'error' ? 8000 : 5000);
            
            // Add CSS if not already added
            if (!document.querySelector('#alert-styles')) {
                const styles = document.createElement('style');
                styles.id = 'alert-styles';
                styles.textContent = `
                    .alert-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10001;
                        max-width: 400px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        animation: alertSlideIn 0.3s ease-out;
                    }
                    
                    @keyframes alertSlideIn {
                        from {
                            opacity: 0;
                            transform: translateX(100%);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                    
                    .alert-content {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 16px;
                        color: white;
                        font-weight: 500;
                    }
                    
                    .alert-info {
                        background: linear-gradient(135deg, var(--info) 0%, #3182CE 100%);
                    }
                    
                    .alert-success {
                        background: linear-gradient(135deg, var(--success) 0%, #38A169 100%);
                    }
                    
                    .alert-error {
                        background: linear-gradient(135deg, var(--error) 0%, #E53E3E 100%);
                    }
                    
                    .alert-warning {
                        background: linear-gradient(135deg, var(--warning) 0%, #D69E2E 100%);
                    }
                    
                    .alert-message {
                        flex: 1;
                    }
                    
                    .alert-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 20px;
                        cursor: pointer;
                        padding: 0;
                        margin-left: 12px;
                        opacity: 0.8;
                        transition: opacity 0.2s ease;
                    }
                    
                    .alert-close:hover {
                        opacity: 1;
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        function attachActionButtonListeners() {
            // Remove existing onclick attributes and add event listeners
            const editBtn = document.querySelector('.edit-btn[onclick*="editInvoice"]');
            if (editBtn) {
                editBtn.removeAttribute('onclick');
                editBtn.addEventListener('click', editInvoice);
            }
            
            const printBtn = document.querySelector('.print-btn[onclick*="printInvoice"]');
            if (printBtn) {
                printBtn.removeAttribute('onclick');
                printBtn.addEventListener('click', printInvoice);
            }
            
            const sendBtn = document.querySelector('.send-btn-new[onclick*="sendInvoice"]');
            if (sendBtn) {
                sendBtn.removeAttribute('onclick');
                sendBtn.addEventListener('click', sendInvoice);
            }
            
            const closeEditBtn = document.querySelector('.close-edit-btn[onclick*="closeEditForm"]');
            if (closeEditBtn) {
                closeEditBtn.removeAttribute('onclick');
                closeEditBtn.addEventListener('click', closeEditForm);
            }
        }

        // Unified Invoice Template Generator
        function generateUnifiedInvoiceTemplate(invoiceData, context = 'preview') {
            const invoice = invoiceData.invoice;
            
            // Get business profile for logo and category
            const savedProfile = localStorage.getItem('businessProfile');
            let businessLogo = '';
            let businessCategory = 'general';
            let businessTerms = 'Pembayaran dalam 30 hari';
            let businessProfile = null;
            if (savedProfile) {
                businessProfile = JSON.parse(savedProfile);
                businessLogo = businessProfile.logo || '';
                businessCategory = businessProfile.category || 'general';
                businessTerms = businessProfile.termsAndConditions || 'Pembayaran dalam 30 hari';
            }
            
            // Logo is now managed by loadBusinessDataFromAPI which syncs database with localStorage
            
            // Category-based titles (consistent across all contexts)
            const getCategoryTitle = (category) => {
                const categoryTitles = {
                    'trade': 'FAKTUR PENJUALAN',
                    'services': 'FAKTUR JASA',
                    'manufacturing': 'FAKTUR PRODUKSI',
                    'logistics': 'FAKTUR PENGIRIMAN',
                    'digital_creative': 'FAKTUR LISENSI DIGITAL',
                    'agriculture': 'FAKTUR PERTANIAN',
                    'construction': 'FAKTUR KONSTRUKSI',
                    'tourism': 'FAKTUR PERHOTELAN',
                    'general': 'FAKTUR'
                };
                return categoryTitles[category] || 'FAKTUR';
            };
            
            const invoiceTitle = getCategoryTitle(businessCategory);
            
            // Currency formatting function
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount || 0).replace('IDR', 'Rp');
            };
            
            // Date formatting function
            const formatDate = (dateString) => {
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    return dateString;
                }
            };
            
            // Clean Professional CSS styling (no emojis, no purple gradient)
            const getContextStyles = (context) => {
                const cleanStyles = `
                    :root {
                        --text: #2D3748;
                        --text-light: #718096;
                        --border: #E2E8F0;
                        --bg: #FFFFFF;
                        --bg-light: #F7FAFC;
                    }
                    
                    body {
                        font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
                        font-size: 16px;
                        line-height: 1.5;
                        color: var(--text);
                        background: white;
                        margin: 0;
                        padding: 0;
                    }
                    
                    .paper {
                        width: 100%;
                        max-width: 794px;
                        min-height: 1123px;
                        margin: 0 auto;
                        background: var(--bg);
                        border: 1px solid var(--border);
                        border-radius: 0;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                        overflow: hidden;
                        padding: 0;
                        position: relative;
                    }
                    
                    .inv-header {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 60px;
                        padding: 24px 32px 16px 32px;
                        background: var(--bg);
                        border-bottom: 2px solid var(--border);
                        align-items: start;
                    }
                    
                    .logo-section {
                        text-align: left;
                    }
                    
                    .logo-section img {
                        max-height: 120px;
                        max-width: 300px;
                        object-fit: contain;
                        display: block;
                        margin-bottom: 6px;
                    }
                    
                    .logo-section strong {
                        display: block;
                        font-size: 28px;
                        font-weight: 800;
                        color: var(--text);
                        margin-top: 4px;
                        line-height: 1.1;
                    }
                    
                    .invoice-meta {
                        text-align: right;
                    }
                    
                    .invoice-title {
                        font-size: 28px;
                        font-weight: 800;
                        color: var(--text);
                        margin: 0 0 20px 0;
                        letter-spacing: 0.5px;
                    }
                    
                    .invoice-details {
                        font-size: 15px;
                        color: var(--text-light);
                        margin-bottom: 10px;
                        line-height: 1.4;
                    }
                    
                    .invoice-details strong {
                        color: var(--text);
                        font-weight: 600;
                        min-width: 100px;
                        display: inline-block;
                    }
                    
                    .parties {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 80px;
                        padding: 20px 32px;
                        border-bottom: 1px solid var(--border);
                    }
                    
                    .party-section h3 {
                        font-size: 14px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        font-weight: 600;
                        color: var(--text);
                        margin: 0 0 16px 0;
                    }
                    
                    .party-section address {
                        font-style: normal;
                        font-size: 15px;
                        line-height: 1.5;
                        color: var(--text-light);
                    }
                    
                    .party-section strong {
                        color: var(--text);
                        font-weight: 600;
                        font-size: 16px;
                        display: block;
                        margin-bottom: 3px;
                    }
                    
                    .items-section {
                        padding: 20px 32px;
                    }
                    
                    .items-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 0;
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        overflow: hidden;
                    }
                    
                    .items-table thead th {
                        background: var(--bg-light);
                        border-bottom: 2px solid var(--border);
                        padding: 18px 20px;
                        font-size: 13px;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 0.8px;
                        color: var(--text);
                        text-align: left;
                    }
                    
                    .items-table th:last-child,
                    .items-table th.text-right { text-align: right; }
                    .items-table th.text-center { text-align: center; }
                    
                    .items-table tbody td {
                        padding: 20px;
                        border-bottom: 1px solid var(--border);
                        font-size: 15px;
                        color: var(--text);
                    }
                    
                    .items-table tbody tr:nth-child(even) {
                        background: rgba(247, 250, 252, 0.5);
                    }
                    
                    .items-table tbody tr:last-child td {
                        border-bottom: none;
                    }
                    
                    .items-table .text-right { text-align: right; font-weight: 600; }
                    .items-table .text-center { text-align: center; }
                    
                    .product-name {
                        font-weight: 500;
                        color: var(--text);
                        margin: 0;
                    }
                    
                    .product-description {
                        color: var(--text-light);
                        font-size: 13px;
                        margin: 2px 0 0 0;
                    }
                    
                    .summary {
                        padding: 20px 32px;
                        border-top: 1px solid var(--border);
                        background: var(--bg);
                    }
                    
                    .summary-grid {
                        display: grid;
                        grid-template-columns: 1fr auto;
                        gap: 12px 40px;
                        max-width: 320px;
                        margin-left: auto;
                    }
                    
                    .summary-label {
                        color: var(--text-light);
                        font-size: 14px;
                    }
                    
                    .summary-value {
                        color: var(--text);
                        font-size: 15px;
                        font-weight: 600;
                        text-align: right;
                    }
                    
                    .total-label {
                        color: var(--text) !important;
                        font-weight: 700 !important;
                        font-size: 16px !important;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        padding-top: 12px;
                        border-top: 2px solid var(--text);
                        margin-top: 8px;
                    }
                    
                    .total-value {
                        color: var(--text) !important;
                        font-weight: 800 !important;
                        font-size: 20px !important;
                        padding-top: 12px;
                        border-top: 2px solid var(--text);
                        margin-top: 8px;
                        text-align: right;
                    }
                    
                    
                    /* Compact Notes Styles */
                    .editable[data-field="notes.publicNotes"] {
                        min-width: 200px;
                        display: inline-block;
                        padding: 2px 4px;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                    }
                    
                    .editable[data-field="notes.publicNotes"]:hover {
                        background: rgba(49, 29, 107, 0.05);
                        cursor: text;
                    }
                    
                    /* Print styles */
                    @media print {
                        @page {
                            margin: 10mm;
                            size: A4 portrait;
                        }
                        
                        body {
                            background: white !important;
                            padding: 0 !important;
                        }
                        
                        .paper {
                            box-shadow: none !important;
                            border: none !important;
                            margin: 0 !important;
                            max-width: none !important;
                            page-break-inside: avoid !important;
                        }
                        
                        /* Prevent page breaks within important sections */
                        .inv-header,
                        .invoice-table,
                        .summary-section,
                        .footer-band {
                            page-break-inside: avoid !important;
                        }
                        
                        /* Reduce spacing to fit on one page */
                        .inv-header {
                            margin-bottom: 10px !important;
                        }
                        
                        .invoice-table {
                            margin-bottom: 10px !important;
                        }
                        
                        .summary-section {
                            margin-bottom: 10px !important;
                        }
                        
                        .edit-indicator {
                            display: none !important;
                        }

                        .footer-band {
                            background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                            margin-bottom: 0 !important;
                            padding-bottom: 0 !important;
                        }

                        .footer-section img {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            display: block !important;
                        }

                        /* Header band print styles */
                        .paper > div:first-child {
                            background: linear-gradient(135deg, #311d6b, #4a2b7a) !important;
                            color: white !important;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }

                        /* Ensure all purple elements print with colors */
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* Force single page printing */
                        html, body {
                            height: auto !important;
                            overflow: visible !important;
                        }
                        
                        /* Reduce font sizes slightly for print to fit more content */
                        .paper {
                            font-size: 13px !important;
                        }
                        
                        /* Compact payment schedule section */
                        .payment-schedule-section {
                            margin: 10px 0 !important;
                            padding: 15px !important;
                        }
                        
                        /* Ensure footer doesn't create page break */
                        .footer-band {
                            page-break-inside: avoid !important;
                            margin-top: 10px !important;
                        }
                    }
                    
                    /* Context-specific styles */
                    ${context === 'preview' ? `
                        .paper {
                            margin: 20px auto;
                        }
                    ` : ''}
                    
                    ${context === 'print' ? `
                        body {
                            background: white !important;
                            padding: 0;
                        }
                        .paper {
                            box-shadow: none !important;
                            border: none !important;
                            margin: 0;
                        }
                    ` : ''}
                `;
                
                return cleanStyles;
            };
            
            // Generate clean professional HTML structure (no emojis)
            const cleanHTML = `
                <div class="paper">
                    <!-- Header band -->
                    <div style="background: linear-gradient(135deg, #311d6b, #4a2b7a); color: white; padding: 12px 0; text-align: center;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <img src="/assets/aspree-header-logo.png" alt="Aspree Logo" style="height: 32px; width: auto;">
                            <p style="font-size: 14px; font-weight: 600; margin: 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Powered by Aspree Invoice Generator</p>
                        </div>
                    </div>
                    
                    <!-- Header with logo and invoice metadata -->
                    <div class="inv-header">
                        <div class="logo-section">
                            ${businessLogo ? 
                                `<img src="${businessLogo}" alt="Logo">` : 
                                `<div style="background: #f0f0f0; padding: 15px; border-radius: 4px; margin-bottom: 12px; font-size: 18px; color: #666; text-align: center; border: 1px solid #e0e0e0;">LOGO</div>`
                            }
                            ${businessProfile && businessProfile.hideBusinessName ? '' : 
                                `<strong>${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.businessName" data-type="text">${invoice.merchant.businessName}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.merchant.businessName
                                }</strong>`
                            }
                        </div>
                        <div class="invoice-meta">
                            <h1 class="invoice-title">${invoiceTitle}</h1>
                            <div class="invoice-details">
                                <strong>No:</strong> ${invoice.header.invoiceNumber}
                            </div>
                            <div class="invoice-details">
                                <strong>Tanggal:</strong> ${context === 'preview' ? 
                                    `<span class="editable" data-field="header.invoiceDate" data-type="date">${formatDate(invoice.header.invoiceDate)}<span class="edit-indicator">✏️</span></span>` : 
                                    formatDate(invoice.header.invoiceDate)
                                }
                            </div>
                            <div class="invoice-details">
                                <strong>Jatuh Tempo:</strong> ${context === 'preview' ? 
                                    `<span class="editable" data-field="header.dueDate" data-type="date">${formatDate(invoice.header.dueDate || invoice.header.invoiceDate)}<span class="edit-indicator">✏️</span></span>` : 
                                    formatDate(invoice.header.dueDate || invoice.header.invoiceDate)
                                }
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parties section -->
                    <div class="parties">
                        <div class="party-section">
                            <h3>DARI</h3>
                            <address>
                                <strong>${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.businessName" data-type="text">${invoice.merchant.businessName}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.merchant.businessName
                                }</strong><br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.address" data-type="textarea">${invoice.merchant.address}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.merchant.address
                                }<br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.phone" data-type="tel">${invoice.merchant.phone}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.merchant.phone
                                }<br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="merchant.email" data-type="email">${invoice.merchant.email}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.merchant.email
                                }
                            </address>
                        </div>
                        <div class="party-section">
                            <h3>KEPADA</h3>
                            <address>
                                <strong>${context === 'preview' ? 
                                    `<span class="editable" data-field="customer.name" data-type="text">${invoice.customer.name}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.customer.name
                                }</strong><br>
                                ${context === 'preview' ? 
                                    `<span class="editable" data-field="customer.address" data-type="textarea">${invoice.customer.address}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.customer.address
                                }<br>
                                ${invoice.customer.phone ? (context === 'preview' ? 
                                    `<span class="editable" data-field="customer.phone" data-type="tel">${invoice.customer.phone}<span class="edit-indicator">✏️</span></span><br>` : 
                                    `${invoice.customer.phone}<br>`
                                ) : ''}
                                ${invoice.customer.email ? (context === 'preview' ? 
                                    `<span class="editable" data-field="customer.email" data-type="email">${invoice.customer.email}<span class="edit-indicator">✏️</span></span>` : 
                                    invoice.customer.email
                                ) : ''}
                            </address>
                        </div>
                    </div>
                    
                    <!-- Items section -->
                    <div class="items-section">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Produk/Layanan</th>
                                    <th class="text-center">Qty</th>
                                    <th class="text-right">Harga Satuan</th>
                                    <th class="text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map((item, index) => `
                                    <tr>
                                        <td>
                                            <div class="product-name">${context === 'preview' ? 
                                                `<span class="editable" data-field="items.${index}.productName" data-type="text">${item.productName}<span class="edit-indicator">✏️</span></span>` : 
                                                item.productName
                                            }</div>
                                            ${item.description ? `<div class="product-description">${item.description}</div>` : ''}
                                        </td>
                                        <td class="text-center">${context === 'preview' ? 
                                            `<span class="editable editable-quantity" data-field="items.${index}.quantity" data-type="number">${item.quantity}<span class="edit-indicator">✏️</span></span>` : 
                                            item.quantity
                                        }</td>
                                        <td class="text-right">${context === 'preview' ? 
                                            `<span class="editable editable-price" data-field="items.${index}.unitPrice" data-type="currency">${formatCurrency(item.unitPrice)}<span class="edit-indicator">✏️</span></span>` : 
                                            formatCurrency(item.unitPrice)
                                        }</td>
                                        <td class="text-right">${formatCurrency(item.lineTotal)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Compact Notes Section -->
                    ${(() => {
                        try {
                            const notes = invoice.notes;
                            
                            // Collect all notes into an array
                            const allNotes = [];
                            
                            // List of placeholder/demo texts to filter out
                            const placeholderTexts = [
                                'Pembayaran dapat dilakukan melalui transfer bank atau tunai',
                                'tambahkan catatan tambahan disini, jika tidak ada catatan maka kolom catatan akan dihilangkan',
                                'Klik untuk menambahkan catatan...',
                                'Extract special requests from message',
                                'Extract delivery schedule if mentioned',
                                'Extract appointment info if service booking',
                                'Extract payment deadline if mentioned'
                            ];
                            
                            const isPlaceholderText = (text) => {
                                if (!text || !text.trim()) return true;
                                const trimmedText = text.trim();
                                return placeholderTexts.some(placeholder => trimmedText.includes(placeholder));
                            };
                            
                            // Only process main user-editable notes (removed AI extraction fields)
                            if (notes?.publicNotes && notes.publicNotes.trim() && !isPlaceholderText(notes.publicNotes)) allNotes.push(notes.publicNotes.trim());
                            if (notes?.customNotes && notes.customNotes.trim() && !isPlaceholderText(notes.customNotes)) allNotes.push(notes.customNotes.trim());
                            
                            console.log('🔧 All notes after filtering:', allNotes);
                            
                            // Show section always in preview mode for editing, or only when notes exist in other modes
                            const hasNotes = allNotes.length > 0;
                            const showSection = context === 'preview' || hasNotes;
                            
                            if (!showSection) return '';
                            
                            if (context === 'preview') {
                                // In preview mode, make it editable
                                const noteContent = hasNotes ? allNotes.join(' | ') : '';
                                const isEmpty = !noteContent.trim();
                                
                                return `
                                    <div style="padding: 12px 32px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); background: rgba(247, 250, 252, 0.3);">
                                        <p style="margin: 0; font-size: 14px; color: var(--text-light); line-height: 1.4;">
                                            <strong style="color: var(--text);">Catatan:</strong> 
                                            <span class="editable" data-field="notes.publicNotes" data-type="text" style="color: ${isEmpty ? 'var(--text-light)' : 'var(--text)'}; ${isEmpty ? 'font-style: italic;' : ''}">${isEmpty ? 'tambahkan catatan tambahan disini, jika tidak ada catatan maka kolom catatan akan dihilangkan' : noteContent}<span class="edit-indicator">✏️</span></span>
                                        </p>
                                    </div>
                                `;
                            } else {
                                // In other modes, show static content
                                const combinedNotes = allNotes.length <= 2 ? 
                                    allNotes : 
                                    [allNotes.slice(0, 2).join(' | ')];
                                
                                return `
                                    <div style="padding: 12px 32px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); background: rgba(247, 250, 252, 0.3);">
                                        ${combinedNotes.map(note => 
                                            `<p style="margin: 0; font-size: 14px; color: var(--text-light); line-height: 1.4;"><strong style="color: var(--text);">Catatan:</strong> ${note}</p>`
                                        ).join('')}
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.error('Error parsing compact notes:', e);
                            return '';
                        }
                    })()}
                    
                    <!-- Summary section -->
                    <div class="summary">
                        <div class="summary-grid">
                            <div class="summary-label">Subtotal</div>
                            <div class="summary-value">${formatCurrency(invoice.calculations.subtotal)}</div>
                            
                            <div class="summary-label">Diskon</div>
                            <div class="summary-value">${context === 'preview' ? 
                                `<span class="editable" data-field="calculations.discount" data-type="currency">-${formatCurrency(invoice.calculations.discount || 0)}<span class="edit-indicator">✏️</span></span>` : 
                                `-${formatCurrency(invoice.calculations.discount || 0)}`
                            }</div>
                            
                            <div class="summary-label">Pajak</div>
                            <div class="summary-value">${context === 'preview' ? 
                                `<span class="editable" data-field="calculations.totalTax" data-type="currency">${formatCurrency(invoice.calculations.totalTax)}<span class="edit-indicator">✏️</span></span>` : 
                                formatCurrency(invoice.calculations.totalTax)
                            }</div>
                            
                            <div class="summary-label">Biaya Kirim</div>
                            <div class="summary-value">${context === 'preview' ? 
                                `<span class="editable" data-field="calculations.shippingCost" data-type="currency">${formatCurrency(invoice.calculations.shippingCost)}<span class="edit-indicator">✏️</span></span>` : 
                                formatCurrency(invoice.calculations.shippingCost)
                            }</div>
                            
                            <div class="summary-label total-label">TOTAL</div>
                            <div class="summary-value total-value">${formatCurrency(invoice.calculations.grandTotal)}</div>
                        </div>
                    </div>

                    <!-- Payment Schedule section -->
                    ${(() => {
                        try {
                            console.log('🔧 Processing payment schedule - Context:', context);
                            console.log('🔧 invoice.paymentSchedule:', invoice.paymentSchedule);
                            console.log('🔧 invoice.payment_schedule_json:', invoice.payment_schedule_json);
                            
                            // Handle both direct object (preview) and JSON string (database) formats
                            let paymentSchedule = null;
                            if (invoice.paymentSchedule) {
                                // Direct object format (preview mode)
                                paymentSchedule = invoice.paymentSchedule;
                                console.log('✅ Using direct paymentSchedule object:', paymentSchedule);
                            } else if (invoice.payment_schedule_json) {
                                // JSON string format (database/view mode)
                                paymentSchedule = typeof invoice.payment_schedule_json === 'string' 
                                    ? JSON.parse(invoice.payment_schedule_json) 
                                    : invoice.payment_schedule_json;
                                console.log('✅ Parsed payment_schedule_json:', paymentSchedule);
                            } else {
                                console.log('❌ No payment schedule data found');
                            }
                            
                            if (paymentSchedule && paymentSchedule.scheduleType === 'down_payment') {
                                return `
                    <div class="payment-schedule-section" style="padding: 40px 32px; border-top: 1px solid var(--border); background: var(--bg);">
                        <h3 style="color: var(--text); font-size: 16px; font-weight: 600; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Jadwal Pembayaran
                        </h3>
                        <div class="payment-schedule-table" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                            <div style="background: var(--bg-light); padding: 18px 20px; border-bottom: 2px solid var(--border); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; font-weight: 700; font-size: 13px; color: var(--text); text-transform: uppercase; letter-spacing: 0.8px;">
                                <div>Jenis Pembayaran</div>
                                <div style="text-align: center;">Jatuh Tempo</div>
                                <div style="text-align: right;">Jumlah</div>
                            </div>
                            ${(() => {
                                // Show complete payment schedule with both phases
                                const finalAmount = invoice.final_payment_amount || paymentSchedule.remainingBalance.amount;
                                const currentStage = invoice.payment_stage || 'down_payment';
                                
                                // Determine status indicators
                                const getStatusIndicator = (phase) => {
                                    if (currentStage === 'completed' || (currentStage === 'final_payment' && phase === 'down_payment')) {
                                        return '✅'; // Completed
                                    } else if (currentStage === phase) {
                                        return '⏳'; // Current/Pending
                                    } else {
                                        return '🔒'; // Future/Locked
                                    }
                                };
                                
                                const getPhaseStyle = (phase) => {
                                    const baseStyle = "padding: 20px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; align-items: center;";
                                    
                                    if (currentStage === phase) {
                                        return baseStyle + " background: rgba(139, 95, 255, 0.05); border-left: 4px solid #8B5FFF;";
                                    } else if (currentStage === 'completed' || (currentStage === 'final_payment' && phase === 'down_payment')) {
                                        return baseStyle + " opacity: 0.7; background: rgba(72, 187, 120, 0.05);";
                                    } else {
                                        return baseStyle + " opacity: 0.6;";
                                    }
                                };
                                
                                return `
                                    <!-- Down Payment Row -->
                                    <div style="${getPhaseStyle('down_payment')}">
                                        <div style="font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 16px;">${getStatusIndicator('down_payment')}</span>
                                            Uang Muka (${paymentSchedule.downPayment.percentage}%)
                                        </div>
                                        <div style="text-align: center; color: var(--text-light); font-size: 15px;">${context === 'preview' ? 
                                            `<span class="editable" data-field="paymentSchedule.downPayment.dueDate" data-type="date">${formatDate(paymentSchedule.downPayment.dueDate)}<span class="edit-indicator">✏️</span></span>` : 
                                            formatDate(paymentSchedule.downPayment.dueDate)
                                        }</div>
                                        <div style="text-align: right; font-weight: 600; font-size: 16px; color: var(--text);">${context === 'preview' ? 
                                            `<span class="editable" data-field="paymentSchedule.downPayment.amount" data-type="currency">${formatCurrency(paymentSchedule.downPayment.amount)}<span class="edit-indicator">✏️</span></span>` : 
                                            formatCurrency(paymentSchedule.downPayment.amount)
                                        }</div>
                                    </div>
                                    <!-- Remaining Payment Row -->
                                    <div style="${getPhaseStyle('final_payment')}">
                                        <div style="font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 16px;">${getStatusIndicator('final_payment')}</span>
                                            Sisa Pembayaran
                                        </div>
                                        <div style="text-align: center; color: var(--text-light); font-size: 15px;">${context === 'preview' ? 
                                            `<span class="editable" data-field="paymentSchedule.remainingBalance.dueDate" data-type="date">${formatDate(paymentSchedule.remainingBalance.dueDate)}<span class="edit-indicator">✏️</span></span>` : 
                                            formatDate(paymentSchedule.remainingBalance.dueDate)
                                        }</div>
                                        <div style="text-align: right; font-weight: 600; font-size: 16px; color: var(--text);">${context === 'preview' ? 
                                            `<span class="editable" data-field="final_payment_amount" data-type="currency">${formatCurrency(finalAmount)}<span class="edit-indicator">✏️</span></span>` : 
                                            formatCurrency(finalAmount)
                                        }</div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    `;
                            }
                            return '';
                        } catch (e) {
                            console.error('Error parsing payment schedule:', e);
                            return '';
                        }
                    })()}


                    <!-- Footer band with terms and contact -->
                    <div class="footer-band" style="background: linear-gradient(135deg, #311d6b, #4a2b7a); color: white; padding: 20px; margin-bottom: 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 200px; gap: 32px; align-items: start; margin-bottom: 24px;">
                            <div class="footer-section">
                                <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Syarat & Ketentuan</h4>
                                <p style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.8;">${businessTerms}</p>
                            </div>
                            <div class="footer-section">
                                <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 16px 0; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px;">Kontak</h4>
                                <ul style="font-size: 13px; line-height: 1.6; margin: 0; opacity: 0.8; list-style: none; padding: 0;">
                                    <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                        <span style="opacity: 0.7;">📞</span>
                                        ${businessProfile ? (businessProfile.phone || invoice.merchant_phone) : invoice.merchant_phone || '-'}
                                    </li>
                                    <li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;">
                                        <span style="opacity: 0.7;">📧</span>
                                        ${businessProfile ? (businessProfile.email || invoice.merchant_email) : invoice.merchant_email || '-'}
                                    </li>
                                    ${businessProfile && businessProfile.website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;">🌐</span>${businessProfile.website}</li>` : invoice.merchant_website ? `<li style="margin-bottom: 6px; display: flex; align-items: center; gap: 8px;"><span style="opacity: 0.7;">🌐</span>${invoice.merchant_website}</li>` : ''}
                                </ul>
                            </div>
                            <div class="footer-section" style="display: flex; align-items: flex-end; justify-content: flex-end; padding: 0; margin-bottom: -30px;">
                                <img src="/assets/aspri-logo.png" alt="aspree.id" style="height: 120px; width: auto; opacity: 0.9;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Return appropriate format based on context
            if (context === 'print') {
                return `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Faktur - ${invoice.header.invoiceNumber}</title>
                        <style>${getContextStyles(context)}</style>
                    </head>
                    <body>
                        ${cleanHTML}
                    </body>
                    </html>
                `;
            } else {
                return {
                    html: cleanHTML,
                    css: getContextStyles(context)
                };
            }
        }

        function generateInvoicePreview(invoiceData) {
            try {
                console.log('🔄 Starting invoice preview generation...');
                console.log('Invoice data for preview:', invoiceData);
                
                // Validate DOM element exists
                const pdfPreview = document.getElementById('pdf-preview');
                if (!pdfPreview) {
                    throw new Error('PDF preview container element not found');
                }
                
                // Validate invoice data structure
                if (!invoiceData || !invoiceData.invoice) {
                    throw new Error('Invalid invoice data structure for preview');
                }
                
                console.log('🔄 Calling generateUnifiedInvoiceTemplate...');
                
                // Use unified template for consistent styling with error handling
                let result;
                try {
                    result = generateUnifiedInvoiceTemplate(invoiceData, 'preview');
                } catch (templateError) {
                    console.error('❌ Error in generateUnifiedInvoiceTemplate:', templateError);
                    throw new Error(`Template generation failed: ${templateError.message}`);
                }
                
                if (!result) {
                    throw new Error('Template generation returned null/undefined result');
                }
                
                if (!result.html || !result.css) {
                    throw new Error('Template generation returned incomplete result (missing html or css)');
                }
                
                console.log('🔄 Inserting generated content into preview...');
                
                // Insert CSS and HTML into preview
                const previewContent = `
                    <style>${result.css}</style>
                    ${result.html}
                `;
                
                pdfPreview.innerHTML = previewContent;
                
                console.log('🔄 Initializing inline editing...');
                
                // Initialize inline editing for the preview with error handling
                try {
                    initializeInlineEditing();
                } catch (editingError) {
                    console.error('❌ Error initializing inline editing:', editingError);
                    // Don't throw here - preview can work without inline editing
                }
                
                console.log('✅ Invoice preview generated successfully');
                
            } catch (error) {
                console.error('❌ Error in generateInvoicePreview:', error);
                console.error('Error stack:', error.stack);
                
                // Show error in preview container
                const pdfPreview = document.getElementById('pdf-preview');
                if (pdfPreview) {
                    // Create error message safely without template string interpolation
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'preview-error';
                    errorDiv.style.cssText = `
                        background: #fee; 
                        border: 2px solid #fcc; 
                        padding: 30px; 
                        border-radius: 12px;
                        color: #c00;
                        text-align: center;
                        margin: 20px;
                        font-family: Arial, sans-serif;
                    `;
                    
                    const heading = document.createElement('h2');
                    heading.textContent = '❌ Error Membuat Preview Faktur';
                    
                    const errorDetail = document.createElement('p');
                    errorDetail.innerHTML = '<strong>Detail Error:</strong> ';
                    errorDetail.appendChild(document.createTextNode(error.message || 'Unknown error'));
                    
                    const infoText = document.createElement('p');
                    infoText.textContent = 'Data yang diterima mungkin tidak lengkap atau format tidak sesuai.';
                    
                    const helpText = document.createElement('p');
                    helpText.textContent = 'Silakan periksa pesan WhatsApp dan coba generate ulang.';
                    helpText.style.cssText = 'font-size: 14px; color: #666; margin-top: 20px;';
                    
                    errorDiv.appendChild(heading);
                    errorDiv.appendChild(errorDetail);
                    errorDiv.appendChild(infoText);
                    errorDiv.appendChild(helpText);
                    pdfPreview.innerHTML = '';
                    pdfPreview.appendChild(errorDiv);
                }
                
                // Re-throw error so calling function knows it failed
                throw error;
            }
        }

        // Update logo in preview template after async loading
        function updateLogoInPreviewTemplate(logoUrl) {
            try {
                // Find the logo img element in the preview and update it
                const pdfPreview = document.getElementById('pdf-preview');
                if (pdfPreview) {
                    const logoElements = pdfPreview.querySelectorAll('.logo-section img');
                    logoElements.forEach(logoElement => {
                        logoElement.src = logoUrl;
                        logoElement.style.display = 'block';
                    });

                    // Also update any LOGO placeholder divs
                    const placeholders = pdfPreview.querySelectorAll('.logo-section div');
                    placeholders.forEach(placeholder => {
                        if (placeholder.textContent === 'LOGO') {
                            placeholder.innerHTML = `<img src="${logoUrl}" alt="Logo" style="max-height: 120px; max-width: 300px; object-fit: contain; border-radius: 4px; margin-bottom: 6px;">`;
                        }
                    });

                    console.log('✅ Logo updated in preview template:', logoUrl);
                }
            } catch (error) {
                console.error('❌ Error updating logo in preview template:', error);
            }
        }

        // Inline Editing Functionality
        let currentlyEditing = null;
        let originalValue = null;

        function initializeInlineEditing() {
            // Add a small delay to ensure DOM is fully rendered
            setTimeout(() => {
                // Add click listeners to all editable elements in the preview
                const editableElements = document.querySelectorAll('#pdf-preview .editable');
                console.log('🔧 Found', editableElements.length, 'editable elements');
                
                editableElements.forEach((element, index) => {
                    element.addEventListener('click', startInlineEdit);
                    // Also add visual confirmation that element is editable
                    element.style.border = '1px dashed transparent';
                    
                    // Mark calculation fields with special styling
                    const field = element.dataset.field;
                    if (isCalculationField(field)) {
                        element.classList.add('calculation-field');
                        console.log('🔢 Marked calculation field:', field);
                    }
                });

                // Add overlay click listener to cancel editing
                const overlay = document.getElementById('editing-overlay');
                if (overlay) {
                    overlay.addEventListener('click', cancelEdit);
                }
            }, 100);
        }

        function startInlineEdit(event) {
            console.log('🔧 startInlineEdit called', event.currentTarget.dataset.field);
            event.preventDefault();
            event.stopPropagation();

            // Cancel any existing edit
            if (currentlyEditing) {
                cancelEdit();
            }

            const element = event.currentTarget;
            const field = element.dataset.field;
            const type = element.dataset.type;
            const value = getFieldValue(field);

            console.log('🔧 Starting edit:', { field, type, value });

            currentlyEditing = element;
            originalValue = value;

            // Add editing class and show overlay
            element.classList.add('editing');
            document.getElementById('editing-overlay').classList.add('active');

            // Create appropriate input based on type
            const input = createInlineInput(type, value, element);
            
            // Replace content with input
            element.innerHTML = input + `
                <div class="inline-edit-actions">
                    <button class="inline-edit-btn save-btn" onclick="saveEdit()">✓</button>
                    <button class="inline-edit-btn cancel-btn" onclick="cancelEdit()">✕</button>
                </div>
            `;

            // Focus the input
            const inputElement = element.querySelector('input, textarea, select');
            if (inputElement) {
                inputElement.focus();
                if (inputElement.type === 'text' || inputElement.tagName === 'TEXTAREA') {
                    inputElement.select();
                }
            }

            // Add keyboard listeners
            inputElement.addEventListener('keydown', handleInlineEditKeydown);
            inputElement.addEventListener('blur', handleInlineEditBlur);
            
            // Add real-time calculation for calculation fields
            if (isCalculationField(field)) {
                console.log('🔄 Adding real-time calculation for field:', field);
                inputElement.addEventListener('input', function(e) {
                    handleRealTimeCalculation(field, e.target.value);
                });
                
                // Add visual indicator that this field affects calculations
                element.classList.add('calculation-highlight');
                
                // Show tooltip or indication
                const tooltip = document.createElement('div');
                tooltip.textContent = 'Auto-calculating...';
                tooltip.style.cssText = `
                    position: absolute;
                    top: -25px;
                    left: 0;
                    background: rgba(139, 95, 255, 0.9);
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    white-space: nowrap;
                    z-index: 1000;
                    pointer-events: none;
                `;
                element.style.position = 'relative';
                element.appendChild(tooltip);
                
                // Remove tooltip after 2 seconds
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.remove();
                    }
                }, 2000);
            }
        }

        function createInlineInput(type, value, element) {
            const options = element.dataset.options;
            
            switch (type) {
                case 'textarea':
                    return `<textarea class="editable-textarea">${value || ''}</textarea>`;
                case 'date':
                    const dateValue = value && value !== '-' ? formatDateForInput(value) : '';
                    return `<input type="date" class="editable-input" value="${dateValue}">`;
                case 'email':
                    return `<input type="email" class="editable-input" value="${value || ''}">`;
                case 'tel':
                    return `<input type="tel" class="editable-input" value="${value || ''}">`;
                case 'number':
                    const numValue = parseFloat(value) || 0;
                    return `<input type="number" class="editable-input" value="${numValue}" min="0" step="1" oninput="handleLiveCalculation(this)">`;
                case 'currency':
                    const currValue = parseCurrency(value) || 0;
                    return `<input type="number" class="editable-input" value="${Math.round(currValue)}" min="0" step="1" oninput="handleLiveCalculation(this)">`;
                case 'select':
                    const opts = options ? options.split(',') : ['IDR', 'USD', 'EUR'];
                    const selectOptions = opts.map(opt => 
                        `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
                    ).join('');
                    return `<select class="editable-input">${selectOptions}</select>`;
                default:
                    return `<input type="text" class="editable-input" value="${value || ''}">`;
            }
        }

        function handleInlineEditKeydown(event) {
            if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                event.preventDefault();
                saveEdit();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                cancelEdit();
            }
        }

        function handleInlineEditBlur(event) {
            // Small delay to allow clicking save/cancel buttons
            setTimeout(() => {
                if (currentlyEditing && !currentlyEditing.contains(document.activeElement)) {
                    saveEdit();
                }
            }, 150);
        }

        function saveEdit() {
            if (!currentlyEditing) return;

            const inputElement = currentlyEditing.querySelector('input, textarea, select');
            const newValue = inputElement ? inputElement.value : '';
            const field = currentlyEditing.dataset.field;
            const type = currentlyEditing.dataset.type;

            // Validate the input
            if (!validateInput(newValue, type)) {
                return; // Don't save if validation fails
            }

            // Update the invoice data
            setFieldValue(field, newValue);
            // Update button states after edit
            updateButtonStates();

            // Format and display the new value
            const displayValue = formatDisplayValue(newValue, type);
            
            // Reset the element
            currentlyEditing.classList.remove('editing');
            currentlyEditing.innerHTML = `${displayValue}<span class="edit-indicator">✏️</span>`;
            
            // Recalculate totals if needed
            if (isCalculationField(field)) {
                // Ensure data consistency after editing calculation fields
                setTimeout(() => {
                    ensureDataConsistency();
                }, 50);
            }

            // Clean up
            cleanupEdit();

            // Show save indicator
            showSaveIndicator();
        }

        function cancelEdit() {
            if (!currentlyEditing) return;

            // Reset to original value
            const displayValue = formatDisplayValue(originalValue, currentlyEditing.dataset.type);
            currentlyEditing.classList.remove('editing');
            currentlyEditing.innerHTML = `${displayValue}<span class="edit-indicator">✏️</span>`;

            cleanupEdit();
        }

        function cleanupEdit() {
            // Remove visual indicators from calculation fields
            if (currentlyEditing) {
                currentlyEditing.classList.remove('calculation-highlight', 'calculation-updating');
                currentlyEditing.style.borderLeft = '';
                currentlyEditing.style.background = '';
                currentlyEditing.style.position = '';
                
                // Remove any calculation tooltips
                const tooltips = currentlyEditing.querySelectorAll('div[style*="Auto-calculating"]');
                tooltips.forEach(tooltip => tooltip.remove());
            }
            
            // Clear calculation timeout
            clearTimeout(window.calculationTimeout);
            
            currentlyEditing = null;
            originalValue = null;
            document.getElementById('editing-overlay').classList.remove('active');
        }

        function validateInput(value, type) {
            switch (type) {
                case 'email':
                    if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                        alert('Please enter a valid email address');
                        return false;
                    }
                    break;
                case 'number':
                case 'currency':
                    if (value && isNaN(parseFloat(value))) {
                        alert('Please enter a valid number');
                        return false;
                    }
                    break;
            }
            return true;
        }

        // Helper functions for data manipulation
        function getFieldValue(field) {
            const parts = field.split('.');
            let value = currentInvoiceData.invoice;
            
            for (let part of parts) {
                if (part.includes('[') && part.includes(']')) {
                    // Handle array access like items[0]
                    const arrayName = part.split('[')[0];
                    const index = parseInt(part.split('[')[1].split(']')[0]);
                    value = value[arrayName][index];
                } else if (!isNaN(parseInt(part)) && Array.isArray(value)) {
                    // Handle numeric index for array access like items.0
                    value = value[parseInt(part)];
                } else {
                    value = value[part];
                }
            }
            
            // Special handling for due date - default to invoice date if empty
            if (field === 'header.dueDate' && (!value || value === '')) {
                value = currentInvoiceData.invoice.header.invoiceDate;
            }
            
            // Special handling for notes - replace AI extraction artifacts with placeholder
            if (field === 'notes.publicNotes' && value && typeof value === 'string') {
                const hasAIArtifacts = value.includes('Extract delivery schedule') ||
                                     value.includes('Extract appointment info') ||
                                     value.includes('Extract payment deadline') ||
                                     value.includes('Extract special requests');
                
                if (hasAIArtifacts) {
                    console.log('🧹 Replacing AI extraction artifacts in notes field for editing');
                    value = ''; // Show empty field for editing instead of AI artifacts
                }
            }
            
            return value || '';
        }

        function setFieldValue(field, value) {
            const parts = field.split('.');
            let obj = currentInvoiceData.invoice;
            
            // Mark as having unsaved edits
            hasUnsavedEdits = true;
            
            for (let i = 0; i < parts.length - 1; i++) {
                const part = parts[i];
                if (part.includes('[') && part.includes(']')) {
                    // Handle array access like items[0]
                    const arrayName = part.split('[')[0];
                    const index = parseInt(part.split('[')[1].split(']')[0]);
                    obj = obj[arrayName][index];
                } else if (!isNaN(parseInt(part)) && Array.isArray(obj)) {
                    // Handle numeric index for array access like items.0
                    obj = obj[parseInt(part)];
                } else {
                    obj = obj[part];
                }
            }
            
            const lastPart = parts[parts.length - 1];
            
            // Special handling for due date - if empty, use invoice date
            if (field === 'header.dueDate' && (!value || value === '')) {
                value = currentInvoiceData.invoice.header.invoiceDate;
            }
            
            // Special handling for notes - filter out AI extraction artifacts
            if (field === 'notes.publicNotes' && value && typeof value === 'string') {
                // Check if value contains AI extraction patterns
                const hasAIArtifacts = value.includes('Extract delivery schedule') ||
                                     value.includes('Extract appointment info') ||
                                     value.includes('Extract payment deadline') ||
                                     value.includes('Extract special requests');
                
                if (hasAIArtifacts) {
                    console.log('🧹 Filtered out AI extraction artifacts from notes');
                    value = ''; // Clear AI-generated content
                }
            }
            
            // Ensure numeric fields are stored as numbers
            if (field.includes('quantity') || field.includes('unitPrice') || 
                field.includes('discount') || field.includes('totalTax') || 
                field.includes('shippingCost')) {
                obj[lastPart] = Math.round(parseFloat(value) || 0);
            } else {
                obj[lastPart] = value;
            }
            
            // Trigger recalculation for calculation fields
            if (isCalculationField(field)) {
                console.log('🔄 Triggering recalculation after field update:', field, obj[lastPart]);
                // Small delay to ensure DOM is updated
                setTimeout(() => {
                    recalculateInvoice();
                }, 10);
            }
            
            // Update button states after field value change
            updateButtonStates();
        }

        function formatDisplayValue(value, type) {
            switch (type) {
                case 'date':
                    return formatDate(value);
                case 'currency':
                    return value ? formatCurrency(parseFloat(value)) : formatCurrency(0);
                default:
                    return value || '-';
            }
        }

        function formatDate(dateString) {
            if (!dateString || dateString === '-' || dateString === '') return '-';
            const date = new Date(dateString);
            // Check if date is valid
            if (isNaN(date.getTime())) return '-';
            
            // Format as Indonesian date: DD/MM/YYYY
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function formatDateForInput(dateString) {
            if (!dateString || dateString === '-') return '';
            const date = new Date(dateString);
            // Check if date is valid
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }

        function parseCurrency(currencyString) {
            if (!currencyString) return 0;
            // Handle both string and number inputs
            if (typeof currencyString === 'number') return Math.round(currencyString);
            if (typeof currencyString === 'string') {
                return Math.round(parseFloat(currencyString.replace(/[^0-9.-]/g, '')) || 0);
            }
            return 0;
        }

        function isCalculationField(field) {
            return field.includes('quantity') || 
                   field.includes('unitPrice') || 
                   field.includes('discount') || 
                   field.includes('totalTax') || 
                   field.includes('shippingCost') ||
                   field.includes('calculations.discount') ||
                   field.includes('calculations.totalTax') ||
                   field.includes('calculations.shippingCost');
        }

        function ensureDataConsistency() {
            // Ensure all calculated values are properly stored in the data structure
            console.log('🔧 Ensuring data consistency...');
            
            // Update all item quantities and prices to be numbers
            if (currentInvoiceData && currentInvoiceData.invoice && currentInvoiceData.invoice.items) {
                currentInvoiceData.invoice.items.forEach((item, index) => {
                    item.quantity = Math.round(parseFloat(item.quantity) || 0);
                    item.unitPrice = Math.round(parseFloat(item.unitPrice) || 0);
                    item.lineTotal = Math.round(item.quantity * item.unitPrice);
                });
            }
            
            // Update calculations to be numbers
            if (currentInvoiceData && currentInvoiceData.invoice && currentInvoiceData.invoice.calculations) {
                const calc = currentInvoiceData.invoice.calculations;
                calc.discount = Math.round(parseFloat(calc.discount) || 0);
                calc.totalTax = Math.round(parseFloat(calc.totalTax) || 0);
                calc.shippingCost = Math.round(parseFloat(calc.shippingCost) || 0);
            }
            
            // Trigger final recalculation to ensure totals are correct
            recalculateInvoice();
            
            console.log('✅ Data consistency ensured');
        }

        function recalculateInvoice() {
            console.log('🔄 Auto-calculating invoice totals...');
            
            // Step 1: Recalculate line totals
            let subtotal = 0;
            currentInvoiceData.invoice.items.forEach((item, index) => {
                const quantity = Math.round(parseFloat(item.quantity) || 0);
                const unitPrice = Math.round(parseFloat(item.unitPrice) || 0);
                const lineTotal = Math.round(quantity * unitPrice);
                
                item.lineTotal = lineTotal;
                subtotal += lineTotal;

                // Update line total display with highlight effect
                const lineTotalElement = document.querySelector(`[data-field="items.${index}.lineTotal"]`);
                if (lineTotalElement) {
                    updateFieldWithAnimation(lineTotalElement, formatCurrency(lineTotal));
                }
            });

            // Step 2: Update subtotal
            currentInvoiceData.invoice.calculations.subtotal = subtotal;
            const subtotalElement = document.querySelector('[data-field="calculations.subtotal"]');
            if (subtotalElement) {
                updateFieldWithAnimation(subtotalElement, formatCurrency(subtotal));
            }

            // Step 3: Calculate discount
            const discountAmount = Math.round(parseFloat(currentInvoiceData.invoice.calculations.discount) || 0);
            const afterDiscount = Math.max(0, subtotal - discountAmount);

            // Step 4: Calculate tax (on discounted amount)
            const tax = Math.round(parseFloat(currentInvoiceData.invoice.calculations.totalTax) || 0);
            
            // Step 5: Add shipping
            const shipping = Math.round(parseFloat(currentInvoiceData.invoice.calculations.shippingCost) || 0);
            
            // Step 6: Calculate grand total
            const grandTotal = Math.round(afterDiscount + tax + shipping);
            
            currentInvoiceData.invoice.calculations.grandTotal = grandTotal;
            const totalElement = document.querySelector('[data-field="calculations.grandTotal"]');
            if (totalElement) {
                updateFieldWithAnimation(totalElement, formatCurrency(grandTotal));
            }

            // Step 7: Update payment schedule if it exists
            updatePaymentScheduleAmounts(subtotal, grandTotal, discountAmount);
            
            console.log('✅ Auto-calculation completed:', {
                subtotal: formatCurrency(subtotal),
                discount: formatCurrency(discountAmount),
                tax: formatCurrency(tax),
                shipping: formatCurrency(shipping),
                grandTotal: formatCurrency(grandTotal)
            });
            
            // Show brief calculation completion feedback
            showCalculationCompleteFeedback();
        }

        function updateFieldWithAnimation(element, newValue) {
            // Remove live preview styling since this is now a saved calculation
            element.classList.remove('live-preview');
            
            // Add highlight animation to show the field was updated
            element.classList.add('calculation-updating');
            
            // Update the value
            if (element.textContent !== newValue) {
                element.textContent = newValue;
                
                // Remove updating class after animation
                setTimeout(() => {
                    element.classList.remove('calculation-updating');
                }, 300);
            } else {
                // Remove class immediately if no change
                setTimeout(() => {
                    element.classList.remove('calculation-updating');
                }, 100);
            }
        }

        function updatePaymentScheduleAmounts(subtotal, grandTotal, discountAmount) {
            // Check if there's a payment schedule
            if (currentInvoiceData.invoice.paymentSchedule && 
                currentInvoiceData.invoice.paymentSchedule.scheduleType === 'down_payment') {
                
                const schedule = currentInvoiceData.invoice.paymentSchedule;
                const percentage = schedule.downPayment.percentage;
                
                // Recalculate payment amounts based on new totals
                const newDownPaymentAmount = Math.round((grandTotal * percentage) / 100);
                const newRemainingAmount = grandTotal - newDownPaymentAmount;
                
                // Update the payment schedule data
                schedule.downPayment.amount = newDownPaymentAmount;
                schedule.remainingBalance.amount = newRemainingAmount;
                
                console.log('💰 Updated payment schedule:', {
                    downPayment: formatCurrency(newDownPaymentAmount),
                    remaining: formatCurrency(newRemainingAmount)
                });
                
                // Update payment schedule display if visible
                updatePaymentScheduleDisplay();
            }
        }

        function updatePaymentScheduleDisplay() {
            // Refresh the payment schedule section if it exists in the preview
            const scheduleSection = document.querySelector('.payment-schedule-section');
            if (scheduleSection && currentInvoiceData.invoice.paymentSchedule) {
                const schedule = currentInvoiceData.invoice.paymentSchedule;
                
                // Update down payment amount display
                const downPaymentElement = scheduleSection.querySelector('[data-payment-type="down_payment"] .amount');
                if (downPaymentElement) {
                    updateFieldWithAnimation(downPaymentElement, formatCurrency(schedule.downPayment.amount));
                }
                
                // Update remaining balance display
                const remainingElement = scheduleSection.querySelector('[data-payment-type="remaining"] .amount');
                if (remainingElement) {
                    updateFieldWithAnimation(remainingElement, formatCurrency(schedule.remainingBalance.amount));
                }
            }
        }

        // Live calculation during typing (debounced)
        let liveCalculationTimeout;
        function handleLiveCalculation(inputElement) {
            // Clear previous timeout
            if (liveCalculationTimeout) {
                clearTimeout(liveCalculationTimeout);
            }
            
            // Debounce calculation by 100ms to avoid excessive calculations
            liveCalculationTimeout = setTimeout(() => {
                const field = inputElement.closest('[data-field]').dataset.field;
                const value = inputElement.value;
                
                console.log('⚡ Live calculation triggered for:', field, 'value:', value);
                
                // Only trigger for calculation fields
                if (isCalculationField(field)) {
                    performLiveCalculation(field, value);
                }
            }, 100);
        }

        function performLiveCalculation(field, value) {
            // Create temporary data structure for live calculation (don't modify actual data)
            const tempData = JSON.parse(JSON.stringify(currentInvoiceData.invoice));
            
            // Update the temporary field value
            const parts = field.split('.');
            let obj = tempData;
            
            for (let i = 0; i < parts.length - 1; i++) {
                const part = parts[i];
                if (part.includes('[') && part.includes(']')) {
                    const arrayName = part.split('[')[0];
                    const index = parseInt(part.split('[')[1].split(']')[0]);
                    obj = obj[arrayName][index];
                } else if (!isNaN(parseInt(part)) && Array.isArray(obj)) {
                    obj = obj[parseInt(part)];
                } else {
                    obj = obj[part];
                }
            }
            
            const lastPart = parts[parts.length - 1];
            obj[lastPart] = Math.round(parseFloat(value) || 0);
            
            // Perform live calculation on temporary data
            let subtotal = 0;
            tempData.items.forEach((item, index) => {
                const quantity = Math.round(parseFloat(item.quantity) || 0);
                const unitPrice = Math.round(parseFloat(item.unitPrice) || 0);
                const lineTotal = Math.round(quantity * unitPrice);
                
                item.lineTotal = lineTotal;
                subtotal += lineTotal;
                
                // Update line total display with live preview styling
                const lineTotalElement = document.querySelector(`[data-field="items.${index}.lineTotal"]`);
                if (lineTotalElement) {
                    updateFieldWithLivePreview(lineTotalElement, formatCurrency(lineTotal));
                }
            });
            
            // Update subtotal with live preview
            tempData.calculations.subtotal = subtotal;
            const subtotalElement = document.querySelector('[data-field="calculations.subtotal"]');
            if (subtotalElement) {
                updateFieldWithLivePreview(subtotalElement, formatCurrency(subtotal));
            }
            
            // Calculate other totals
            const discountAmount = Math.round(parseFloat(tempData.calculations.discount) || 0);
            const afterDiscount = Math.max(0, subtotal - discountAmount);
            const tax = Math.round(parseFloat(tempData.calculations.totalTax) || 0);
            const shipping = Math.round(parseFloat(tempData.calculations.shippingCost) || 0);
            const grandTotal = Math.round(afterDiscount + tax + shipping);
            
            // Update grand total with live preview
            tempData.calculations.grandTotal = grandTotal;
            const totalElement = document.querySelector('[data-field="calculations.grandTotal"]');
            if (totalElement) {
                updateFieldWithLivePreview(totalElement, formatCurrency(grandTotal));
            }
            
            console.log('✨ Live calculation completed:', {
                subtotal: formatCurrency(subtotal),
                grandTotal: formatCurrency(grandTotal)
            });
        }
        
        function updateFieldWithLivePreview(element, newValue) {
            // Add live preview styling to distinguish from saved values
            element.classList.add('live-preview');
            element.textContent = newValue;
            
            // Remove live preview styling after a delay (will be replaced by saved styling when edit is saved)
            setTimeout(() => {
                // Only remove if it's still a live preview (not converted to saved)
                if (element.classList.contains('live-preview')) {
                    element.classList.remove('live-preview');
                }
            }, 2000);
        }

        function handleRealTimeCalculation(field, value) {
            console.log('⚡ Real-time calculation triggered for:', field, 'value:', value);
            
            // Temporarily update the field value in the data structure
            const numericValue = parseFloat(value) || 0;
            
            // Parse currency values correctly
            let processedValue = value;
            if (field.includes('Price') || field.includes('Tax') || field.includes('Cost') || field.includes('discount') || field.includes('quantity')) {
                // Remove currency formatting for numeric fields
                processedValue = value.replace(/[^\d.-]/g, '');
                if (processedValue === '' || isNaN(parseFloat(processedValue))) {
                    processedValue = '0';
                } else {
                    // Round to whole number for IDR currency
                    processedValue = Math.round(parseFloat(processedValue)).toString();
                }
            }
            
            // Update the temporary field value
            try {
                setFieldValue(field, processedValue);
                
                // Trigger recalculation with a small delay to avoid excessive calls
                clearTimeout(window.calculationTimeout);
                window.calculationTimeout = setTimeout(() => {
                    recalculateInvoice();
                }, 150); // 150ms delay for smooth typing
                
            } catch (error) {
                console.warn('Error in real-time calculation:', error);
            }
        }

        function showCalculationCompleteFeedback() {
            // Create or update feedback notification
            let feedback = document.getElementById('calculation-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'calculation-feedback';
                feedback.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #48bb78, #38a169);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                    z-index: 1000;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                    pointer-events: none;
                `;
                document.body.appendChild(feedback);
            }
            
            feedback.innerHTML = '🔢 Calculations updated';
            
            // Show feedback
            feedback.style.opacity = '1';
            feedback.style.transform = 'translateX(0)';
            
            // Hide after 2 seconds
            setTimeout(() => {
                feedback.style.opacity = '0';
                feedback.style.transform = 'translateX(100%)';
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.remove();
                    }
                }, 300);
            }, 1500);
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Additional Generator Functions
        function editInvoice() {
            if (!currentInvoiceData) return;
            
            // Create edit form content
            const invoice = currentInvoiceData.invoice;
            const editFormHTML = `
                <div style="max-width: 500px;">
                    <h4 style="margin-bottom: 20px; color: var(--primary-purple);">Edit Invoice Details</h4>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Customer Name:</label>
                        <input type="text" id="edit-customer-name" value="${invoice.customer.name}" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Customer Email:</label>
                        <input type="email" id="edit-customer-email" value="${invoice.customer.email || ''}" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Customer Address:</label>
                        <textarea id="edit-customer-address" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; height: 80px;">${invoice.customer.address}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Invoice Date:</label>
                        <input type="date" id="edit-invoice-date" value="${invoice.header.invoiceDate}" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Catatan:</label>
                        <textarea id="edit-notes" placeholder="Tambahkan catatan untuk faktur ini..." style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; height: 80px; resize: vertical;">${invoice.notes?.publicNotes || ''}</textarea>
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 4px; display: block;">Catatan ini akan ditampilkan di faktur dan terlihat oleh pelanggan</small>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button onclick="saveInvoiceEdits()" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            💾 Save Changes
                        </button>
                        <button onclick="closeEditForm()" style="padding: 12px 24px; background: transparent; color: var(--text-secondary); border: 2px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
                            ❌ Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('edit-form-content').innerHTML = editFormHTML;
            document.getElementById('edit-form').style.display = 'flex';
        }

        function closeEditForm() {
            document.getElementById('edit-form').style.display = 'none';
        }

        function saveInvoiceEdits() {
            if (!currentInvoiceData) return;
            
            // Get edited values
            const newCustomerName = document.getElementById('edit-customer-name').value;
            const newCustomerEmail = document.getElementById('edit-customer-email').value;
            const newCustomerAddress = document.getElementById('edit-customer-address').value;
            const newInvoiceDate = document.getElementById('edit-invoice-date').value;
            const newNotes = document.getElementById('edit-notes').value;
            
            // Update current invoice data
            currentInvoiceData.invoice.customer.name = newCustomerName;
            currentInvoiceData.invoice.customer.email = newCustomerEmail;
            currentInvoiceData.invoice.customer.address = newCustomerAddress;
            currentInvoiceData.invoice.header.invoiceDate = newInvoiceDate;
            
            // Initialize notes object if it doesn't exist
            if (!currentInvoiceData.invoice.notes) {
                currentInvoiceData.invoice.notes = {};
            }
            currentInvoiceData.invoice.notes.publicNotes = newNotes;
            
            // Mark as having unsaved edits and update button states
            hasUnsavedEdits = true;
            updateButtonStates();
            
            // Refresh preview
            generateInvoicePreview(currentInvoiceData);
            
            // Close edit form
            closeEditForm();
            
            // Show success message
            alert('✅ Invoice updated successfully!');
        }

        function printInvoice() {
            if (!currentInvoiceData) {
                alert('No invoice data available for printing');
                return;
            }
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            // Generate print-optimized HTML
            const printHtml = generatePrintableInvoice(currentInvoiceData);
            
            printWindow.document.write(printHtml);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 100);
            };
        }
        
        function generatePrintableInvoice(invoiceData) {
            // Use unified template for consistent styling
            return generateUnifiedInvoiceTemplate(invoiceData, 'print');
        }

        function toggleSendOptions() {
            const dropdown = document.getElementById('sendOptionsDropdown');
            const arrow = document.querySelector('.dropdown-arrow');
            
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                dropdown.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.send-options-container');
            if (container && !container.contains(event.target)) {
                const dropdown = document.getElementById('sendOptionsDropdown');
                const arrow = document.querySelector('.dropdown-arrow');
                if (dropdown) {
                    dropdown.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        });
        
        // Helper function to update invoice status to 'sent' after sharing
        async function updateInvoiceStatusToSent() {
            if (!currentInvoiceData?.databaseId) {
                console.log('No invoice ID available for status update');
                return;
            }
            
            try {
                console.log(`📤 Updating invoice ${currentInvoiceData.databaseId} status to 'sent' after sharing`);
                
                const response = await fetch(`/api/invoices/${currentInvoiceData.databaseId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: 'sent',
                        sent_at: new Date().toISOString()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ Invoice status automatically updated to sent');
                } else {
                    console.error('❌ Failed to auto-update invoice status:', data.error);
                }
            } catch (error) {
                console.error('❌ Error auto-updating invoice status:', error);
            }
        }
        
        async function sendInvoiceEmail() {
            if (!currentInvoiceData) {
                alert('Tidak ada data faktur yang tersedia untuk dikirim');
                return;
            }
            
            console.log('Current invoice data for email:', currentInvoiceData);
            console.log('Database ID for email:', currentInvoiceData.databaseId);
            
            if (!currentInvoiceData.databaseId) {
                alert('ID faktur tidak ditemukan. Silakan buat faktur terlebih dahulu.');
                return;
            }
            
            const customerEmail = currentInvoiceData.invoice.customer.email;
            if (!customerEmail) {
                alert('Email pelanggan diperlukan untuk mengirim faktur. Silakan edit faktur dan tambahkan alamat email.');
                return;
            }
            
            // Close dropdown
            document.getElementById('sendOptionsDropdown').style.display = 'none';
            document.querySelector('.dropdown-arrow').style.transform = 'rotate(0deg)';
            
            try {
                // Get business profile data including logo
                const savedProfile = localStorage.getItem('businessProfile');
                let businessProfile = null;
                if (savedProfile) {
                    businessProfile = JSON.parse(savedProfile);
                }

                const response = await fetch('/api/invoices/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoiceId: currentInvoiceData.databaseId,
                        customerEmail: customerEmail,
                        businessProfile: businessProfile
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('✅ Faktur berhasil dikirim ke ' + customerEmail);
                    // Update invoice status to 'sent' after successful email
                    await updateInvoiceStatusToSent();
                } else {
                    console.error('Email send failed:', result);
                    alert('❌ Gagal mengirim faktur: ' + result.error);
                }
            } catch (error) {
                console.error('Email sending error:', error);
                alert('Error mengirim faktur. Silakan coba lagi.');
            }
        }
        
        async function shareWhatsApp() {
            console.log('🚀 ShareWhatsApp function called');
            console.log('📊 currentInvoiceData:', currentInvoiceData);
            
            if (!currentInvoiceData) {
                console.error('❌ No currentInvoiceData available');
                alert('Tidak ada data faktur yang tersedia untuk dibagikan');
                return;
            }
            
            console.log('✅ currentInvoiceData exists, proceeding...');
            
            // Close dropdown
            try {
                document.getElementById('sendOptionsDropdown').style.display = 'none';
                document.querySelector('.dropdown-arrow').style.transform = 'rotate(0deg)';
            } catch (e) {
                console.warn('⚠️ Dropdown elements not found:', e);
            }
            
            console.log('📋 Extracting invoice data...');
            const invoice = currentInvoiceData.invoice;
            console.log('📋 Invoice object:', invoice);
            
            const invoiceNumber = invoice.header.invoiceNumber;
            const customerName = invoice.customer.name;
            const customerPhone = invoice.customer.phone || '';
            const dueDate = invoice.header.dueDate;
            const businessName = invoice.merchant.businessName;
            
            console.log('📋 Extracted data:', {
                invoiceNumber,
                customerName,
                customerPhone,
                dueDate,
                businessName
            });
            
            // Format items list
            let itemsList = '';
            if (invoice.items && invoice.items.length > 0) {
                invoice.items.forEach((item, index) => {
                    const itemTotal = item.quantity * item.unitPrice;
                    itemsList += `${index + 1}. ${item.productName} × ${item.quantity} → Rp ${itemTotal.toLocaleString('id-ID')}\\n`;
                });
            }
            
            // Calculate totals
            const subtotal = invoice.calculations.subtotal || 0;
            const shipping = invoice.calculations.shippingCost || 0;
            const tax = invoice.calculations.totalTax || 0;
            const total = invoice.calculations.grandTotal || subtotal + shipping + tax;
            
            // Create invoice URL
            const invoiceUrl = `${window.location.origin}/simple-invoice-view.html?id=${currentInvoiceData.invoice.header.invoiceNumber}`;
            
            // Format message using Option 3 style
            const message = `🧾 INVOICE #${invoiceNumber}

Kepada: ${customerName}
Total: Rp ${total.toLocaleString('id-ID')}
Due: ${dueDate}

📦 Items:
${itemsList}
Subtotal: Rp ${subtotal.toLocaleString('id-ID')}${shipping > 0 ? `\\nPengiriman: Rp ${shipping.toLocaleString('id-ID')}` : ''}${tax > 0 ? `\\nPajak: Rp ${tax.toLocaleString('id-ID')}` : ''}
TOTAL: Rp ${total.toLocaleString('id-ID')}

📲 Detail: ${invoiceUrl}

${businessName}`;

            // Create WhatsApp URL - if customer has phone, send directly to them
            let whatsappUrl;
            let formattedPhone = '';
            
            if (customerPhone && customerPhone.trim() !== '') {
                // Clean phone number (remove spaces, dashes, parentheses, etc.)
                const cleanPhone = customerPhone.replace(/[^0-9+]/g, '');
                formattedPhone = cleanPhone;
                
                // Handle Indonesian phone number formats
                if (cleanPhone.startsWith('08')) {
                    // Convert 08xx to +628xx
                    formattedPhone = '+62' + cleanPhone.substring(1);
                } else if (cleanPhone.startsWith('62') && !cleanPhone.startsWith('+')) {
                    // Convert 62xx to +62xx
                    formattedPhone = '+' + cleanPhone;
                } else if (!cleanPhone.startsWith('+')) {
                    // Assume Indonesian number if no country code
                    formattedPhone = '+62' + cleanPhone;
                }
                
                whatsappUrl = `https://wa.me/${formattedPhone.replace('+', '')}?text=${encodeURIComponent(message)}`;
            } else {
                // No phone number, open WhatsApp without specific contact
                whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            }
            
            // Debug log
            console.log('WhatsApp URL:', whatsappUrl);
            console.log('Customer phone:', customerPhone);
            console.log('Formatted phone:', customerPhone ? formattedPhone : 'No phone');
            
            // Open WhatsApp
            console.log('🔗 Opening WhatsApp URL:', whatsappUrl);
            try {
                window.open(whatsappUrl, '_blank');
                console.log('✅ WhatsApp window.open() called successfully');
                
                // Update invoice status to 'sent' after successful WhatsApp share
                await updateInvoiceStatusToSent();
                
                // Show success message
                if (customerPhone && customerPhone.trim() !== '') {
                    alert(`✅ Membuka WhatsApp untuk ${customerName} (${customerPhone})`);
                } else {
                    alert('✅ Membuka WhatsApp dengan pesan faktur siap kirim');
                }
            } catch (error) {
                console.error('❌ Error opening WhatsApp:', error);
                alert('❌ Gagal membuka WhatsApp. Silakan coba lagi atau salin link secara manual.');
            }
        }
        
        function copyLink() {
            if (!currentInvoiceData) {
                alert('Tidak ada data faktur yang tersedia');
                return;
            }
            
            // Close dropdown
            document.getElementById('sendOptionsDropdown').style.display = 'none';
            document.querySelector('.dropdown-arrow').style.transform = 'rotate(0deg)';
            
            const invoiceUrl = `${window.location.origin}/simple-invoice-view.html?id=${currentInvoiceData.invoice.header.invoiceNumber}`;
            
            // Try to use the modern clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(invoiceUrl).then(() => {
                    alert('Link faktur berhasil disalin ke clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopyTextToClipboard(invoiceUrl);
                });
            } else {
                fallbackCopyTextToClipboard(invoiceUrl);
            }
        }
        
        async function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    // Update invoice status to 'sent' after successful fallback copy
                    await updateInvoiceStatusToSent();
                    alert('Link faktur berhasil disalin ke clipboard!');
                } else {
                    alert('Gagal menyalin link. Silakan salin secara manual: ' + text);
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('Gagal menyalin link. Silakan salin secara manual: ' + text);
            }
            
            document.body.removeChild(textArea);
        }

        // Missing functions for buttons
        async function copyInvoiceLink() {
            if (!currentInvoiceData || !currentInvoiceData.databaseId) {
                alert('Tidak ada data faktur yang tersedia. Silakan buat faktur terlebih dahulu.');
                return;
            }
            
            const invoiceUrl = `${window.location.origin}/simple-invoice-view.html?id=${currentInvoiceData.invoice.header.invoiceNumber}`;
            
            // Try to use the modern clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(invoiceUrl).then(async () => {
                    // Update invoice status to 'sent' after successful link copy
                    await updateInvoiceStatusToSent();
                    alert('✅ Link faktur berhasil disalin ke clipboard!');
                }).catch(async (err) => {
                    console.error('Failed to copy: ', err);
                    await fallbackCopyTextToClipboard(invoiceUrl);
                });
            } else {
                await fallbackCopyTextToClipboard(invoiceUrl);
            }
        }

        async function shareViaWhatsApp() {
            if (!currentInvoiceData || !currentInvoiceData.databaseId) {
                alert('Tidak ada data faktur yang tersedia. Silakan buat faktur terlebih dahulu.');
                return;
            }
            
            const invoice = currentInvoiceData.invoice;
            const invoiceNumber = invoice.header.invoiceNumber;
            const customerName = invoice.customer.name;
            const customerPhone = invoice.customer.phone || '';
            const customerAddress = invoice.customer.address || '';
            const dueDate = invoice.header.dueDate;
            const businessName = invoice.merchant.businessName;
            const total = invoice.calculations.grandTotal;
            const subtotal = invoice.calculations.subtotal;
            const discount = invoice.calculations.discount || 0;
            const shippingCost = invoice.calculations.shippingCost || 0;
            const items = invoice.items || [];
            
            // Get business settings for payment information
            let bankInfo = '';
            let paymentMethods = '';
            console.log('🔧 Fetching payment methods for WhatsApp message...');
            
            try {
                // Try to get payment methods from business profile or make API call
                const response = await fetch('/api/settings/payment-methods');
                console.log('📡 API Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Payment methods data received:', data);
                    
                    if (data.success && data.paymentMethods) {
                        const bank = data.paymentMethods.bankTransfer;
                        console.log('🏦 Bank transfer data:', bank);
                        
                        if (bank && bank.enabled) {
                            bankInfo = `\n💳 *PEMBAYARAN BANK TRANSFER*\nBank: ${bank.bankName || ''}\nNo. Rekening: ${bank.accountNumber || ''}\nAtas Nama: ${bank.accountHolderName || ''}\n${bank.instructions ? `Catatan: ${bank.instructions}` : ''}`;
                            console.log('✅ Bank info generated:', bankInfo);
                        } else {
                            console.log('❌ Bank transfer not enabled or missing');
                        }
                        
                        // Check for other payment methods
                        const methods = [];
                        if (bank && bank.enabled) methods.push('Transfer Bank');
                        if (data.paymentMethods.xendit && data.paymentMethods.xendit.enabled) {
                            methods.push('E-Wallet', 'Kartu Kredit');
                        }
                        if (methods.length > 0) {
                            paymentMethods = `\n💸 *METODE PEMBAYARAN TERSEDIA*\n${methods.map(m => `• ${m}`).join('\n')}`;
                            console.log('✅ Payment methods list generated:', paymentMethods);
                        }
                    } else {
                        console.log('❌ API response not successful or missing paymentMethods');
                    }
                } else {
                    console.log('❌ API request failed with status:', response.status);
                }
            } catch (error) {
                console.error('❌ Error fetching payment methods for WhatsApp message:', error);
            }
            
            // Always ensure bank info is available as fallback
            if (!bankInfo) {
                console.log('🔄 No bank info found, applying static fallback...');
                // Use hardcoded bank info from database as fallback
                bankInfo = `\n💳 *PEMBAYARAN BANK TRANSFER*\nBank: BCA\nNo. Rekening: 4800273949\nAtas Nama: Fairtel Mong\n`;
                paymentMethods = `\n💸 *METODE PEMBAYARAN TERSEDIA*\n• Transfer Bank\n• E-Wallet\n• Kartu Kredit`;
                console.log('✅ Static fallback bank info applied:', bankInfo);
            }
            
            // Format items list
            let itemsList = '';
            if (items.length > 0) {
                itemsList = items.map((item, index) => {
                    const qty = item.quantity || 0;
                    const price = item.unitPrice || 0;
                    const total = item.lineTotal || (qty * price);
                    return `${index + 1}. ${item.productName || 'Produk'}\n   ${qty}x @ Rp ${price.toLocaleString('id-ID')} = Rp ${total.toLocaleString('id-ID')}`;
                }).join('\n\n');
            }
            
            // Check for payment schedule
            let paymentSchedule = '';
            try {
                if (invoice.paymentSchedule && invoice.paymentSchedule.scheduleType === 'down_payment') {
                    const dp = invoice.paymentSchedule.downPayment;
                    const remaining = invoice.paymentSchedule.remainingBalance;
                    if (dp && remaining) {
                        paymentSchedule = `\n📅 *JADWAL PEMBAYARAN*\n• DP (${dp.percentage}%): Rp ${dp.amount.toLocaleString('id-ID')}\n• Pelunasan: Rp ${remaining.amount.toLocaleString('id-ID')}\n• Jatuh Tempo: ${dueDate || 'Sesuai kesepakatan'}`;
                    }
                }
            } catch (error) {
                console.log('No payment schedule found');
            }
            
            // Get notes
            let notes = '';
            try {
                if (invoice.notes && invoice.notes.publicNotes) {
                    notes = `\n📝 *CATATAN*\n${invoice.notes.publicNotes}`;
                }
            } catch (error) {
                console.log('No notes found');
            }
            
            // Create invoice URL
            const invoiceUrl = `${window.location.origin}/simple-invoice-view.html?id=${currentInvoiceData.invoice.header.invoiceNumber}`;
            
            // Debug final variables before creating message
            console.log('🔍 Final message variables:');
            console.log('  - bankInfo:', bankInfo);
            console.log('  - paymentMethods:', paymentMethods);
            console.log('  - paymentSchedule:', paymentSchedule);
            console.log('  - notes:', notes);
            
            // Format comprehensive WhatsApp message
            const message = `🧾 *FAKTUR #${invoiceNumber}*

*DARI:* ${businessName}
*KEPADA:* ${customerName}

👤 *MOHON KONFIRMASI DATA ANDA:*
📱 Telepon: ${customerPhone}
📍 Alamat: ${customerAddress}
${customerPhone || customerAddress ? '\n*Jika ada yang salah, silakan beritahu kami.*' : '\n*Silakan berikan no. telepon dan alamat lengkap Anda.*'}

🛒 *DETAIL PEMBELIAN:*${itemsList ? `\n${itemsList}` : '\nTidak ada detail item'}

💰 *RINGKASAN BIAYA:*
• Subtotal: Rp ${subtotal.toLocaleString('id-ID')}${discount > 0 ? `\n• Diskon: -Rp ${discount.toLocaleString('id-ID')}` : ''}${shippingCost > 0 ? `\n• Ongkos Kirim: Rp ${shippingCost.toLocaleString('id-ID')}` : ''}
• *TOTAL: Rp ${total.toLocaleString('id-ID')}*${paymentSchedule}${bankInfo}${paymentMethods}${notes}

📋 *LIHAT FAKTUR LENGKAP:*
${invoiceUrl}

Terima kasih! 🙏`;
            
            console.log('📱 Final WhatsApp message generated:');
            console.log(message);
            
            // Open WhatsApp with the message
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Update invoice status to 'sent' after successful WhatsApp share
            await updateInvoiceStatusToSent();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0).replace('IDR', 'Rp');
        }

        async function processWithAI(message) {
            try {
                // Get business profile data from localStorage
                let businessProfile = null;
                const savedProfile = localStorage.getItem('businessProfile');
                if (savedProfile) {
                    businessProfile = JSON.parse(savedProfile);
                }

                // STAGE 1: Call preview-only API endpoint
                const response = await fetch('/api/preview-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: message,
                        businessProfile: businessProfile
                    })
                });

                const result = await response.json();
                return result; // Return the result instead of adding chat messages
            } catch (error) {
                console.error('AI Processing Error:', error);
                throw error;
            }
        }

        function addMessage(message, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }


        function showSmartConfirmation(type, data) {
            const confirmationHTML = `
                <div class="smart-confirm">
                    <div class="confirm-header">
                        <span>🤔</span>
                        <div class="confirm-title">New ${type} detected</div>
                    </div>
                    <div>I found a new ${type}: "${data.name}". Should I add it to your database?</div>
                    <div class="confirm-actions">
                        <button class="action-btn primary" data-type="${type}" data-info='${JSON.stringify(data)}' onclick="confirmAddFromData(this)">✅ Yes, add</button>
                        <button class="action-btn" data-type="${type}" data-info='${JSON.stringify(data)}' onclick="editBeforeAddFromData(this)">✏️ Edit details</button>
                        <button class="action-btn" onclick="skipAdd('${type}')">❌ Skip</button>
                    </div>
                </div>
            `;
            addMessage(confirmationHTML, 'ai');
        }

        // Action handlers
        function viewInvoice(invoiceId) {
            window.open(`/merchant#invoice-${invoiceId}`, '_blank');
        }



        // Helper functions for data attribute approach
        function confirmAddFromData(button) {
            const type = button.getAttribute('data-type');
            const dataString = button.getAttribute('data-info');
            confirmAdd(type, dataString);
        }
        
        function editBeforeAddFromData(button) {
            const type = button.getAttribute('data-type');
            const dataString = button.getAttribute('data-info');
            editBeforeAdd(type, dataString);
        }

        async function confirmAdd(type, dataString) {
            try {
                const data = JSON.parse(dataString);
                
                const endpoint = type === 'customer' ? '/api/auto-learning/confirm-customer' : '/api/auto-learning/confirm-product';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        [type + 'Data']: data, 
                        action: 'add' 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addMessage(`✅ <strong>${type} added successfully!</strong><br>Name: ${data.name}<br>Future orders will recognize this ${type} automatically.`, 'ai');
                } else {
                    addMessage(`❌ <strong>Gagal menambah ${type}:</strong><br>${result.error}`, 'ai');
                }
            } catch (error) {
                console.error('Error confirming add:', error);
                addMessage(`❌ <strong>Error menambah ${type}.</strong><br>Silakan coba lagi.`, 'ai');
            }
        }

        function editBeforeAdd(type, dataString) {
            const data = JSON.parse(dataString);
            
            // Create a simple inline edit form
            const editFormHTML = `
                <div class="smart-confirm" style="margin-top: 16px;">
                    <div class="confirm-header">
                        <span>✏️</span>
                        <div class="confirm-title">Edit ${type} details</div>
                    </div>
                    <div style="margin: 12px 0;">
                        <form id="edit-${type}-form" onsubmit="submitEdit(event, '${type}')">
                            <div style="margin-bottom: 8px;">
                                <label style="display: block; font-weight: 600;">Name:</label>
                                <input type="text" name="name" value="${data.name}" required style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            ${type === 'customer' ? `
                                <div style="margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600;">Email:</label>
                                    <input type="email" name="email" value="${data.email || ''}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600;">Phone:</label>
                                    <input type="text" name="phone" value="${data.phone || ''}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600;">Address:</label>
                                    <textarea name="address" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; height: 60px;">${data.address || ''}</textarea>
                                </div>
                            ` : `
                                <div style="margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600;">Price:</label>
                                    <input type="number" name="unit_price" value="${data.unit_price || 0}" min="0" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600;">Category:</label>
                                    <input type="text" name="category" value="${data.category || ''}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600;">Description:</label>
                                    <textarea name="description" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; height: 60px;">${data.description || ''}</textarea>
                                </div>
                            `}
                            <div class="confirm-actions">
                                <button type="submit" class="action-btn primary">💾 Save</button>
                                <button type="button" class="action-btn" onclick="skipAdd('${type}')">❌ Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            addMessage(editFormHTML, 'ai');
        }

        async function submitEdit(event, type) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Add additional fields based on type
            if (type === 'product') {
                data.sku = data.name.replace(/[^a-zA-Z0-9]/g, '').toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
                data.stock_quantity = 0;
                data.min_stock_level = 5;
            }
            
            try {
                const endpoint = type === 'customer' ? '/api/auto-learning/edit-customer' : '/api/auto-learning/edit-product';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [type + 'Data']: data })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addMessage(`✅ <strong>${type} edited and added successfully!</strong><br>Name: ${data.name}<br>Your changes have been saved.`, 'ai');
                } else {
                    addMessage(`❌ <strong>Gagal mengedit ${type}:</strong><br>${result.error}`, 'ai');
                }
            } catch (error) {
                console.error('Error editing:', error);
                addMessage(`❌ <strong>Error mengedit ${type}.</strong><br>Silakan coba lagi.`, 'ai');
            }
        }

        async function skipAdd(type) {
            addMessage(`⏭️ <strong>Skipped adding ${type}.</strong><br>You can manually add it later if needed.`, 'ai');
        }

        async function openBusinessProfile() {
            // Get current business data from localStorage if available
            const savedProfile = localStorage.getItem('businessProfile');
            let currentData = {
                name: document.getElementById('business-name').textContent,
                email: document.getElementById('business-email').textContent,
                phone: document.getElementById('business-phone').textContent,
                address: document.getElementById('business-address').textContent,
                category: 'general',
                logo: document.getElementById('business-logo-img').src || '',
                taxRate: 0,
                termsAndConditions: '',
                website: '',
                taxId: '',
                taxName: 'PPN',
                taxDescription: '',
                hideBusinessName: false
            };
            
            if (savedProfile) {
                const savedData = JSON.parse(savedProfile);
                currentData = { ...currentData, ...savedData };
            }
            
            // Load complete business settings from database to ensure synchronization
            try {
                console.log('📥 Loading business settings for modal...');
                const businessResponse = await fetch('/api/business-settings');
                if (businessResponse.ok) {
                    const businessData = await businessResponse.json();
                    if (businessData.settings) {
                        // Merge database settings with current data, giving priority to database
                        currentData = { 
                            ...currentData, 
                            ...businessData.settings,
                            // Keep logo from current display if database doesn't have one
                            logo: businessData.settings.logoUrl || currentData.logo
                        };
                        console.log('✅ Business settings loaded for modal:', currentData);
                    }
                }
            } catch (error) {
                console.warn('⚠️  Could not load business settings for modal:', error);
            }

            // Create tabbed modal content
            const modalHTML = `
                <div class="business-profile-modal" id="business-profile-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: var(--card-background); border-radius: var(--border-radius-large); padding: 0; max-width: 700px; width: 90%; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-strong);">
                        
                        <!-- Modal Header -->
                        <div style="padding: 24px 32px; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--primary-purple); font-size: 24px; font-weight: 700; margin: 0;">Merchant Dashboard</h3>
                            <button onclick="closeBusinessProfile()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 4px;">×</button>
                        </div>

                        <!-- Tab Navigation -->
                        <div style="display: flex; border-bottom: 2px solid var(--border-color);">
                            <button id="business-info-tab" class="tab-button active" onclick="switchTab('business-info')" style="flex: 1; padding: 16px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--primary-purple); border-bottom: 3px solid var(--primary-purple); transition: var(--transition); font-size: 14px;">
                                🏢 Business Info
                            </button>
                            <button id="payment-methods-tab" class="tab-button" onclick="switchTab('payment-methods')" style="flex: 1; padding: 16px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: var(--transition); font-size: 14px;">
                                💳 Payment Methods
                            </button>
                            <button id="integration-tab" class="tab-button" onclick="switchTab('integration')" style="flex: 1; padding: 16px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: var(--transition); font-size: 14px;">
                                🔗 Integration
                            </button>
                        </div>

                        <!-- Tab Content Container -->
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <!-- Business Info Tab -->
                            <div id="business-info-content" class="tab-content" style="padding: 32px; display: block;">

                        <form id="business-profile-form" onsubmit="saveBusinessProfile(event)">
                            <!-- Logo Upload -->
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Business Logo</label>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div id="logo-preview" style="width: 80px; height: 80px; border: 2px dashed var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; background: var(--background); cursor: pointer;" onclick="document.getElementById('logo-upload').click()">
                                        ${currentData.logo ? `<img src="${currentData.logo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">` : '<div style="text-align: center; color: var(--text-secondary); font-size: 12px;">🏢<br>Logo</div>'}
                                    </div>
                                    <div>
                                        <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="previewLogo(event)">
                                        <button type="button" onclick="document.getElementById('logo-upload').click()" style="padding: 8px 16px; background: var(--primary-purple); color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-right: 8px;">Choose Logo</button>
                                        <button type="button" onclick="removeLogo()" style="padding: 8px 16px; background: transparent; color: var(--error); border: 2px solid var(--error); border-radius: 6px; font-size: 14px; cursor: pointer;">Remove</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Business Name -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Business Name *</label>
                                <input type="text" id="edit-business-name" value="${currentData.name}" required style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: var(--transition);">
                            </div>

                            <!-- Hide Business Name Toggle -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 16px; background: var(--background); border: 2px solid var(--border-color); border-radius: 8px; transition: var(--transition);">
                                    <input type="checkbox" id="edit-hide-business-name" ${currentData.hideBusinessName ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Hide Business Name in Invoices</div>
                                        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">Enable this if your logo already contains your business name to avoid duplication</div>
                                    </div>
                                </label>
                            </div>

                            <!-- Email -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Email Address *</label>
                                <input type="email" id="edit-business-email" value="${currentData.email}" required style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: var(--transition);">
                            </div>

                            <!-- Phone -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Phone Number *</label>
                                <input type="tel" id="edit-business-phone" value="${currentData.phone}" required style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: var(--transition);">
                            </div>

                            <!-- Address -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Business Address *</label>
                                <textarea id="edit-business-address" required style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; min-height: 80px; resize: vertical; transition: var(--transition);">${currentData.address}</textarea>
                            </div>

                            <!-- Business Category -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Business Category *</label>
                                <select id="edit-business-category" required style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: var(--transition); cursor: pointer;">
                                    <option value="">Pilih kategori bisnis Anda...</option>
                                    <option value="general" ${(currentData.category || 'general') === 'general' ? 'selected' : ''}>Bisnis Umum</option>
                                    <option value="trade" ${currentData.category === 'trade' ? 'selected' : ''}>Perdagangan (Retail & Grosir)</option>
                                    <option value="services" ${currentData.category === 'services' ? 'selected' : ''}>Jasa</option>
                                    <option value="manufacturing" ${currentData.category === 'manufacturing' ? 'selected' : ''}>Manufaktur & Pengolahan</option>
                                    <option value="logistics" ${currentData.category === 'logistics' ? 'selected' : ''}>Logistik & Transportasi</option>
                                    <option value="digital_creative" ${currentData.category === 'digital_creative' ? 'selected' : ''}>Produk Digital & Kreatif</option>
                                    <option value="agriculture" ${currentData.category === 'agriculture' ? 'selected' : ''}>Pertanian & Agro-industri</option>
                                    <option value="construction" ${currentData.category === 'construction' ? 'selected' : ''}>Konstruksi & Properti</option>
                                    <option value="tourism" ${currentData.category === 'tourism' ? 'selected' : ''}>Pariwisata & Perhotelan</option>
                                </select>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Kategori ini akan menentukan format dan terminologi faktur yang sesuai dengan industri Anda</div>
                            </div>

                            <!-- Tax Rate -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Default Tax Rate (%)</label>
                                <input type="number" id="edit-tax-rate" value="${currentData.taxRate || 0}" min="0" max="100" step="0.1" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; transition: var(--transition);" placeholder="e.g., 11 for 11% PPN">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Set to 0 if no tax should be applied by default</div>
                            </div>


                            <!-- Syarat dan Ketentuan -->
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Syarat dan Ketentuan</label>
                                <textarea id="edit-terms-conditions" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px; min-height: 80px; resize: vertical; transition: var(--transition);" placeholder="Syarat pembayaran, ketentuan pengiriman, garansi, dll.">${currentData.termsAndConditions || ''}</textarea>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Syarat dan ketentuan ini akan muncul di semua faktur</div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" onclick="closeBusinessProfile()" style="padding: 12px 24px; background: transparent; color: var(--text-secondary); border: 2px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition);">
                                    Cancel
                                </button>
                                <button type="submit" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); box-shadow: var(--shadow-soft);">
                                    💾 Save Changes
                                </button>
                            </div>
                        </form>
                            </div>

                            <!-- Payment Methods Tab -->
                            <div id="payment-methods-content" class="tab-content" style="padding: 32px; display: none;">
                                <h4 style="color: var(--primary-purple); margin-bottom: 16px; font-size: 18px; font-weight: 600;">💳 Payment Methods</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">Configure which payment methods you accept. These will appear on your invoices.</p>
                                
                                <!-- Payment Methods Configuration -->
                                <div style="margin-bottom: 24px;">
                                    <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">Accepted Payment Methods</label>
                                    
                                    <!-- Bank Transfer -->
                                    <div style="margin-bottom: 16px; padding: 16px; background: var(--background); border-radius: 12px; border: 1px solid var(--border-color);">
                                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                            <input type="checkbox" id="payment-bank-transfer" ${currentData.paymentMethods?.bankTransfer?.enabled ? 'checked' : ''} style="margin-right: 12px; transform: scale(1.2);">
                                            <label for="payment-bank-transfer" style="font-weight: 600; color: var(--text-primary);">🏦 Transfer Bank</label>
                                        </div>
                                        <div id="bank-transfer-details" style="margin-left: 28px;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Nama Bank</label>
                                                <input type="text" id="bank-name" value="${currentData.paymentMethods?.bankTransfer?.bankName || ''}" placeholder="contoh: BCA, Mandiri, BNI" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Nomor Rekening</label>
                                                <input type="text" id="bank-account" value="${currentData.paymentMethods?.bankTransfer?.accountNumber || ''}" placeholder="1234567890" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Atas Nama</label>
                                                <input type="text" id="bank-account-name" value="${currentData.paymentMethods?.bankTransfer?.accountName || ''}" placeholder="Nama pemilik rekening" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- QRIS -->
                                    <div style="margin-bottom: 16px; padding: 16px; background: var(--background); border-radius: 12px; border: 1px solid var(--border-color);">
                                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                            <input type="checkbox" id="payment-qris" ${currentData.paymentMethods?.qris?.enabled ? 'checked' : ''} onchange="togglePaymentDetails('qris')" style="margin-right: 12px; transform: scale(1.2);">
                                            <label for="payment-qris" style="font-weight: 600; color: var(--text-primary);">📱 QRIS</label>
                                        </div>
                                        <div id="qris-details" style="margin-left: 28px; display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">QRIS Code Image</label>
                                                <input type="file" id="qris-image" accept="image/*" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cash -->
                                    <div style="margin-bottom: 16px; padding: 16px; background: var(--background); border-radius: 12px; border: 1px solid var(--border-color);">
                                        <div style="display: flex; align-items: center;">
                                            <input type="checkbox" id="payment-cash" ${currentData.paymentMethods?.cash?.enabled ? 'checked' : ''} style="margin-right: 12px; transform: scale(1.2);">
                                            <label for="payment-cash" style="font-weight: 600; color: var(--text-primary);">💵 Tunai</label>
                                        </div>
                                    </div>

                                    <!-- E-Wallet -->
                                    <div style="margin-bottom: 16px; padding: 16px; background: var(--background); border-radius: 12px; border: 1px solid var(--border-color);">
                                        <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                            <input type="checkbox" id="payment-ewallet" ${currentData.paymentMethods?.ewallet?.enabled ? 'checked' : ''} onchange="togglePaymentDetails('ewallet')" style="margin-right: 12px; transform: scale(1.2);">
                                            <label for="payment-ewallet" style="font-weight: 600; color: var(--text-primary);">📲 E-Wallet</label>
                                        </div>
                                        <div id="ewallet-details" style="margin-left: 28px; display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Jenis E-Wallet</label>
                                                <input type="text" id="ewallet-types" value="${currentData.paymentMethods?.ewallet?.types || ''}" placeholder="contoh: GoPay, OVO, DANA, ShopeePay" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Nomor E-Wallet</label>
                                                <input type="text" id="ewallet-number" value="${currentData.paymentMethods?.ewallet?.number || ''}" placeholder="08123456789" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Save Button -->
                                <div style="text-align: center; margin-top: 32px;">
                                    <button onclick="savePaymentMethods()" style="background: var(--gradient-primary); color: white; border: none; padding: 16px 32px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: var(--shadow-soft); transition: var(--transition);">
                                        💾 Save Payment Methods
                                    </button>
                                </div>
                            </div>

                            <!-- Integration Tab -->
                            <div id="integration-content" class="tab-content" style="padding: 32px; display: none;">
                                <h4 style="color: var(--primary-purple); margin-bottom: 16px; font-size: 18px; font-weight: 600;">📧 Email Configuration</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 24px; font-size: 14px;">Configure email settings to automatically send invoices to customers.</p>
                                
                                <!-- Email Provider Selection -->
                                <div style="margin-bottom: 24px; padding: 20px; background: var(--background); border-radius: 12px; border: 1px solid var(--border-color);">
                                    <h5 style="color: var(--text-primary); margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">🎯 Quick Setup Wizard</h5>
                                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">Choose your email provider for automatic configuration:</p>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                        <button type="button" class="provider-btn" data-provider="gmail" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
                                            <span style="font-size: 18px;">📧</span>
                                            <span>Gmail</span>
                                        </button>
                                        <button type="button" class="provider-btn" data-provider="outlook" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
                                            <span style="font-size: 18px;">🔷</span>
                                            <span>Outlook</span>
                                        </button>
                                        <button type="button" class="provider-btn" data-provider="yahoo" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
                                            <span style="font-size: 18px;">🟣</span>
                                            <span>Yahoo</span>
                                        </button>
                                        <button type="button" class="provider-btn" data-provider="custom" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; background: white; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
                                            <span style="font-size: 18px;">⚙️</span>
                                            <span>Custom</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Setup Instructions -->
                                    <div id="setup-instructions" style="display: none; padding: 16px; background: var(--card-background); border-radius: 8px; border-left: 4px solid var(--primary-purple); margin-bottom: 16px;">
                                        <div id="instruction-content"></div>
                                    </div>
                                    
                                    <!-- Quick Setup Button -->
                                    <button type="button" id="quick-setup-btn" style="display: none; width: 100%; padding: 12px; background: var(--primary-purple); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 12px;">
                                        ⚡ Apply Quick Setup
                                    </button>
                                </div>
                                
                                <form id="integration-form" onsubmit="saveIntegrationSettings(event)">
                                    <!-- Email Enable/Disable -->
                                    <div style="margin-bottom: 20px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="checkbox" id="email-enabled" ${currentData.emailConfig?.enabled ? 'checked' : ''} style="margin-right: 12px; transform: scale(1.2);">
                                            <span style="font-weight: 600; color: var(--text-primary);">Enable Email Notifications</span>
                                        </label>
                                        <p style="color: var(--text-secondary); margin: 8px 0 0 28px; font-size: 13px;">Automatically send invoices and payment confirmations to customers</p>
                                    </div>

                                    <!-- SMTP Settings -->
                                    <div id="smtp-settings" style="opacity: ${currentData.emailConfig?.enabled ? '1' : '0.5'}; pointer-events: ${currentData.emailConfig?.enabled ? 'auto' : 'none'};">
                                        <!-- SMTP Host -->
                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">SMTP Host *</label>
                                            <input type="text" id="smtp-host" value="${currentData.emailConfig?.smtpHost || 'smtp.gmail.com'}" placeholder="smtp.gmail.com" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px;">
                                            <small style="color: var(--text-secondary); font-size: 12px;">Common: Gmail (smtp.gmail.com), Outlook (smtp-mail.outlook.com)</small>
                                        </div>

                                        <!-- SMTP Port -->
                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">SMTP Port *</label>
                                            <input type="number" id="smtp-port" value="${currentData.emailConfig?.smtpPort || '587'}" placeholder="587" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px;">
                                            <small style="color: var(--text-secondary); font-size: 12px;">Common: 587 (TLS), 465 (SSL), 25 (unsecured)</small>
                                        </div>

                                        <!-- Email & Password -->
                                        <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                                            <div style="flex: 1;">
                                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Email Address *</label>
                                                <input type="email" id="smtp-email" value="${currentData.emailConfig?.smtpEmail || ''}" placeholder="your.email@gmail.com" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px;">
                                            </div>
                                            <div style="flex: 1;">
                                                <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">App Password *</label>
                                                <input type="password" id="smtp-password" value="${currentData.emailConfig?.smtpPassword || ''}" placeholder="App-specific password" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px;">
                                            </div>
                                        </div>

                                        <!-- Security Options -->
                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">Security</label>
                                            <div style="display: flex; gap: 20px;">
                                                <label style="display: flex; align-items: center; cursor: pointer;">
                                                    <input type="radio" name="smtp-security" value="tls" ${(!currentData.emailConfig?.smtpSecurity || currentData.emailConfig?.smtpSecurity === 'tls') ? 'checked' : ''} style="margin-right: 8px;">
                                                    <span>TLS (Recommended)</span>
                                                </label>
                                                <label style="display: flex; align-items: center; cursor: pointer;">
                                                    <input type="radio" name="smtp-security" value="ssl" ${currentData.emailConfig?.smtpSecurity === 'ssl' ? 'checked' : ''} style="margin-right: 8px;">
                                                    <span>SSL</span>
                                                </label>
                                                <label style="display: flex; align-items: center; cursor: pointer;">
                                                    <input type="radio" name="smtp-security" value="none" ${currentData.emailConfig?.smtpSecurity === 'none' ? 'checked' : ''} style="margin-right: 8px;">
                                                    <span>None</span>
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Email Templates -->
                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">From Name</label>
                                            <input type="text" id="email-from-name" value="${currentData.emailConfig?.fromName || currentData.name || ''}" placeholder="Your Business Name" style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 15px;">
                                            <small style="color: var(--text-secondary); font-size: 12px;">This appears as the sender name in emails</small>
                                        </div>

                                        <!-- Test Connection -->
                                        <div style="margin-bottom: 24px; padding: 16px; background: var(--background); border-radius: 8px; border: 1px solid var(--border-color);">
                                            <h5 style="margin: 0 0 8px 0; color: var(--text-primary);">🧪 Test Email Configuration</h5>
                                            <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 13px;">Send a test email to verify your SMTP settings work correctly.</p>
                                            <div style="display: flex; gap: 12px; align-items: center;">
                                                <input type="email" id="test-email" placeholder="test@example.com" style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                                <button type="button" id="test-email-btn" style="padding: 8px 16px; background: var(--info); color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                                    📤 Send Test
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <button type="button" onclick="closeBusinessProfile()" style="padding: 12px 24px; background: transparent; color: var(--text-secondary); border: 2px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer;">
                                            Cancel
                                        </button>
                                        <button type="submit" style="padding: 12px 24px; background: var(--gradient-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: var(--shadow-soft);">
                                            💾 Save Integration
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeBusinessProfile() {
            const modal = document.getElementById('business-profile-modal');
            if (modal) {
                modal.remove();
            }
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoPreview = document.getElementById('logo-preview');
                    logoPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function removeLogo() {
            try {
                // Clear the preview immediately
                const logoPreview = document.getElementById('logo-preview');
                logoPreview.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 12px;">🏢<br>Logo</div>';
                document.getElementById('logo-upload').value = '';
                
                // Remove logo from database via API
                const response = await fetch('/api/remove-business-logo', {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Logo removed from database successfully');
                    
                    // Update business logo display on main page
                    const businessLogoImg = document.getElementById('business-logo-img');
                    const logoPlaceholder = document.getElementById('logo-placeholder');
                    
                    if (businessLogoImg) businessLogoImg.style.display = 'none';
                    if (logoPlaceholder) logoPlaceholder.style.display = 'block';
                    
                    // Update localStorage
                    const savedProfile = localStorage.getItem('businessProfile');
                    if (savedProfile) {
                        const profile = JSON.parse(savedProfile);
                        profile.logo = '';
                        profile.logoUrl = '';
                        localStorage.setItem('businessProfile', JSON.stringify(profile));
                    }
                } else {
                    console.error('❌ Failed to remove logo from database:', result.error);
                }
                
            } catch (error) {
                console.error('❌ Error removing logo:', error);
            }
        }

        async function saveBusinessProfile(event) {
            event.preventDefault();
            
            try {
                // Show loading state
                alert('⏳ Saving business profile...');
                
                // Get form data
                const name = document.getElementById('edit-business-name').value;
                const email = document.getElementById('edit-business-email').value;
                const phone = document.getElementById('edit-business-phone').value;
                const address = document.getElementById('edit-business-address').value;
                const category = document.getElementById('edit-business-category').value;
                const taxRate = parseFloat(document.getElementById('edit-tax-rate').value) || 0;
                const termsAndConditions = document.getElementById('edit-terms-conditions').value;
                const hideBusinessName = document.getElementById('edit-hide-business-name').checked;
                
                let logoUrl = document.getElementById('business-logo-img').src || '';
                
                // Handle logo upload to Cloudinary
                const logoFile = document.getElementById('logo-upload').files[0];
                if (logoFile) {
                    console.log('📤 Uploading logo to Cloudinary...');
                    
                    const formData = new FormData();
                    formData.append('logo', logoFile);
                    
                    const logoResponse = await fetch('/api/upload-business-logo', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const logoResult = await logoResponse.json();
                    
                    if (logoResult.success) {
                        logoUrl = logoResult.logoUrl;
                        console.log('✅ Logo uploaded successfully:', logoUrl);
                    } else {
                        throw new Error('Failed to upload logo: ' + logoResult.error);
                    }
                }

                // First, get existing business settings to avoid overwriting other fields
                console.log('📥 Getting existing business settings to merge...');
                let existingSettings = {};
                try {
                    const existingResponse = await fetch('/api/business-settings');
                    if (existingResponse.ok) {
                        const existingData = await existingResponse.json();
                        existingSettings = existingData.settings || {};
                        console.log('✅ Existing settings loaded:', existingSettings);
                    }
                } catch (error) {
                    console.warn('⚠️  Could not load existing settings, proceeding with new data only:', error);
                }

                // Save business settings to database - MERGE with existing settings to avoid data loss
                const businessSettings = {
                    // Preserve existing fields that are not in the modal
                    ...existingSettings,
                    
                    // Update only the fields that are in the modal form
                    name,
                    email,
                    phone,
                    address,
                    category,
                    taxRate,
                    taxEnabled: taxRate > 0,
                    taxName: existingSettings.taxName || 'PPN',
                    taxDescription: existingSettings.taxDescription || `${taxRate}% PPN`,
                    termsAndConditions,
                    hideBusinessName,
                    logoUrl: logoUrl,
                    
                    // Preserve important fields that modal doesn't handle
                    website: existingSettings.website || '',
                    taxId: existingSettings.taxId || ''
                };
                
                console.log('💾 Saving merged business settings:', businessSettings);

                const response = await fetch('/api/business-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(businessSettings)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save business settings');
                }

                // Update localStorage for backward compatibility
                const businessData = {
                    name,
                    email,
                    phone,
                    address,
                    category,
                    taxRate,
                    termsAndConditions,
                    hideBusinessName,
                    logo: logoUrl || ''
                };
                
                localStorage.setItem('businessProfile', JSON.stringify(businessData));

                // Update UI immediately
                document.getElementById('business-name').textContent = name;
                document.getElementById('business-email').textContent = email;
                document.getElementById('business-phone').textContent = phone;
                document.getElementById('business-address').textContent = address;
                
                // Update business category display
                const categoryNames = {
                    'general': 'Bisnis Umum',
                    'trade': 'Perdagangan (Retail & Grosir)',
                    'services': 'Jasa',
                    'manufacturing': 'Manufaktur & Pengolahan',
                    'logistics': 'Logistik & Transportasi',
                    'digital_creative': 'Produk Digital & Kreatif',
                    'agriculture': 'Pertanian & Agro-industri',
                    'construction': 'Konstruksi & Properti',
                    'tourism': 'Pariwisata & Perhotelan'
                };
                document.getElementById('business-category').textContent = categoryNames[category] || 'Bisnis Umum';

                // Update logo display
                const logoImg = document.getElementById('business-logo-img');
                const logoPlaceholder = document.getElementById('logo-placeholder');
                
                if (logoUrl) {
                    logoImg.src = logoUrl;
                    logoImg.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
                } else {
                    logoImg.style.display = 'none';
                    logoPlaceholder.style.display = 'block';
                }

                // Close modal
                closeBusinessProfile();

                // Show success message
                alert('✅ Business profile updated successfully!');

            } catch (error) {
                console.error('Error saving business profile:', error);
                alert('❌ Error saving business profile: ' + error.message);
            }
        }

        function convertFileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(amount).replace('IDR', 'Rp');
        }

        // Load saved business data
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('businessProfile');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('business-name').textContent = data.name || 'Toko Gadget Teknologi';
                document.getElementById('business-email').textContent = data.email || 'billing@tokogadget.co.id';
                document.getElementById('business-phone').textContent = data.phone || '+62 21 1234 5678';
                document.getElementById('business-address').textContent = data.address || 'Jl. Teknologi No. 123, Jakarta Selatan';
                
                // Update business category display
                const categoryNames = {
                    'general': 'Bisnis Umum',
                    'trade': 'Perdagangan (Retail & Grosir)',
                    'services': 'Jasa',
                    'manufacturing': 'Manufaktur & Pengolahan',
                    'logistics': 'Logistik & Transportasi',
                    'digital_creative': 'Produk Digital & Kreatif',
                    'agriculture': 'Pertanian & Agro-industri',
                    'construction': 'Konstruksi & Properti',
                    'tourism': 'Pariwisata & Perhotelan'
                };
                document.getElementById('business-category').textContent = categoryNames[data.category] || 'Bisnis Umum';
                
                // Load logo if exists
                if (data.logo) {
                    const logoImg = document.getElementById('business-logo-img');
                    const logoPlaceholder = document.getElementById('logo-placeholder');
                    logoImg.src = data.logo;
                    logoImg.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
                }
            }
        });

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.style.color = 'var(--text-secondary)';
                tab.style.borderBottom = '3px solid transparent';
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById(tabName + '-content');
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
            
            // Add active class to selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.style.color = 'var(--primary-purple)';
                selectedTab.style.borderBottom = '3px solid var(--primary-purple)';
            }
        }

        // Test email connection function
        // Update Business Profile Display
        function updateBusinessProfileDisplay() {
            const savedData = localStorage.getItem('businessProfile');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // Update business info display
                if (data.name) document.getElementById('business-name').textContent = data.name;
                if (data.email) document.getElementById('business-email').textContent = data.email;
                if (data.phone) document.getElementById('business-phone').textContent = data.phone;
                if (data.address) document.getElementById('business-address').textContent = data.address;
                
                // Update logo if exists
                if (data.logo) {
                    const logoImg = document.getElementById('business-logo-img');
                    const logoPlaceholder = document.getElementById('logo-placeholder');
                    if (logoImg && logoPlaceholder) {
                        logoImg.src = data.logo;
                        logoImg.style.display = 'block';
                        logoPlaceholder.style.display = 'none';
                    }
                }
            }
        }

        // Save Integration Settings (Email Configuration)
        async function saveIntegrationSettings(event) {
            event.preventDefault();
            
            try {
                // Get integration form data
                const emailEnabled = document.getElementById('email-enabled').checked;
                const smtpHost = document.getElementById('smtp-host').value;
                const smtpPort = document.getElementById('smtp-port').value;
                const smtpEmail = document.getElementById('smtp-email').value;
                const smtpPassword = document.getElementById('smtp-password').value;
                const smtpSecurity = document.querySelector('input[name="smtp-security"]:checked').value;
                const fromName = document.getElementById('email-from-name').value;
                
                // Get existing business profile
                let businessProfile = {};
                const saved = localStorage.getItem('businessProfile');
                if (saved) {
                    businessProfile = JSON.parse(saved);
                }
                
                // Update email configuration
                businessProfile.emailConfig = {
                    enabled: emailEnabled,
                    smtpHost: smtpHost,
                    smtpPort: parseInt(smtpPort),
                    smtpEmail: smtpEmail,
                    smtpPassword: smtpPassword,
                    smtpSecurity: smtpSecurity,
                    fromName: fromName
                };
                
                // Save to localStorage
                localStorage.setItem('businessProfile', JSON.stringify(businessProfile));
                
                // Update the business profile display
                updateBusinessProfileDisplay();
                
                // Close modal
                closeBusinessProfile();
                
                // Show success message
                alert('✅ Integration settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving integration settings:', error);
                alert('❌ Error menyimpan pengaturan integrasi. Silakan coba lagi.');
            }
        }

        // Save Payment Methods
        async function savePaymentMethods() {
            try {
                // Get payment methods data
                const paymentMethods = {
                    bankTransfer: {
                        enabled: document.getElementById('payment-bank-transfer').checked,
                        bankName: document.getElementById('bank-name').value,
                        accountNumber: document.getElementById('bank-account').value,
                        accountName: document.getElementById('bank-account-name').value
                    },
                    qris: {
                        enabled: document.getElementById('payment-qris').checked,
                        qrisImage: document.getElementById('qris-image').files[0] ? await convertFileToDataURL(document.getElementById('qris-image').files[0]) : null
                    },
                    cash: {
                        enabled: document.getElementById('payment-cash').checked
                    },
                    ewallet: {
                        enabled: document.getElementById('payment-ewallet').checked,
                        types: document.getElementById('ewallet-types').value,
                        number: document.getElementById('ewallet-number').value
                    }
                };

                // Get existing business profile
                let businessProfile = {};
                const saved = localStorage.getItem('businessProfile');
                if (saved) {
                    businessProfile = JSON.parse(saved);
                }
                
                // Update payment methods configuration
                businessProfile.paymentMethods = paymentMethods;
                
                // Save to localStorage
                localStorage.setItem('businessProfile', JSON.stringify(businessProfile));
                
                // Update the business profile display
                updateBusinessProfileDisplay();
                
                // Close modal
                closeBusinessProfile();
                
                // Show success message
                alert('✅ Payment methods saved successfully!');
                
            } catch (error) {
                console.error('Error saving payment methods:', error);
                alert('❌ Error menyimpan metode pembayaran. Silakan coba lagi.');
            }
        }

        // Toggle payment method details visibility
        function togglePaymentDetails(paymentType) {
            const checkbox = document.getElementById(`payment-${paymentType}`);
            const details = document.getElementById(`${paymentType}-details`);
            
            if (checkbox && details) {
                details.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        // Email provider configurations
        const emailProviderConfigs = {
            gmail: {
                name: 'Gmail',
                smtpHost: 'smtp.gmail.com',
                smtpPort: 587,
                smtpSecurity: 'tls',
                instructions: `
                    <h6 style="color: var(--primary-purple); margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">📧 Gmail Setup Instructions</h6>
                    <ol style="margin: 0; padding-left: 20px; color: var(--text-primary); line-height: 1.6;">
                        <li><strong>Enable 2-Factor Authentication:</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Go to Google Account → Security → 2-Step Verification → Turn on</span>
                        </li>
                        <li style="margin-top: 12px;"><strong>Generate App Password:</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Google Account → Security → App passwords → Mail → Other (Aspree Invoice Generator)</span>
                        </li>
                        <li style="margin-top: 12px;"><strong>Copy the 16-character password</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Example: abcd efgh ijkl mnop</span>
                        </li>
                    </ol>
                    <p style="margin: 16px 0 0 0; padding: 12px; background: #fff3cd; border-radius: 6px; color: #856404; font-size: 13px;">
                        ⚠️ <strong>Important:</strong> Use the app password, not your regular Gmail password!
                    </p>
                `
            },
            outlook: {
                name: 'Outlook/Hotmail',
                smtpHost: 'smtp-mail.outlook.com',
                smtpPort: 587,
                smtpSecurity: 'tls',
                instructions: `
                    <h6 style="color: var(--primary-purple); margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">🔷 Outlook Setup Instructions</h6>
                    <ol style="margin: 0; padding-left: 20px; color: var(--text-primary); line-height: 1.6;">
                        <li><strong>Sign in to Microsoft Account:</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Go to account.microsoft.com</span>
                        </li>
                        <li style="margin-top: 12px;"><strong>Enable App Passwords:</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Security → Advanced security options → App passwords</span>
                        </li>
                        <li style="margin-top: 12px;"><strong>Create new app password for Mail</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Select "Mail" and copy the generated password</span>
                        </li>
                    </ol>
                `
            },
            yahoo: {
                name: 'Yahoo Mail',
                smtpHost: 'smtp.mail.yahoo.com',
                smtpPort: 587,
                smtpSecurity: 'tls',
                instructions: `
                    <h6 style="color: var(--primary-purple); margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">🟣 Yahoo Mail Setup Instructions</h6>
                    <ol style="margin: 0; padding-left: 20px; color: var(--text-primary); line-height: 1.6;">
                        <li><strong>Sign in to Yahoo Account:</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Go to Yahoo Account Info</span>
                        </li>
                        <li style="margin-top: 12px;"><strong>Generate App Password:</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Account Security → Generate app password → Select "Mail"</span>
                        </li>
                        <li style="margin-top: 12px;"><strong>Copy the password</strong>
                            <br><span style="color: var(--text-secondary); font-size: 13px;">Use this password instead of your Yahoo password</span>
                        </li>
                    </ol>
                `
            },
            custom: {
                name: 'Custom/Business Email',
                smtpHost: '',
                smtpPort: 587,
                smtpSecurity: 'tls',
                instructions: `
                    <h6 style="color: var(--primary-purple); margin: 0 0 12px 0; font-size: 15px; font-weight: 600;">⚙️ Custom Email Setup</h6>
                    <p style="margin: 0 0 12px 0; color: var(--text-primary); line-height: 1.6;">
                        For business or custom domain emails, you'll need to get SMTP settings from:
                    </p>
                    <ul style="margin: 0; padding-left: 20px; color: var(--text-primary); line-height: 1.6;">
                        <li>Your hosting provider (cPanel, Plesk, etc.)</li>
                        <li style="margin-top: 8px;">Your IT administrator</li>
                        <li style="margin-top: 8px;">Email service documentation</li>
                    </ul>
                    <p style="margin: 16px 0 0 0; padding: 12px; background: #d1ecf1; border-radius: 6px; color: #0c5460; font-size: 13px;">
                        💡 <strong>Common settings:</strong> Port 587 (TLS) or 465 (SSL), server like mail.yourdomain.com
                    </p>
                `
            }
        };

        let selectedProvider = null;

        function selectEmailProvider(provider) {
            selectedProvider = provider;
            
            // Update button styles
            document.querySelectorAll('.provider-btn').forEach(btn => {
                btn.style.borderColor = 'var(--border-color)';
                btn.style.background = 'white';
            });
            
            const selectedBtn = document.querySelector(`[data-provider="${provider}"]`);
            selectedBtn.style.borderColor = 'var(--primary-purple)';
            selectedBtn.style.background = 'var(--background)';
            
            // Show instructions
            const instructionsDiv = document.getElementById('setup-instructions');
            const contentDiv = document.getElementById('instruction-content');
            const quickSetupBtn = document.getElementById('quick-setup-btn');
            
            contentDiv.innerHTML = emailProviderConfigs[provider].instructions;
            instructionsDiv.style.display = 'block';
            quickSetupBtn.style.display = 'block';
        }

        function applyQuickSetup() {
            if (!selectedProvider) return;
            
            const config = emailProviderConfigs[selectedProvider];
            
            // Fill in the SMTP settings
            document.getElementById('smtp-host').value = config.smtpHost;
            document.getElementById('smtp-port').value = config.smtpPort;
            
            // Select the correct security option
            const securityRadio = document.querySelector(`input[name="smtp-security"][value="${config.smtpSecurity}"]`);
            if (securityRadio) {
                securityRadio.checked = true;
            }
            
            // Enable email notifications
            const emailEnabledCheckbox = document.getElementById('email-enabled');
            emailEnabledCheckbox.checked = true;
            
            // Trigger the change event to enable SMTP settings
            emailEnabledCheckbox.dispatchEvent(new Event('change'));
            
            // Show success message
            alert(`✅ ${config.name} settings applied! Now just enter your email and app password below.`);
            
            // Focus on email field
            document.getElementById('smtp-email').focus();
        }

        function testEmailConnection() {
            const smtpHost = document.getElementById('smtp-host')?.value || document.getElementById('edit-smtp-host')?.value;
            const smtpPort = document.getElementById('smtp-port')?.value || document.getElementById('edit-smtp-port')?.value;
            const smtpUser = document.getElementById('smtp-email')?.value || document.getElementById('edit-smtp-user')?.value;
            const smtpPass = document.getElementById('smtp-password')?.value || document.getElementById('edit-smtp-pass')?.value;
            
            if (!smtpHost || !smtpPort || !smtpUser || !smtpPass) {
                alert('Please fill in all SMTP settings before testing');
                return;
            }
            
            // Here you would make an API call to test the email connection
            alert('Email connection test would be implemented here. For now, settings look valid!');
        }

        // Fix onclick handlers for CSP compliance
        // Load business data from API and sync with display
        async function loadBusinessDataFromAPI() {
            try {
                console.log('🏢 Loading business data from API...');
                const response = await fetch('/api/business-settings');
                const settings = await response.json();
                
                if (settings) {
                    // Update display elements on main page
                    const businessName = document.getElementById('business-name');
                    const businessEmail = document.getElementById('business-email');
                    const businessPhone = document.getElementById('business-phone');
                    const businessAddress = document.getElementById('business-address');
                    const businessLogoImg = document.getElementById('business-logo-img');
                    const logoPlaceholder = document.getElementById('logo-placeholder');
                    
                    if (businessName) businessName.textContent = settings.name || 'Your Business Name';
                    if (businessEmail) businessEmail.textContent = settings.email || 'business@example.com';
                    if (businessPhone) businessPhone.textContent = settings.phone || '+62 21 1234 5678';
                    if (businessAddress) businessAddress.textContent = settings.address || 'Your Business Address';
                    
                    // Update business logo display
                    if (businessLogoImg && logoPlaceholder) {
                        if (settings.logoUrl) {
                            businessLogoImg.src = settings.logoUrl;
                            businessLogoImg.style.display = 'block';
                            logoPlaceholder.style.display = 'none';
                        } else {
                            businessLogoImg.style.display = 'none';
                            logoPlaceholder.style.display = 'block';
                        }
                    }
                    
                    // Create business profile object for localStorage (used by invoice generation)
                    const businessProfile = {
                        name: settings.name || 'Your Business Name',
                        email: settings.email || 'business@example.com',
                        phone: settings.phone || '+62 21 1234 5678',
                        address: settings.address || 'Your Business Address',
                        website: settings.website || '',
                        taxId: settings.taxId || '',
                        taxRate: settings.taxRate || 0,
                        taxEnabled: settings.taxEnabled || false,
                        taxName: settings.taxName || 'PPN',
                        taxDescription: settings.taxDescription || '',
                        logo: settings.logoUrl || '',  // Add logo field that template looks for
                        logoUrl: settings.logoUrl || null,
                        category: settings.category || 'general',
                        termsAndConditions: settings.termsAndConditions || 'Pembayaran dalam 30 hari',
                        hideBusinessName: settings.hideBusinessName || false  // Add hide business name setting
                    };
                    
                    // Update localStorage for invoice generation
                    localStorage.setItem('businessProfile', JSON.stringify(businessProfile));
                    
                    console.log('✅ Business data loaded and synced:', businessProfile);
                } else {
                    console.log('⚠️ No business settings found, using defaults');
                }
            } catch (error) {
                console.error('❌ Error loading business data:', error);
                // Keep existing hardcoded values as fallback
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Load business data from server on page load
            loadBusinessDataFromAPI();
            
            // Listen for business data updates from other tabs/windows
            try {
                const channel = new BroadcastChannel('business-settings-updates');
                channel.addEventListener('message', function(event) {
                    if (event.data.type === 'business-data-updated') {
                        console.log('🔄 Received business data update from another tab');
                        loadBusinessDataFromAPI();
                    }
                });
                
                // Clean up on page unload
                window.addEventListener('beforeunload', () => {
                    channel.close();
                });
            } catch (error) {
                console.log('BroadcastChannel not supported, cross-tab updates disabled');
            }
            
            // Handle URL parameters for editing existing invoices
            const urlParams = new URLSearchParams(window.location.search);
            const editInvoiceId = urlParams.get('edit');
            const editDescription = urlParams.get('desc');
            
            if (editInvoiceId && editDescription) {
                // Pre-fill the invoice description for editing
                const textarea = document.getElementById('invoice-description');
                if (textarea) {
                    textarea.value = decodeURIComponent(editDescription);
                    
                    // Set the currentInvoiceDbId so updates work correctly
                    currentInvoiceDbId = parseInt(editInvoiceId);
                    
                    // Update button states
                    updateButtonStates();
                    
                    console.log('📝 Invoice loaded for editing:', editInvoiceId);
                    console.log('📝 Current DB ID set to:', currentInvoiceDbId);
                    
                    // Show a message to the user
                    showAlert('📝 Invoice loaded for editing. Make your changes and click "Generate Final Invoice" to update.', 'info', 5000);
                }
            }
            
            // Fix business profile buttons
            const profileButtons = document.querySelectorAll('[onclick*="openBusinessProfile"]');
            profileButtons.forEach(btn => {
                btn.removeAttribute('onclick');
                btn.addEventListener('click', openBusinessProfile);
            });
            
            // Fix process button
            const processBtn = document.querySelector('.process-btn');
            if (processBtn) {
                processBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    processMessage();
                });
            }
            
            // Fix tab buttons when modal is opened
            document.addEventListener('click', function(e) {
                if (e.target.classList && e.target.classList.contains('tab-button')) {
                    e.preventDefault();
                    const tabName = e.target.id.replace('-tab', '');
                    switchTab(tabName);
                }
            });
            
            // Handle email enabled checkbox toggle
            document.addEventListener('change', function(e) {
                if (e.target.id === 'email-enabled') {
                    const smtpSettings = document.getElementById('smtp-settings');
                    if (smtpSettings) {
                        if (e.target.checked) {
                            smtpSettings.style.opacity = '1';
                            smtpSettings.style.pointerEvents = 'auto';
                        } else {
                            smtpSettings.style.opacity = '0.5';
                            smtpSettings.style.pointerEvents = 'none';
                        }
                    }
                }
            });

            // Handle provider button clicks
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('provider-btn') || e.target.closest('.provider-btn')) {
                    e.preventDefault();
                    const btn = e.target.classList.contains('provider-btn') ? e.target : e.target.closest('.provider-btn');
                    const provider = btn.getAttribute('data-provider');
                    if (provider && typeof selectEmailProvider === 'function') {
                        selectEmailProvider(provider);
                    }
                }
                
                if (e.target.id === 'quick-setup-btn' && typeof applyQuickSetup === 'function') {
                    e.preventDefault();
                    applyQuickSetup();
                }
                
                if (e.target.id === 'test-email-btn' && typeof testEmailConnection === 'function') {
                    e.preventDefault();
                    testEmailConnection();
                }
            });
        });

        // Test function to check button states (for debugging from console)
        window.testButtonStates = function() {
            console.log('=== BUTTON STATE TEST ===');
            console.log('invoiceGenerated:', invoiceGenerated);
            console.log('hasUnsavedEdits:', hasUnsavedEdits);
            console.log('currentInvoiceData:', currentInvoiceData ? 'exists' : 'null');
            
            const shareBtnPreview = document.getElementById('share-btn-preview');
            const shareBtnFinal = document.getElementById('share-btn-final');
            
            console.log('Share buttons status:');
            if (shareBtnPreview) {
                console.log('Preview share button found:');
                console.log('  disabled:', shareBtnPreview.disabled);
                console.log('  style.display:', shareBtnPreview.style.display);
                console.log('  computed display:', window.getComputedStyle(shareBtnPreview).display);
                console.log('  computed visibility:', window.getComputedStyle(shareBtnPreview).visibility);
                console.log('  computed opacity:', window.getComputedStyle(shareBtnPreview).opacity);
                console.log('  offsetWidth:', shareBtnPreview.offsetWidth);
                console.log('  offsetHeight:', shareBtnPreview.offsetHeight);
            } else {
                console.log('Preview share button NOT FOUND');
            }
            
            if (shareBtnFinal) {
                console.log('Final share button found:');
                console.log('  disabled:', shareBtnFinal.disabled);
                console.log('  style.display:', shareBtnFinal.style.display);
                console.log('  computed display:', window.getComputedStyle(shareBtnFinal).display);
                console.log('  computed visibility:', window.getComputedStyle(shareBtnFinal).visibility);
                console.log('  computed opacity:', window.getComputedStyle(shareBtnFinal).opacity);
                console.log('  offsetWidth:', shareBtnFinal.offsetWidth);
                console.log('  offsetHeight:', shareBtnFinal.offsetHeight);
            } else {
                console.log('Final share button NOT FOUND');
            }
            
            // Manually call updateButtonStates and log result
            console.log('--- Calling updateButtonStates manually ---');
            updateButtonStates();
            console.log('=== END TEST ===');
        };

        // Test function to simulate invoice generation (for debugging)
        window.testInvoiceGeneration = function() {
            console.log('=== SIMULATING INVOICE GENERATION ===');
            invoiceGenerated = true;
            hasUnsavedEdits = false;
            console.log('Set invoiceGenerated = true, hasUnsavedEdits = false');
            updateButtonStates();
            console.log('Called updateButtonStates()');
            window.testButtonStates();
        };

        // Test function for duplicate prevention flow
        window.testDuplicatePrevention = function() {
            console.log('=== TESTING DUPLICATE PREVENTION FLOW ===');
            
            console.log('1. Initial state:');
            console.log('  currentInvoiceDbId:', currentInvoiceDbId);
            console.log('  finalInvoiceGenerated:', finalInvoiceGenerated);
            console.log('  hasUnsavedEdits:', hasUnsavedEdits);
            
            console.log('2. Simulating first final invoice generation...');
            currentInvoiceDbId = 12345; // Simulate DB ID from server response
            finalInvoiceGenerated = true;
            hasUnsavedEdits = false;
            updateButtonStates();
            console.log('  → Invoice created with DB ID:', currentInvoiceDbId);
            console.log('  → Button should be DISABLED (grey)');
            
            console.log('3. Simulating edit action...');
            hasUnsavedEdits = true;
            updateButtonStates();
            console.log('  → hasUnsavedEdits = true');
            console.log('  → Button should be ENABLED (green) with text "Update Final Invoice"');
            
            console.log('4. Simulating second final invoice generation (UPDATE)...');
            hasUnsavedEdits = false;
            updateButtonStates();
            console.log('  → hasUnsavedEdits = false');
            console.log('  → Button should be DISABLED (grey) again');
            console.log('  → Same DB ID should be used:', currentInvoiceDbId);
            console.log('  → No new invoice record should be created!');
            
            console.log('5. Simulating new invoice (Clear)...');
            currentInvoiceDbId = null;
            finalInvoiceGenerated = false;
            hasUnsavedEdits = false;
            invoiceGenerated = false;
            updateButtonStates();
            console.log('  → All IDs reset');
            console.log('  → Next generation will CREATE new invoice');
            
            console.log('=== END TEST ===');
            console.log('Expected behavior:');
            console.log('- First generation: CREATE new invoice');
            console.log('- Edit + Generate: UPDATE same invoice (same DB ID)');
            console.log('- Clear + Generate: CREATE new invoice (new DB ID)');
        };

        // Test function for notes functionality  
        window.testNotesFeature = function() {
            console.log('=== TESTING NOTES FUNCTIONALITY ===');
            
            console.log('1. Testing notes data structure...');
            if (currentInvoiceData) {
                console.log('Current invoice data exists');
                console.log('Notes field:', currentInvoiceData.invoice.notes);
                
                // Regenerate preview to check notes visibility
                console.log('2. Regenerating preview to show notes...');
                generateInvoicePreview(currentInvoiceData);
                
                console.log('3. Checking if notes section is visible...');
                const notesSection = document.querySelector('.notes-section');
                if (notesSection) {
                    console.log('✅ Notes section found in DOM');
                    
                    const notesContent = notesSection.querySelector('.notes-content');
                    const isPlaceholder = notesContent?.querySelector('.notes-placeholder');
                    const actualContent = currentInvoiceData.invoice.notes?.publicNotes || '';
                    
                    if (isPlaceholder) {
                        console.log('✅ Empty state with placeholder displayed correctly');
                        console.log('Placeholder text:', isPlaceholder.textContent.replace('✏️', ''));
                    } else if (actualContent) {
                        console.log('✅ Notes content displayed:', actualContent);
                    }
                    
                    console.log('Notes section is properly visible!');
                } else {
                    console.log('❌ Notes section not found in DOM');
                }
                
            } else {
                console.log('❌ No current invoice data. Generate a preview first.');
            }
            
            console.log('=== END NOTES TEST ===');
        };

        // Test function for notes editing
        window.testNotesEditing = function(testNote = 'This is a test note for the invoice') {
            console.log('=== TESTING NOTES EDITING ===');
            
            if (!currentInvoiceData) {
                console.log('❌ No invoice data. Generate a preview first.');
                return;
            }
            
            console.log('1. Setting test note...');
            if (!currentInvoiceData.invoice.notes) {
                currentInvoiceData.invoice.notes = {};
            }
            currentInvoiceData.invoice.notes.publicNotes = testNote;
            
            console.log('2. Updating button states...');
            hasUnsavedEdits = true;
            updateButtonStates();
            
            console.log('3. Refreshing preview...');
            generateInvoicePreview(currentInvoiceData);
            
            console.log('4. Verifying notes are displayed...');
            const notesSection = document.querySelector('.notes-section');
            if (notesSection) {
                console.log('✅ Notes section visible');
                const editableNote = notesSection.querySelector('.editable[data-field="notes.publicNotes"]');
                if (editableNote) {
                    console.log('✅ Editable notes field found');
                    console.log('Note content:', editableNote.textContent.replace('✏️', ''));
                } else {
                    console.log('❌ Editable notes field not found');
                }
            } else {
                console.log('❌ Notes section not visible');
            }
            
            console.log('=== END NOTES EDITING TEST ===');
            console.log('💡 You can now click on the note in the preview to edit it inline!');
        };

        // Test function for immediate notes visibility after generation
        window.testNotesImmediateVisibility = function() {
            console.log('=== TESTING IMMEDIATE NOTES VISIBILITY ===');
            
            if (!currentInvoiceData) {
                console.log('❌ No invoice data. Generate a preview first by typing invoice description and clicking "Buat Faktur"');
                return;
            }
            
            console.log('✅ Current invoice data exists');
            console.log('Notes structure:', currentInvoiceData.invoice.notes);
            
            // Check DOM immediately
            const notesSection = document.querySelector('.notes-section');
            if (notesSection) {
                console.log('🎉 SUCCESS: Notes section is immediately visible after generation!');
                
                const placeholder = notesSection.querySelector('.notes-placeholder');
                if (placeholder) {
                    console.log('✅ Empty state placeholder is showing: "' + placeholder.textContent.replace('✏️', '') + '"');
                    console.log('✅ Users can click on the placeholder to add notes');
                }
            } else {
                console.log('❌ FAILED: Notes section is still not visible');
            }
            
            console.log('=== END IMMEDIATE VISIBILITY TEST ===');
        };

        // ============================================================================
        // MOBILE INVOICE PREVIEW ZOOM & PAN FUNCTIONALITY
        // ============================================================================

        let currentScale = 1.0;
        let initialScale = 0.4;
        let minScale = 0.2;
        let maxScale = 3.0;
        let zoomIndicatorTimeout;
        let isMobile = window.innerWidth <= 767;
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        // Initialize mobile zoom functionality when invoice preview is shown
        function initializeMobileZoom() {
            if (!isMobile) return;

            const previewContainer = document.getElementById('pdf-preview-container');
            const mobileControls = document.getElementById('mobile-zoom-controls');
            const preview = document.getElementById('pdf-preview');
            
            if (!previewContainer || !mobileControls || !preview) return;

            // Calculate initial scale to fit A4 in mobile screen
            const containerWidth = previewContainer.clientWidth - 16; // Account for padding
            const a4WidthPx = 794; // 210mm in pixels at 96 DPI
            initialScale = Math.max(containerWidth / a4WidthPx, 0.25);
            currentScale = initialScale;

            // Set CSS custom property for mobile scaling
            document.documentElement.style.setProperty('--mobile-scale-factor', currentScale);

            // Show mobile zoom controls
            mobileControls.style.display = 'flex';

            // Update zoom indicator
            updateZoomIndicator();

            // Add touch gesture support
            addTouchGestureSupport();

            // Add pan support when zoomed in
            addPanSupport();

            console.log('📱 Mobile zoom initialized', {
                initialScale: initialScale,
                containerWidth: containerWidth,
                a4Width: a4WidthPx
            });
        }

        // Adjust zoom level
        function adjustZoom(delta) {
            const newScale = Math.max(minScale, Math.min(maxScale, currentScale + delta));
            
            if (newScale !== currentScale) {
                currentScale = newScale;
                applyZoom();
            }
        }

        // Fit invoice to screen width
        function fitToScreen() {
            const previewContainer = document.getElementById('pdf-preview-container');
            const containerWidth = previewContainer.clientWidth - 16;
            const a4WidthPx = 794;
            
            currentScale = Math.max(containerWidth / a4WidthPx, 0.25);
            applyZoom();
        }

        // Apply current zoom level
        function applyZoom() {
            document.documentElement.style.setProperty('--mobile-scale-factor', currentScale);
            updateZoomIndicator();
            
            const panIndicator = document.getElementById('pan-indicator');
            if (currentScale > initialScale + 0.1) {
                panIndicator.classList.add('show');
            } else {
                panIndicator.classList.remove('show');
            }
        }

        // Update zoom indicator
        function updateZoomIndicator() {
            const indicator = document.getElementById('zoom-indicator');
            if (indicator) {
                indicator.textContent = Math.round(currentScale * 100) + '%';
                indicator.classList.add('show');
                
                // Hide after 2 seconds
                clearTimeout(zoomIndicatorTimeout);
                zoomIndicatorTimeout = setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Add touch gesture support for pinch-zoom and double-tap
        function addTouchGestureSupport() {
            const previewContainer = document.getElementById('pdf-preview-container');
            if (!previewContainer) return;

            let lastTouchDistance = 0;
            let lastTapTime = 0;
            let touchStartScale = currentScale;

            // Pinch-to-zoom
            previewContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    lastTouchDistance = Math.hypot(
                        touch1.clientX - touch2.clientX,
                        touch1.clientY - touch2.clientY
                    );
                    touchStartScale = currentScale;
                }
                
                // Double-tap detection
                if (e.touches.length === 1) {
                    const currentTime = new Date().getTime();
                    const tapGap = currentTime - lastTapTime;
                    
                    if (tapGap < 300 && tapGap > 0) {
                        e.preventDefault();
                        // Double-tap: toggle between fit-to-screen and 1.5x zoom
                        if (Math.abs(currentScale - initialScale) < 0.05) {
                            currentScale = Math.min(initialScale * 2.5, maxScale);
                        } else {
                            currentScale = initialScale;
                        }
                        applyZoom();
                    }
                    lastTapTime = currentTime;
                }
            }, { passive: false });

            previewContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch1.clientX - touch2.clientX,
                        touch1.clientY - touch2.clientY
                    );
                    
                    if (lastTouchDistance > 0) {
                        const scale = touchStartScale * (currentDistance / lastTouchDistance);
                        currentScale = Math.max(minScale, Math.min(maxScale, scale));
                        applyZoom();
                    }
                }
            }, { passive: false });

            previewContainer.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) {
                    lastTouchDistance = 0;
                }
            });
        }

        // Add pan support when zoomed in
        function addPanSupport() {
            const previewContainer = document.getElementById('pdf-preview-container');
            if (!previewContainer) return;

            // Mouse events for testing
            previewContainer.addEventListener('mousedown', startDrag);
            previewContainer.addEventListener('mousemove', doDrag);
            previewContainer.addEventListener('mouseup', endDrag);
            previewContainer.addEventListener('mouseleave', endDrag);

            // Touch events
            previewContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1 && currentScale > initialScale + 0.1) {
                    startDrag(e.touches[0]);
                }
            });
            
            previewContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && isDragging) {
                    e.preventDefault();
                    doDrag(e.touches[0]);
                }
            }, { passive: false });
            
            previewContainer.addEventListener('touchend', endDrag);

            function startDrag(e) {
                if (currentScale <= initialScale + 0.1) return;
                
                isDragging = true;
                startX = e.clientX - previewContainer.offsetLeft;
                startY = e.clientY - previewContainer.offsetTop;
                scrollLeft = previewContainer.scrollLeft;
                scrollTop = previewContainer.scrollTop;
                
                previewContainer.style.cursor = 'grabbing';
            }

            function doDrag(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                const x = e.clientX - previewContainer.offsetLeft;
                const y = e.clientY - previewContainer.offsetTop;
                const walkX = (x - startX) * 1.5;
                const walkY = (y - startY) * 1.5;
                
                previewContainer.scrollLeft = scrollLeft - walkX;
                previewContainer.scrollTop = scrollTop - walkY;
            }

            function endDrag() {
                isDragging = false;
                previewContainer.style.cursor = currentScale > initialScale + 0.1 ? 'grab' : 'auto';
            }
        }

        // Update mobile detection on window resize
        window.addEventListener('resize', () => {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 767;
            
            if (wasMobile !== isMobile) {
                const mobileControls = document.getElementById('mobile-zoom-controls');
                if (mobileControls) {
                    mobileControls.style.display = isMobile ? 'flex' : 'none';
                }
                
                if (isMobile) {
                    initializeMobileZoom();
                } else {
                    // Reset to desktop styles
                    document.documentElement.style.setProperty('--mobile-scale-factor', '1');
                    currentScale = 1.0;
                }
            }
        });

        // Hook into existing invoice preview generation
        const originalGenerateInvoicePreview = window.generateInvoicePreview;
        if (originalGenerateInvoicePreview) {
            window.generateInvoicePreview = function(invoiceData) {
                const result = originalGenerateInvoicePreview(invoiceData);
                
                // Initialize mobile zoom after preview is generated
                setTimeout(() => {
                    initializeMobileZoom();
                }, 100);
                
                return result;
            };
        }

        // Initialize on DOM load if preview already exists
        document.addEventListener('DOMContentLoaded', () => {
            const preview = document.getElementById('pdf-preview');
            if (preview && preview.innerHTML && !preview.innerHTML.includes('preview-loading')) {
                setTimeout(() => {
                    initializeMobileZoom();
                }, 100);
            }
        });

        console.log('📱 Mobile invoice zoom functionality loaded');
    </script>
</body>
</html>